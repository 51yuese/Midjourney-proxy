'use strict';const _0x23a2cd=_0x5a43;function _0x5a43(_0x3374aa,_0x5c09a8){const _0x2bea47=_0x2bea();return _0x5a43=function(_0x5a431d,_0x1a2612){_0x5a431d=_0x5a431d-0x95;let _0x4711a1=_0x2bea47[_0x5a431d];return _0x4711a1;},_0x5a43(_0x3374aa,_0x5c09a8);}(function(_0x2a4b76,_0x2ab002){const _0xd95dbd=_0x5a43,_0x42447f=_0x2a4b76();while(!![]){try{const _0x2eb30a=-parseInt(_0xd95dbd(0xba))/0x1+parseInt(_0xd95dbd(0xe3))/0x2+parseInt(_0xd95dbd(0xb7))/0x3+-parseInt(_0xd95dbd(0xd7))/0x4*(-parseInt(_0xd95dbd(0x9d))/0x5)+-parseInt(_0xd95dbd(0xc1))/0x6+parseInt(_0xd95dbd(0xeb))/0x7+-parseInt(_0xd95dbd(0xa6))/0x8*(-parseInt(_0xd95dbd(0xf0))/0x9);if(_0x2eb30a===_0x2ab002)break;else _0x42447f['push'](_0x42447f['shift']());}catch(_0x1d7b9d){_0x42447f['push'](_0x42447f['shift']());}}}(_0x2bea,0x7eb10));function _0x2bea(){const _0x357ace=['day','\x20AND\x20s.userId\x20=\x20','object','91672NMjMjj','decorate','HttpStatus','signInDate','push','month','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','BAD_REQUEST','2102961gpobBf','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','\x0a\x20\x20\x20\x20','error:\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','11880NPCuVY','signin.signInTime\x20<=\x20:lastDay','metadata','log','save','find','ClsService','select','getReqSaasId','昨天没签到、今天重置天数！','signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned','count','用户不存在','305UCgJdw','format','length','changeScore4Other','EChangeType','签到奖励','@nestjs/common','function','clsService','3496UIweUF','query','SigninEntity','design:paramtypes','signin.userId\x20=\x20:userId','globalConfigService','今日已签到、改天再来吧!.','__decorate','\x20AND\x20u.saasId\x20=\x20','signinEntity','sign','../../common/utils/date','userService','phone','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','andWhere','maskEmail','1745124AwJaPo','@nestjs/typeorm','debug','930440udDnEC','getSignatureGiftConfig','__metadata','setDate','typeorm','userPage','__param','2486178EfUfnd','昨天签到了、今天是连续签到！','获取签到数据失败！','isSuper','Logger','isDefined','findOne','HttpException','Connection','Repository','GlobalConfigService','default','__esModule','YYYY-MM-DD','createQueryBuilder','defineProperty','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','toDate','connection','getRawMany','email','user','23536FtnUQq','./signIn.entity','SigninService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','./../globalConfig/globalConfig.service','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','updateSignDay','endOf','YYYY-MM-DD\x20HH:mm:ss'];_0x2bea=function(){return _0x357ace;};return _0x2bea();}var __decorate=this&&this[_0x23a2cd(0xad)]||function(_0x240e40,_0x3e7c51,_0x1ac0fe,_0x36edfd){const _0x5f425a=_0x23a2cd;var _0x3ca718=arguments[_0x5f425a(0x9f)],_0x39be44=_0x3ca718<0x3?_0x3e7c51:_0x36edfd===null?_0x36edfd=Object['getOwnPropertyDescriptor'](_0x3e7c51,_0x1ac0fe):_0x36edfd,_0x7e3de9;if(typeof Reflect===_0x5f425a(0xe2)&&typeof Reflect['decorate']===_0x5f425a(0xa4))_0x39be44=Reflect[_0x5f425a(0xe4)](_0x240e40,_0x3e7c51,_0x1ac0fe,_0x36edfd);else{for(var _0x593d51=_0x240e40['length']-0x1;_0x593d51>=0x0;_0x593d51--)if(_0x7e3de9=_0x240e40[_0x593d51])_0x39be44=(_0x3ca718<0x3?_0x7e3de9(_0x39be44):_0x3ca718>0x3?_0x7e3de9(_0x3e7c51,_0x1ac0fe,_0x39be44):_0x7e3de9(_0x3e7c51,_0x1ac0fe))||_0x39be44;}return _0x3ca718>0x3&&_0x39be44&&Object[_0x5f425a(0xd0)](_0x3e7c51,_0x1ac0fe,_0x39be44),_0x39be44;},__metadata=this&&this[_0x23a2cd(0xbc)]||function(_0x1e243c,_0x107ce6){const _0x16a12a=_0x23a2cd;if(typeof Reflect===_0x16a12a(0xe2)&&typeof Reflect[_0x16a12a(0xf2)]===_0x16a12a(0xa4))return Reflect[_0x16a12a(0xf2)](_0x1e243c,_0x107ce6);},__param=this&&this[_0x23a2cd(0xc0)]||function(_0x27d80f,_0x270b3a){return function(_0x2f35e8,_0x2a23e1){_0x270b3a(_0x2f35e8,_0x2a23e1,_0x27d80f);};};Object[_0x23a2cd(0xd0)](exports,_0x23a2cd(0xcd),{'value':!![]}),exports['SigninService']=void 0x0;const globalConfig_service_1=require(_0x23a2cd(0xdb)),common_1=require(_0x23a2cd(0xa3)),signIn_entity_1=require(_0x23a2cd(0xd8)),typeorm_1=require(_0x23a2cd(0xb8)),typeorm_2=require(_0x23a2cd(0xbe)),date_1=require(_0x23a2cd(0xb1)),balance_constant_1=require('../../common/constants/balance.constant'),user_service_1=require('../user/user.service'),utils_1=require('../../common/utils'),nestjs_cls_1=require('nestjs-cls');let SigninService=class SigninService{constructor(_0x3fc15a,_0x4e0749,_0x4c1ed7,_0x37ae47,_0x45e5a9){const _0x45f255=_0x23a2cd;this[_0x45f255(0xaf)]=_0x3fc15a,this['clsService']=_0x4e0749,this['userService']=_0x4c1ed7,this['globalConfigService']=_0x37ae47,this[_0x45f255(0xd3)]=_0x45e5a9;}async[_0x23a2cd(0xb0)](_0x3e7194){const _0x5a5073=_0x23a2cd,_0x3c7819=_0x3e7194[_0x5a5073(0xd6)]['id'],_0x390ec5=await this[_0x5a5073(0xb2)]['getUserById'](_0x3c7819),_0x3740f5=(0x0,date_1[_0x5a5073(0xcc)])()[_0x5a5073(0x9e)](_0x5a5073(0xce)),_0x39273c=await this[_0x5a5073(0xaf)][_0x5a5073(0xc7)]({'where':{'userId':_0x3c7819,'signInDate':_0x3740f5}});if(_0x39273c)throw new common_1[(_0x5a5073(0xc8))](_0x5a5073(0xac),common_1['HttpStatus'][_0x5a5073(0xea)]);const _0x2cf933=await this[_0x5a5073(0xaf)][_0x5a5073(0xf4)]({'userId':_0x3c7819,'signInTime':(0x0,date_1[_0x5a5073(0xcc)])()[_0x5a5073(0xd2)](),'signInDate':_0x3740f5,'isSigned':!![]}),_0x56c8ee=await this[_0x5a5073(0xab)][_0x5a5073(0xbb)]();_0x56c8ee&&await this['userService'][_0x5a5073(0xa0)](_0x390ec5,balance_constant_1[_0x5a5073(0xa1)]['SignInReward'],_0x56c8ee,_0x5a5073(0xa2),_0x2cf933['id']);const _0x3dd286=(0x0,date_1[_0x5a5073(0xcc)])()['subtract'](0x1,_0x5a5073(0xe0))[_0x5a5073(0x9e)](_0x5a5073(0xce)),_0x156d8f=await this[_0x5a5073(0xaf)]['findOne']({'where':{'userId':_0x3c7819,'signInDate':_0x3dd286}});if(_0x156d8f){common_1[_0x5a5073(0xc5)][_0x5a5073(0xb9)]('用户'+_0x3c7819+_0x5a5073(0xc2),'SigninService');const _0x461e8f=await this[_0x5a5073(0xb2)]['getUserById'](_0x3c7819);if(!_0x461e8f)throw new common_1[(_0x5a5073(0xc8))](_0x5a5073(0x9c),common_1['HttpStatus']['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x461e8f;await this[_0x5a5073(0xb2)][_0x5a5073(0xdd)](_0x3c7819,consecutiveDays+0x1);}else common_1['Logger'][_0x5a5073(0xb9)]('用户'+_0x3c7819+_0x5a5073(0x99),_0x5a5073(0xd9)),await this[_0x5a5073(0xb2)][_0x5a5073(0xdd)](_0x3c7819,0x1);return _0x56c8ee;}async['getSigninLog'](_0x352096){const _0x2e2ad8=_0x23a2cd;try{const _0x17b3f7=(0x0,date_1[_0x2e2ad8(0xcc)])()['startOf'](_0x2e2ad8(0xe8))['format'](_0x2e2ad8(0xdf)),_0x22786c=(0x0,date_1[_0x2e2ad8(0xcc)])()[_0x2e2ad8(0xde)](_0x2e2ad8(0xe8))[_0x2e2ad8(0x9e)](_0x2e2ad8(0xdf)),_0x3179e5=this[_0x2e2ad8(0xaf)][_0x2e2ad8(0xcf)]('signin'),_0x45258c=await _0x3179e5[_0x2e2ad8(0x97)](_0x2e2ad8(0x9a))[_0x2e2ad8(0xb5)](_0x2e2ad8(0xaa),{'userId':_0x352096[_0x2e2ad8(0xd6)]['id']})['andWhere']('signin.signInTime\x20>=\x20:firstDay',{'firstDay':_0x17b3f7})[_0x2e2ad8(0xb5)](_0x2e2ad8(0xf1),{'lastDay':_0x22786c})[_0x2e2ad8(0xd4)](),_0xf29e6=(0x0,date_1[_0x2e2ad8(0xcc)])(_0x17b3f7)[_0x2e2ad8(0xd2)](),_0x53cbb0=(0x0,date_1['default'])(_0x22786c)[_0x2e2ad8(0xd2)](),_0x4c892f=[],_0x5ea421=(0x0,date_1[_0x2e2ad8(0xcc)])(_0xf29e6)[_0x2e2ad8(0xd2)]();while(_0x5ea421<=_0x53cbb0){_0x4c892f[_0x2e2ad8(0xe7)]((0x0,date_1[_0x2e2ad8(0xcc)])((0x0,date_1[_0x2e2ad8(0xcc)])(_0x5ea421))[_0x2e2ad8(0x9e)](_0x2e2ad8(0xce))),_0x5ea421[_0x2e2ad8(0xbd)](_0x5ea421['getDate']()+0x1);}const _0x491005=[];for(const _0x5d0cb2 of _0x4c892f){const _0x25014c=_0x45258c[_0x2e2ad8(0x95)](_0x47b5b4=>_0x47b5b4[_0x2e2ad8(0xe6)]===_0x5d0cb2);!_0x25014c?_0x491005[_0x2e2ad8(0xe7)]({'signInDate':_0x5d0cb2,'isSigned':![]}):(_0x25014c['isSigned']=!![],_0x491005[_0x2e2ad8(0xe7)](_0x25014c));}return _0x491005;}catch(_0xe96701){console[_0x2e2ad8(0xf3)](_0x2e2ad8(0xee),_0xe96701);throw new common_1['HttpException'](_0x2e2ad8(0xc3),common_1[_0x2e2ad8(0xe5)][_0x2e2ad8(0xea)]);}}async[_0x23a2cd(0xbf)](_0x24f44f,_0x3b8fc8,_0x32aaae){const _0x261c26=_0x23a2cd,_0x12cea9=(0x0,utils_1[_0x261c26(0x98)])(this['clsService']),{page:page=0x1,size:size=0x14,startTime:_0x3e2837,endTime:_0x4f0340,saasId:_0x5ebbe1,keyword:_0x4084a8}=_0x3b8fc8,_0x369320=_0x261c26(0xe9)+(_0x32aaae?_0x261c26(0xe1)+_0x32aaae:'')+_0x261c26(0xda)+(_0x3e2837?'\x20AND\x20s.createdAt\x20>=\x20\x27'+_0x3e2837+'\x27':'')+_0x261c26(0xda)+(_0x4f0340?'\x20AND\x20s.createdAt\x20<=\x20\x27'+_0x4f0340+'\x27':'')+_0x261c26(0xda)+(_0x12cea9!==0x0?_0x261c26(0xae)+_0x12cea9:(0x0,utils_1[_0x261c26(0xc6)])(_0x5ebbe1)?'\x20AND\x20u.saasId\x20=\x20'+_0x5ebbe1:'')+_0x261c26(0xda)+(_0x4084a8?_0x261c26(0xec)+_0x4084a8+_0x261c26(0xb4)+_0x4084a8+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x4084a8+_0x261c26(0xdc)+_0x4084a8+'%\x27\x20)':'')+_0x261c26(0xed),_0x1cea6d=_0x261c26(0xef)+_0x369320+_0x261c26(0xed),_0x1e5994='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x369320+_0x261c26(0xd1)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x261c26(0xed),_0x29015c=await this[_0x261c26(0xd3)]['query'](_0x1cea6d),_0x9132af=await this[_0x261c26(0xd3)][_0x261c26(0xa7)](_0x1e5994);return!(0x0,utils_1[_0x261c26(0xc4)])(this[_0x261c26(0xa5)])&&_0x9132af['forEach'](_0xd7a166=>{const _0xf441d6=_0x261c26;_0xd7a166[_0xf441d6(0xd5)]=(0x0,utils_1[_0xf441d6(0xb6)])(_0xd7a166[_0xf441d6(0xd5)]),_0xd7a166[_0xf441d6(0xb3)]=(0x0,utils_1[_0xf441d6(0xb6)])(_0xd7a166[_0xf441d6(0xb3)]);}),{'rows':_0x9132af,'count':Number(_0x29015c[0x0]?.[_0x261c26(0x9b)]||0x0)};}};SigninService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(signIn_entity_1[_0x23a2cd(0xa8)])),__metadata(_0x23a2cd(0xa9),[typeorm_2[_0x23a2cd(0xca)],nestjs_cls_1[_0x23a2cd(0x96)],user_service_1['UserService'],globalConfig_service_1[_0x23a2cd(0xcb)],typeorm_2[_0x23a2cd(0xc9)]])],SigninService),exports[_0x23a2cd(0xd9)]=SigninService;