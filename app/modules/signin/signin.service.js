'use strict';const _0x2eda3e=_0x5ef3;(function(_0x8473bf,_0xb93161){const _0x40f44d=_0x5ef3,_0x4d8c32=_0x8473bf();while(!![]){try{const _0x59b7cf=parseInt(_0x40f44d(0x1cf))/0x1*(parseInt(_0x40f44d(0x1db))/0x2)+-parseInt(_0x40f44d(0x20d))/0x3+-parseInt(_0x40f44d(0x227))/0x4*(parseInt(_0x40f44d(0x1d0))/0x5)+-parseInt(_0x40f44d(0x206))/0x6+-parseInt(_0x40f44d(0x1de))/0x7+parseInt(_0x40f44d(0x1c7))/0x8*(-parseInt(_0x40f44d(0x1ff))/0x9)+-parseInt(_0x40f44d(0x1d2))/0xa*(-parseInt(_0x40f44d(0x223))/0xb);if(_0x59b7cf===_0xb93161)break;else _0x4d8c32['push'](_0x4d8c32['shift']());}catch(_0x4e60a5){_0x4d8c32['push'](_0x4d8c32['shift']());}}}(_0x1e66,0x8d113));var __decorate=this&&this[_0x2eda3e(0x1d4)]||function(_0x150ed0,_0xf7c789,_0x40423c,_0x5f0a5e){const _0x4a468a=_0x2eda3e;var _0x3081c0=arguments[_0x4a468a(0x1f6)],_0x141054=_0x3081c0<0x3?_0xf7c789:_0x5f0a5e===null?_0x5f0a5e=Object[_0x4a468a(0x1e7)](_0xf7c789,_0x40423c):_0x5f0a5e,_0x22e0ac;if(typeof Reflect===_0x4a468a(0x220)&&typeof Reflect[_0x4a468a(0x1fc)]==='function')_0x141054=Reflect['decorate'](_0x150ed0,_0xf7c789,_0x40423c,_0x5f0a5e);else{for(var _0x479180=_0x150ed0['length']-0x1;_0x479180>=0x0;_0x479180--)if(_0x22e0ac=_0x150ed0[_0x479180])_0x141054=(_0x3081c0<0x3?_0x22e0ac(_0x141054):_0x3081c0>0x3?_0x22e0ac(_0xf7c789,_0x40423c,_0x141054):_0x22e0ac(_0xf7c789,_0x40423c))||_0x141054;}return _0x3081c0>0x3&&_0x141054&&Object[_0x4a468a(0x1f8)](_0xf7c789,_0x40423c,_0x141054),_0x141054;},__metadata=this&&this[_0x2eda3e(0x1ec)]||function(_0x5b6b15,_0x769ad7){const _0x594929=_0x2eda3e;if(typeof Reflect===_0x594929(0x220)&&typeof Reflect[_0x594929(0x1e4)]==='function')return Reflect['metadata'](_0x5b6b15,_0x769ad7);},__param=this&&this[_0x2eda3e(0x1d5)]||function(_0x4980ea,_0x517d72){return function(_0x1261e9,_0x14809a){_0x517d72(_0x1261e9,_0x14809a,_0x4980ea);};};Object['defineProperty'](exports,_0x2eda3e(0x1f5),{'value':!![]}),exports[_0x2eda3e(0x1ca)]=void 0x0;function _0x5ef3(_0x1a954f,_0x5ce63a){const _0x1e664f=_0x1e66();return _0x5ef3=function(_0x5ef3d6,_0x11e8e8){_0x5ef3d6=_0x5ef3d6-0x1c5;let _0x493875=_0x1e664f[_0x5ef3d6];return _0x493875;},_0x5ef3(_0x1a954f,_0x5ce63a);}function _0x1e66(){const _0x5ad9e5=['clsService','2121705ETJntG','Connection','ClsService','signin.userId\x20=\x20:userId','UserService','./signIn.entity','format','find','\x20AND\x20u.saasId\x20=\x20','startOf','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','getRawMany','BAD_REQUEST','getReqSaasId','nestjs-cls','HttpException','maskEmail','今日已签到、改天再来吧!.','phone','object','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','\x20AND\x20s.createdAt\x20>=\x20\x27','26170309WGNpFI','design:paramtypes','forEach','HttpStatus','816lhbcfI','andWhere','subtract','SigninEntity','GlobalConfigService','isSigned','24KSuBvq','Logger','day','SigninService','setDate','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','userService','signin.signInTime\x20>=\x20:firstDay','264185xrADzt','26045iOBnYq','@nestjs/typeorm','10yNJVCl','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','__decorate','__param','userPage','typeorm','getSignatureGiftConfig','connection','getUserById','8rhaasL','./../globalConfig/globalConfig.service','签到奖励','2558885esWOGM','getSigninLog','获取签到数据失败！','error:\x20','push','\x20AND\x20s.createdAt\x20<=\x20\x27','metadata','signin','globalConfigService','getOwnPropertyDescriptor','debug','findOne','log','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(\x20al.change_score,\x200\x20)\x20AS\x20score\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20account_log\x20al\x20ON\x20al.change_type\x20=\x206\x20AND\x20al.relate_id\x20=\x20s.id\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','__metadata','createQueryBuilder','month','signinEntity','updateSignDay','%\x27\x20)','../../common/utils/date','InjectRepository','user','__esModule','length','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','defineProperty','Repository','endOf','toDate','decorate','YYYY-MM-DD','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','714006IJGxzD','signin.signInTime\x20<=\x20:lastDay','isDefined','@nestjs/common','isSuper','query','getDate','2907720aUhPUL','SignInReward','Injectable','default','\x0a\x20\x20\x20\x20','用户不存在'];_0x1e66=function(){return _0x5ad9e5;};return _0x1e66();}const globalConfig_service_1=require(_0x2eda3e(0x1dc)),common_1=require(_0x2eda3e(0x202)),signIn_entity_1=require(_0x2eda3e(0x212)),typeorm_1=require(_0x2eda3e(0x1d1)),typeorm_2=require(_0x2eda3e(0x1d7)),date_1=require(_0x2eda3e(0x1f2)),balance_constant_1=require('../../common/constants/balance.constant'),user_service_1=require('../user/user.service'),utils_1=require('../../common/utils'),nestjs_cls_1=require(_0x2eda3e(0x21b));let SigninService=class SigninService{constructor(_0x1b76ce,_0x5a4736,_0x181e98,_0x2f0ed9,_0x32f56c){const _0x24853b=_0x2eda3e;this[_0x24853b(0x1ef)]=_0x1b76ce,this[_0x24853b(0x20c)]=_0x5a4736,this[_0x24853b(0x1cd)]=_0x181e98,this[_0x24853b(0x1e6)]=_0x2f0ed9,this[_0x24853b(0x1d9)]=_0x32f56c;}async['sign'](_0x2ee76d){const _0x2f8061=_0x2eda3e,_0x3540ce=_0x2ee76d[_0x2f8061(0x1f4)]['id'],_0x49c990=await this[_0x2f8061(0x1cd)][_0x2f8061(0x1da)](_0x3540ce),_0x294649=(0x0,date_1[_0x2f8061(0x209)])()[_0x2f8061(0x213)](_0x2f8061(0x1fd)),_0x14b580=await this[_0x2f8061(0x1ef)]['findOne']({'where':{'userId':_0x3540ce,'signInDate':_0x294649}});if(_0x14b580)throw new common_1[(_0x2f8061(0x21c))](_0x2f8061(0x21e),common_1['HttpStatus'][_0x2f8061(0x219)]);const _0x239ecd=await this[_0x2f8061(0x1ef)]['save']({'userId':_0x3540ce,'signInTime':(0x0,date_1['default'])()[_0x2f8061(0x1fb)](),'signInDate':_0x294649,'isSigned':!![]}),_0x1a7614=await this[_0x2f8061(0x1e6)][_0x2f8061(0x1d8)]();_0x1a7614&&await this[_0x2f8061(0x1cd)]['changeScore4Other'](_0x49c990,balance_constant_1['EChangeType'][_0x2f8061(0x207)],_0x1a7614,_0x2f8061(0x1dd),_0x239ecd['id']);const _0x3a3ced=(0x0,date_1[_0x2f8061(0x209)])()[_0x2f8061(0x229)](0x1,_0x2f8061(0x1c9))['format'](_0x2f8061(0x1fd)),_0x137b3d=await this[_0x2f8061(0x1ef)][_0x2f8061(0x1e9)]({'where':{'userId':_0x3540ce,'signInDate':_0x3a3ced}});if(_0x137b3d){common_1[_0x2f8061(0x1c8)][_0x2f8061(0x1e8)]('用户'+_0x3540ce+'昨天签到了、今天是连续签到！',_0x2f8061(0x1ca));const _0x24e564=await this[_0x2f8061(0x1cd)]['getUserById'](_0x3540ce);if(!_0x24e564)throw new common_1[(_0x2f8061(0x21c))](_0x2f8061(0x20b),common_1[_0x2f8061(0x226)]['BAD_REQUEST']);const {consecutiveDays:consecutiveDays=0x0}=_0x24e564;await this[_0x2f8061(0x1cd)][_0x2f8061(0x1f0)](_0x3540ce,consecutiveDays+0x1);}else common_1[_0x2f8061(0x1c8)][_0x2f8061(0x1e8)]('用户'+_0x3540ce+'昨天没签到、今天重置天数！','SigninService'),await this[_0x2f8061(0x1cd)][_0x2f8061(0x1f0)](_0x3540ce,0x1);return _0x1a7614;}async[_0x2eda3e(0x1df)](_0x20131f){const _0x4a7275=_0x2eda3e;try{const _0x41e608=(0x0,date_1[_0x4a7275(0x209)])()[_0x4a7275(0x216)](_0x4a7275(0x1ee))[_0x4a7275(0x213)]('YYYY-MM-DD\x20HH:mm:ss'),_0x3cb64d=(0x0,date_1['default'])()[_0x4a7275(0x1fa)]('month')[_0x4a7275(0x213)]('YYYY-MM-DD\x20HH:mm:ss'),_0x3f8038=this[_0x4a7275(0x1ef)][_0x4a7275(0x1ed)](_0x4a7275(0x1e5)),_0x4f40e9=await _0x3f8038['select']('signin.signInDate\x20as\x20signInDate,\x20signin.isSigned\x20as\x20isSigned')[_0x4a7275(0x228)](_0x4a7275(0x210),{'userId':_0x20131f['user']['id']})[_0x4a7275(0x228)](_0x4a7275(0x1ce),{'firstDay':_0x41e608})['andWhere'](_0x4a7275(0x200),{'lastDay':_0x3cb64d})[_0x4a7275(0x218)](),_0x2eec9b=(0x0,date_1['default'])(_0x41e608)[_0x4a7275(0x1fb)](),_0x52f36f=(0x0,date_1[_0x4a7275(0x209)])(_0x3cb64d)['toDate'](),_0x3f0fa3=[],_0x292cf2=(0x0,date_1[_0x4a7275(0x209)])(_0x2eec9b)[_0x4a7275(0x1fb)]();while(_0x292cf2<=_0x52f36f){_0x3f0fa3[_0x4a7275(0x1e2)]((0x0,date_1[_0x4a7275(0x209)])((0x0,date_1['default'])(_0x292cf2))[_0x4a7275(0x213)](_0x4a7275(0x1fd))),_0x292cf2[_0x4a7275(0x1cb)](_0x292cf2[_0x4a7275(0x205)]()+0x1);}const _0x17c755=[];for(const _0x55e1b6 of _0x3f0fa3){const _0x23cf28=_0x4f40e9[_0x4a7275(0x214)](_0x527cda=>_0x527cda['signInDate']===_0x55e1b6);!_0x23cf28?_0x17c755[_0x4a7275(0x1e2)]({'signInDate':_0x55e1b6,'isSigned':![]}):(_0x23cf28[_0x4a7275(0x1c6)]=!![],_0x17c755['push'](_0x23cf28));}return _0x17c755;}catch(_0x5d8c4c){console[_0x4a7275(0x1ea)](_0x4a7275(0x1e1),_0x5d8c4c);throw new common_1[(_0x4a7275(0x21c))](_0x4a7275(0x1e0),common_1[_0x4a7275(0x226)][_0x4a7275(0x219)]);}}async[_0x2eda3e(0x1d6)](_0x4f5fe6,_0x1277ef,_0x1c9641){const _0x2a1a62=_0x2eda3e,_0x25f9c2=(0x0,utils_1[_0x2a1a62(0x21a)])(this[_0x2a1a62(0x20c)]),{page:page=0x1,size:size=0x14,startTime:_0xdf9fcc,endTime:_0x38a3aa,saasId:_0x416231,keyword:_0x2fa348}=_0x1277ef,_0x3cf59a=_0x2a1a62(0x1fe)+(_0x1c9641?'\x20AND\x20s.userId\x20=\x20'+_0x1c9641:'')+_0x2a1a62(0x221)+(_0xdf9fcc?_0x2a1a62(0x222)+_0xdf9fcc+'\x27':'')+_0x2a1a62(0x221)+(_0x38a3aa?_0x2a1a62(0x1e3)+_0x38a3aa+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x25f9c2!==0x0?_0x2a1a62(0x215)+_0x25f9c2:(0x0,utils_1[_0x2a1a62(0x201)])(_0x416231)?_0x2a1a62(0x215)+_0x416231:'')+_0x2a1a62(0x221)+(_0x2fa348?_0x2a1a62(0x1f7)+_0x2fa348+_0x2a1a62(0x217)+_0x2fa348+_0x2a1a62(0x1d3)+_0x2fa348+_0x2a1a62(0x1cc)+_0x2fa348+_0x2a1a62(0x1f1):'')+_0x2a1a62(0x20a),_0x15525c='\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20signin\x20s\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20s.userId\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x3cf59a+_0x2a1a62(0x20a),_0x514006=_0x2a1a62(0x1eb)+_0x3cf59a+'\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20s.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20',_0x4ec1c8=await this[_0x2a1a62(0x1d9)][_0x2a1a62(0x204)](_0x15525c),_0x1f0d81=await this[_0x2a1a62(0x1d9)][_0x2a1a62(0x204)](_0x514006);return!(0x0,utils_1[_0x2a1a62(0x203)])(this[_0x2a1a62(0x20c)])&&_0x1f0d81[_0x2a1a62(0x225)](_0x407668=>{const _0x300905=_0x2a1a62;_0x407668['email']=(0x0,utils_1['maskEmail'])(_0x407668['email']),_0x407668[_0x300905(0x21f)]=(0x0,utils_1[_0x300905(0x21d)])(_0x407668[_0x300905(0x21f)]);}),{'rows':_0x1f0d81,'count':Number(_0x4ec1c8[0x0]?.['count']||0x0)};}};SigninService=__decorate([(0x0,common_1[_0x2eda3e(0x208)])(),__param(0x0,(0x0,typeorm_1[_0x2eda3e(0x1f3)])(signIn_entity_1[_0x2eda3e(0x22a)])),__metadata(_0x2eda3e(0x224),[typeorm_2[_0x2eda3e(0x1f9)],nestjs_cls_1[_0x2eda3e(0x20f)],user_service_1[_0x2eda3e(0x211)],globalConfig_service_1[_0x2eda3e(0x1c5)],typeorm_2[_0x2eda3e(0x20e)]])],SigninService),exports[_0x2eda3e(0x1ca)]=SigninService;