'use strict';const _0x3d2cb1=_0x388a;function _0x388a(_0x43a1ab,_0x9607e4){const _0x301526=_0x3015();return _0x388a=function(_0x388ae5,_0x3c6e06){_0x388ae5=_0x388ae5-0x144;let _0x476b51=_0x301526[_0x388ae5];return _0x476b51;},_0x388a(_0x43a1ab,_0x9607e4);}(function(_0x530c53,_0x35e92e){const _0x5d7683=_0x388a,_0x139c82=_0x530c53();while(!![]){try{const _0x2dcb0e=-parseInt(_0x5d7683(0x18a))/0x1+-parseInt(_0x5d7683(0x17d))/0x2*(-parseInt(_0x5d7683(0x14f))/0x3)+-parseInt(_0x5d7683(0x163))/0x4*(parseInt(_0x5d7683(0x180))/0x5)+parseInt(_0x5d7683(0x14b))/0x6*(-parseInt(_0x5d7683(0x1a4))/0x7)+-parseInt(_0x5d7683(0x16a))/0x8*(-parseInt(_0x5d7683(0x16b))/0x9)+parseInt(_0x5d7683(0x146))/0xa*(-parseInt(_0x5d7683(0x147))/0xb)+parseInt(_0x5d7683(0x159))/0xc*(parseInt(_0x5d7683(0x179))/0xd);if(_0x2dcb0e===_0x35e92e)break;else _0x139c82['push'](_0x139c82['shift']());}catch(_0x3ee7da){_0x139c82['push'](_0x139c82['shift']());}}}(_0x3015,0xf355d));var __decorate=this&&this[_0x3d2cb1(0x199)]||function(_0x125bda,_0x1c386e,_0x40533d,_0x4dcf27){const _0x5edc37=_0x3d2cb1;var _0x198a0e=arguments['length'],_0xbd0798=_0x198a0e<0x3?_0x1c386e:_0x4dcf27===null?_0x4dcf27=Object[_0x5edc37(0x1a6)](_0x1c386e,_0x40533d):_0x4dcf27,_0x2f4ff3;if(typeof Reflect===_0x5edc37(0x168)&&typeof Reflect[_0x5edc37(0x17a)]===_0x5edc37(0x157))_0xbd0798=Reflect[_0x5edc37(0x17a)](_0x125bda,_0x1c386e,_0x40533d,_0x4dcf27);else{for(var _0xb1e45d=_0x125bda['length']-0x1;_0xb1e45d>=0x0;_0xb1e45d--)if(_0x2f4ff3=_0x125bda[_0xb1e45d])_0xbd0798=(_0x198a0e<0x3?_0x2f4ff3(_0xbd0798):_0x198a0e>0x3?_0x2f4ff3(_0x1c386e,_0x40533d,_0xbd0798):_0x2f4ff3(_0x1c386e,_0x40533d))||_0xbd0798;}return _0x198a0e>0x3&&_0xbd0798&&Object[_0x5edc37(0x171)](_0x1c386e,_0x40533d,_0xbd0798),_0xbd0798;},__metadata=this&&this[_0x3d2cb1(0x195)]||function(_0x43ec6e,_0x2fdf09){const _0x555843=_0x3d2cb1;if(typeof Reflect===_0x555843(0x168)&&typeof Reflect[_0x555843(0x15d)]==='function')return Reflect[_0x555843(0x15d)](_0x43ec6e,_0x2fdf09);},__param=this&&this[_0x3d2cb1(0x170)]||function(_0x128ae2,_0xedb27a){return function(_0x49323a,_0x4aa340){_0xedb27a(_0x49323a,_0x4aa340,_0x128ae2);};};Object[_0x3d2cb1(0x171)](exports,_0x3d2cb1(0x16d),{'value':!![]}),exports[_0x3d2cb1(0x191)]=void 0x0;function _0x3015(){const _0x3ba592=['./accountLog.entity','../user/user.service','9653225uLTChU','非法操作、当前充值套餐暂不存在！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','update','query','Repository','email','log','Connection','isManage','733625lpzCMZ','../../common/constants/balance.constant','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','../../common/utils','@nestjs/common','maskEmail','购买套餐：','UserBalanceService','\x0a\x20\x20\x20\x20','forwardRef','Inject','__metadata','\x20AND\x20al.createdAt\x20<=\x20\x27','\x20AND\x20(\x20u.username\x20LIKE\x20\x27%','error:\x20','__decorate','@nestjs/typeorm','../sales/sales.service','Injectable','insertAccountLog','cramiPackageEntity','\x20AND\x20al.createdAt\x20>=\x20\x27','addBalanceToOrder','connection','AccountLogEntity','name','67123OzMMoC','<\x200','getOwnPropertyDescriptor','CramiPackageEntity','\x20AND\x20al.change_score\x20','getUserById','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','PurchasePackage','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','findOne','userService','11850ENioYF','14993SUnkVq','%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%','userPage','HttpStatus','36ftfcaJ','total','AccountVipLogEntity','EChangeType','4488681QLXZrn','increase','phone','../crami/cramiPackage.entity','ids','score','%\x27\x20)','changeScore4Other','function','getReqSaasId','15091668DSlXfc','\x20AND\x20al.userId\x20=\x20','nestjs-cls','clsService','metadata','充值失败！','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.raw_score\x20AS\x20rawScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.new_score\x20AS\x20newScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_score\x20AS\x20changeScore,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.change_type\x20AS\x20changeType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.relate_id\x20AS\x20relateId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.rebate_user_id\x20AS\x20rebateUserId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.del_flag\x20AS\x20delFlag,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20account_log\x20al\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20al.userId\x20=\x20u.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','HttpException','deleteAccountLog','accountLogEntity','4TxqLxp','salesService','../sales/salesUsers.entity','\x20OFFSET\x20','save','object','BAD_REQUEST','40GYCCGb','2379879oCpSHG','salesUsersEntity','__esModule','invitedBy','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','__param','defineProperty','updateVipExpire','InjectRepository','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20al.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20LIMIT\x20','commissionAmount','\x20AND\x20al.change_type\x20=\x20','UserService','isSuper','26fcjpRj','decorate','>\x200','accountVipLogEntity','2sNStWV'];_0x3015=function(){return _0x3ba592;};return _0x3015();}const typeorm_1=require(_0x3d2cb1(0x19a)),common_1=require(_0x3d2cb1(0x18e)),typeorm_2=require('typeorm'),balance_constant_1=require(_0x3d2cb1(0x18b)),accountLog_entity_1=require(_0x3d2cb1(0x17e)),cramiPackage_entity_1=require(_0x3d2cb1(0x152)),salesUsers_entity_1=require(_0x3d2cb1(0x165)),sales_service_1=require(_0x3d2cb1(0x19b)),user_service_1=require(_0x3d2cb1(0x17f)),accountVipLog_entity_1=require('./accountVipLog.entity'),utils_1=require(_0x3d2cb1(0x18d)),nestjs_cls_1=require(_0x3d2cb1(0x15b));let UserBalanceService=class UserBalanceService{constructor(_0x578c0b,_0x4422cd,_0x287daf,_0x17cb52,_0x7f0e3b,_0x106531,_0x2ee885,_0x3d9ca4){const _0x2fb9e6=_0x3d2cb1;this['accountLogEntity']=_0x578c0b,this['accountVipLogEntity']=_0x4422cd,this[_0x2fb9e6(0x19e)]=_0x287daf,this[_0x2fb9e6(0x16c)]=_0x17cb52,this[_0x2fb9e6(0x145)]=_0x7f0e3b,this['salesService']=_0x106531,this[_0x2fb9e6(0x15c)]=_0x2ee885,this['connection']=_0x3d9ca4;}async[_0x3d2cb1(0x1a0)](_0x3783dd){const _0x20ff12=_0x3d2cb1;console[_0x20ff12(0x187)]('充值的订单信息:',_0x3783dd);try{const {userId:_0x2ca100,goodsId:_0x2f1217}=_0x3783dd,_0x5063aa=await this[_0x20ff12(0x19e)][_0x20ff12(0x144)]({'where':{'id':_0x2f1217,'status':0x1}});if(!_0x5063aa)throw new common_1[(_0x20ff12(0x160))](_0x20ff12(0x181),common_1[_0x20ff12(0x14a)][_0x20ff12(0x169)]);const _0x3a945d=await this[_0x20ff12(0x145)][_0x20ff12(0x1a9)](_0x2ca100);_0x5063aa[_0x20ff12(0x154)]>0x0&&await this['userService'][_0x20ff12(0x156)](_0x3a945d,balance_constant_1[_0x20ff12(0x14e)][_0x20ff12(0x1ab)],_0x5063aa[_0x20ff12(0x154)],_0x20ff12(0x190)+_0x5063aa['name'],_0x5063aa['id']);_0x5063aa['days']!==0x0&&await this[_0x20ff12(0x145)][_0x20ff12(0x172)](_0x3a945d,balance_constant_1[_0x20ff12(0x14e)][_0x20ff12(0x1ab)],_0x5063aa['days'],'购买套餐:\x20'+_0x5063aa[_0x20ff12(0x1a3)],_0x5063aa['id']);if(_0x3a945d[_0x20ff12(0x16e)]){const _0xad94ae=await this[_0x20ff12(0x145)]['getUserByInviteCode'](_0x3a945d[_0x20ff12(0x16e)]);if(!_0xad94ae)return;const _0x559e34=await this['salesUsersEntity'][_0x20ff12(0x144)]({'where':{'userId':_0xad94ae['id']}}),{id:_0x507f01}=_0xad94ae,{performanceRatio:_0x32f499}=_0x559e34,_0x3d1d54={'inviterUserId':_0x507f01,'inviteeUserId':_0x2ca100,'orderId':_0x3783dd['id'],'orderPrice':_0x3783dd[_0x20ff12(0x14c)],'commissionPercentage':_0x32f499,'commissionAmount':(_0x3783dd[_0x20ff12(0x14c)]*_0x32f499/0x64)['toFixed'](0x2)};await this['salesService']['createSalesRecords'](_0x3d1d54),await this[_0x20ff12(0x164)]['saveCommissionAmount'](_0x507f01,_0x3d1d54[_0x20ff12(0x175)]);}}catch(_0x57eddd){console[_0x20ff12(0x187)](_0x20ff12(0x198),_0x57eddd);throw new common_1[(_0x20ff12(0x160))](_0x20ff12(0x15e),common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x3d2cb1(0x149)](_0x8bae7d,_0x55958f,_0x4fe020){const _0x5bbe91=_0x3d2cb1,_0x1ebe17=(0x0,utils_1[_0x5bbe91(0x158)])(this[_0x5bbe91(0x15c)]),{page:page=0x1,size:size=0x14,startTime:_0x146e3e,endTime:_0x3a2088,keyword:_0x3c04d3,saasId:_0x28bcc1,changeType:_0x379f9d,creaseType:_0x4fe866}=_0x55958f;let _0x333cf5=_0x5bbe91(0x1aa)+(_0x4fe020?_0x5bbe91(0x15a)+_0x4fe020:'')+_0x5bbe91(0x1ac)+(_0x379f9d?_0x5bbe91(0x176)+_0x379f9d:'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x4fe866?_0x5bbe91(0x1a8)+(_0x4fe866===_0x5bbe91(0x150)?_0x5bbe91(0x17b):_0x5bbe91(0x1a5)):'')+_0x5bbe91(0x1ac)+(_0x146e3e?_0x5bbe91(0x19f)+_0x146e3e+'\x27':'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x3a2088?_0x5bbe91(0x196)+_0x3a2088+'\x27':'')+_0x5bbe91(0x1ac)+(_0x3c04d3?_0x5bbe91(0x197)+_0x3c04d3+_0x5bbe91(0x18c)+_0x3c04d3+_0x5bbe91(0x148)+_0x3c04d3+_0x5bbe91(0x16f)+_0x3c04d3+_0x5bbe91(0x155):'')+_0x5bbe91(0x192);(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1[_0x5bbe91(0x189)])(this[_0x5bbe91(0x15c)])&&_0x28bcc1&&(_0x333cf5=_0x333cf5+('\x20AND\x20al.saasId\x20=\x20'+_0x28bcc1)):_0x333cf5=_0x333cf5+('\x20AND\x20al.saasId\x20=\x20'+_0x1ebe17);const _0x206537=_0x5bbe91(0x182)+_0x333cf5+'\x0a\x20\x20\x20\x20',_0x21f9e2=_0x5bbe91(0x15f)+_0x333cf5+_0x5bbe91(0x174)+size+_0x5bbe91(0x166)+(page-0x1)*size+'\x0a\x20\x20\x20\x20',_0x30da07=await this[_0x5bbe91(0x1a1)][_0x5bbe91(0x184)](_0x206537),_0x12279b=await this[_0x5bbe91(0x1a1)]['query'](_0x21f9e2);return!(0x0,utils_1[_0x5bbe91(0x178)])(this[_0x5bbe91(0x15c)])&&_0x12279b['forEach'](_0x41aaf7=>{const _0x122263=_0x5bbe91;_0x41aaf7[_0x122263(0x186)]=(0x0,utils_1[_0x122263(0x18f)])(_0x41aaf7['email']),_0x41aaf7[_0x122263(0x151)]=(0x0,utils_1['maskEmail'])(_0x41aaf7[_0x122263(0x151)]);}),{'rows':_0x12279b,'count':Number(_0x30da07[0x0]?.['count']||0x0)};}async['myPage'](_0x13335b,_0x5c5f6c){const _0x59b981=_0x3d2cb1;return this[_0x59b981(0x149)](_0x13335b,_0x5c5f6c,_0x13335b['user']['id']);}async[_0x3d2cb1(0x161)](_0x419932){const _0x48d705=_0x3d2cb1;if(!_0x419932[_0x48d705(0x153)]['length'])return!![];return await this[_0x48d705(0x162)][_0x48d705(0x183)]({'id':(0x0,typeorm_2['In'])(_0x419932[_0x48d705(0x153)])},{'delFlag':0x1}),!![];}async[_0x3d2cb1(0x19d)](_0x32e74e){const _0x404577=_0x3d2cb1,_0x12e8e3=(0x0,utils_1[_0x404577(0x158)])(this[_0x404577(0x15c)]);await this[_0x404577(0x162)][_0x404577(0x167)]({..._0x32e74e,'saasId':_0x12e8e3});}async['insertAccountVipLog'](_0x3d78c8){const _0x239f55=_0x3d2cb1;await this[_0x239f55(0x17c)][_0x239f55(0x167)](_0x3d78c8);}};UserBalanceService=__decorate([(0x0,common_1[_0x3d2cb1(0x19c)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(accountLog_entity_1[_0x3d2cb1(0x1a2)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(accountVipLog_entity_1[_0x3d2cb1(0x14d)])),__param(0x2,(0x0,typeorm_1[_0x3d2cb1(0x173)])(cramiPackage_entity_1[_0x3d2cb1(0x1a7)])),__param(0x3,(0x0,typeorm_1[_0x3d2cb1(0x173)])(salesUsers_entity_1['SalesUsersEntity'])),__param(0x4,(0x0,common_1[_0x3d2cb1(0x194)])((0x0,common_1[_0x3d2cb1(0x193)])(()=>user_service_1[_0x3d2cb1(0x177)]))),__metadata('design:paramtypes',[typeorm_2[_0x3d2cb1(0x185)],typeorm_2[_0x3d2cb1(0x185)],typeorm_2[_0x3d2cb1(0x185)],typeorm_2[_0x3d2cb1(0x185)],user_service_1[_0x3d2cb1(0x177)],sales_service_1['SalesService'],nestjs_cls_1['ClsService'],typeorm_2[_0x3d2cb1(0x188)]])],UserBalanceService),exports['UserBalanceService']=UserBalanceService;