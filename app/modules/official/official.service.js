'use strict';const _0x5b9790=_0x238d;(function(_0x1ad0f0,_0x25f42a){const _0x44208d=_0x238d,_0x437cea=_0x1ad0f0();while(!![]){try{const _0x265b80=parseInt(_0x44208d(0xaf))/0x1*(parseInt(_0x44208d(0xc0))/0x2)+parseInt(_0x44208d(0x94))/0x3+-parseInt(_0x44208d(0x85))/0x4*(-parseInt(_0x44208d(0xa8))/0x5)+parseInt(_0x44208d(0xc3))/0x6+-parseInt(_0x44208d(0x8f))/0x7+parseInt(_0x44208d(0xd5))/0x8+-parseInt(_0x44208d(0xb5))/0x9;if(_0x265b80===_0x25f42a)break;else _0x437cea['push'](_0x437cea['shift']());}catch(_0x619ad7){_0x437cea['push'](_0x437cea['shift']());}}}(_0x22df,0xecfe3));var __decorate=this&&this['__decorate']||function(_0x7807a4,_0x2b332b,_0x306ecf,_0x33242f){const _0x483695=_0x238d;var _0x27ed2a=arguments[_0x483695(0x89)],_0x53102a=_0x27ed2a<0x3?_0x2b332b:_0x33242f===null?_0x33242f=Object[_0x483695(0xd6)](_0x2b332b,_0x306ecf):_0x33242f,_0x17bbba;if(typeof Reflect===_0x483695(0x75)&&typeof Reflect[_0x483695(0x86)]===_0x483695(0xb7))_0x53102a=Reflect[_0x483695(0x86)](_0x7807a4,_0x2b332b,_0x306ecf,_0x33242f);else{for(var _0x453ea5=_0x7807a4[_0x483695(0x89)]-0x1;_0x453ea5>=0x0;_0x453ea5--)if(_0x17bbba=_0x7807a4[_0x453ea5])_0x53102a=(_0x27ed2a<0x3?_0x17bbba(_0x53102a):_0x27ed2a>0x3?_0x17bbba(_0x2b332b,_0x306ecf,_0x53102a):_0x17bbba(_0x2b332b,_0x306ecf))||_0x53102a;}return _0x27ed2a>0x3&&_0x53102a&&Object[_0x483695(0xa1)](_0x2b332b,_0x306ecf,_0x53102a),_0x53102a;},__metadata=this&&this[_0x5b9790(0x78)]||function(_0x1ceb31,_0x24cd17){const _0x4cfb6f=_0x5b9790;if(typeof Reflect==='object'&&typeof Reflect[_0x4cfb6f(0xab)]===_0x4cfb6f(0xb7))return Reflect[_0x4cfb6f(0xab)](_0x1ceb31,_0x24cd17);};Object['defineProperty'](exports,'__esModule',{'value':!![]}),exports[_0x5b9790(0x9d)]=void 0x0;const globalConfig_service_1=require('./../globalConfig/globalConfig.service'),auth_service_1=require(_0x5b9790(0x7d)),user_service_1=require(_0x5b9790(0x8d)),autoreply_service_1=require(_0x5b9790(0xbe)),common_1=require(_0x5b9790(0x73)),crypto=require(_0x5b9790(0x98)),axios_1=require(_0x5b9790(0xba)),utils_1=require(_0x5b9790(0xd1)),Login_vo_1=require(_0x5b9790(0xca)),redisKey_constant_1=require(_0x5b9790(0x82)),redisCache_service_1=require('../redisCache/redisCache.service'),date_1=require('../../common/utils/date');let OfficialService=class OfficialService{constructor(_0x33bd1b,_0x14b36d,_0x25b3d4,_0x5f58b1,_0x272b3d){const _0x48f4a5=_0x5b9790;this['autoreplyService']=_0x33bd1b,this[_0x48f4a5(0xc8)]=_0x14b36d,this['authService']=_0x25b3d4,this['globalConfigService']=_0x5f58b1,this[_0x48f4a5(0xc4)]=_0x272b3d,this[_0x48f4a5(0xcd)]={},this['scanedSceneStrMap']={};}async['getQRSceneStr'](_0x30ca1e){const {invitedBy:_0x4b1fec}=_0x30ca1e;let _0x3d6e27=(0x0,utils_1['createRandomNonceStr'])(0x20);return _0x4b1fec&&(_0x3d6e27+=':'+_0x4b1fec),this['sceneStrMap'][_0x3d6e27]=!![],_0x3d6e27;}async[_0x5b9790(0xb8)](_0x4b93fc){const _0x469702=_0x5b9790,{id:_0x5d8d71}=_0x4b93fc[_0x469702(0xc7)],_0x232327=(0x0,utils_1['createRandomNonceStr'])(0x20)+'/'+_0x5d8d71;return this['sceneStrMap'][_0x232327]=!![],_0x232327;}async['getQRCodeTicket'](_0x162a48){const _0xd4b588=_0x5b9790;return this[_0xd4b588(0x9c)](_0x162a48);}async[_0x5b9790(0xbb)](_0x435221){const _0x563c5a=_0x5b9790,_0x4dfe7b=await this['globalConfigService']['getConfigByKeys'](['wechatOfficialAppId']),_0x271fd1=_0x563c5a(0x7f)+_0x4dfe7b+_0x563c5a(0xc2)+encodeURIComponent(_0x435221)+_0x563c5a(0x91);return console[_0x563c5a(0xda)]('回跳跳转地址:\x20',_0x271fd1),_0x271fd1;}async[_0x5b9790(0xb0)](_0x4acba7){const _0x1121fd=_0x5b9790,_0x35acd0=(0x0,utils_1[_0x1121fd(0x9f)])(0x20),_0x5b4bde=(Date[_0x1121fd(0x88)]()/0x3e8)[_0x1121fd(0x7b)](0x0),_0x8e8695=await this[_0x1121fd(0xad)][_0x1121fd(0xdc)]([_0x1121fd(0x84),_0x1121fd(0xd0)]),{wechatJsapiTicket:_0x455f60,wechatOfficialAppId:_0x3cdd8e}=_0x8e8695;console[_0x1121fd(0xda)](_0x1121fd(0xb2),_0x455f60),console[_0x1121fd(0xda)](_0x1121fd(0xa7),_0x3cdd8e);const _0x20fff1='jsapi_ticket='+_0x455f60+_0x1121fd(0xd4)+_0x35acd0+_0x1121fd(0xb9)+_0x5b4bde+'&url='+_0x4acba7;console['log'](_0x1121fd(0x7c),_0x20fff1);const _0x610b37=this[_0x1121fd(0xc5)](_0x20fff1);return{'appId':_0x3cdd8e,'nonceStr':_0x35acd0,'timestamp':_0x5b4bde,'signature':_0x610b37};}async[_0x5b9790(0x9c)](_0x337fea){const _0x2fa7ac=_0x5b9790,_0x1b0a3b=await this[_0x2fa7ac(0xad)][_0x2fa7ac(0xdc)]([_0x2fa7ac(0xc1)]),_0x32fada={'action_name':_0x2fa7ac(0x93),'action_info':{'scene':{'scene_str':_0x337fea}}},_0x17260f=await axios_1[_0x2fa7ac(0x92)][_0x2fa7ac(0x74)](_0x2fa7ac(0xd7)+_0x1b0a3b,_0x32fada),{data:{errmsg:_0x344536,ticket:_0x42a768}}=_0x17260f;if(_0x344536)throw new common_1[(_0x2fa7ac(0xa2))](_0x344536,common_1['HttpStatus'][_0x2fa7ac(0x79)]);return _0x42a768;}async[_0x5b9790(0xa6)](_0x4eac98,_0x1157fd){const _0x381d8b=_0x5b9790,_0x56358e=await this[_0x381d8b(0xad)][_0x381d8b(0xdc)]([_0x381d8b(0xd0),'wechatOfficialAppSecret']),{wechatOfficialAppId:_0x3cbd28,wechatOfficialAppSecret:_0x206ded}=_0x56358e,_0x31d828=await axios_1['default'][_0x381d8b(0xb1)](_0x381d8b(0x8e)+_0x3cbd28+_0x381d8b(0xcc)+_0x206ded+_0x381d8b(0xdb)+_0x1157fd+_0x381d8b(0xc9)),{data:{errmsg:_0x1b5577,openid:_0x1cb12f,access_token:_0x5c3439}}=_0x31d828;if(_0x1b5577)throw new common_1['HttpException'](_0x1b5577,common_1[_0x381d8b(0xcf)]['BAD_REQUEST']);let _0x25a4de=new Login_vo_1[(_0x381d8b(0x97))]();_0x25a4de[_0x381d8b(0xd3)]=_0x1cb12f;const _0x6c1708=await this[_0x381d8b(0xc8)]['getUserOpenId'](_0x1cb12f);if(_0x6c1708)_0x25a4de[_0x381d8b(0x9a)]=await this[_0x381d8b(0x87)][_0x381d8b(0xcb)](_0x6c1708,_0x4eac98);else{if(_0x5c3439){const {data:_0xd4afcf}=await axios_1[_0x381d8b(0x92)]['get'](_0x381d8b(0xbc)+_0x5c3439+_0x381d8b(0xbf)+_0x1cb12f+_0x381d8b(0x96));!_0xd4afcf[_0x381d8b(0xa5)]&&console[_0x381d8b(0x8a)](_0xd4afcf[_0x381d8b(0xa5)]),_0x25a4de[_0x381d8b(0x83)]=_0xd4afcf;}}return _0x25a4de;}async['scan'](_0x2940e2,_0x1a6d6f){const _0x2472ca=_0x5b9790;if(!this[_0x2472ca(0xcd)][_0x1a6d6f])throw new common_1['HttpException'](_0x2472ca(0xa4),common_1[_0x2472ca(0xcf)]['BAD_REQUEST']);this[_0x2472ca(0xaa)][_0x1a6d6f]=_0x2940e2;}async['loginBySceneStr'](_0x56fb92,_0x34c800){const _0x3492bb=_0x5b9790;if(!this[_0x3492bb(0xcd)][_0x34c800])return;const _0x2edccc=this['scanedSceneStrMap'][_0x34c800];if(!_0x2edccc)return new Login_vo_1[(_0x3492bb(0x97))]();let _0x1f4281=new Login_vo_1[(_0x3492bb(0x97))]();_0x1f4281['openId']=_0x2edccc;const _0x436845=await this[_0x3492bb(0xc8)][_0x3492bb(0x7a)](_0x2edccc);return _0x436845&&(_0x1f4281[_0x3492bb(0x9a)]=await this[_0x3492bb(0x87)][_0x3492bb(0xcb)](_0x436845,_0x56fb92)),delete this[_0x3492bb(0xaa)][_0x34c800],_0x1f4281;}async[_0x5b9790(0xb6)](_0x3de706,_0x3cd090){const _0x41a238=_0x5b9790;if(!this[_0x41a238(0xcd)][_0x3cd090])throw new common_1[(_0x41a238(0xa2))](_0x41a238(0xa4),common_1[_0x41a238(0xcf)][_0x41a238(0x79)]);const _0x326ed4=_0x3cd090[_0x41a238(0x90)]('/')[0x1],_0x4b6849=await this[_0x41a238(0xc8)][_0x41a238(0xd2)](_0x3de706,_0x326ed4);this[_0x41a238(0xaa)][_0x3cd090]=_0x4b6849;}async[_0x5b9790(0xb3)](_0x2ac918,_0x517f9e){const _0x2cd37b=_0x5b9790;if(!this[_0x2cd37b(0xcd)][_0x517f9e])throw new common_1['HttpException']('非法参数',common_1['HttpStatus']['BAD_REQUEST']);const {id:_0x287866}=_0x2ac918[_0x2cd37b(0xc7)],_0x41d16a=this[_0x2cd37b(0xaa)][_0x517f9e];if(!_0x41d16a)return'';return delete this[_0x2cd37b(0xaa)][_0x517f9e],_0x41d16a;}async['verify'](_0x528866,_0x3eb74c,_0x4ac3c9){const _0x5ef261=_0x5b9790,_0x477b5b=await this[_0x5ef261(0xad)][_0x5ef261(0xdc)]([_0x5ef261(0xd9)]),_0x5957cd=_0x477b5b||_0x5ef261(0x99);return await this[_0x5ef261(0xc5)]([_0x5957cd,_0x3eb74c,_0x4ac3c9]['sort']()['join'](''))==_0x528866;}['sha1'](_0x715b7){const _0x587d68=_0x5b9790;return crypto[_0x587d68(0x8b)](_0x587d68(0xc5))['update'](_0x715b7)[_0x587d68(0xce)](_0x587d68(0xbd));}async[_0x5b9790(0x7e)](_0x39297e,_0x34436b){const _0x281db0=_0x5b9790,_0x234822=await this[_0x281db0(0xad)][_0x281db0(0xdc)]([_0x34436b]);return this[_0x281db0(0x9b)](_0x39297e,_0x234822);}async[_0x5b9790(0x9b)](_0x165780,_0x3a9c96){const _0x55f736=_0x5b9790;return _0x55f736(0xa0)+_0x165780[_0x55f736(0xa9)][0x0]+']]></ToUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<FromUserName><![CDATA['+_0x165780[_0x55f736(0x95)][0x0]+']]></FromUserName>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<CreateTime>'+(0x0,date_1[_0x55f736(0x92)])()[_0x55f736(0xb4)]()+_0x55f736(0x76)+_0x3a9c96+']]></Content>\x0a\x20\x20\x20\x20</xml>';}async[_0x5b9790(0xa3)](_0xb5fe31){const _0x3755e8=_0x5b9790;let _0x4587aa=await this[_0x3755e8(0xae)]['checkAutoReply'](_0xb5fe31);if(!_0x4587aa){const _0x5e855a=await this['globalConfigService']['getConfigByKeys'](['officialAutoReplyText']);_0x4587aa=_0x5e855a;}return _0x4587aa;}async[_0x5b9790(0x80)](_0x2c6c90,_0x885cab){const _0x55f855=_0x5b9790;console[_0x55f855(0xda)](_0x2c6c90['ip']);if(_0x885cab===_0x55f855(0x81)){const _0x14fb12=await this[_0x55f855(0xad)][_0x55f855(0xdc)]([_0x55f855(0xc1)]);return _0x14fb12;}else{if(_0x885cab===_0x55f855(0xac)){const _0x5bb66c=await this[_0x55f855(0xc4)][_0x55f855(0xb1)]({'key':redisKey_constant_1[_0x55f855(0x8c)]});return _0x5bb66c;}else throw new common_1[(_0x55f855(0xa2))](null,common_1[_0x55f855(0xcf)][_0x55f855(0x79)]);}}};function _0x238d(_0x5941d7,_0xa20488){const _0x22dfe4=_0x22df();return _0x238d=function(_0x238d13,_0x51f337){_0x238d13=_0x238d13-0x73;let _0x35fde2=_0x22dfe4[_0x238d13];return _0x35fde2;},_0x238d(_0x5941d7,_0xa20488);}function _0x22df(){const _0x47e31a=['fetchQRCodeTicket','OfficialService','GlobalConfigService','createRandomNonceStr','\x0a\x20\x20\x20\x20<xml>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<ToUserName><![CDATA[','defineProperty','HttpException','aotoPlay','非法参数','errmsg','loginByCode','appId:\x20','21165GVTxGx','fromusername','scanedSceneStrMap','metadata','mini','globalConfigService','autoreplyService','175846YxlCYe','getJsapiTicket','get','jsapiTicket:\x20','bindWxBySceneStr','valueOf','17493426onbMxS','scanBindWx','function','getQRSceneStrByBind','&timestamp=','axios','getRedirectUrl','\x0a\x20\x20\x20\x20\x20\x20\x20\x20https://api.weixin.qq.com/sns/userinfo?access_token=','hex','./../autoreply/autoreply.service','&openid=','2tLpyRh','wechatAccessToken','&redirect_uri=','1479666OSRQpf','redisCacheService','sha1','Injectable','user','userService','&grant_type=authorization_code','./vo/Login.vo','getJwtToken','&secret=','sceneStrMap','digest','HttpStatus','wechatOfficialAppId','../../common/utils','bindWx','openId','&noncestr=','13746760AbHJzF','getOwnPropertyDescriptor','https://api.weixin.qq.com/cgi-bin/qrcode/create?access_token=','UserService','wechatOfficialToken','log','&code=','getConfigByKeys','@nestjs/common','post','object','</CreateTime>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<MsgType><![CDATA[text]]></MsgType>\x0a\x20\x20\x20\x20\x20\x20\x20\x20<Content><![CDATA[','AuthService','__metadata','BAD_REQUEST','getUserOpenId','toFixed','str:\x20','./../auth/auth.service','genXmlMsgByConfig','https://open.weixin.qq.com/connect/oauth2/authorize?appid=','getAccessToken','official','../../common/constants/redisKey.constant','wechatUser','wechatJsapiTicket','236gWxgyH','decorate','authService','now','length','error','createHash','WE_MINI_ACCESS_KEY','./../user/user.service','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','475832xvSyXl','split','&response_type=code&scope=snsapi_base&state=weChatLogin#wechat_redirect','default','QR_STR_SCENE','1775592sMLDSl','tousername','&lang=zh_CN','OfficialLoginVO','crypto','jiangly','authToken','genXmlMsg'];_0x22df=function(){return _0x47e31a;};return _0x22df();}OfficialService=__decorate([(0x0,common_1[_0x5b9790(0xc6)])(),__metadata('design:paramtypes',[autoreply_service_1['AutoreplyService'],user_service_1[_0x5b9790(0xd8)],auth_service_1[_0x5b9790(0x77)],globalConfig_service_1[_0x5b9790(0x9e)],redisCache_service_1['RedisCacheService']])],OfficialService),exports[_0x5b9790(0x9d)]=OfficialService;