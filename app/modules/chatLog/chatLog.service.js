'use strict';const _0x54b563=_0x1b4b;(function(_0x526f97,_0x314280){const _0x1dfcea=_0x1b4b,_0xa850ac=_0x526f97();while(!![]){try{const _0x2e43c3=-parseInt(_0x1dfcea(0x13b))/0x1+-parseInt(_0x1dfcea(0x104))/0x2*(-parseInt(_0x1dfcea(0x17c))/0x3)+parseInt(_0x1dfcea(0x134))/0x4+parseInt(_0x1dfcea(0x114))/0x5+parseInt(_0x1dfcea(0x18e))/0x6+parseInt(_0x1dfcea(0x19c))/0x7*(parseInt(_0x1dfcea(0x160))/0x8)+-parseInt(_0x1dfcea(0x182))/0x9;if(_0x2e43c3===_0x314280)break;else _0xa850ac['push'](_0xa850ac['shift']());}catch(_0x29b235){_0xa850ac['push'](_0xa850ac['shift']());}}}(_0x1030,0x3a084));var __decorate=this&&this[_0x54b563(0x1a1)]||function(_0x19da05,_0x4641ac,_0x5734fd,_0x33e157){const _0x2d2607=_0x54b563;var _0x32eca6=arguments[_0x2d2607(0x11b)],_0x528de3=_0x32eca6<0x3?_0x4641ac:_0x33e157===null?_0x33e157=Object['getOwnPropertyDescriptor'](_0x4641ac,_0x5734fd):_0x33e157,_0xe6a55b;if(typeof Reflect==='object'&&typeof Reflect[_0x2d2607(0x178)]===_0x2d2607(0x112))_0x528de3=Reflect['decorate'](_0x19da05,_0x4641ac,_0x5734fd,_0x33e157);else{for(var _0x1e4801=_0x19da05[_0x2d2607(0x11b)]-0x1;_0x1e4801>=0x0;_0x1e4801--)if(_0xe6a55b=_0x19da05[_0x1e4801])_0x528de3=(_0x32eca6<0x3?_0xe6a55b(_0x528de3):_0x32eca6>0x3?_0xe6a55b(_0x4641ac,_0x5734fd,_0x528de3):_0xe6a55b(_0x4641ac,_0x5734fd))||_0x528de3;}return _0x32eca6>0x3&&_0x528de3&&Object[_0x2d2607(0x111)](_0x4641ac,_0x5734fd,_0x528de3),_0x528de3;},__metadata=this&&this['__metadata']||function(_0x180f38,_0x187841){const _0x44499e=_0x54b563;if(typeof Reflect===_0x44499e(0x132)&&typeof Reflect['metadata']===_0x44499e(0x112))return Reflect[_0x44499e(0x1bc)](_0x180f38,_0x187841);},__param=this&&this[_0x54b563(0x189)]||function(_0x3a8f48,_0x3d47e5){return function(_0x1e1fba,_0x29f6a3){_0x3d47e5(_0x1e1fba,_0x29f6a3,_0x3a8f48);};};Object[_0x54b563(0x111)](exports,_0x54b563(0x1ad),{'value':!![]}),exports[_0x54b563(0x13a)]=void 0x0;function _0x1b4b(_0x1fa8cf,_0x396ba3){const _0x1030c3=_0x1030();return _0x1b4b=function(_0x1b4b7d,_0x5b8865){_0x1b4b7d=_0x1b4b7d-0xfd;let _0x5a3ca6=_0x1030c3[_0x1b4b7d];return _0x5a3ca6;},_0x1b4b(_0x1fa8cf,_0x396ba3);}function _0x1030(){const _0x3d851b=['find','AND\x20aa.title\x20LIKE\x20(\x27%','DESC','__decorate','components','agreeNum','你推荐的图片不存在、请检查！','PAINT_TYPE','save','tencent','type','你操作的图片不存在、请检查！','###🎵\x20歌曲名','%storage.cdn-luma.com%','取消推荐','__esModule','AiAssetsEntity','parseAndSaveVideo','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','/q/55','?x-oss-process=image/resize,w_','\x20AND\x20id\x20IN\x20(','join','\x0a\x20\x20\x20\x20\x20\x20','deleteChatLog','gpts','transferAndCover','cos','substring','解析错误','metadata','Like','removeLogsBatch','isDefined','includes','state','findOne','listByGroupId','fileService','message','url','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','206398RBCVSA','getUserId','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','删除对话记录成功！','chatList','delByGroupId','aiAssetsEntity','listByIds','图片成功！','FileService','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','paintCount','redisCacheService','defineProperty','function','forEach','461605BuiPzk','**歌词：**','findAndCount','set','parse','catch','affected','length','ids','assetsDel','Injectable','listUndoneVideo','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','extend','isPlatform','你删除的对话记录不存在、请检查！','querAllChatLog','../../common/utils','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','push','query','del','aa.createdAt','luma通知：','?imageView2/1/w/','listAssetsBychatLogIds','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','byAppId','Not','chatLogId','object','Request\x20failed','1113320XFVvvo','mp4','visitNum','\x20\x0a\x20\x20\x20\x20','delete','email','ChatLogService','259196hBrOey','user','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','playNum','maskEmail','videoNotify','ale.agree_num','：**','@nestjs/common','completed','log','ali','connection','InjectRepository','startsWith','assistant','RedisCacheService','parseAndSaveMusic','match','replace','test','AiLogService','DeductionKey','getAgreeMap','rec','transferFile','\x0a\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','chatLogEntity','has','isGroup','音乐生成错误：','**版本ID','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','BAD_REQUEST','getMusicVoMap','aiLogService','10616zDjRAO','size','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','MUSIC_TRANSFER','syncAssets','syncVideo','agree','当前页面已经没有东西可以删除了！','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','formatDate','assign','资源不存在！','isDelete\x20=\x200','chatTaskLog','answer','nestjs-cls','mp3','lock','./aiAssets.entity','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','indexOf','cover','page','decorate','transaction','clsService','ale.play_num','9cCkKWh','design:paramtypes','assetsPublish','chatGptsList','update','userId','4163481iFYzZb','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','HttpException','split','%filesystem.site%','error','map','__param','%\x27)','../aiLog/aiLog.service','filter','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20','1667580VZBslA','model','assetsSquare','get','phone','count','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','querAllDrawLog','@nestjs/typeorm','```','../redisCache/redisCache.service','getExtByRelate',')\x0a\x20\x20\x20\x20','HttpStatus','7jPaOyp','video'];_0x1030=function(){return _0x3d851b;};return _0x1030();}const common_1=require(_0x54b563(0x143)),typeorm_1=require(_0x54b563(0x196)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require('typeorm'),balance_constant_1=require('../../common/constants/balance.constant'),utils_1=require(_0x54b563(0x125)),file_service_1=require('../file/file.service'),redisCache_service_1=require(_0x54b563(0x198)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),aiAssets_entity_1=require(_0x54b563(0x173)),aiLog_service_1=require(_0x54b563(0x18b)),nestjs_cls_1=require(_0x54b563(0x170)),class_validator_1=require('class-validator');let ChatLogService=class ChatLogService{constructor(_0x5c3476,_0x180b61,_0xca630,_0x47eb02,_0x2d7a62,_0x1b53de,_0xd5df33){const _0x3be182=_0x54b563;this[_0x3be182(0x157)]=_0x5c3476,this[_0x3be182(0x10a)]=_0x180b61,this[_0x3be182(0x17a)]=_0xca630,this[_0x3be182(0x100)]=_0x47eb02,this[_0x3be182(0x15f)]=_0x2d7a62,this[_0x3be182(0x110)]=_0x1b53de,this['connection']=_0xd5df33;}async['saveChatLog'](_0x2d407f){const _0x4b6048=_0x54b563;return await this[_0x4b6048(0x157)]['save'](_0x2d407f);}async[_0x54b563(0x14c)](_0x585c19){const _0x29276d=_0x54b563,_0x259d28=_0x585c19[_0x29276d(0x16f)];let _0x39387c={},_0x40907c={};if(_0x259d28['indexOf'](_0x29276d(0x133))!=-0x1)throw new Error(_0x29276d(0x15a)+_0x259d28);else{let _0x3e3412='',_0x3f27ce='',_0x16410b=_0x29276d(0x1bb),_0x13cfcd='解析错误',_0x43f83a='解析错误',_0x76933e=_0x29276d(0x1bb),_0x5de165=_0x29276d(0x1bb),_0x289888=_0x29276d(0x1bb),_0x24b120='解析错误',_0x38c26e=_0x29276d(0x1bb);if(_0x259d28['startsWith']('####')){const [_0x4c24e8]=_0x259d28[_0x29276d(0x14d)](/>(\S+)\n/g);_0x3e3412=_0x3f27ce=_0x4c24e8[_0x29276d(0x1ba)](0x1,_0x4c24e8[_0x29276d(0x11b)]-0x1),_0x16410b=_0x259d28['split']('\x0a')[0x0]['substring'](0x7),_0x13cfcd=_0x259d28[_0x29276d(0x185)]('---')[0x1]['replace'](/\[.*\]|（.*）/g,'')['replace'](/\n+/g,'\x0a');const _0xd10d4b=_0x259d28[_0x29276d(0x14d)](/!\[image\].*\)/g);_0xd10d4b&&([_0x43f83a,_0x76933e]=_0xd10d4b['map'](_0x532d37=>_0x532d37[_0x29276d(0x1ba)](0x9,_0x532d37[_0x29276d(0x11b)]-0x1)));const _0x280f4c=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp3/g);_0x280f4c&&([_0x5de165,_0x289888]=_0x280f4c);const _0x5cd959=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp4/g);_0x5cd959&&([_0x24b120,_0x38c26e]=_0x5cd959);}else{if(_0x259d28[_0x29276d(0x149)]('🎵')){_0x16410b=_0x259d28[_0x29276d(0x185)]('\x0a')[0x0][_0x29276d(0x14e)](/🎵/g,'');const _0x2f22aa=_0x259d28[_0x29276d(0x185)]('--')[_0x29276d(0x19e)](_0x2b2f1b=>/-\n\n\[/[_0x29276d(0x14f)](_0x2b2f1b));if(_0x2f22aa){const _0x9b1d91=_0x2f22aa['replace'](/\[.*\]|（.*）|-/g,'')['replace'](/\n+/g,'\x0a');_0x9b1d91[_0x29276d(0x149)]('\x0a')?_0x13cfcd=_0x9b1d91[_0x29276d(0x14e)]('\x0a',''):_0x13cfcd=_0x9b1d91;}const _0x261b3e=_0x259d28[_0x29276d(0x14d)](/歌曲id(.+)\n/ig);_0x261b3e&&([_0x3e3412,_0x3f27ce]=_0x261b3e[_0x29276d(0x188)](_0x102756=>_0x102756['substring'](0xc,_0x102756[_0x29276d(0x11b)]-0x1)));const _0x11f1d6=_0x259d28[_0x29276d(0x14d)](/\[封面图片\].*\)/g);_0x11f1d6&&([_0x43f83a,_0x76933e]=_0x11f1d6[_0x29276d(0x188)](_0x5c29ee=>_0x5c29ee[_0x29276d(0x1ba)](0x7,_0x5c29ee[_0x29276d(0x11b)]-0x1)));const _0x38cfca=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp3/g);_0x38cfca&&([_0x5de165,_0x289888]=_0x38cfca);const _0x1228f8=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp4/g);_0x1228f8&&([_0x24b120,_0x38c26e]=_0x1228f8);}else{if(_0x259d28['indexOf']('💄')!=-0x1){let _0x4554c0=_0x259d28[_0x29276d(0x185)]('\x0a');_0x4554c0[_0x29276d(0x113)](_0x4be586=>{const _0x301959=_0x29276d;_0x4be586[_0x301959(0x175)]('🔎')!=-0x1&&(_0x16410b=_0x4be586[_0x301959(0x185)]('：')[0x1]);});const _0x4dd7aa=_0x259d28['split'](_0x29276d(0x197))[0x1]['split']('\x0a');if(_0x4dd7aa){const _0x1e4c55=_0x4dd7aa[_0x29276d(0x18c)](_0xbb8980=>_0xbb8980[_0x29276d(0x175)]('[')==-0x1)[_0x29276d(0x1b4)]('');_0x1e4c55[_0x29276d(0x149)]('\x0a')?_0x13cfcd=_0x1e4c55[_0x29276d(0x14e)]('\x0a',''):_0x13cfcd=_0x1e4c55;}const _0x5d24c5=_0x259d28[_0x29276d(0x14d)](/歌曲id(.+)\n/ig);_0x5d24c5&&([_0x3e3412,_0x3f27ce]=_0x5d24c5[_0x29276d(0x188)](_0x2606a1=>_0x2606a1[_0x29276d(0x1ba)](0xa,_0x2606a1[_0x29276d(0x11b)]-0x1)));const _0x21f3f8=_0x259d28[_0x29276d(0x14d)](/\[封面图片\].*\)/g);_0x21f3f8&&([_0x43f83a,_0x76933e]=_0x21f3f8[_0x29276d(0x188)](_0x2d6348=>_0x2d6348['substring'](0x7,_0x2d6348['length']-0x1)));const _0xac7cbf=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp3/g);_0xac7cbf&&([_0x5de165,_0x289888]=_0xac7cbf);const _0x2fb6df=_0x259d28['match'](/https:\/\/(.*)\.mp4/g);_0x2fb6df&&([_0x24b120,_0x38c26e]=_0x2fb6df);}else{if(_0x259d28[_0x29276d(0x149)]('🎁')){_0x16410b=_0x259d28[_0x29276d(0x185)]('\x0a')[0x2][_0x29276d(0x185)](_0x29276d(0x142))[0x1];const _0xfb1efc=_0x259d28[_0x29276d(0x185)](_0x29276d(0x197))[0x1][_0x29276d(0x185)]('\x0a');if(_0xfb1efc){const _0x1b1af7=_0xfb1efc[_0x29276d(0x18c)](_0x21c585=>_0x21c585[_0x29276d(0x175)]('[')==-0x1)[_0x29276d(0x1b4)]('');_0x1b1af7[_0x29276d(0x149)]('\x0a')?_0x13cfcd=_0x1b1af7[_0x29276d(0x14e)]('\x0a',''):_0x13cfcd=_0x1b1af7;}const _0x235990=_0x259d28[_0x29276d(0x14d)](/歌曲ID：(.+)\n/ig);_0x235990&&([_0x3e3412,_0x3f27ce]=_0x235990['map'](_0x4d105f=>_0x4d105f[_0x29276d(0x1ba)](0x8,_0x4d105f[_0x29276d(0x11b)]-0x1)));const _0x95bce3=_0x259d28['match'](/\[封面\].*\)/g);_0x95bce3&&([_0x43f83a,_0x76933e]=_0x95bce3[_0x29276d(0x188)](_0xbdf35a=>_0xbdf35a[_0x29276d(0x1ba)](0x5,_0xbdf35a['length']-0x1)));const _0x320d6e=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp3/g);_0x320d6e&&([_0x5de165,_0x289888]=_0x320d6e);const _0xe3e5d2=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp4/g);_0xe3e5d2&&([_0x24b120,_0x38c26e]=_0xe3e5d2);}else{if(_0x259d28[_0x29276d(0x175)]('###🎵\x20歌曲名')!==-0x1){let _0x1e82b7=_0x259d28[_0x29276d(0x185)]('\x0a'),_0x290571=![];const _0x335844=[];for(let _0x5aafcb=0x0;_0x5aafcb<_0x1e82b7['length'];_0x5aafcb++){const _0x54f745=_0x1e82b7[_0x5aafcb];_0x54f745[_0x29276d(0x175)](_0x29276d(0x1aa))!==-0x1&&(_0x16410b=_0x54f745[_0x29276d(0x185)]('：\x20')[0x1]);if(_0x54f745[_0x29276d(0x1c0)](_0x29276d(0x15b)))_0x290571=![];else{if(_0x290571&&!_0x54f745['startsWith']('['))_0x335844[_0x29276d(0x127)](_0x54f745);else _0x54f745[_0x29276d(0x1c0)](_0x29276d(0x115))&&(_0x290571=!![]);}}_0x13cfcd=_0x335844[_0x29276d(0x1b4)]('\x20');const _0x525a15=_0x259d28['match'](/版本ID：(.+)\n/ig);_0x525a15&&([_0x3e3412,_0x3f27ce]=_0x525a15['map'](_0x5320a6=>_0x5320a6[_0x29276d(0x1ba)](0xa,_0x5320a6['length']-0x1)));const _0x410835=_0x259d28[_0x29276d(0x14d)](/\[封面\].*\)/g);_0x410835&&([_0x43f83a,_0x76933e]=_0x410835['map'](_0x2f8919=>_0x2f8919[_0x29276d(0x1ba)](0x5,_0x2f8919['length']-0x1)));const _0x4cbe06=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp3/g);_0x4cbe06&&([_0x5de165,_0x289888]=_0x4cbe06);const _0x1029b2=_0x259d28[_0x29276d(0x14d)](/https:\/\/(.*)\.mp4/g);_0x1029b2&&([_0x24b120,_0x38c26e]=_0x1029b2);}else throw new Error('解析错误');}}}}_0x39387c={'title':_0x16410b,'intro':_0x13cfcd,'mp3':_0x5de165,'mp4':_0x24b120,'cover':_0x43f83a,'sunoMusicId':_0x3e3412,'chatLogId':_0x585c19['id'],'userId':_0x585c19['userId']},_0x40907c={'title':_0x16410b,'intro':_0x13cfcd,'mp3':_0x289888,'mp4':_0x38c26e,'cover':_0x76933e,'sunoMusicId':_0x3f27ce,'chatLogId':_0x585c19['id'],'userId':_0x585c19[_0x29276d(0x181)]};}await this[_0x29276d(0x147)][_0x29276d(0x179)](async()=>{const _0x352dec=_0x29276d;await this[_0x352dec(0x10a)][_0x352dec(0x1a6)](_0x39387c),await this[_0x352dec(0x10a)]['save'](_0x40907c);});}async[_0x54b563(0x1af)](_0x34ee2a,_0x558504){const _0x50047a=_0x54b563;let _0x5d0d12={'mp4':_0x558504[_0x50047a(0x19d)]?.[_0x50047a(0x102)],'sunoMusicId':_0x558504['id'],'chatLogId':_0x34ee2a['id'],'userId':_0x34ee2a['userId']};if(_0x558504['id']){const _0x17f9ec=await this[_0x50047a(0x10a)][_0x50047a(0xfe)]({'where':{'sunoMusicId':_0x558504['id']}});_0x17f9ec&&(_0x5d0d12=Object[_0x50047a(0x16b)](_0x17f9ec,_0x5d0d12));}_0x5d0d12=await this[_0x50047a(0x10a)][_0x50047a(0x1a6)](_0x5d0d12),_0x34ee2a[_0x50047a(0x16f)]=_0x558504[_0x50047a(0xfd)],this['chatLogEntity']['save'](_0x34ee2a),_0x558504[_0x50047a(0xfd)]===_0x50047a(0x144)&&_0x5d0d12[_0x50047a(0x135)]&&this[_0x50047a(0x166)](_0x5d0d12);}async['querDrawLog'](_0x4f59b4,_0x26431b){const _0x5e4ffa=_0x54b563,{id:_0x278d96}=_0x4f59b4[_0x5e4ffa(0x13c)],{model:_0x52aedb}=_0x26431b,_0x216bcc={'userId':_0x278d96,'type':balance_constant_1[_0x5e4ffa(0x151)][_0x5e4ffa(0x1a5)]};_0x52aedb&&(_0x216bcc[_0x5e4ffa(0x18f)]=_0x52aedb);const _0x216a8c=await this['chatLogEntity'][_0x5e4ffa(0x19e)]({'where':_0x216bcc,'order':{'id':_0x5e4ffa(0x1a0)}});return _0x216a8c['forEach'](_0x5ad10a=>{const _0x3ed74e=_0x5e4ffa;if(_0x5ad10a[_0x3ed74e(0x1a8)]===_0x3ed74e(0x10f)){const _0x265c66=_0x5ad10a[_0x3ed74e(0x18f)]==='mj'?0x136:0xa0,_0x3a7d02=_0x5ad10a[_0x3ed74e(0x16f)][_0x3ed74e(0x1c0)](_0x3ed74e(0x1b9))?_0x3ed74e(0x1a7):'ali',_0x48ee4e=_0x3a7d02===_0x3ed74e(0x1a7)?_0x3ed74e(0x12c)+_0x265c66+_0x3ed74e(0x1b1):_0x3ed74e(0x1b2)+_0x265c66;_0x5ad10a['thumbImg']=_0x5ad10a[_0x3ed74e(0x16f)]+_0x48ee4e;const _0x4e5b4b=_0x5ad10a[_0x3ed74e(0x121)]?JSON['parse'](_0x5ad10a['extend']):null;_0x4e5b4b&&(_0x4e5b4b?_0x5ad10a[_0x3ed74e(0x159)]=_0x4e5b4b?.[_0x3ed74e(0x1a2)][0x0]?.[_0x3ed74e(0x1a2)][_0x3ed74e(0x11b)]===0x5:_0x5ad10a['isGroup']=![]);}}),_0x216a8c;}async[_0x54b563(0x195)](_0x1e580e){const _0x5b4cd8=_0x54b563,{page:page=0x1,size:size=0x14,rec:_0x5594cb,userId:_0x16a6ec,model:_0xb7f703}=_0x1e580e,_0x3cfe0e={'type':balance_constant_1['DeductionKey'][_0x5b4cd8(0x1a5)],'prompt':(0x0,typeorm_2['Not'])(''),'answer':(0x0,typeorm_2[_0x5b4cd8(0x130)])('')};_0x5594cb&&Object[_0x5b4cd8(0x16b)](_0x3cfe0e,{'rec':_0x5594cb}),_0x16a6ec&&Object['assign'](_0x3cfe0e,{'userId':_0x16a6ec}),_0xb7f703&&Object[_0x5b4cd8(0x16b)](_0x3cfe0e,{'model':_0xb7f703});const [_0x13d9a0,_0xe6ff30]=await this['chatLogEntity'][_0x5b4cd8(0x116)]({'order':{'id':'DESC'},'skip':(page-0x1)*size,'take':size,'where':_0x3cfe0e});return _0x13d9a0['forEach'](_0x25ec4c=>{const _0x31480a=_0x5b4cd8;if(_0x25ec4c[_0x31480a(0x1a8)]===_0x31480a(0x10f)){const _0x8ae6ed=_0x25ec4c[_0x31480a(0x18f)]==='mj'?0x136:0xa0,_0x2bc2bb=_0x25ec4c[_0x31480a(0x16f)][_0x31480a(0x1c0)](_0x31480a(0x1b9))?_0x31480a(0x1a7):_0x31480a(0x146),_0x878583=_0x2bc2bb===_0x31480a(0x1a7)?_0x31480a(0x12c)+_0x8ae6ed+_0x31480a(0x1b1):_0x31480a(0x1b2)+_0x8ae6ed;_0x25ec4c['thumbImg']=_0x25ec4c[_0x31480a(0x16f)]+_0x878583;const _0x268a14=_0x25ec4c[_0x31480a(0x121)]?JSON[_0x31480a(0x118)](_0x25ec4c[_0x31480a(0x121)]):null;_0x268a14&&(_0x268a14?_0x25ec4c[_0x31480a(0x159)]=_0x268a14?.['components'][0x0]?.[_0x31480a(0x1a2)][_0x31480a(0x11b)]===0x5:_0x25ec4c[_0x31480a(0x159)]=![]);}}),{'rows':_0x13d9a0,'count':_0xe6ff30};}async['recDrawImg'](_0x3b2c63){const _0x49b0bd=_0x54b563,{id:_0x221ef0}=_0x3b2c63,_0x3b618d=await this[_0x49b0bd(0x157)]['findOne']({'where':{'id':_0x221ef0,'type':balance_constant_1[_0x49b0bd(0x151)][_0x49b0bd(0x1a5)]}});if(!_0x3b618d)throw new common_1[(_0x49b0bd(0x184))](_0x49b0bd(0x1a4),common_1[_0x49b0bd(0x19b)][_0x49b0bd(0x15d)]);const _0x51d74f=_0x3b618d[_0x49b0bd(0x153)]===0x1?0x0:0x1,_0x25e87e=await this[_0x49b0bd(0x157)]['update']({'id':_0x221ef0},{'rec':_0x51d74f});if(_0x25e87e[_0x49b0bd(0x11a)]>0x0)return(_0x51d74f?'推荐':_0x49b0bd(0x1ac))+_0x49b0bd(0x10c);throw new common_1[(_0x49b0bd(0x184))](_0x49b0bd(0x1a9),common_1[_0x49b0bd(0x19b)][_0x49b0bd(0x15d)]);}async[_0x54b563(0x124)](_0x5a51b8,_0x29fd55){const _0x16e463=_0x54b563,_0x15aa60=(0x0,utils_1['getReqSaasId'])(this['clsService']),{page:page=0x1,size:size=0x14,userId:_0x3835d6,keyword:_0x2c5c61,prompt:_0x35e453,saasId:_0x531647,modelType:_0x31600e}=_0x5a51b8;let _0x4ffcb7=_0x16e463(0x16d);_0x3835d6&&(_0x4ffcb7=_0x4ffcb7+(_0x16e463(0x162)+_0x3835d6));_0x35e453&&(_0x4ffcb7=_0x4ffcb7+(_0x16e463(0x103)+_0x35e453+'%\x27'));_0x31600e&&(_0x4ffcb7=_0x4ffcb7+(_0x16e463(0x12e)+_0x31600e+'\x27'));(0x0,utils_1[_0x16e463(0x122)])(this[_0x16e463(0x17a)])?(0x0,class_validator_1[_0x16e463(0x1bf)])(_0x531647)&&(_0x4ffcb7=_0x4ffcb7+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20'+_0x531647)):_0x4ffcb7=_0x4ffcb7+(_0x16e463(0x183)+_0x15aa60);_0x2c5c61&&(_0x4ffcb7=_0x4ffcb7+(_0x16e463(0x156)+_0x2c5c61+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x2c5c61+_0x16e463(0x163)+_0x2c5c61+_0x16e463(0x169)+_0x2c5c61+'%\x27)'));const _0xbfb58c=await this['connection'][_0x16e463(0x128)](_0x16e463(0x15c)+_0x4ffcb7+_0x16e463(0x137)),_0x71f7a9=await this[_0x16e463(0x147)][_0x16e463(0x128)](_0x16e463(0x120)+_0x4ffcb7+'\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x16e463(0x155));return!(0x0,utils_1['isSuper'])(this[_0x16e463(0x17a)])&&_0x71f7a9[_0x16e463(0x113)](_0x483dcd=>{const _0x2664d5=_0x16e463;_0x483dcd[_0x2664d5(0x139)]=(0x0,utils_1[_0x2664d5(0x13f)])(_0x483dcd[_0x2664d5(0x139)]),_0x483dcd[_0x2664d5(0x192)]=(0x0,utils_1[_0x2664d5(0x13f)])(_0x483dcd[_0x2664d5(0x192)]);}),{'rows':_0x71f7a9,'count':Number(_0xbfb58c[0x0]?.[_0x16e463(0x193)]||0x0)};}async['delChatLog'](_0x95b733){const _0x3e87bf=_0x54b563;if(!_0x95b733[_0x3e87bf(0x11c)]['length'])return!![];return await this[_0x3e87bf(0x157)][_0x3e87bf(0x180)]({'id':(0x0,typeorm_2['In'])(_0x95b733['ids'])},{'isDelete':!![]}),!![];}async[_0x54b563(0x108)](_0x10d65c,_0x45fcb3){const _0x2a1ea0=_0x54b563,{id:_0x110ef1}=_0x10d65c[_0x2a1ea0(0x13c)],{groupId:_0x2a52c3,logType:_0x8e3237}=_0x45fcb3,_0x4ae6d2={'userId':_0x110ef1,'isDelete':![]};_0x2a52c3&&Object['assign'](_0x4ae6d2,{'groupId':_0x2a52c3}),_0x8e3237&&Object[_0x2a1ea0(0x16b)](_0x4ae6d2,{'logType':_0x8e3237});const _0x4b5f3e=await this['chatLogEntity'][_0x2a1ea0(0x19e)]({'where':_0x4ae6d2})[_0x2a1ea0(0x119)](_0xa09aea=>{const _0x5d223b=_0x2a1ea0;common_1['Logger'][_0x5d223b(0x187)](_0xa09aea);});if(!_0x4b5f3e||_0x4b5f3e[_0x2a1ea0(0x11b)]===0x0)return[];return _0x4b5f3e[_0x2a1ea0(0x188)](_0x3fffcf=>{const _0x432871=_0x2a1ea0,{prompt:_0x250336,role:_0x23a6bb,answer:_0x4ecf07,createdAt:_0x343873,model:_0x49753e,conversationOptions:_0x27d618,requestOptions:_0x228560,id:_0x56a77d}=_0x3fffcf;return{'chatId':_0x56a77d,'dateTime':(0x0,utils_1[_0x432871(0x16a)])(_0x343873),'text':_0x23a6bb===_0x432871(0x13c)?_0x250336:_0x4ecf07,'inversion':_0x23a6bb===_0x432871(0x13c),'error':![],'conversationOptions':_0x27d618?JSON[_0x432871(0x118)](_0x27d618):null,'requestOptions':_0x228560?JSON[_0x432871(0x118)](_0x228560):null};});}async[_0x54b563(0xff)](_0x501783){const _0x3aefa8=_0x54b563;return this['chatLogEntity'][_0x3aefa8(0x19e)]({'where':{'groupId':_0x501783,'isDelete':![]}});}async['getMusicVoMap'](_0x1dece4,_0x20e2e9,_0x2a080e){const _0x51742d=_0x54b563,_0x24253e=new Map();if(!_0x20e2e9['length'])return _0x24253e;const _0x4e98cf=await this[_0x51742d(0x10a)][_0x51742d(0x19e)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x20e2e9),'deleteFlag':0x0}}),_0x583dbb=_0x4e98cf[_0x51742d(0x188)](_0x176769=>_0x176769['id']),_0xf8c894=await this['aiLogService'][_0x51742d(0x152)](_0x1dece4,_0x583dbb,_0x2a080e),_0x4629f8=await this['aiLogService'][_0x51742d(0x199)](_0x583dbb,_0x2a080e);return _0x4e98cf[_0x51742d(0x113)](_0x32b267=>{const _0x507bac=_0x51742d;!_0x24253e[_0x507bac(0x158)](_0x32b267[_0x507bac(0x131)])&&_0x24253e[_0x507bac(0x117)](_0x32b267[_0x507bac(0x131)],[]);const _0x17bc0f=_0x4629f8[_0x507bac(0x191)](_0x32b267['id']);_0x24253e[_0x507bac(0x191)](_0x32b267[_0x507bac(0x131)])['push']({..._0x32b267,'agree':_0xf8c894['get'](_0x32b267['id'])||null,'playNum':_0x17bc0f?.[_0x507bac(0x13e)]||0x0,'visitNum':_0x17bc0f?.[_0x507bac(0x136)]||0x0,'agreeNum':_0x17bc0f?.['agreeNum']||0x0});}),_0x24253e;}async[_0x54b563(0x10b)](_0x1199d5,_0x5d44e4,_0x377584){const _0x5d3915=_0x54b563;if(!_0x5d44e4[_0x5d3915(0x11b)])return[];const _0x19355=await this[_0x5d3915(0x157)][_0x5d3915(0x19e)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0x5d44e4)}});if(!_0x19355['length'])return[];const _0x135339=await this['getMusicVoMap'](_0x1199d5['user']['id'],_0x5d44e4,_0x377584);return _0x19355[_0x5d3915(0x188)](_0x532e93=>{const _0x1f9725=_0x5d3915;return{..._0x532e93,'children':_0x135339[_0x1f9725(0x191)](_0x532e93['id'])||[]};});}async[_0x54b563(0x12d)](_0x3ceec5){const _0x57860e=_0x54b563;if(!_0x3ceec5['length'])return[];return this['aiAssetsEntity'][_0x57860e(0x19e)]({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x3ceec5)}});}async[_0x54b563(0x16e)](_0x588a3d,_0x373d5f){const _0x55cee7=_0x54b563;try{const _0x305e8a={'isDelete':![],'role':_0x55cee7(0x14a),'userId':_0x588a3d[_0x55cee7(0x13c)]['id'],'modelType':_0x373d5f['modelType']},[_0x355913,_0x15f11d]=await this[_0x55cee7(0x157)]['findAndCount']({'where':_0x305e8a,'take':_0x373d5f[_0x55cee7(0x161)],'skip':(_0x373d5f[_0x55cee7(0x177)]-0x1)*_0x373d5f[_0x55cee7(0x161)],'order':{'createdAt':_0x55cee7(0x1a0)}}),_0x3400bf=_0x355913[_0x55cee7(0x188)](_0x49ef01=>_0x49ef01['id']),_0x15a7ec=await this[_0x55cee7(0x15e)](_0x588a3d[_0x55cee7(0x13c)]['id'],_0x3400bf,_0x373d5f['modelType']),_0x18fc98=_0x355913[_0x55cee7(0x188)](_0x5485a2=>{const _0xf3ec54=_0x55cee7;return{..._0x5485a2,'children':_0x15a7ec[_0xf3ec54(0x191)](_0x5485a2['id'])||[]};});return{'count':_0x15f11d,'records':_0x18fc98};}catch(_0x430753){throw new common_1[(_0x55cee7(0x184))](_0x430753[_0x55cee7(0x101)],common_1[_0x55cee7(0x19b)][_0x55cee7(0x15d)]);}}async[_0x54b563(0x11d)](_0x2d2e4c,_0x262eb5){const _0x3af8f2=_0x54b563;if(!_0x262eb5[_0x3af8f2(0x11c)][_0x3af8f2(0x11b)])return!![];return await this['aiAssetsEntity'][_0x3af8f2(0x180)]({'userId':_0x2d2e4c[_0x3af8f2(0x13c)]['id'],'id':(0x0,typeorm_2['In'])(_0x262eb5[_0x3af8f2(0x11c)])},{'deleteFlag':0x1}),!![];}async[_0x54b563(0x17e)](_0x5462c8,_0xfc95e4){const _0x34a713=_0x54b563;if(!_0xfc95e4[_0x34a713(0x11c)])return!![];return await this[_0x34a713(0x147)][_0x34a713(0x128)](_0x34a713(0x106)+_0x5462c8[_0x34a713(0x13c)]['id']+_0x34a713(0x1b3)+_0xfc95e4['ids'][_0x34a713(0x1b4)]()+_0x34a713(0x19a)),!![];}async[_0x54b563(0x190)](_0x42f444,_0x4e62c0){const _0x3d3424=_0x54b563,_0x4d1c32=(0x0,utils_1[_0x3d3424(0x105)])(this[_0x3d3424(0x17a)]);try{const {page:page=0x1,size:size=0x14,order:_0x2e6591,keyword:_0x44e0c6,modelType:_0x486780}=_0x4e62c0;let _0x698ed=_0x3d3424(0x12a);if(_0x2e6591===_0x3d3424(0x13e))_0x698ed=_0x3d3424(0x17b);else _0x2e6591===_0x3d3424(0x1a3)&&(_0x698ed=_0x3d3424(0x141));const _0x4a459c=await this[_0x3d3424(0x147)][_0x3d3424(0x128)](_0x3d3424(0x194)+_0x486780+'\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x44e0c6?_0x3d3424(0x19f)+_0x44e0c6+_0x3d3424(0x18a):'')+_0x3d3424(0x1b5)),_0x593def=await this[_0x3d3424(0x147)]['query'](_0x3d3424(0x174)+_0x486780+_0x3d3424(0x10e)+_0x486780+'\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x44e0c6?_0x3d3424(0x19f)+_0x44e0c6+'%\x27)':'')+_0x3d3424(0x126)+_0x698ed+_0x3d3424(0x13d)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x3d3424(0x1b5)),_0x1b218b=_0x593def[_0x3d3424(0x188)](_0xa6788f=>_0xa6788f['id']),_0x14869c=await this['aiLogService']['getAgreeMap'](_0x4d1c32,_0x1b218b,_0x486780);return _0x593def[_0x3d3424(0x113)](_0x5e8bd0=>{const _0x5c0f53=_0x3d3424;_0x5e8bd0[_0x5c0f53(0x167)]=_0x14869c[_0x5c0f53(0x191)](_0x5e8bd0['id'])||null;}),{'records':_0x593def,'count':Number(_0x4a459c[0x0]?.[_0x3d3424(0x193)]||0x0)};}catch(_0x478485){throw new common_1[(_0x3d3424(0x184))](_0x478485[_0x3d3424(0x101)],common_1[_0x3d3424(0x19b)][_0x3d3424(0x15d)]);}}async[_0x54b563(0x17f)](_0x2d704c,_0x22d6e3){const _0x398314=_0x54b563,{id:_0x5ec2f4}=_0x2d704c[_0x398314(0x13c)],{groupId:_0x3b75ee}=_0x22d6e3,_0x31d0c6={'userId':_0x5ec2f4,'isDelete':![]};_0x3b75ee&&Object[_0x398314(0x16b)](_0x31d0c6,{'groupId':_0x3b75ee});const _0x1b1074=await this[_0x398314(0x157)][_0x398314(0x19e)]({'where':_0x31d0c6});return _0x1b1074[_0x398314(0x188)](_0x5a2b38=>{const _0x5925bc=_0x398314,{prompt:_0x3a3d20,role:_0xffbef5,answer:_0x2f4aa9,createdAt:_0x408989,model:_0x5b71fe,conversationOptions:_0x1dd8a6,requestOptions:_0x3e8483,id:_0x41a431}=_0x5a2b38;return{'chatId':_0x41a431,'dateTime':(0x0,utils_1[_0x5925bc(0x16a)])(_0x408989),'text':_0xffbef5===_0x5925bc(0x13c)?_0x3a3d20:_0x2f4aa9,'inversion':_0xffbef5===_0x5925bc(0x13c),'error':![],'conversationOptions':_0x1dd8a6?JSON['parse'](_0x1dd8a6):null,'requestOptions':_0x3e8483?JSON['parse'](_0x3e8483):null};});}async[_0x54b563(0x1b6)](_0x5880fb,_0x45b9ff){const _0x4bee7a=_0x54b563,{id:_0xc42f20}=_0x5880fb[_0x4bee7a(0x13c)],{id:_0x5571ab}=_0x45b9ff,_0x409415=await this['chatLogEntity']['findOne']({'where':{'id':_0x5571ab,'userId':_0xc42f20}});if(!_0x409415)throw new common_1[(_0x4bee7a(0x184))](_0x4bee7a(0x123),common_1[_0x4bee7a(0x19b)][_0x4bee7a(0x15d)]);const _0x3447b2=await this[_0x4bee7a(0x157)][_0x4bee7a(0x180)]({'id':_0x5571ab},{'isDelete':!![]});if(_0x3447b2[_0x4bee7a(0x11a)]>0x0)return _0x4bee7a(0x107);else throw new common_1['HttpException'](_0x4bee7a(0x123),common_1[_0x4bee7a(0x19b)][_0x4bee7a(0x15d)]);}async[_0x54b563(0x109)](_0x3e5f41,_0x32453b){const _0xba5b8e=_0x54b563,{groupId:_0x363101,type:_0x37c7a6}=_0x32453b,{id:_0x4a7546}=_0x3e5f41['user'],_0x5e6228=_0x37c7a6&&_0x37c7a6===_0xba5b8e(0x1b7)?{'groupId':_0x363101,'userId':_0x4a7546}:{'groupId':_0x363101,'userId':_0x4a7546},_0x2d23c0=await this[_0xba5b8e(0x157)][_0xba5b8e(0x138)](_0x5e6228);if(_0x2d23c0[_0xba5b8e(0x11a)]>0x0)return!![];if(_0x2d23c0[_0xba5b8e(0x11a)]===0x0)throw new common_1[(_0xba5b8e(0x184))](_0xba5b8e(0x168),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x54b563(0x1be)](_0x4bf866){const _0x2002fe=_0x54b563,{ids:_0x232681,userId:_0x5ae29f}=_0x4bf866;return await this['chatLogEntity'][_0x2002fe(0x138)]({'groupId':(0x0,typeorm_2['In'])(_0x232681),'userId':_0x5ae29f});}async[_0x54b563(0x12f)](_0x592a3e,_0x46c026){const _0x2da51c=_0x54b563,{id:_0x283e61}=_0x592a3e[_0x2da51c(0x13c)],{appId:_0x45ed49,page:page=0x1,size:size=0xa}=_0x46c026,[_0x52bb92,_0x3d3f1a]=await this['chatLogEntity'][_0x2da51c(0x116)]({'where':{'userId':_0x283e61,'appId':_0x45ed49,'role':_0x2da51c(0x14a)},'order':{'id':_0x2da51c(0x1a0)},'take':size,'skip':(page-0x1)*size});return{'rows':_0x52bb92,'count':_0x3d3f1a};}async[_0x54b563(0x11f)](){const _0x3f4a8a=_0x54b563,_0x45890f=await this[_0x3f4a8a(0x147)][_0x3f4a8a(0x128)](_0x3f4a8a(0x18d));return _0x45890f;}async[_0x54b563(0x140)](_0x3e088d){const _0x295515=_0x54b563;console[_0x295515(0x145)](_0x295515(0x12b),_0x3e088d);const _0x14920d=await this[_0x295515(0x10a)]['findOne']({'where':{'sunoMusicId':_0x3e088d['id']}});if(!_0x14920d)throw new Error(_0x295515(0x16c));const _0x256643=await this[_0x295515(0x157)]['findOne']({'where':{'id':_0x14920d[_0x295515(0x131)]}});_0x256643[_0x295515(0x16f)]=_0x3e088d[_0x295515(0xfd)],_0x14920d['mp4']=_0x3e088d[_0x295515(0x19d)]?.[_0x295515(0x102)],await this['chatLogEntity'][_0x295515(0x1a6)](_0x256643),await this[_0x295515(0x10a)][_0x295515(0x1a6)](_0x14920d),_0x256643[_0x295515(0x16f)]==='completed'&&_0x14920d[_0x295515(0x135)]&&this[_0x295515(0x166)](_0x14920d);}async[_0x54b563(0x166)](_0x15284b){const _0x342600=_0x54b563,[_0x4263d3,_0x71fe93]=await this[_0x342600(0x100)][_0x342600(0x1b8)](_0x15284b['mp4']);_0x15284b[_0x342600(0x135)]=_0x4263d3,_0x15284b[_0x342600(0x176)]=_0x71fe93,await this['aiAssetsEntity'][_0x342600(0x1a6)](_0x15284b);}async[_0x54b563(0x165)](){const _0x4ddc54=_0x54b563,_0x25786b=await this[_0x4ddc54(0x10a)]['find']({'where':[{'cover':(0x0,typeorm_2[_0x4ddc54(0x1bd)])(_0x4ddc54(0x186))},{'mp3':(0x0,typeorm_2[_0x4ddc54(0x1bd)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2[_0x4ddc54(0x1bd)])('%filesystem.site%')},{'mp4':(0x0,typeorm_2['Like'])(_0x4ddc54(0x1ab))}]});for(let _0x4b52b9=0x0;_0x4b52b9<_0x25786b[_0x4ddc54(0x11b)];_0x4b52b9++){const _0x550561=_0x25786b[_0x4b52b9],_0x388f77=redisKey_constant_1[_0x4ddc54(0x164)]+_0x550561['id'];try{const _0x2df018=await this[_0x4ddc54(0x110)][_0x4ddc54(0x191)]({'key':_0x388f77});if(_0x2df018)continue;await this['redisCacheService'][_0x4ddc54(0x117)]({'key':_0x388f77,'val':_0x4ddc54(0x172)});const {cover:_0x41879a,mp3:_0x5efe9a,mp4:_0x2eb584}=_0x550561;/filesystem.site/[_0x4ddc54(0x14f)](_0x41879a)&&(_0x550561[_0x4ddc54(0x176)]=await this[_0x4ddc54(0x100)]['transferFile'](_0x41879a));/filesystem.site/['test'](_0x5efe9a)&&(_0x550561[_0x4ddc54(0x171)]=await this['fileService'][_0x4ddc54(0x154)](_0x5efe9a));if(/filesystem.site|storage.cdn-luma.com/['test'](_0x2eb584)){if(_0x41879a)_0x550561[_0x4ddc54(0x135)]=await this[_0x4ddc54(0x100)][_0x4ddc54(0x154)](_0x2eb584);else{const [_0x25f321,_0x822ca6]=await this[_0x4ddc54(0x100)][_0x4ddc54(0x1b8)](_0x2eb584);_0x550561['mp4']=_0x25f321,_0x550561[_0x4ddc54(0x176)]=_0x822ca6;}}await this[_0x4ddc54(0x10a)][_0x4ddc54(0x1a6)](_0x550561);}catch(_0x5d837a){common_1['Logger'][_0x4ddc54(0x187)](_0x5d837a);}finally{await this[_0x4ddc54(0x110)][_0x4ddc54(0x129)]({'key':_0x388f77});}}}async['getLastByUserAndAppIds'](_0x574826,_0x504b62){const _0x3a4e97=_0x54b563,_0x46278e=await this['chatLogEntity']['query']('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20'+_0x574826+_0x3a4e97(0x1b0)+_0x504b62[_0x3a4e97(0x1b4)]()+'\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20');return _0x46278e;}};ChatLogService=__decorate([(0x0,common_1[_0x54b563(0x11e)])(),__param(0x0,(0x0,typeorm_1[_0x54b563(0x148)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(aiAssets_entity_1[_0x54b563(0x1ae)])),__metadata(_0x54b563(0x17d),[typeorm_2['Repository'],typeorm_2['Repository'],nestjs_cls_1['ClsService'],file_service_1[_0x54b563(0x10d)],aiLog_service_1[_0x54b563(0x150)],redisCache_service_1[_0x54b563(0x14b)],typeorm_2['Connection']])],ChatLogService),exports['ChatLogService']=ChatLogService;