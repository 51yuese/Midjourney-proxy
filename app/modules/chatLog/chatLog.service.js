'use strict';const _0x505326=_0x528e;(function(_0x22b55e,_0x4e310b){const _0x42a689=_0x528e,_0x2c3461=_0x22b55e();while(!![]){try{const _0x51e8d9=parseInt(_0x42a689(0x19d))/0x1*(-parseInt(_0x42a689(0x1e9))/0x2)+parseInt(_0x42a689(0x201))/0x3*(-parseInt(_0x42a689(0x208))/0x4)+-parseInt(_0x42a689(0x238))/0x5*(parseInt(_0x42a689(0x1f5))/0x6)+-parseInt(_0x42a689(0x1a0))/0x7+parseInt(_0x42a689(0x21b))/0x8*(parseInt(_0x42a689(0x1d1))/0x9)+-parseInt(_0x42a689(0x1e4))/0xa+parseInt(_0x42a689(0x1c4))/0xb;if(_0x51e8d9===_0x4e310b)break;else _0x2c3461['push'](_0x2c3461['shift']());}catch(_0x58e069){_0x2c3461['push'](_0x2c3461['shift']());}}}(_0xdaa8,0x83143));function _0xdaa8(){const _0x3dfbe9=['ChatLogService','state','delByGroupId','filter','###üéµ\x20Ê≠åÊõ≤Âêç','map','cos','6hgtDFW','PAINT_TYPE','ali','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.rompt\x20LIKE\x20\x27%','querAllChatLog','Ôºö**','delete','Request\x20failed','clsService','?x-oss-process=image/resize,w_','\x0a\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20','listAssetsBychatLogIds','26430FxKGTk','\x20)\x20\x0a\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId\x0a\x20\x20\x20\x20','chatLogEntity','assign','isDelete\x20=\x200','startsWith','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','352WnNZSV','design:paramtypes','DeductionKey','ids','__esModule','catch','./aiAssets.entity','affected','listUndoneVideo','getLastByUserAndAppIds','%storage.cdn-luma.com%','parse','fileService','chatLogId','\x20\x0a\x20\x20\x20\x20','---','transferFile','listByGroupId','assetsDel','2070008KUVrYN','\x20AND\x20id\x20IN\x20(','syncVideo','Injectable','AND\x20aa.title\x20LIKE\x20(\x27%','‰Ω†Êìç‰ΩúÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','AiLogService','?imageView2/1/w/','defineProperty',')\x0a\x20\x20\x20\x20','../aiLog/aiLog.service','getAgreeMap','%\x27)','answer','replace','split','\x0a\x20\x20\x20\x20\x20\x20UPDATE\x20ai_assets\x20\x0a\x20\x20\x20\x20\x20\x20SET\x20publish_flag\x20=\x20CASE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHEN\x20publish_flag\x20=\x200\x20THEN\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x201\x20ELSE\x200\x20\x0a\x20\x20\x20\x20\x20\x20END\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_id\x20=\x20','‰Ω†Âà†Èô§ÁöÑÂØπËØùËÆ∞ÂΩï‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ','HttpStatus','HttpException','get','count','assetsSquare','../redisCache/redisCache.service','AiAssetsEntity','user','\x20OFFSET\x20','\x20\x20\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','../../common/constants/redisKey.constant','990005hZDmEM','../file/file.service','@nestjs/common','save','error','transaction','extend','parseAndSaveMusic','aiLogService','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.modelType\x20=\x20\x27','components','agreeNum','agree','update','message','/q/55','completed','ale.play_num','findOne','listByIds','assetsPublish','set','class-validator','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20aa.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.model\x20as\x20model,\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.prompt\x20as\x20prompt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.play_num,0)\x20as\x20playNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.visit_num,0)\x20as\x20visitNum,\x0a\x20\x20\x20\x20\x20\x20\x20\x20IFNULL(ale.agree_num,0)\x20as\x20agreeNum\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.userId\x20=\x20','test','Ëß£ÊûêÈîôËØØ','model','length','\x0a\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20','function','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_log_ext\x20ale\x20ON\x20ale.relate_id\x20=\x20aa.id\x20AND\x20ale.relate_type\x20=\x20\x27','lumaÈÄöÁü•Ôºö','querDrawLog','chatTaskLog','page','typeorm','forEach','decorate','byAppId','ale.agree_num','1KatTAJ','\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(u.username\x20LIKE\x20\x27%','**Ê≠åËØçÔºö**','4252423tNxkJI','\x0a\x20\x20\x20\x20\x20\x20','querAllDrawLog','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ai_assets\x20aa\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20chatlog\x20cl\x20ON\x20cl.id\x20=\x20aa.chat_log_id\x20AND\x20cl.modelType\x20=\x20\x27','####','find','metadata','\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20','__metadata','thumbImg','Not','Like','```','match','size','assistant','aa.createdAt','removeLogsBatch','DESC','query','indexOf','@nestjs/typeorm','Connection','\x20DESC\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','chatList','recDrawImg','InjectRepository','isGroup','mp4','isDefined','type','includes','formatDate','rec','\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','email','20271086jCZrHA','push','connection','findAndCount','videoNotify','../../common/constants/balance.constant','cover','getMusicVoMap','video','paintCount','lock','FileService','__decorate','36sxWGrp','tencent','object','maskEmail','Âà†Èô§ÂØπËØùËÆ∞ÂΩïÊàêÂäüÔºÅ','redisCacheService','Èü≥‰πêÁîüÊàêÈîôËØØÔºö','join','%filesystem.site%','gpts','__param','substring','mp3','BAD_REQUEST','\x27\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20cl.id\x20IS\x20NOT\x20NULL\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.delete_flag\x20=\x200\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20aa.publish_flag\x20=\x201\x0a\x20\x20\x20\x20\x20\x20\x20\x20','aiAssetsEntity','isPlatform','url','userId','6994950lBdpOZ','\x0a\x20\x20\x20\x20','getUserId','chatGptsList','modelType','121332XWgwYR','transferAndCover','visitNum','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20appId\x20IN\x20(\x20','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%'];_0xdaa8=function(){return _0x3dfbe9;};return _0xdaa8();}var __decorate=this&&this[_0x505326(0x1d0)]||function(_0x2a514b,_0x425d28,_0x1ad81e,_0x385f47){const _0x3e2946=_0x505326;var _0x368413=arguments['length'],_0x4cfbfb=_0x368413<0x3?_0x425d28:_0x385f47===null?_0x385f47=Object['getOwnPropertyDescriptor'](_0x425d28,_0x1ad81e):_0x385f47,_0x5e34ca;if(typeof Reflect===_0x3e2946(0x1d3)&&typeof Reflect['decorate']==='function')_0x4cfbfb=Reflect[_0x3e2946(0x19a)](_0x2a514b,_0x425d28,_0x1ad81e,_0x385f47);else{for(var _0x2bb1fb=_0x2a514b['length']-0x1;_0x2bb1fb>=0x0;_0x2bb1fb--)if(_0x5e34ca=_0x2a514b[_0x2bb1fb])_0x4cfbfb=(_0x368413<0x3?_0x5e34ca(_0x4cfbfb):_0x368413>0x3?_0x5e34ca(_0x425d28,_0x1ad81e,_0x4cfbfb):_0x5e34ca(_0x425d28,_0x1ad81e))||_0x4cfbfb;}return _0x368413>0x3&&_0x4cfbfb&&Object['defineProperty'](_0x425d28,_0x1ad81e,_0x4cfbfb),_0x4cfbfb;},__metadata=this&&this[_0x505326(0x1a8)]||function(_0x17119c,_0xd2f993){const _0x4b1d35=_0x505326;if(typeof Reflect===_0x4b1d35(0x1d3)&&typeof Reflect[_0x4b1d35(0x1a6)]===_0x4b1d35(0x192))return Reflect[_0x4b1d35(0x1a6)](_0x17119c,_0xd2f993);},__param=this&&this[_0x505326(0x1db)]||function(_0x1c9a2d,_0x901ace){return function(_0x3cf027,_0x33a10f){_0x901ace(_0x3cf027,_0x33a10f,_0x1c9a2d);};};Object[_0x505326(0x223)](exports,_0x505326(0x20c),{'value':!![]}),exports['ChatLogService']=void 0x0;const common_1=require(_0x505326(0x23a)),typeorm_1=require(_0x505326(0x1b5)),chatLog_entity_1=require('./chatLog.entity'),typeorm_2=require(_0x505326(0x198)),balance_constant_1=require(_0x505326(0x1c9)),utils_1=require('../../common/utils'),file_service_1=require(_0x505326(0x239)),redisCache_service_1=require(_0x505326(0x232)),redisKey_constant_1=require(_0x505326(0x237)),aiAssets_entity_1=require(_0x505326(0x20e)),aiLog_service_1=require(_0x505326(0x225)),nestjs_cls_1=require('nestjs-cls'),class_validator_1=require(_0x505326(0x24e));let ChatLogService=class ChatLogService{constructor(_0x46af5a,_0xe41d60,_0x25bb44,_0x55ea7f,_0x32c74c,_0x18948f,_0x7c22bf){const _0x8e6fa9=_0x505326;this[_0x8e6fa9(0x203)]=_0x46af5a,this['aiAssetsEntity']=_0xe41d60,this['clsService']=_0x25bb44,this[_0x8e6fa9(0x214)]=_0x55ea7f,this[_0x8e6fa9(0x240)]=_0x32c74c,this['redisCacheService']=_0x18948f,this[_0x8e6fa9(0x1c6)]=_0x7c22bf;}async['saveChatLog'](_0x448f46){const _0x140f80=_0x505326;return await this[_0x140f80(0x203)]['save'](_0x448f46);}async[_0x505326(0x23f)](_0x25e00a){const _0x81104c=_0x505326,_0x520194=_0x25e00a[_0x81104c(0x228)];let _0x1ddf26={},_0x3b8883={};if(_0x520194[_0x81104c(0x1b4)](_0x81104c(0x1fc))!=-0x1)throw new Error(_0x81104c(0x1d7)+_0x520194);else{let _0x5e2687='',_0x270540='',_0x5f13e9='Ëß£ÊûêÈîôËØØ',_0x5b2da1='Ëß£ÊûêÈîôËØØ',_0x127734=_0x81104c(0x18e),_0x8c0db0=_0x81104c(0x18e),_0x4e6304=_0x81104c(0x18e),_0x3d5ad2=_0x81104c(0x18e),_0x2324f2='Ëß£ÊûêÈîôËØØ',_0xeac98b=_0x81104c(0x18e);if(_0x520194[_0x81104c(0x206)](_0x81104c(0x1a4))){const [_0x4254b4]=_0x520194[_0x81104c(0x1ad)](/>(\S+)\n/g);_0x5e2687=_0x270540=_0x4254b4[_0x81104c(0x1dc)](0x1,_0x4254b4[_0x81104c(0x190)]-0x1),_0x5f13e9=_0x520194['split']('\x0a')[0x0][_0x81104c(0x1dc)](0x7),_0x5b2da1=_0x520194['split'](_0x81104c(0x217))[0x1][_0x81104c(0x229)](/\[.*\]|Ôºà.*Ôºâ/g,'')[_0x81104c(0x229)](/\n+/g,'\x0a');const _0x440f26=_0x520194[_0x81104c(0x1ad)](/!\[image\].*\)/g);_0x440f26&&([_0x127734,_0x8c0db0]=_0x440f26[_0x81104c(0x1f3)](_0xf2c379=>_0xf2c379[_0x81104c(0x1dc)](0x9,_0xf2c379[_0x81104c(0x190)]-0x1)));const _0x59c233=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp3/g);_0x59c233&&([_0x4e6304,_0x3d5ad2]=_0x59c233);const _0x57532f=_0x520194['match'](/https:\/\/(.*)\.mp4/g);_0x57532f&&([_0x2324f2,_0xeac98b]=_0x57532f);}else{if(_0x520194[_0x81104c(0x206)]('üéµ')){_0x5f13e9=_0x520194[_0x81104c(0x22a)]('\x0a')[0x0][_0x81104c(0x229)](/üéµ/g,'');const _0x4fd7db=_0x520194['split']('--')[_0x81104c(0x1a5)](_0x3fefbe=>/-\n\n\[/[_0x81104c(0x18d)](_0x3fefbe));if(_0x4fd7db){const _0x27b90e=_0x4fd7db[_0x81104c(0x229)](/\[.*\]|Ôºà.*Ôºâ|-/g,'')[_0x81104c(0x229)](/\n+/g,'\x0a');_0x27b90e[_0x81104c(0x206)]('\x0a')?_0x5b2da1=_0x27b90e[_0x81104c(0x229)]('\x0a',''):_0x5b2da1=_0x27b90e;}const _0x41fc5f=_0x520194[_0x81104c(0x1ad)](/Ê≠åÊõ≤id(.+)\n/ig);_0x41fc5f&&([_0x5e2687,_0x270540]=_0x41fc5f['map'](_0x346558=>_0x346558[_0x81104c(0x1dc)](0xc,_0x346558['length']-0x1)));const _0x21908=_0x520194[_0x81104c(0x1ad)](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x21908&&([_0x127734,_0x8c0db0]=_0x21908[_0x81104c(0x1f3)](_0x1b66a1=>_0x1b66a1['substring'](0x7,_0x1b66a1[_0x81104c(0x190)]-0x1)));const _0x134855=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp3/g);_0x134855&&([_0x4e6304,_0x3d5ad2]=_0x134855);const _0x342e33=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp4/g);_0x342e33&&([_0x2324f2,_0xeac98b]=_0x342e33);}else{if(_0x520194['indexOf']('üíÑ')!=-0x1){let _0x279dac=_0x520194[_0x81104c(0x22a)]('\x0a');_0x279dac[_0x81104c(0x199)](_0x550556=>{const _0x3f7692=_0x81104c;_0x550556['indexOf']('üîé')!=-0x1&&(_0x5f13e9=_0x550556[_0x3f7692(0x22a)]('Ôºö')[0x1]);});const _0x9dc18a=_0x520194[_0x81104c(0x22a)](_0x81104c(0x1ac))[0x1][_0x81104c(0x22a)]('\x0a');if(_0x9dc18a){const _0x543cae=_0x9dc18a[_0x81104c(0x1f1)](_0x44d1f8=>_0x44d1f8[_0x81104c(0x1b4)]('[')==-0x1)[_0x81104c(0x1d8)]('');_0x543cae[_0x81104c(0x206)]('\x0a')?_0x5b2da1=_0x543cae['replace']('\x0a',''):_0x5b2da1=_0x543cae;}const _0x515c9b=_0x520194[_0x81104c(0x1ad)](/Ê≠åÊõ≤id(.+)\n/ig);_0x515c9b&&([_0x5e2687,_0x270540]=_0x515c9b[_0x81104c(0x1f3)](_0x40e290=>_0x40e290['substring'](0xa,_0x40e290[_0x81104c(0x190)]-0x1)));const _0x184750=_0x520194[_0x81104c(0x1ad)](/\[Â∞ÅÈù¢ÂõæÁâá\].*\)/g);_0x184750&&([_0x127734,_0x8c0db0]=_0x184750[_0x81104c(0x1f3)](_0x2b601a=>_0x2b601a[_0x81104c(0x1dc)](0x7,_0x2b601a[_0x81104c(0x190)]-0x1)));const _0x1f44cb=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp3/g);_0x1f44cb&&([_0x4e6304,_0x3d5ad2]=_0x1f44cb);const _0x1d2b3b=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp4/g);_0x1d2b3b&&([_0x2324f2,_0xeac98b]=_0x1d2b3b);}else{if(_0x520194[_0x81104c(0x206)]('üéÅ')){_0x5f13e9=_0x520194[_0x81104c(0x22a)]('\x0a')[0x2][_0x81104c(0x22a)](_0x81104c(0x1fa))[0x1];const _0x1dc024=_0x520194[_0x81104c(0x22a)](_0x81104c(0x1ac))[0x1][_0x81104c(0x22a)]('\x0a');if(_0x1dc024){const _0x461c1e=_0x1dc024[_0x81104c(0x1f1)](_0x2ccae0=>_0x2ccae0[_0x81104c(0x1b4)]('[')==-0x1)[_0x81104c(0x1d8)]('');_0x461c1e[_0x81104c(0x206)]('\x0a')?_0x5b2da1=_0x461c1e['replace']('\x0a',''):_0x5b2da1=_0x461c1e;}const _0x209fc0=_0x520194['match'](/Ê≠åÊõ≤IDÔºö(.+)\n/ig);_0x209fc0&&([_0x5e2687,_0x270540]=_0x209fc0[_0x81104c(0x1f3)](_0x49556c=>_0x49556c[_0x81104c(0x1dc)](0x8,_0x49556c[_0x81104c(0x190)]-0x1)));const _0x592ff5=_0x520194[_0x81104c(0x1ad)](/\[Â∞ÅÈù¢\].*\)/g);_0x592ff5&&([_0x127734,_0x8c0db0]=_0x592ff5[_0x81104c(0x1f3)](_0x28a925=>_0x28a925['substring'](0x5,_0x28a925[_0x81104c(0x190)]-0x1)));const _0x3cd1de=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp3/g);_0x3cd1de&&([_0x4e6304,_0x3d5ad2]=_0x3cd1de);const _0x99e6c0=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp4/g);_0x99e6c0&&([_0x2324f2,_0xeac98b]=_0x99e6c0);}else{if(_0x520194[_0x81104c(0x1b4)](_0x81104c(0x1f2))!==-0x1){let _0x6e7ca8=_0x520194['split']('\x0a'),_0x2cf631=![];const _0x1c70a9=[];for(let _0x42feda=0x0;_0x42feda<_0x6e7ca8['length'];_0x42feda++){const _0x3ff1e0=_0x6e7ca8[_0x42feda];_0x3ff1e0[_0x81104c(0x1b4)]('###üéµ\x20Ê≠åÊõ≤Âêç')!==-0x1&&(_0x5f13e9=_0x3ff1e0[_0x81104c(0x22a)]('Ôºö\x20')[0x1]);if(_0x3ff1e0[_0x81104c(0x1bf)]('**ÁâàÊú¨ID'))_0x2cf631=![];else{if(_0x2cf631&&!_0x3ff1e0[_0x81104c(0x206)]('['))_0x1c70a9['push'](_0x3ff1e0);else _0x3ff1e0[_0x81104c(0x1bf)](_0x81104c(0x19f))&&(_0x2cf631=!![]);}}_0x5b2da1=_0x1c70a9['join']('\x20');const _0x17e26e=_0x520194['match'](/ÁâàÊú¨IDÔºö(.+)\n/ig);_0x17e26e&&([_0x5e2687,_0x270540]=_0x17e26e[_0x81104c(0x1f3)](_0x40d9f8=>_0x40d9f8[_0x81104c(0x1dc)](0xa,_0x40d9f8['length']-0x1)));const _0x288199=_0x520194[_0x81104c(0x1ad)](/\[Â∞ÅÈù¢\].*\)/g);_0x288199&&([_0x127734,_0x8c0db0]=_0x288199[_0x81104c(0x1f3)](_0x2efdd8=>_0x2efdd8[_0x81104c(0x1dc)](0x5,_0x2efdd8[_0x81104c(0x190)]-0x1)));const _0x10aded=_0x520194[_0x81104c(0x1ad)](/https:\/\/(.*)\.mp3/g);_0x10aded&&([_0x4e6304,_0x3d5ad2]=_0x10aded);const _0x43a8d2=_0x520194['match'](/https:\/\/(.*)\.mp4/g);_0x43a8d2&&([_0x2324f2,_0xeac98b]=_0x43a8d2);}else throw new Error(_0x81104c(0x18e));}}}}_0x1ddf26={'title':_0x5f13e9,'intro':_0x5b2da1,'mp3':_0x4e6304,'mp4':_0x2324f2,'cover':_0x127734,'sunoMusicId':_0x5e2687,'chatLogId':_0x25e00a['id'],'userId':_0x25e00a['userId']},_0x3b8883={'title':_0x5f13e9,'intro':_0x5b2da1,'mp3':_0x3d5ad2,'mp4':_0xeac98b,'cover':_0x8c0db0,'sunoMusicId':_0x270540,'chatLogId':_0x25e00a['id'],'userId':_0x25e00a[_0x81104c(0x1e3)]};}await this[_0x81104c(0x1c6)][_0x81104c(0x23d)](async()=>{const _0x43c7ff=_0x81104c;await this['aiAssetsEntity'][_0x43c7ff(0x23b)](_0x1ddf26),await this[_0x43c7ff(0x1e0)]['save'](_0x3b8883);});}async['parseAndSaveVideo'](_0xd6165d,_0x2fd7d8){const _0x995345=_0x505326;let _0x3e25d5={'mp4':_0x2fd7d8[_0x995345(0x1cc)]?.[_0x995345(0x1e2)],'sunoMusicId':_0x2fd7d8['id'],'chatLogId':_0xd6165d['id'],'userId':_0xd6165d[_0x995345(0x1e3)]};if(_0x2fd7d8['id']){const _0x18ccf0=await this[_0x995345(0x1e0)][_0x995345(0x24a)]({'where':{'sunoMusicId':_0x2fd7d8['id']}});_0x18ccf0&&(_0x3e25d5=Object[_0x995345(0x204)](_0x18ccf0,_0x3e25d5));}_0x3e25d5=await this['aiAssetsEntity'][_0x995345(0x23b)](_0x3e25d5),_0xd6165d['answer']=_0x2fd7d8[_0x995345(0x1ef)],this[_0x995345(0x203)][_0x995345(0x23b)](_0xd6165d),_0x2fd7d8[_0x995345(0x1ef)]==='completed'&&_0x3e25d5['mp4']&&this[_0x995345(0x21d)](_0x3e25d5);}async[_0x505326(0x195)](_0x9de63a,_0x30aed5){const _0x480520=_0x505326,{id:_0xf73bc6}=_0x9de63a[_0x480520(0x234)],{model:_0x3c63f5}=_0x30aed5,_0x56311c={'userId':_0xf73bc6,'type':balance_constant_1[_0x480520(0x20a)][_0x480520(0x1f6)]};_0x3c63f5&&(_0x56311c[_0x480520(0x18f)]=_0x3c63f5);const _0x2bc2cf=await this['chatLogEntity']['find']({'where':_0x56311c,'order':{'id':_0x480520(0x1b2)}});return _0x2bc2cf[_0x480520(0x199)](_0x13b721=>{const _0x2421bc=_0x480520;if(_0x13b721[_0x2421bc(0x1be)]===_0x2421bc(0x1cd)){const _0xa537f5=_0x13b721[_0x2421bc(0x18f)]==='mj'?0x136:0xa0,_0x53208f=_0x13b721[_0x2421bc(0x228)]['includes'](_0x2421bc(0x1f4))?_0x2421bc(0x1d2):_0x2421bc(0x1f7),_0x5a3407=_0x53208f===_0x2421bc(0x1d2)?_0x2421bc(0x222)+_0xa537f5+_0x2421bc(0x247):_0x2421bc(0x1fe)+_0xa537f5;_0x13b721[_0x2421bc(0x1a9)]=_0x13b721['answer']+_0x5a3407;const _0x512a54=_0x13b721['extend']?JSON[_0x2421bc(0x213)](_0x13b721[_0x2421bc(0x23e)]):null;_0x512a54&&(_0x512a54?_0x13b721['isGroup']=_0x512a54?.[_0x2421bc(0x242)][0x0]?.[_0x2421bc(0x242)]['length']===0x5:_0x13b721[_0x2421bc(0x1bb)]=![]);}}),_0x2bc2cf;}async[_0x505326(0x1a2)](_0x11a5b9){const _0x40e5e5=_0x505326,{page:page=0x1,size:size=0x14,rec:_0x5c961b,userId:_0x56985a,model:_0x2100b8}=_0x11a5b9,_0x369eba={'type':balance_constant_1['DeductionKey'][_0x40e5e5(0x1f6)],'prompt':(0x0,typeorm_2[_0x40e5e5(0x1aa)])(''),'answer':(0x0,typeorm_2[_0x40e5e5(0x1aa)])('')};_0x5c961b&&Object[_0x40e5e5(0x204)](_0x369eba,{'rec':_0x5c961b}),_0x56985a&&Object[_0x40e5e5(0x204)](_0x369eba,{'userId':_0x56985a}),_0x2100b8&&Object[_0x40e5e5(0x204)](_0x369eba,{'model':_0x2100b8});const [_0x4405a3,_0x3af324]=await this['chatLogEntity'][_0x40e5e5(0x1c7)]({'order':{'id':_0x40e5e5(0x1b2)},'skip':(page-0x1)*size,'take':size,'where':_0x369eba});return _0x4405a3[_0x40e5e5(0x199)](_0x44e10e=>{const _0x1071b3=_0x40e5e5;if(_0x44e10e[_0x1071b3(0x1be)]===_0x1071b3(0x1cd)){const _0x3d0f61=_0x44e10e[_0x1071b3(0x18f)]==='mj'?0x136:0xa0,_0x2ab137=_0x44e10e[_0x1071b3(0x228)][_0x1071b3(0x1bf)](_0x1071b3(0x1f4))?_0x1071b3(0x1d2):'ali',_0xe247c7=_0x2ab137===_0x1071b3(0x1d2)?_0x1071b3(0x222)+_0x3d0f61+_0x1071b3(0x247):_0x1071b3(0x1fe)+_0x3d0f61;_0x44e10e['thumbImg']=_0x44e10e[_0x1071b3(0x228)]+_0xe247c7;const _0x5120cb=_0x44e10e['extend']?JSON[_0x1071b3(0x213)](_0x44e10e[_0x1071b3(0x23e)]):null;_0x5120cb&&(_0x5120cb?_0x44e10e[_0x1071b3(0x1bb)]=_0x5120cb?.['components'][0x0]?.[_0x1071b3(0x242)][_0x1071b3(0x190)]===0x5:_0x44e10e[_0x1071b3(0x1bb)]=![]);}}),{'rows':_0x4405a3,'count':_0x3af324};}async[_0x505326(0x1b9)](_0x44520c){const _0x2f835b=_0x505326,{id:_0x15bf6e}=_0x44520c,_0x406181=await this[_0x2f835b(0x203)][_0x2f835b(0x24a)]({'where':{'id':_0x15bf6e,'type':balance_constant_1[_0x2f835b(0x20a)][_0x2f835b(0x1f6)]}});if(!_0x406181)throw new common_1[(_0x2f835b(0x22e))]('‰Ω†Êé®ËçêÁöÑÂõæÁâá‰∏çÂ≠òÂú®„ÄÅËØ∑Ê£ÄÊü•ÔºÅ',common_1[_0x2f835b(0x22d)][_0x2f835b(0x1de)]);const _0xabde1a=_0x406181[_0x2f835b(0x1c1)]===0x1?0x0:0x1,_0x555284=await this['chatLogEntity']['update']({'id':_0x15bf6e},{'rec':_0xabde1a});if(_0x555284[_0x2f835b(0x20f)]>0x0)return(_0xabde1a?'Êé®Ëçê':'ÂèñÊ∂àÊé®Ëçê')+'ÂõæÁâáÊàêÂäüÔºÅ';throw new common_1[(_0x2f835b(0x22e))](_0x2f835b(0x220),common_1[_0x2f835b(0x22d)][_0x2f835b(0x1de)]);}async[_0x505326(0x1f9)](_0x1a150f,_0x421ecf){const _0x4c58ba=_0x505326,_0x176348=(0x0,utils_1['getReqSaasId'])(this[_0x4c58ba(0x1fd)]),{page:page=0x1,size:size=0x14,userId:_0x2ca818,keyword:_0x384e59,prompt:_0xdaa614,saasId:_0x47e3e2,modelType:_0x54acc0}=_0x1a150f;let _0x5dfd98=_0x4c58ba(0x205);_0x2ca818&&(_0x5dfd98=_0x5dfd98+(_0x4c58ba(0x250)+_0x2ca818));_0xdaa614&&(_0x5dfd98=_0x5dfd98+(_0x4c58ba(0x1f8)+_0xdaa614+'%\x27'));_0x54acc0&&(_0x5dfd98=_0x5dfd98+(_0x4c58ba(0x241)+_0x54acc0+'\x27'));(0x0,utils_1[_0x4c58ba(0x1e1)])(this[_0x4c58ba(0x1fd)])?(0x0,class_validator_1[_0x4c58ba(0x1bd)])(_0x47e3e2)&&(_0x5dfd98=_0x5dfd98+('\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.saasId\x20=\x20'+_0x47e3e2)):_0x5dfd98=_0x5dfd98+(_0x4c58ba(0x1ff)+_0x176348);_0x384e59&&(_0x5dfd98=_0x5dfd98+(_0x4c58ba(0x19e)+_0x384e59+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x384e59+_0x4c58ba(0x1ed)+_0x384e59+_0x4c58ba(0x207)+_0x384e59+_0x4c58ba(0x227)));const _0x5bfdc4=await this[_0x4c58ba(0x1c6)]['query'](_0x4c58ba(0x1a7)+_0x5dfd98+_0x4c58ba(0x216)),_0x4a2dc2=await this[_0x4c58ba(0x1c6)][_0x4c58ba(0x1b3)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20u.email\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20u.id\x20=\x20c.userId\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20'+_0x5dfd98+_0x4c58ba(0x236)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x4c58ba(0x1e5));return!(0x0,utils_1['isSuper'])(this[_0x4c58ba(0x1fd)])&&_0x4a2dc2[_0x4c58ba(0x199)](_0x2cab7c=>{const _0xcfa7f7=_0x4c58ba;_0x2cab7c[_0xcfa7f7(0x1c3)]=(0x0,utils_1[_0xcfa7f7(0x1d4)])(_0x2cab7c[_0xcfa7f7(0x1c3)]),_0x2cab7c['phone']=(0x0,utils_1['maskEmail'])(_0x2cab7c['phone']);}),{'rows':_0x4a2dc2,'count':Number(_0x5bfdc4[0x0]?.[_0x4c58ba(0x230)]||0x0)};}async['delChatLog'](_0x11b60e){const _0x4ba926=_0x505326;if(!_0x11b60e['ids']['length'])return!![];return await this[_0x4ba926(0x203)]['update']({'id':(0x0,typeorm_2['In'])(_0x11b60e[_0x4ba926(0x20b)])},{'isDelete':!![]}),!![];}async[_0x505326(0x1b8)](_0x1a5016,_0x5b3991){const _0x3c3565=_0x505326,{id:_0x3c40be}=_0x1a5016[_0x3c3565(0x234)],{groupId:_0x414351,logType:_0x7f146}=_0x5b3991,_0x46f9d9={'userId':_0x3c40be,'isDelete':![]};_0x414351&&Object[_0x3c3565(0x204)](_0x46f9d9,{'groupId':_0x414351}),_0x7f146&&Object['assign'](_0x46f9d9,{'logType':_0x7f146});const _0x4a46cf=await this[_0x3c3565(0x203)]['find']({'where':_0x46f9d9})[_0x3c3565(0x20d)](_0x48f2a4=>{const _0x916203=_0x3c3565;common_1['Logger'][_0x916203(0x23c)](_0x48f2a4);});if(!_0x4a46cf||_0x4a46cf[_0x3c3565(0x190)]===0x0)return[];return _0x4a46cf['map'](_0x44d35c=>{const _0x23b057=_0x3c3565,{prompt:_0x578beb,role:_0x25ccea,answer:_0x313e67,createdAt:_0x3da8f0,model:_0x1c2520,conversationOptions:_0x760664,requestOptions:_0x3ca6d1,id:_0x2a8aa3}=_0x44d35c;return{'chatId':_0x2a8aa3,'dateTime':(0x0,utils_1[_0x23b057(0x1c0)])(_0x3da8f0),'text':_0x25ccea===_0x23b057(0x234)?_0x578beb:_0x313e67,'inversion':_0x25ccea===_0x23b057(0x234),'error':![],'conversationOptions':_0x760664?JSON['parse'](_0x760664):null,'requestOptions':_0x3ca6d1?JSON[_0x23b057(0x213)](_0x3ca6d1):null};});}async[_0x505326(0x219)](_0x2cc970){const _0x4fcd16=_0x505326;return this[_0x4fcd16(0x203)]['find']({'where':{'groupId':_0x2cc970,'isDelete':![]}});}async['getMusicVoMap'](_0x1aade5,_0x5641e1,_0x3ff15d){const _0x2da1bd=_0x505326,_0x49a2e9=new Map();if(!_0x5641e1['length'])return _0x49a2e9;const _0x3c8a4d=await this[_0x2da1bd(0x1e0)]['find']({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x5641e1),'deleteFlag':0x0}}),_0x1c3232=_0x3c8a4d[_0x2da1bd(0x1f3)](_0x4306e5=>_0x4306e5['id']),_0x2b9279=await this[_0x2da1bd(0x240)]['getAgreeMap'](_0x1aade5,_0x1c3232,_0x3ff15d),_0x587fab=await this['aiLogService']['getExtByRelate'](_0x1c3232,_0x3ff15d);return _0x3c8a4d['forEach'](_0x4109d0=>{const _0x41b5c5=_0x2da1bd;!_0x49a2e9['has'](_0x4109d0[_0x41b5c5(0x215)])&&_0x49a2e9[_0x41b5c5(0x24d)](_0x4109d0[_0x41b5c5(0x215)],[]);const _0x564ecd=_0x587fab[_0x41b5c5(0x22f)](_0x4109d0['id']);_0x49a2e9[_0x41b5c5(0x22f)](_0x4109d0[_0x41b5c5(0x215)])[_0x41b5c5(0x1c5)]({..._0x4109d0,'agree':_0x2b9279[_0x41b5c5(0x22f)](_0x4109d0['id'])||null,'playNum':_0x564ecd?.['playNum']||0x0,'visitNum':_0x564ecd?.[_0x41b5c5(0x1eb)]||0x0,'agreeNum':_0x564ecd?.['agreeNum']||0x0});}),_0x49a2e9;}async[_0x505326(0x24b)](_0x3204a9,_0xdb6fec,_0x516c8d){const _0x116305=_0x505326;if(!_0xdb6fec[_0x116305(0x190)])return[];const _0x3b7776=await this[_0x116305(0x203)][_0x116305(0x1a5)]({'where':{'isDelete':![],'id':(0x0,typeorm_2['In'])(_0xdb6fec)}});if(!_0x3b7776[_0x116305(0x190)])return[];const _0x844f79=await this[_0x116305(0x1cb)](_0x3204a9[_0x116305(0x234)]['id'],_0xdb6fec,_0x516c8d);return _0x3b7776[_0x116305(0x1f3)](_0xae6063=>{const _0x8a3b74=_0x116305;return{..._0xae6063,'children':_0x844f79[_0x8a3b74(0x22f)](_0xae6063['id'])||[]};});}async[_0x505326(0x200)](_0x7a1d6b){const _0x2cfdc5=_0x505326;if(!_0x7a1d6b[_0x2cfdc5(0x190)])return[];return this[_0x2cfdc5(0x1e0)]['find']({'where':{'chatLogId':(0x0,typeorm_2['In'])(_0x7a1d6b)}});}async[_0x505326(0x196)](_0x5e1ce0,_0x96af4e){const _0x136a58=_0x505326;try{const _0xd61a9={'isDelete':![],'role':_0x136a58(0x1af),'userId':_0x5e1ce0['user']['id'],'modelType':_0x96af4e[_0x136a58(0x1e8)]},[_0xd63808,_0x284d9d]=await this[_0x136a58(0x203)][_0x136a58(0x1c7)]({'where':_0xd61a9,'take':_0x96af4e[_0x136a58(0x1ae)],'skip':(_0x96af4e[_0x136a58(0x197)]-0x1)*_0x96af4e[_0x136a58(0x1ae)],'order':{'createdAt':'DESC'}}),_0x1d066d=_0xd63808[_0x136a58(0x1f3)](_0x19c0e1=>_0x19c0e1['id']),_0xba8ef=await this[_0x136a58(0x1cb)](_0x5e1ce0[_0x136a58(0x234)]['id'],_0x1d066d,_0x96af4e['modelType']),_0x472cf7=_0xd63808[_0x136a58(0x1f3)](_0x55c1f9=>{return{..._0x55c1f9,'children':_0xba8ef['get'](_0x55c1f9['id'])||[]};});return{'count':_0x284d9d,'records':_0x472cf7};}catch(_0x7cd8fc){throw new common_1['HttpException'](_0x7cd8fc[_0x136a58(0x246)],common_1[_0x136a58(0x22d)][_0x136a58(0x1de)]);}}async[_0x505326(0x21a)](_0x4585ad,_0x5710a6){const _0x575507=_0x505326;if(!_0x5710a6[_0x575507(0x20b)][_0x575507(0x190)])return!![];return await this[_0x575507(0x1e0)][_0x575507(0x245)]({'userId':_0x4585ad['user']['id'],'id':(0x0,typeorm_2['In'])(_0x5710a6['ids'])},{'deleteFlag':0x1}),!![];}async[_0x505326(0x24c)](_0x5a41e2,_0x4cc3ce){const _0x4ecdc6=_0x505326;if(!_0x4cc3ce[_0x4ecdc6(0x20b)])return!![];return await this[_0x4ecdc6(0x1c6)][_0x4ecdc6(0x1b3)](_0x4ecdc6(0x22b)+_0x5a41e2['user']['id']+_0x4ecdc6(0x21c)+_0x4cc3ce[_0x4ecdc6(0x20b)][_0x4ecdc6(0x1d8)]()+_0x4ecdc6(0x224)),!![];}async[_0x505326(0x231)](_0x2fdc5a,_0x1d487d){const _0x4b09c9=_0x505326,_0x3a73d3=(0x0,utils_1[_0x4b09c9(0x1e6)])(this[_0x4b09c9(0x1fd)]);try{const {page:page=0x1,size:size=0x14,order:_0x2420d4,keyword:_0x2e9ae1,modelType:_0x12b3cd}=_0x1d487d;let _0x101567=_0x4b09c9(0x1b0);if(_0x2420d4==='playNum')_0x101567=_0x4b09c9(0x249);else _0x2420d4===_0x4b09c9(0x243)&&(_0x101567=_0x4b09c9(0x19c));const _0x17f8c0=await this[_0x4b09c9(0x1c6)][_0x4b09c9(0x1b3)](_0x4b09c9(0x1a3)+_0x12b3cd+_0x4b09c9(0x1c2)+(_0x2e9ae1?'AND\x20aa.title\x20LIKE\x20(\x27%'+_0x2e9ae1+_0x4b09c9(0x227):'')+_0x4b09c9(0x1a1)),_0x273f48=await this[_0x4b09c9(0x1c6)][_0x4b09c9(0x1b3)](_0x4b09c9(0x24f)+_0x12b3cd+_0x4b09c9(0x193)+_0x12b3cd+_0x4b09c9(0x1df)+(_0x2e9ae1?_0x4b09c9(0x21f)+_0x2e9ae1+_0x4b09c9(0x227):'')+_0x4b09c9(0x191)+_0x101567+_0x4b09c9(0x1b7)+size+_0x4b09c9(0x235)+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20'),_0x3890c1=_0x273f48[_0x4b09c9(0x1f3)](_0x1fabe5=>_0x1fabe5['id']),_0x28d9d4=await this[_0x4b09c9(0x240)][_0x4b09c9(0x226)](_0x3a73d3,_0x3890c1,_0x12b3cd);return _0x273f48[_0x4b09c9(0x199)](_0xd92c3b=>{const _0x47e092=_0x4b09c9;_0xd92c3b[_0x47e092(0x244)]=_0x28d9d4['get'](_0xd92c3b['id'])||null;}),{'records':_0x273f48,'count':Number(_0x17f8c0[0x0]?.['count']||0x0)};}catch(_0x361aaf){throw new common_1[(_0x4b09c9(0x22e))](_0x361aaf[_0x4b09c9(0x246)],common_1['HttpStatus'][_0x4b09c9(0x1de)]);}}async[_0x505326(0x1e7)](_0xcc15de,_0x29e294){const _0x55102c=_0x505326,{id:_0x23e522}=_0xcc15de[_0x55102c(0x234)],{groupId:_0x50ee08}=_0x29e294,_0x340f19={'userId':_0x23e522,'isDelete':![]};_0x50ee08&&Object[_0x55102c(0x204)](_0x340f19,{'groupId':_0x50ee08});const _0x207b75=await this[_0x55102c(0x203)][_0x55102c(0x1a5)]({'where':_0x340f19});return _0x207b75[_0x55102c(0x1f3)](_0x421ae9=>{const _0x2c100b=_0x55102c,{prompt:_0x242966,role:_0x14e6d9,answer:_0x4974d4,createdAt:_0x5005e2,model:_0x50ab21,conversationOptions:_0x260d1f,requestOptions:_0x4dd270,id:_0x7de64f}=_0x421ae9;return{'chatId':_0x7de64f,'dateTime':(0x0,utils_1[_0x2c100b(0x1c0)])(_0x5005e2),'text':_0x14e6d9==='user'?_0x242966:_0x4974d4,'inversion':_0x14e6d9===_0x2c100b(0x234),'error':![],'conversationOptions':_0x260d1f?JSON[_0x2c100b(0x213)](_0x260d1f):null,'requestOptions':_0x4dd270?JSON[_0x2c100b(0x213)](_0x4dd270):null};});}async['deleteChatLog'](_0x15a2a5,_0x3929d6){const _0x45de05=_0x505326,{id:_0x86a7d1}=_0x15a2a5[_0x45de05(0x234)],{id:_0x38fec6}=_0x3929d6,_0x260b40=await this[_0x45de05(0x203)]['findOne']({'where':{'id':_0x38fec6,'userId':_0x86a7d1}});if(!_0x260b40)throw new common_1['HttpException'](_0x45de05(0x22c),common_1['HttpStatus'][_0x45de05(0x1de)]);const _0x2a6072=await this[_0x45de05(0x203)]['update']({'id':_0x38fec6},{'isDelete':!![]});if(_0x2a6072[_0x45de05(0x20f)]>0x0)return _0x45de05(0x1d5);else throw new common_1[(_0x45de05(0x22e))](_0x45de05(0x22c),common_1[_0x45de05(0x22d)][_0x45de05(0x1de)]);}async[_0x505326(0x1f0)](_0x5a9370,_0x1d1d3a){const _0x5ed386=_0x505326,{groupId:_0xc7c1e1,type:_0x37da51}=_0x1d1d3a,{id:_0xad466f}=_0x5a9370[_0x5ed386(0x234)],_0x111d50=_0x37da51&&_0x37da51===_0x5ed386(0x1da)?{'groupId':_0xc7c1e1,'userId':_0xad466f}:{'groupId':_0xc7c1e1,'userId':_0xad466f},_0x43f27d=await this[_0x5ed386(0x203)][_0x5ed386(0x1fb)](_0x111d50);if(_0x43f27d[_0x5ed386(0x20f)]>0x0)return!![];if(_0x43f27d[_0x5ed386(0x20f)]===0x0)throw new common_1[(_0x5ed386(0x22e))]('ÂΩìÂâçÈ°µÈù¢Â∑≤ÁªèÊ≤°Êúâ‰∏úË•øÂèØ‰ª•Âà†Èô§‰∫ÜÔºÅ',common_1['HttpStatus'][_0x5ed386(0x1de)]);}async[_0x505326(0x1b1)](_0x52272e){const _0x1c1ad6=_0x505326,{ids:_0x5edb5c,userId:_0x3c2682}=_0x52272e;return await this[_0x1c1ad6(0x203)]['delete']({'groupId':(0x0,typeorm_2['In'])(_0x5edb5c),'userId':_0x3c2682});}async[_0x505326(0x19b)](_0x46d004,_0xeefe5e){const _0x5299bb=_0x505326,{id:_0x1e8ab5}=_0x46d004['user'],{appId:_0x4e4d97,page:page=0x1,size:size=0xa}=_0xeefe5e,[_0x3db0c8,_0x15960b]=await this[_0x5299bb(0x203)]['findAndCount']({'where':{'userId':_0x1e8ab5,'appId':_0x4e4d97,'role':_0x5299bb(0x1af)},'order':{'id':'DESC'},'take':size,'skip':(page-0x1)*size});return{'rows':_0x3db0c8,'count':_0x15960b};}async[_0x505326(0x210)](){const _0x30248a=_0x505326,_0x373ead=await this[_0x30248a(0x1c6)][_0x30248a(0x1b3)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.*\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x20c\x0a\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20ai_assets\x20aa\x20ON\x20aa.chat_log_id\x20=\x20c.id\x20\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.modelType\x20=\x20\x27video\x27\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20c.errMsg\x20IS\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20c.answer\x20IN\x20(\x20\x27pending\x27,\x20\x27processing\x27\x20)\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20OR\x20(\x20c.answer\x20=\x20\x27completed\x27\x20AND\x20aa.mp4\x20IS\x20NULL\x20))\x0a\x20\x20\x20\x20');return _0x373ead;}async[_0x505326(0x1c8)](_0xe7e9ce){const _0x17c0ec=_0x505326;console['log'](_0x17c0ec(0x194),_0xe7e9ce);const _0x3831c7=await this[_0x17c0ec(0x1e0)][_0x17c0ec(0x24a)]({'where':{'sunoMusicId':_0xe7e9ce['id']}});if(!_0x3831c7)throw new Error('ËµÑÊ∫ê‰∏çÂ≠òÂú®ÔºÅ');const _0x13e83e=await this[_0x17c0ec(0x203)][_0x17c0ec(0x24a)]({'where':{'id':_0x3831c7['chatLogId']}});_0x13e83e[_0x17c0ec(0x228)]=_0xe7e9ce[_0x17c0ec(0x1ef)],_0x3831c7[_0x17c0ec(0x1bc)]=_0xe7e9ce[_0x17c0ec(0x1cc)]?.[_0x17c0ec(0x1e2)],await this[_0x17c0ec(0x203)][_0x17c0ec(0x23b)](_0x13e83e),await this[_0x17c0ec(0x1e0)]['save'](_0x3831c7),_0x13e83e['answer']===_0x17c0ec(0x248)&&_0x3831c7[_0x17c0ec(0x1bc)]&&this[_0x17c0ec(0x21d)](_0x3831c7);}async['syncVideo'](_0x535323){const _0x5e684c=_0x505326,[_0x2bbeaa,_0x117220]=await this[_0x5e684c(0x214)][_0x5e684c(0x1ea)](_0x535323[_0x5e684c(0x1bc)]);_0x535323[_0x5e684c(0x1bc)]=_0x2bbeaa,_0x535323[_0x5e684c(0x1ca)]=_0x117220,await this[_0x5e684c(0x1e0)][_0x5e684c(0x23b)](_0x535323);}async['syncAssets'](){const _0x29910c=_0x505326,_0x1da397=await this['aiAssetsEntity'][_0x29910c(0x1a5)]({'where':[{'cover':(0x0,typeorm_2[_0x29910c(0x1ab)])(_0x29910c(0x1d9))},{'mp3':(0x0,typeorm_2[_0x29910c(0x1ab)])(_0x29910c(0x1d9))},{'mp4':(0x0,typeorm_2[_0x29910c(0x1ab)])(_0x29910c(0x1d9))},{'mp4':(0x0,typeorm_2[_0x29910c(0x1ab)])(_0x29910c(0x212))}]});for(let _0x4a567c=0x0;_0x4a567c<_0x1da397[_0x29910c(0x190)];_0x4a567c++){const _0x5cdb02=_0x1da397[_0x4a567c],_0x1bf92b=redisKey_constant_1['MUSIC_TRANSFER']+_0x5cdb02['id'];try{const _0x32b7dc=await this[_0x29910c(0x1d6)]['get']({'key':_0x1bf92b});if(_0x32b7dc)continue;await this[_0x29910c(0x1d6)][_0x29910c(0x24d)]({'key':_0x1bf92b,'val':_0x29910c(0x1ce)});const {cover:_0xebfc46,mp3:_0x2c81ee,mp4:_0x1b713f}=_0x5cdb02;/filesystem.site/[_0x29910c(0x18d)](_0xebfc46)&&(_0x5cdb02[_0x29910c(0x1ca)]=await this[_0x29910c(0x214)][_0x29910c(0x218)](_0xebfc46));/filesystem.site/[_0x29910c(0x18d)](_0x2c81ee)&&(_0x5cdb02[_0x29910c(0x1dd)]=await this[_0x29910c(0x214)][_0x29910c(0x218)](_0x2c81ee));if(/filesystem.site|storage.cdn-luma.com/[_0x29910c(0x18d)](_0x1b713f)){if(_0xebfc46)_0x5cdb02[_0x29910c(0x1bc)]=await this[_0x29910c(0x214)][_0x29910c(0x218)](_0x1b713f);else{const [_0x1a6b86,_0x58c8e2]=await this['fileService'][_0x29910c(0x1ea)](_0x1b713f);_0x5cdb02['mp4']=_0x1a6b86,_0x5cdb02[_0x29910c(0x1ca)]=_0x58c8e2;}}await this[_0x29910c(0x1e0)]['save'](_0x5cdb02);}catch(_0x42daf3){common_1['Logger'][_0x29910c(0x23c)](_0x42daf3);}finally{await this['redisCacheService']['del']({'key':_0x1bf92b});}}}async[_0x505326(0x211)](_0x32350a,_0x50dd67){const _0x22804a=_0x505326,_0xf48c24=await this['chatLogEntity'][_0x22804a(0x1b3)]('\x0a\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20appId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20MAX(\x20createdAt\x20)\x20AS\x20createdAt\x20\x0a\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20chatlog\x0a\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20userId\x20=\x20'+_0x32350a+_0x22804a(0x1ec)+_0x50dd67['join']()+_0x22804a(0x202));return _0xf48c24;}};function _0x528e(_0x5a82a6,_0x492bb4){const _0xdaa869=_0xdaa8();return _0x528e=function(_0x528e92,_0x35ef3f){_0x528e92=_0x528e92-0x18d;let _0x50e7e1=_0xdaa869[_0x528e92];return _0x50e7e1;},_0x528e(_0x5a82a6,_0x492bb4);}ChatLogService=__decorate([(0x0,common_1[_0x505326(0x21e)])(),__param(0x0,(0x0,typeorm_1[_0x505326(0x1ba)])(chatLog_entity_1['ChatLogEntity'])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(aiAssets_entity_1[_0x505326(0x233)])),__metadata(_0x505326(0x209),[typeorm_2['Repository'],typeorm_2['Repository'],nestjs_cls_1['ClsService'],file_service_1[_0x505326(0x1cf)],aiLog_service_1[_0x505326(0x221)],redisCache_service_1['RedisCacheService'],typeorm_2[_0x505326(0x1b6)]])],ChatLogService),exports[_0x505326(0x1ee)]=ChatLogService;