'use strict';const _0x41836a=_0x1440;(function(_0x34eb29,_0x102289){const _0x413ab5=_0x1440,_0x120ddf=_0x34eb29();while(!![]){try{const _0x4db998=-parseInt(_0x413ab5(0x88))/0x1+-parseInt(_0x413ab5(0x119))/0x2*(-parseInt(_0x413ab5(0xd4))/0x3)+parseInt(_0x413ab5(0x165))/0x4*(parseInt(_0x413ab5(0x156))/0x5)+-parseInt(_0x413ab5(0x118))/0x6+-parseInt(_0x413ab5(0x104))/0x7*(-parseInt(_0x413ab5(0x138))/0x8)+parseInt(_0x413ab5(0x93))/0x9*(parseInt(_0x413ab5(0x13d))/0xa)+-parseInt(_0x413ab5(0x162))/0xb*(-parseInt(_0x413ab5(0xb9))/0xc);if(_0x4db998===_0x102289)break;else _0x120ddf['push'](_0x120ddf['shift']());}catch(_0x53c030){_0x120ddf['push'](_0x120ddf['shift']());}}}(_0x2337,0x562d2));var __decorate=this&&this[_0x41836a(0x140)]||function(_0x243e5c,_0x1606f4,_0x4eb9ca,_0x3cecc9){const _0x5ac741=_0x41836a;var _0x25ca24=arguments[_0x5ac741(0x116)],_0x1f046e=_0x25ca24<0x3?_0x1606f4:_0x3cecc9===null?_0x3cecc9=Object[_0x5ac741(0xf7)](_0x1606f4,_0x4eb9ca):_0x3cecc9,_0x809d97;if(typeof Reflect==='object'&&typeof Reflect[_0x5ac741(0xb7)]===_0x5ac741(0x154))_0x1f046e=Reflect[_0x5ac741(0xb7)](_0x243e5c,_0x1606f4,_0x4eb9ca,_0x3cecc9);else{for(var _0x417c23=_0x243e5c[_0x5ac741(0x116)]-0x1;_0x417c23>=0x0;_0x417c23--)if(_0x809d97=_0x243e5c[_0x417c23])_0x1f046e=(_0x25ca24<0x3?_0x809d97(_0x1f046e):_0x25ca24>0x3?_0x809d97(_0x1606f4,_0x4eb9ca,_0x1f046e):_0x809d97(_0x1606f4,_0x4eb9ca))||_0x1f046e;}return _0x25ca24>0x3&&_0x1f046e&&Object[_0x5ac741(0x15c)](_0x1606f4,_0x4eb9ca,_0x1f046e),_0x1f046e;},__metadata=this&&this[_0x41836a(0xf8)]||function(_0x21346e,_0x40b107){const _0x282ce1=_0x41836a;if(typeof Reflect===_0x282ce1(0xd9)&&typeof Reflect[_0x282ce1(0xc3)]===_0x282ce1(0x154))return Reflect[_0x282ce1(0xc3)](_0x21346e,_0x40b107);},__param=this&&this[_0x41836a(0xb8)]||function(_0x1aa233,_0x4fe643){return function(_0x578759,_0x34ac7c){_0x4fe643(_0x578759,_0x34ac7c,_0x1aa233);};};Object[_0x41836a(0x15c)](exports,'__esModule',{'value':!![]}),exports[_0x41836a(0xfc)]=void 0x0;const globalConfig_service_1=require(_0x41836a(0x114)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require(_0x41836a(0xaa)),user_entity_1=require(_0x41836a(0x123)),common_1=require(_0x41836a(0x135)),jwt_1=require(_0x41836a(0xbf)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x41836a(0xd6)),user_constant_1=require(_0x41836a(0x131)),utils_1=require(_0x41836a(0x10a)),redisCache_service_1=require('../redisCache/redisCache.service'),svgCaptcha=require('svg-captcha'),bcrypt=require('bcryptjs'),store_1=require(_0x41836a(0x106)),axios_1=require(_0x41836a(0x103)),redisKey_constant_1=require(_0x41836a(0x126)),Login_vo_1=require(_0x41836a(0x120)),WeAppLogin_vo_1=require('./vo/WeAppLogin.vo'),typeorm_1=require('@nestjs/typeorm'),typeorm_2=require(_0x41836a(0x113)),nestjs_cls_1=require(_0x41836a(0xcb)),role_entity_1=require(_0x41836a(0x108)),Role_constant_1=require(_0x41836a(0x163));let AuthService=class AuthService{constructor(_0x311845,_0x249cf8,_0x4c4ead,_0x5e2ed9,_0x2f42c3,_0x3744a6,_0x543879,_0x4485dd,_0xe0092){const _0x3282f3=_0x41836a;this[_0x3282f3(0xc7)]=_0x311845,this[_0x3282f3(0x9a)]=_0x249cf8,this[_0x3282f3(0x90)]=_0x4c4ead,this[_0x3282f3(0x8e)]=_0x5e2ed9,this[_0x3282f3(0x101)]=_0x2f42c3,this[_0x3282f3(0x13a)]=_0x3744a6,this[_0x3282f3(0x112)]=_0x543879,this[_0x3282f3(0xe9)]=_0x4485dd,this[_0x3282f3(0x91)]=_0xe0092;}[_0x41836a(0x102)](_0x55d933){const _0x5f2531=_0x41836a,{id:_0x56c844,username:_0x263fb4,role:_0x214fd3,openId:_0x1e6bce,email:_0x5c977d,client:_0x200610,saasId:_0x261286}=_0x55d933;return this['jwtService'][_0x5f2531(0xca)]({'id':_0x56c844,'username':_0x263fb4,'role':_0x214fd3,'openId':_0x1e6bce,'email':_0x5c977d,'client':_0x200610,'saasId':_0x261286});}async['loginByAdmin'](_0xbc4fa1){const _0xe28e30=_0x41836a,{username:_0xa12317,password:_0x49e92b}=_0xbc4fa1;if(!_0xa12317||!_0x49e92b)throw new common_1['HttpException']('账号密码或密码错误',common_1[_0xe28e30(0xce)][_0xe28e30(0x130)]);const _0x737378=await this[_0xe28e30(0x101)][_0xe28e30(0x10d)](_0xa12317);if(!_0x737378)throw new common_1[(_0xe28e30(0x85))](_0xe28e30(0x115),common_1[_0xe28e30(0xce)][_0xe28e30(0x130)]);if((0x0,utils_1[_0xe28e30(0xef)])(_0x49e92b,_0x737378[_0xe28e30(0x137)]))throw new common_1[(_0xe28e30(0x85))]('用户名或密码错误',common_1[_0xe28e30(0xce)][_0xe28e30(0x130)]);return this[_0xe28e30(0x102)](_0x737378);}async[_0x41836a(0x96)](_0x1ad37e,_0x4e334d){const _0x3d6cde=_0x41836a,_0x24b790=await this[_0x3d6cde(0x91)]['getConfigByKeys']([_0x3d6cde(0x14e),'registerSuccessEmailTeamName','registerSuccessEmaileAppend','registerFailEmailTitle',_0x3d6cde(0xed)]);try{const _0x7e8e32=await this[_0x3d6cde(0xe9)]['verifyCode'](_0x1ad37e,verification_constant_1['VerificationEnum']['ChangeEmail']),{type:_0x24b535,userId:_0x2a1101}=_0x7e8e32;if(_0x24b535!==verification_constant_1['VerificationEnum'][_0x3d6cde(0xa3)])throw new common_1['HttpException'](_0x3d6cde(0x148),common_1[_0x3d6cde(0xce)][_0x3d6cde(0x130)]);let _0x2c2fb3=await this[_0x3d6cde(0xc7)]['findOne']({'where':{'id':_0x2a1101}});_0x2c2fb3[_0x3d6cde(0xb2)]=_0x1ad37e[_0x3d6cde(0xb2)],_0x2c2fb3=await this[_0x3d6cde(0xc7)][_0x3d6cde(0xea)](_0x2c2fb3);const {id:_0x27ed6b,username:_0x561595,email:_0x2d9b66}=_0x2c2fb3;_0x4e334d[_0x3d6cde(0x133)](_0x3d6cde(0xa1)+_0x27ed6b[_0x3d6cde(0xc6)]()[_0x3d6cde(0x151)](0x4,'0')+'&username='+_0x561595+'&email='+_0x2d9b66+_0x3d6cde(0x9b)+_0x24b790[_0x3d6cde(0x14e)]+'&registerSuccessEmailTeamName='+_0x24b790[_0x3d6cde(0x94)]+_0x3d6cde(0x11b)+_0x24b790['registerSuccessEmaileAppend']);}catch(_0x5adc10){const _0x84ad2b=_0x5adc10['response'];_0x4e334d[_0x3d6cde(0x133)](_0x3d6cde(0xe4)+_0x84ad2b+_0x3d6cde(0x155)+_0x24b790['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x24b790['registerFailEmailTeamName']);}}async[_0x41836a(0x86)](_0x39125f){const _0x2fe67e=_0x41836a,_0x55c994=await this[_0x2fe67e(0x91)][_0x2fe67e(0x166)](),{color:color=_0x2fe67e(0xc8)}=_0x39125f,_0x6f9379=svgCaptcha['createMathExpr']({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x5bb55d=_0x6f9379['text'],_0x48d981=(0x0,utils_1[_0x2fe67e(0xd3)])(),_0x115823=_0x55c994+_0x2fe67e(0xbc)+_0x48d981;return await this[_0x2fe67e(0x112)]['set']({'key':_0x115823,'val':_0x6f9379[_0x2fe67e(0x152)]},0x5*0x3c),{'svgCode':_0x6f9379['data'],'code':_0x48d981};}async[_0x41836a(0xbb)](_0x363644){const _0x233ea7=_0x41836a;_0x363644[_0x233ea7(0x159)]&&await this[_0x233ea7(0xe9)][_0x233ea7(0xfa)](_0x363644);const {phone:_0x31a78b}=_0x363644,_0x43fd59=await this[_0x233ea7(0x91)][_0x233ea7(0x166)](),_0x544db1=_0x43fd59+_0x233ea7(0xec)+_0x31a78b,_0x5c2f35=await this['redisCacheService'][_0x233ea7(0xe1)](_0x544db1);if(_0x5c2f35&&_0x5c2f35>0x0)throw new common_1[(_0x233ea7(0x85))](_0x5c2f35+'秒内不得重复发送短信！',common_1[_0x233ea7(0xce)][_0x233ea7(0x130)]);const _0x4ffe07=(0x0,utils_1[_0x233ea7(0x10c)])(),_0x3dbd3e={'phone':_0x31a78b,'code':_0x4ffe07};return await this['verificationService'][_0x233ea7(0xbb)](_0x3dbd3e),await this[_0x233ea7(0x112)][_0x233ea7(0x125)]({'key':_0x544db1,'val':_0x4ffe07},0x1*0x3c),_0x233ea7(0x150);}async[_0x41836a(0x117)](_0x72db64){const _0x5a0145=_0x41836a;try{var _0x3699e5=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x3699e5[_0x5a0145(0x109)](_0x72db64))throw new Error(_0x5a0145(0x12a));const _0x238882=await this[_0x5a0145(0xc7)][_0x5a0145(0x95)]({'where':{'email':_0x72db64}});if(_0x238882)throw new Error(_0x5a0145(0x107));const _0x506c89=await this[_0x5a0145(0x91)][_0x5a0145(0xab)]([_0x5a0145(0x11f),_0x5a0145(0xcc),_0x5a0145(0xff),_0x5a0145(0x14d),_0x5a0145(0x10b)]),_0x2c6f99=(0x0,utils_1[_0x5a0145(0x10c)])(),_0x34fd92=_0x506c89[_0x5a0145(0x10b)]?Number(_0x506c89[_0x5a0145(0x10b)]):0x1e*0x3c;await this['redisCacheService'][_0x5a0145(0x125)]({'key':redisKey_constant_1[_0x5a0145(0x161)]+_0x72db64,'val':_0x2c6f99},_0x34fd92*0x3c),await this[_0x5a0145(0x13a)][_0x5a0145(0x147)]({'to':_0x72db64,'template':_0x5a0145(0xa2),'subject':'来自'+_0x506c89[_0x5a0145(0x14d)]+'的注册验证','context':{'baseUrl':_0x506c89[_0x5a0145(0x11f)],'code':_0x2c6f99,..._0x506c89}});}catch(_0x1717c6){throw new common_1[(_0x5a0145(0x85))](_0x1717c6[_0x5a0145(0x100)],common_1[_0x5a0145(0xce)][_0x5a0145(0x130)]);}}async[_0x41836a(0xc4)](_0x37dde6){const _0xfbe453=_0x41836a;try{const _0x5b9af5=await this[_0xfbe453(0x112)][_0xfbe453(0xd8)]({'key':redisKey_constant_1[_0xfbe453(0x149)]}),_0x92b045=await axios_1['default']['post'](_0xfbe453(0xd5)+_0x5b9af5,{'code':_0x37dde6});if(_0x92b045[_0xfbe453(0xdb)][_0xfbe453(0x145)])throw new Error(_0x92b045[_0xfbe453(0xdb)][_0xfbe453(0x10f)]);return _0x92b045['data']['phone_info']['purePhoneNumber'];}catch(_0x1d3c78){common_1[_0xfbe453(0x87)][_0xfbe453(0x121)](_0xfbe453(0x13c),_0x1d3c78);throw new common_1[(_0xfbe453(0x85))](_0x1d3c78['message'],common_1[_0xfbe453(0xce)]['BAD_REQUEST']);}}async['phoneWithOpenId4regist'](_0x16121a){const _0x19d136=_0x41836a;try{if(!_0x16121a[_0x19d136(0xd7)]&&!_0x16121a[_0x19d136(0xa7)]&&!_0x16121a[_0x19d136(0xb6)])throw new Error(_0x19d136(0x134));let _0x3ecaca=_0x19d136(0xd7),_0x26ea6f={};if(_0x16121a[_0x19d136(0xd7)])_0x3ecaca=_0x19d136(0xd7);else _0x16121a[_0x19d136(0xa7)]?_0x3ecaca=_0x19d136(0xa7):_0x3ecaca='weAppOpenId';_0x26ea6f[_0x3ecaca]=_0x16121a[_0x3ecaca];const _0x3b7284=await this[_0x19d136(0xc7)][_0x19d136(0x95)]({'where':_0x26ea6f});if(_0x3b7284&&_0x3b7284['phone'])return![];const _0x1625c6=await this[_0x19d136(0xc7)][_0x19d136(0x95)]({'where':{'phone':_0x16121a[_0x19d136(0x168)]}});if(_0x1625c6)return!_0x1625c6[_0x3ecaca];return!![];}catch(_0x20a1b2){throw new common_1[(_0x19d136(0x85))](_0x20a1b2[_0x19d136(0x100)],common_1[_0x19d136(0xce)][_0x19d136(0x130)]);}}async['registeV3'](_0x5d2e86,_0x35ebfd){const _0x321425=_0x41836a,_0x34c780=(0x0,utils_1[_0x321425(0xa4)])(this[_0x321425(0x90)]);try{if(_0x5d2e86[_0x321425(0x8c)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/['test'](_0x5d2e86[_0x321425(0x8c)]))throw new Error(_0x321425(0xee));if(!_0x5d2e86[_0x321425(0x137)])throw new Error(_0x321425(0x129));}else{if(!_0x5d2e86[_0x321425(0xd7)]&&!_0x5d2e86[_0x321425(0xa7)]&&!_0x5d2e86[_0x321425(0xb6)])throw new Error(_0x321425(0x11a));}if(_0x5d2e86[_0x321425(0x168)]&&!_0x5d2e86[_0x321425(0xde)])throw new Error(_0x321425(0xf2));let _0x518997=null;if(_0x5d2e86[_0x321425(0x168)])await this[_0x321425(0xe3)](_0x5d2e86[_0x321425(0x168)],_0x5d2e86['phoneCode']),_0x518997=await this['userEntity']['findOne']({'where':{'phone':_0x5d2e86[_0x321425(0x168)],'saasId':_0x34c780}});else{if(_0x5d2e86['openId']||_0x5d2e86[_0x321425(0xa7)]||_0x5d2e86['weAppOpenId']){let _0x2f53d2=_0x321425(0xd7),_0x1fff2b={'saasId':_0x34c780};if(_0x5d2e86['openId'])_0x2f53d2=_0x321425(0xd7);else _0x5d2e86[_0x321425(0xa7)]?_0x2f53d2=_0x321425(0xa7):_0x2f53d2=_0x321425(0xb6);_0x1fff2b[_0x2f53d2]=_0x5d2e86[_0x2f53d2],_0x518997=await this[_0x321425(0xc7)]['findOne']({'where':_0x1fff2b});if(_0x518997)throw new Error(_0x321425(0xc2));}else{_0x518997=await this[_0x321425(0xc7)][_0x321425(0x95)]({'where':{'username':_0x5d2e86[_0x321425(0x8c)],'saasId':_0x34c780}});if(_0x518997)throw new Error(_0x321425(0xc2));}}const _0x5e4864=new user_entity_1[(_0x321425(0x97))]();for(let _0x5cf46d in _0x5d2e86){_0x5d2e86[_0x5cf46d]&&(_0x5e4864[_0x5cf46d]=_0x5d2e86[_0x5cf46d]);}_0x518997?_0x5e4864['id']=_0x518997['id']:(_0x5e4864[_0x321425(0x137)]&&(_0x5e4864['password']=bcrypt[_0x321425(0x153)](_0x5d2e86['password'],0xa)),_0x5e4864[_0x321425(0xe2)]=user_constant_1['UserStatusEnum'][_0x321425(0xb3)],!_0x5e4864[_0x321425(0xba)]&&(_0x5e4864[_0x321425(0xba)]=_0x5e4864[_0x321425(0xba)]||'小智'),!_0x5e4864[_0x321425(0x142)]&&(_0x5e4864[_0x321425(0x142)]=await this[_0x321425(0x91)][_0x321425(0xab)]([_0x321425(0xda)])));_0x5e4864[_0x321425(0xd2)]=_0x34c780;const _0x4c85=await this['userService'][_0x321425(0x15e)](_0x5e4864);!_0x518997&&this[_0x321425(0xa9)](_0x4c85,_0x5d2e86['invitedBy']);const _0x2638e8=(0x0,utils_1[_0x321425(0x110)])(_0x35ebfd),_0x311a6e=this[_0x321425(0x102)](_0x4c85);return await this[_0x321425(0x101)][_0x321425(0xad)](_0x4c85['id'],_0x2638e8),await this[_0x321425(0x112)]['saveToken'](_0x4c85['id'],_0x311a6e),_0x311a6e;}catch(_0x20c53e){if(_0x20c53e instanceof common_1[_0x321425(0x85)])throw _0x20c53e;else throw new common_1['HttpException'](_0x20c53e[_0x321425(0x100)],common_1[_0x321425(0xce)]['BAD_REQUEST']);}}async['loginByPhoneV3'](_0x47bc78,_0x23a90d){const _0x23c7b7=_0x41836a,_0x338991=(0x0,utils_1[_0x23c7b7(0xa4)])(this['clsService']);await this['validatePhoneCode'](_0x47bc78[_0x23c7b7(0x168)],_0x47bc78[_0x23c7b7(0xde)]);let _0x5d3cfe=await this[_0x23c7b7(0xc7)]['findOne']({'where':{'phone':_0x47bc78[_0x23c7b7(0x168)],'saasId':_0x338991}});if(!_0x5d3cfe){const _0x4ed796=new user_entity_1[(_0x23c7b7(0x97))]();_0x4ed796[_0x23c7b7(0x168)]=_0x47bc78['phone'],_0x4ed796[_0x23c7b7(0xba)]=_0x47bc78[_0x23c7b7(0x168)],_0x4ed796[_0x23c7b7(0xe2)]=user_constant_1[_0x23c7b7(0x111)]['ACTIVE'],_0x4ed796[_0x23c7b7(0x142)]=await this[_0x23c7b7(0x91)][_0x23c7b7(0xab)]([_0x23c7b7(0xda)]),_0x5d3cfe=await this[_0x23c7b7(0x101)][_0x23c7b7(0x15e)](_0x4ed796),this[_0x23c7b7(0xa9)](_0x5d3cfe,_0x47bc78['invitedBy']);}const _0x3dda64=(0x0,utils_1['getClientIp'])(_0x23a90d),_0x381874=this[_0x23c7b7(0x102)](_0x5d3cfe);return await this[_0x23c7b7(0x101)][_0x23c7b7(0xad)](_0x5d3cfe['id'],_0x3dda64),await this['redisCacheService'][_0x23c7b7(0xd0)](_0x5d3cfe['id'],_0x381874),_0x381874;}async[_0x41836a(0xf3)](_0x51c3e0,_0x21135e){const _0x21bbe2=_0x41836a;try{const _0x15cbdd=(0x0,utils_1[_0x21bbe2(0xa4)])(this['clsService']),_0xc8a55d=await this[_0x21bbe2(0xc7)][_0x21bbe2(0x95)]({'where':[{'username':_0x51c3e0[_0x21bbe2(0x8c)],'saasId':_0x15cbdd},{'email':_0x51c3e0['username'],'saasId':_0x15cbdd},{'phone':_0x51c3e0['username'],'saasId':_0x15cbdd}]});if(!_0xc8a55d)throw new Error(_0x21bbe2(0x15d));if(!_0xc8a55d[_0x21bbe2(0x137)])throw new Error(_0x21bbe2(0x15d));if(!bcrypt[_0x21bbe2(0x13f)](_0x51c3e0[_0x21bbe2(0x137)],_0xc8a55d['password']))throw new Error(_0x21bbe2(0x15d));_0xc8a55d[_0x21bbe2(0x8c)]&&!_0xc8a55d['lastLoginIp']&&await this[_0x21bbe2(0x101)][_0x21bbe2(0x9d)](_0xc8a55d);const _0x147ebc=(0x0,utils_1[_0x21bbe2(0x110)])(_0x21135e),_0x110525=this[_0x21bbe2(0x102)](_0xc8a55d);await this[_0x21bbe2(0x101)][_0x21bbe2(0xad)](_0xc8a55d['id'],_0x147ebc),await this['redisCacheService'][_0x21bbe2(0xd0)](_0xc8a55d['id'],_0x110525);if((0x0,utils_1['shouldAccess'])(_0xc8a55d[_0x21bbe2(0x132)])){let _0x2b4e1d;_0xc8a55d[_0x21bbe2(0x132)]===Role_constant_1[_0x21bbe2(0x158)][_0x21bbe2(0x13b)]?_0x2b4e1d=await this[_0x21bbe2(0x9a)][_0x21bbe2(0x95)]({'where':{'code':_0xc8a55d['role']}}):_0x2b4e1d=await this[_0x21bbe2(0x9a)][_0x21bbe2(0x95)]({'where':{'code':_0xc8a55d[_0x21bbe2(0x132)],'saasId':_0x15cbdd}});if(!_0x2b4e1d)throw new Error('角色信息异常！');await this[_0x21bbe2(0x112)][_0x21bbe2(0x125)]({'key':_0x21bbe2(0x15a)+_0xc8a55d['id'],'val':_0x2b4e1d[_0x21bbe2(0xb0)]});}return _0x110525;}catch(_0x656c12){throw new common_1[(_0x21bbe2(0x85))](_0x656c12['message'],common_1[_0x21bbe2(0xce)]['BAD_REQUEST']);}}async[_0x41836a(0xcd)](_0x505cd2){const _0x22f667=_0x41836a;try{const _0x526c83=new Login_vo_1[(_0x22f667(0xd1))](),_0x5e260d=(0x0,utils_1[_0x22f667(0xa4)])(this[_0x22f667(0x90)]),_0x4a97f3=await axios_1[_0x22f667(0xd1)][_0x22f667(0xd8)](_0x22f667(0xac),{'params':{'appid':store_1[_0x22f667(0x10e)][_0x22f667(0x164)],'secret':store_1[_0x22f667(0x10e)][_0x22f667(0x8a)],'js_code':_0x505cd2,'grant_type':'authorization_code'}}),_0x13bb1a=_0x4a97f3[_0x22f667(0xdb)];if(_0x13bb1a['errcode'])throw new Error(_0x13bb1a[_0x22f667(0x10f)]);const _0x18841c=await this[_0x22f667(0xc7)][_0x22f667(0x95)]({'where':{'miniOpenId':_0x13bb1a[_0x22f667(0x157)],'saasId':_0x5e260d}});return!_0x18841c?this[_0x22f667(0x112)][_0x22f667(0x125)]({'key':redisKey_constant_1[_0x22f667(0xe6)]+_0x13bb1a[_0x22f667(0x157)],'val':_0x13bb1a[_0x22f667(0x128)]||null}):(_0x526c83[_0x22f667(0x12c)]=this[_0x22f667(0x102)](_0x18841c),await this[_0x22f667(0x112)][_0x22f667(0xd0)](_0x18841c['id'],_0x526c83['authToken'])),_0x526c83[_0x22f667(0x157)]=_0x13bb1a['openid'],_0x526c83;}catch(_0x27bddd){common_1[_0x22f667(0x87)]['error'](_0x22f667(0xe5),_0x27bddd);throw new common_1[(_0x22f667(0x85))](_0x27bddd[_0x22f667(0x100)],common_1['HttpStatus'][_0x22f667(0x130)]);}}async[_0x41836a(0x122)](_0x34e613){const _0x2c4e60=_0x41836a,_0x18d66e=new WeAppLogin_vo_1[(_0x2c4e60(0x9c))](),_0x3d06e5=(0x0,utils_1[_0x2c4e60(0xa4)])(this[_0x2c4e60(0x90)]);try{const _0x1ffb51=await axios_1[_0x2c4e60(0xd1)][_0x2c4e60(0xd8)](_0x2c4e60(0x12b)+store_1[_0x2c4e60(0x10e)]['WE_APP_APPID']+_0x2c4e60(0xeb)+store_1[_0x2c4e60(0x10e)]['WE_APP_APPSECRET']+_0x2c4e60(0xfb)+_0x34e613+_0x2c4e60(0x105));if(_0x1ffb51['data'][_0x2c4e60(0x145)])throw new Error(_0x1ffb51['data'][_0x2c4e60(0x10f)]);const _0x193916=_0x1ffb51[_0x2c4e60(0xdb)],_0x3c3e38=await this[_0x2c4e60(0xc7)][_0x2c4e60(0x95)]({'where':{'weAppOpenId':_0x193916[_0x2c4e60(0x157)],'saasId':_0x3d06e5}});return!_0x3c3e38?this[_0x2c4e60(0x112)][_0x2c4e60(0x125)]({'key':redisKey_constant_1[_0x2c4e60(0x141)]+_0x193916[_0x2c4e60(0x157)],'val':_0x193916[_0x2c4e60(0x128)]||null}):(_0x18d66e[_0x2c4e60(0x12c)]=this[_0x2c4e60(0x102)](_0x3c3e38),await this[_0x2c4e60(0x112)][_0x2c4e60(0xd0)](_0x3c3e38['id'],_0x18d66e[_0x2c4e60(0x12c)])),_0x18d66e[_0x2c4e60(0x157)]=_0x193916['openid'],_0x18d66e[_0x2c4e60(0xfd)]=_0x193916[_0x2c4e60(0x14c)],_0x18d66e;}catch(_0x2d95e1){common_1['Logger']['error'](_0x2c4e60(0xb1),_0x2d95e1);throw new common_1['HttpException'](_0x2d95e1[_0x2c4e60(0x100)],common_1[_0x2c4e60(0xce)][_0x2c4e60(0x130)]);}}async[_0x41836a(0x160)](_0x4ad630,_0x379997){const _0x1ad7ef=_0x41836a,_0x1738d8=await this[_0x1ad7ef(0x91)][_0x1ad7ef(0xab)]([_0x1ad7ef(0x14e),_0x1ad7ef(0x94),_0x1ad7ef(0xf9),_0x1ad7ef(0x15f),_0x1ad7ef(0xed)]);try{const _0x34dd98=await this[_0x1ad7ef(0xe9)]['verifyCode'](_0x4ad630,verification_constant_1['VerificationEnum'][_0x1ad7ef(0xc5)]),{type:_0x57061b,userId:_0x4d5206}=_0x34dd98;if(_0x57061b!==verification_constant_1[_0x1ad7ef(0x12f)]['Registration'])throw new common_1[(_0x1ad7ef(0x85))](_0x1ad7ef(0x148),common_1[_0x1ad7ef(0xce)][_0x1ad7ef(0x130)]);const _0x37b52e=await this[_0x1ad7ef(0x101)][_0x1ad7ef(0x99)](_0x4d5206);if(_0x37b52e===user_constant_1[_0x1ad7ef(0x111)][_0x1ad7ef(0xb3)])throw new common_1['HttpException'](_0x1ad7ef(0xdd),common_1[_0x1ad7ef(0xce)][_0x1ad7ef(0x130)]);await this[_0x1ad7ef(0x101)][_0x1ad7ef(0x144)](_0x34dd98[_0x1ad7ef(0x146)],user_constant_1[_0x1ad7ef(0x111)]['ACTIVE']);const _0xce497c=await this['userService'][_0x1ad7ef(0x11c)](_0x34dd98[_0x1ad7ef(0x146)]),{username:_0x255fe6,email:_0x3e0672,id:_0x3e0a5d,invitedBy:_0x25dbfe}=_0xce497c;let _0xe556f4;_0x25dbfe&&(_0xe556f4=await this[_0x1ad7ef(0x101)][_0x1ad7ef(0xbd)](_0x25dbfe)),await this['userService'][_0x1ad7ef(0xf5)](_0xce497c,_0xe556f4),_0x379997[_0x1ad7ef(0x133)](_0x1ad7ef(0xf0)+_0x3e0a5d[_0x1ad7ef(0xc6)]()[_0x1ad7ef(0x151)](0x4,'0')+'&username='+_0x255fe6+_0x1ad7ef(0xe0)+_0x3e0672+'&registerSuccessEmailTitle='+_0x1738d8[_0x1ad7ef(0x14e)]+_0x1ad7ef(0x8d)+_0x1738d8[_0x1ad7ef(0x94)]+_0x1ad7ef(0x11b)+_0x1738d8['registerSuccessEmaileAppend']);}catch(_0x2c0797){console[_0x1ad7ef(0xaf)]('error:\x20',_0x2c0797);const _0x4d1bf3=_0x2c0797[_0x1ad7ef(0x14f)];_0x379997[_0x1ad7ef(0x133)](_0x1ad7ef(0xe4)+_0x4d1bf3+_0x1ad7ef(0x155)+_0x1738d8[_0x1ad7ef(0x15f)]+_0x1ad7ef(0x12d)+_0x1738d8[_0x1ad7ef(0xed)]);}}async[_0x41836a(0xdc)](_0x27b415){const _0x5c5dfb=_0x41836a,_0x34f06a=await this[_0x5c5dfb(0x101)]['queryOne']({'id':_0x27b415[_0x5c5dfb(0x9e)]['id']});return{'userInfo':_0x34f06a};}async[_0x41836a(0x98)](_0xcf74a4,_0x9eb91d){const _0x380593=_0x41836a,{id:_0x2cc374,client:_0x24e171}=_0xcf74a4[_0x380593(0x9e)];if(_0x24e171&&Number(_0x24e171)>0x0)throw new common_1[(_0x380593(0x85))](_0x380593(0xc0),common_1['HttpStatus'][_0x380593(0x130)]);const {oldPassword:_0x577171,password:_0x32f291}=_0x9eb91d,_0x1a4753=await this['userEntity']['findOne']({'where':{'id':_0x2cc374}});if(_0x1a4753[_0x380593(0x137)]){if(!_0x577171)throw new common_1[(_0x380593(0x85))]('原密码不可为空',common_1[_0x380593(0xce)]['BAD_REQUEST']);const _0x404ea5=bcrypt[_0x380593(0x13f)](_0x577171,_0x1a4753[_0x380593(0x137)]);if(!_0x404ea5)throw new common_1['HttpException'](_0x380593(0x12e),common_1[_0x380593(0xce)]['BAD_REQUEST']);}return _0x1a4753['password']=bcrypt[_0x380593(0x153)](_0x32f291,0xa),await this[_0x380593(0xc7)][_0x380593(0xea)](_0x1a4753),_0x380593(0x143);}async['updateEmail'](_0x576d0f,_0x1c7c8e){const _0x3f3ec4=_0x41836a,_0x31e849=_0x576d0f['user']['id'],_0x59a539=await this[_0x3f3ec4(0xc7)][_0x3f3ec4(0x95)]({'where':{'email':_0x1c7c8e[_0x3f3ec4(0xb2)]}});if(_0x59a539)throw new common_1[(_0x3f3ec4(0x85))](_0x3f3ec4(0x9f),axios_1[_0x3f3ec4(0xb5)]['BadRequest']);const _0xe83a46=await this['userEntity'][_0x3f3ec4(0x95)]({'where':{'id':_0x31e849}}),_0x44d49a=await this[_0x3f3ec4(0x91)][_0x3f3ec4(0xab)]([_0x3f3ec4(0xa6),_0x3f3ec4(0x11f),_0x3f3ec4(0xcc),_0x3f3ec4(0xff),_0x3f3ec4(0x14d),_0x3f3ec4(0x10b)]);_0xe83a46[_0x3f3ec4(0xb2)]=_0x1c7c8e[_0x3f3ec4(0xb2)];const _0xcc0217=_0x44d49a['registerVerifyExpir']?Number(_0x44d49a['registerVerifyExpir']):0x1e*0x3c,_0x9c529f=await this[_0x3f3ec4(0xe9)]['createVerification'](_0xe83a46,verification_constant_1[_0x3f3ec4(0x12f)][_0x3f3ec4(0xa3)],_0xcc0217),{code:_0x505b60,email:_0x28a3b7,id:_0x9874db}=_0x9c529f,{registerVerifyEmailFrom:_0x3e1d52}=_0x44d49a;await this[_0x3f3ec4(0x13a)][_0x3f3ec4(0x147)]({'to':_0x28a3b7,'template':_0x3f3ec4(0x96),'subject':'来自'+_0x3e1d52+_0x3f3ec4(0x11d),'context':{'id':_0x9874db,'code':_0x505b60,'email':_0x28a3b7,..._0x44d49a,'baseUrl':_0x44d49a['registerBaseUrl']}});}async[_0x41836a(0x14a)](_0x255192){const _0x2ae536=_0x41836a,_0x2fc707=await this[_0x2ae536(0xc7)][_0x2ae536(0xcf)]({'where':{'phone':_0x255192}});return _0x2fc707>0x0;}async[_0x41836a(0xc1)](_0xc171d){const _0x1de057=_0x41836a;return await this[_0x1de057(0xe3)](_0xc171d[_0x1de057(0x168)],_0xc171d[_0x1de057(0xde)]),await this[_0x1de057(0xc7)][_0x1de057(0xea)]({'id':_0xc171d[_0x1de057(0x146)],'phone':_0xc171d[_0x1de057(0x168)]}),!![];}async[_0x41836a(0xe8)](){const _0x3a3884=_0x41836a;try{const _0x5a3910=process[_0x3a3884(0xf6)][_0x3a3884(0x13e)];if(_0x5a3910===_0x3a3884(0xdf)||_0x5a3910===_0x3a3884(0x167)||_0x5a3910===_0x3a3884(0x8b)){const _0x162e5a=await axios_1[_0x3a3884(0xd1)][_0x3a3884(0xd8)](_0x3a3884(0x127));await this[_0x3a3884(0x112)][_0x3a3884(0x125)]({'key':redisKey_constant_1[_0x3a3884(0x149)],'val':_0x162e5a[_0x3a3884(0xdb)][_0x3a3884(0xdb)]});}else{const _0x583008=await axios_1[_0x3a3884(0xd1)][_0x3a3884(0x89)](_0x3a3884(0xf1),{'grant_type':_0x3a3884(0x136),'appid':store_1[_0x3a3884(0x10e)][_0x3a3884(0x164)],'secret':store_1[_0x3a3884(0x10e)][_0x3a3884(0x8a)],'force_refresh':![]});await this['redisCacheService'][_0x3a3884(0x125)]({'key':redisKey_constant_1['WE_MINI_ACCESS_KEY'],'val':_0x583008[_0x3a3884(0xdb)][_0x3a3884(0x14c)]});}}catch(_0x15f92e){common_1['Logger'][_0x3a3884(0x121)](_0x3a3884(0x15b),_0x15f92e);}}[_0x41836a(0xb4)](_0x8b966d){const _0x1c7e34=_0x41836a,_0x2984f2={'id':_0x8b966d,'openId':null,'client':null,'role':_0x1c7e34(0x11e),'username':'游客'+_0x8b966d,'email':_0x8b966d+'@nine.com','saasId':(0x0,utils_1[_0x1c7e34(0xa4)])(this[_0x1c7e34(0x90)])};return this[_0x1c7e34(0x102)](_0x2984f2);}async['getJwtToken'](_0x331e83,_0x4a34e3){const _0x19c60c=_0x41836a,{status:_0x5137dc}=_0x331e83;if(_0x5137dc!==user_constant_1['UserStatusEnum']['ACTIVE'])throw new common_1[(_0x19c60c(0x85))](user_constant_1[_0x19c60c(0x92)][_0x5137dc],common_1[_0x19c60c(0xce)][_0x19c60c(0x130)]);const _0x2e71eb=(0x0,utils_1[_0x19c60c(0x110)])(_0x4a34e3),_0x499e57=this[_0x19c60c(0x102)](_0x331e83);return await this[_0x19c60c(0x101)][_0x19c60c(0xad)](_0x331e83['id'],_0x2e71eb),await this[_0x19c60c(0x112)][_0x19c60c(0xd0)](_0x331e83['id'],_0x499e57),_0x499e57;}async[_0x41836a(0xe3)](_0x39fd64,_0x34cb94){const _0x1763ae=_0x41836a,_0x4c80de=await this[_0x1763ae(0x91)][_0x1763ae(0x166)](),_0x474ddb=_0x4c80de+_0x1763ae(0xec)+_0x39fd64;if(_0x34cb94===_0x1763ae(0xae))return;const _0x5d747a=await this[_0x1763ae(0x112)][_0x1763ae(0xd8)]({'key':_0x474ddb});if(!_0x5d747a)throw new common_1['HttpException'](_0x1763ae(0xa8),common_1[_0x1763ae(0xce)][_0x1763ae(0x130)]);if(_0x34cb94!==_0x5d747a)throw new common_1[(_0x1763ae(0x85))](_0x1763ae(0x139),common_1[_0x1763ae(0xce)]['BAD_REQUEST']);}async['invitationRewards'](_0x17b2cf,_0x2ab97d){const _0x425f09=_0x41836a;let _0x3994a3;_0x2ab97d&&(_0x3994a3=await this[_0x425f09(0x101)][_0x425f09(0xbd)](_0x2ab97d)),await this[_0x425f09(0x101)][_0x425f09(0xf5)](_0x17b2cf,_0x3994a3);}};function _0x1440(_0xf259f8,_0x4d5ae5){const _0x2337b0=_0x2337();return _0x1440=function(_0x1440d4,_0x2eec64){_0x1440d4=_0x1440d4-0x85;let _0x2fcb0f=_0x2337b0[_0x1440d4];return _0x2fcb0f;},_0x1440(_0xf259f8,_0x4d5ae5);}function _0x2337(){const _0x47614a=['clsService','globalConfigService','UserStatusErrMsg','9AQnQyt','registerSuccessEmailTeamName','findOne','changeEmail','UserEntity','updatePassword','getUserStatus','roleEntity','&registerSuccessEmailTitle=','WeAppLoginVO','userInitVip','user','邮箱已被其他用户使用','JwtService','/api/auth/changeEmailSuccess?id=','emailVerify','ChangeEmail','getReqSaasId','MailerService','isVerifyEmail','miniOpenId','验证码已过期、请重新发送！','invitationRewards','./../verification/verification.service','getConfigByKeys','https://api.weixin.qq.com/sns/jscode2session','savaLoginIp','000000','log','accessLabel','loginWithWechatApp:\x20','email','ACTIVE','createTokenFromFingerprint','HttpStatusCode','weAppOpenId','decorate','__param','7805316FCLCxO','nickname','sendPhoneCode',':CAPTCHA:','qureyUserInfoByInviteCode','InjectRepository','@nestjs/jwt','无权此操作、请联系管理员！','bindPhone','当前用户已注册，请勿重复注册！','metadata','getPhoneInMini','Registration','toString','userEntity','#fff','RoleEntity','sign','nestjs-cls','registerVerifyEmailTitle','loginInMinigin','HttpStatus','count','saveToken','default','saasId','createRandomUid','3DxlZbd','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','../mailer/mailer.service','openId','get','object','userDefautlAvatar','data','getInfo','账户已被激活过','phoneCode','kaifa.qumao518.vip','&email=','ttl','status','validatePhoneCode','/api/auth/registerError?message=','loginInMinigin:\x20','WE_MINI_TEMP_USER','VerificationService','renewMiniAccessToken','verificationService','save','&secret=',':PHONECODE:','registerFailEmailTeamName','用户名格式错误！','comparePassword','/api/auth/registerSuccess?id=','https://api.weixin.qq.com/cgi-bin/stable_token','验证码不能为空！','loginV4','ClsService','changeScore4registe','env','getOwnPropertyDescriptor','__metadata','registerSuccessEmaileAppend','verifyCaptcha','&code=','AuthService','accessToken','RedisCacheService','registerVerifyEmailDesc','message','userService','signToken','axios','253393DnZFOF','&grant_type=authorization_code','../../common/store','该邮箱已注册！','../user/role.entity','test','../../common/utils','registerVerifyExpir','createRandomCode','getOne','WechatConfig','errmsg','getClientIp','UserStatusEnum','redisCacheService','typeorm','../globalConfig/globalConfig.service','账户不存在，请联系管理员或注册','length','sendEmailCode','3220038qbCnZl','213266iKAEAm','参数错误！','&registerSuccessEmaileAppend=','queryUserInfoById','的邮箱验证','visitor','registerBaseUrl','./vo/Login.vo','error','loginWithWechatApp','./../user/user.entity','UserService','set','../../common/constants/redisKey.constant','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','unionid','账号注册时密码不能为空！','邮箱格式错误！','https://api.weixin.qq.com/sns/oauth2/access_token?appid=','authToken','&registerFailEmailTeamName=','旧密码错误、请检查提交','VerificationEnum','BAD_REQUEST','../../common/constants/user.constant','role','redirect','openId、miniOpenId、weAppOpenId中必须存在一个','@nestjs/common','client_credential','password','32uKsJSa','验证码填写错误、请重新输入！','mailerService','AGENT','getPhoneInMini:\x20','1016530tpqFKp','GOMAXAI_HOST','compareSync','__decorate','WE_APP_TEMP_USER','avatar','密码修改成功','updateUserStatus','errcode','userId','sendMail','验证码类型错误','WE_MINI_ACCESS_KEY','getPhoneStatus','GlobalConfigService','access_token','registerVerifyEmailFrom','registerSuccessEmailTitle','response','验证码发送成功、请填写验证码完成注册！','padStart','text','hashSync','function','&registerFailEmailTitle=','100pueicK','openid','ERole','captchaId','access:','wechat\x20获取access_token\x20失败：','defineProperty','用户名或密码错误！','createUser','registerFailEmailTitle','activateAccount','EMAIL_REGISTE','11NDKNEz','../../common/constants/Role.constant','WE_MiNI_APPID','87496loyLxR','getNamespace','ceshi.qumao518.vip','phone','Repository','HttpException','captcha','Logger','551354fBkQNV','post','WE_MINI_APPSECRET','saas.qumao518.vip','username','&registerSuccessEmailTeamName=','jwtService','design:paramtypes'];_0x2337=function(){return _0x47614a;};return _0x2337();}AuthService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x41836a(0xbe)])(user_entity_1[_0x41836a(0x97)])),__param(0x1,(0x0,typeorm_1[_0x41836a(0xbe)])(role_entity_1[_0x41836a(0xc9)])),__metadata(_0x41836a(0x8f),[typeorm_2[_0x41836a(0x169)],typeorm_2[_0x41836a(0x169)],nestjs_cls_1[_0x41836a(0xf4)],jwt_1[_0x41836a(0xa0)],user_service_1[_0x41836a(0x124)],mailer_service_1[_0x41836a(0xa5)],redisCache_service_1[_0x41836a(0xfe)],verification_service_1[_0x41836a(0xe7)],globalConfig_service_1[_0x41836a(0x14b)]])],AuthService),exports[_0x41836a(0xfc)]=AuthService;