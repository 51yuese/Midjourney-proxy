'use strict';function _0x1f63(_0x289fd2,_0x5f0a43){const _0x329543=_0x3295();return _0x1f63=function(_0x1f6339,_0x28a2f9){_0x1f6339=_0x1f6339-0x1d0;let _0x2abcb1=_0x329543[_0x1f6339];return _0x2abcb1;},_0x1f63(_0x289fd2,_0x5f0a43);}const _0x10e70c=_0x1f63;(function(_0x5447d7,_0x212a21){const _0x267f8f=_0x1f63,_0x50abad=_0x5447d7();while(!![]){try{const _0x45cdad=-parseInt(_0x267f8f(0x20e))/0x1+parseInt(_0x267f8f(0x27e))/0x2*(-parseInt(_0x267f8f(0x279))/0x3)+-parseInt(_0x267f8f(0x262))/0x4+parseInt(_0x267f8f(0x267))/0x5*(parseInt(_0x267f8f(0x271))/0x6)+parseInt(_0x267f8f(0x249))/0x7*(-parseInt(_0x267f8f(0x1ef))/0x8)+parseInt(_0x267f8f(0x1ff))/0x9*(parseInt(_0x267f8f(0x28d))/0xa)+parseInt(_0x267f8f(0x1fb))/0xb*(parseInt(_0x267f8f(0x25f))/0xc);if(_0x45cdad===_0x212a21)break;else _0x50abad['push'](_0x50abad['shift']());}catch(_0x2e2d2a){_0x50abad['push'](_0x50abad['shift']());}}}(_0x3295,0x2105a));function _0x3295(){const _0xae33c4=['bindPhone','验证码类型错误','svg-captcha','&registerFailEmailTeamName=','WE_APP_TEMP_USER','password','../globalConfig/globalConfig.service','Repository','RedisCacheService','ceshi.qumao518.vip','../../common/utils','changeScore4registe','axios','MailerService','../redisCache/redisCache.service','error:\x20','nickname','InjectRepository','registerVerifyEmailTitle','#fff','@nestjs/common','sendEmailCode','count','用户名或密码错误','__metadata','280ZcRmFF','authToken','UserEntity','save','邮箱已被其他用户使用','defineProperty',':PHONECODE:','queryOne','role','/api/auth/changeEmailSuccess?id=','ttl','savaLoginIp','../../common/constants/Role.constant','getNamespace','@nestjs/typeorm','EMAIL_REGISTE','phone','saas.qumao518.vip','renewMiniAccessToken','createTokenFromFingerprint','registeV3','验证码发送成功、请填写验证码完成注册！','6060OxHLeJ','UserStatusEnum','createUser','729088aRbLzk','verificationService','phone_info','get','email','5iMaAYe','redisCacheService','sendMail','sign','AuthService','username','sendPhoneCode','registerSuccessEmailTitle','errmsg','./vo/Login.vo','1159806KWxUbe','userId','invitationRewards','createMathExpr','object','post','clsService','comparePassword','3sItasw','accessLabel','phoneCode','registerVerifyExpir','WE_MINI_ACCESS_KEY','437662stwmWD','当前用户已注册，请勿重复注册！','HttpStatusCode','set','message','ChangeEmail','openid','hashSync','UserService','WechatConfig','__decorate','验证码已过期、请重新发送！','HttpStatus','verifyCaptcha','padStart','10FAlFNi','WE_MiNI_APPID','captchaId','response','user','typeorm','data','账户已被激活过','test','getReqSaasId','updatePassword','updateUserStatus','GOMAXAI_HOST','registerVerifyEmailDesc','error','userEntity','kaifa.qumao518.vip','loginByPhoneV3','validatePhoneCode','getJwtToken','loginWithWechatApp','getOne','旧密码错误、请检查提交','HttpException','参数错误！','ClsService','weAppOpenId','/api/auth/registerError?message=','用户名或密码错误！','用户名格式错误！','&registerSuccessEmailTeamName=','https://gomaxai.qumao518.vip/api/official/getAccessToken?type=mini','purePhoneNumber','text','getOwnPropertyDescriptor','Logger','registerSuccessEmailTeamName','metadata','log','Registration','activateAccount','loginWithWechatApp:\x20','ERole','WE_APP_APPID','验证码填写错误、请重新输入！','createRandomCode','compareSync','BAD_REQUEST','&registerSuccessEmailTitle=','authorization_code','./vo/WeAppLogin.vo','Injectable','roleEntity','status','000000','getConfigByKeys','registerBaseUrl','UserStatusErrMsg','qureyUserInfoByInviteCode','../../common/constants/user.constant','&grant_type=authorization_code','findOne','21544dqPzJz','signToken','原密码不可为空','的邮箱验证','__esModule','function','shouldAccess','loginInMinigin','lastLoginIp','queryUserInfoById','changeEmail','VerificationService','10725hLdwlM','&registerSuccessEmaileAppend=','env','https://api.weixin.qq.com/wxa/business/getuserphonenumber?access_token=','870003MJcrTO','账号注册时密码不能为空！','registerFailEmailTeamName','registerVerifyEmailFrom','../../common/store','WE_MINI_TEMP_USER','avatar','unionid','loginInMinigin:\x20','BadRequest','RoleEntity','userInitVip','openId','bcryptjs','saveToken','138262HLyvft','globalConfigService','redirect','账号密码或密码错误','该邮箱已注册！','&username=','的注册验证','ACTIVE','getClientIp','邮箱格式错误！','openId、miniOpenId、weAppOpenId中必须存在一个','userService','账户不存在，请联系管理员或注册','registerSuccessEmaileAppend','registerFailEmailTitle','verifyCode','default','nestjs-cls','mailerService','../user/role.entity','WE_MINI_APPSECRET','emailVerify','@nine.com','saasId','GlobalConfigService','&code=','@nestjs/jwt','miniOpenId','../mailer/mailer.service','errcode','VerificationEnum','userDefautlAvatar','https://api.weixin.qq.com/sns/jscode2session','WeAppLoginVO'];_0x3295=function(){return _0xae33c4;};return _0x3295();}var __decorate=this&&this[_0x10e70c(0x288)]||function(_0x364dec,_0x1b0800,_0x39639c,_0x14f716){const _0x41110f=_0x10e70c;var _0x3d0d91=arguments['length'],_0x229325=_0x3d0d91<0x3?_0x1b0800:_0x14f716===null?_0x14f716=Object[_0x41110f(0x1d3)](_0x1b0800,_0x39639c):_0x14f716,_0xd6a9f9;if(typeof Reflect===_0x41110f(0x275)&&typeof Reflect['decorate']===_0x41110f(0x1f4))_0x229325=Reflect['decorate'](_0x364dec,_0x1b0800,_0x39639c,_0x14f716);else{for(var _0x18f6f4=_0x364dec['length']-0x1;_0x18f6f4>=0x0;_0x18f6f4--)if(_0xd6a9f9=_0x364dec[_0x18f6f4])_0x229325=(_0x3d0d91<0x3?_0xd6a9f9(_0x229325):_0x3d0d91>0x3?_0xd6a9f9(_0x1b0800,_0x39639c,_0x229325):_0xd6a9f9(_0x1b0800,_0x39639c))||_0x229325;}return _0x3d0d91>0x3&&_0x229325&&Object[_0x41110f(0x24e)](_0x1b0800,_0x39639c,_0x229325),_0x229325;},__metadata=this&&this[_0x10e70c(0x248)]||function(_0x3626bd,_0x4d6742){const _0x881878=_0x10e70c;if(typeof Reflect===_0x881878(0x275)&&typeof Reflect[_0x881878(0x1d6)]==='function')return Reflect['metadata'](_0x3626bd,_0x4d6742);},__param=this&&this['__param']||function(_0x18a2fd,_0x7d6fa6){return function(_0x42bb03,_0x9a3a39){_0x7d6fa6(_0x42bb03,_0x9a3a39,_0x18a2fd);};};Object['defineProperty'](exports,_0x10e70c(0x1f3),{'value':!![]}),exports[_0x10e70c(0x26b)]=void 0x0;const globalConfig_service_1=require(_0x10e70c(0x236)),verification_constant_1=require('../../common/constants/verification.constant'),verification_service_1=require('./../verification/verification.service'),user_entity_1=require('./../user/user.entity'),common_1=require(_0x10e70c(0x244)),jwt_1=require(_0x10e70c(0x228)),user_service_1=require('../user/user.service'),mailer_service_1=require(_0x10e70c(0x22a)),user_constant_1=require(_0x10e70c(0x1ec)),utils_1=require(_0x10e70c(0x23a)),redisCache_service_1=require(_0x10e70c(0x23e)),svgCaptcha=require(_0x10e70c(0x232)),bcrypt=require(_0x10e70c(0x20c)),store_1=require(_0x10e70c(0x203)),axios_1=require(_0x10e70c(0x23c)),redisKey_constant_1=require('../../common/constants/redisKey.constant'),Login_vo_1=require(_0x10e70c(0x270)),WeAppLogin_vo_1=require(_0x10e70c(0x1e3)),typeorm_1=require(_0x10e70c(0x257)),typeorm_2=require(_0x10e70c(0x292)),nestjs_cls_1=require(_0x10e70c(0x21f)),role_entity_1=require(_0x10e70c(0x221)),Role_constant_1=require(_0x10e70c(0x255));let AuthService=class AuthService{constructor(_0x2dbc4f,_0x436b8d,_0xb2218a,_0x3fef10,_0x2510d1,_0x38c4fc,_0x3ff9c0,_0x35b40e,_0x20f03b){const _0x1edcfd=_0x10e70c;this[_0x1edcfd(0x29c)]=_0x2dbc4f,this[_0x1edcfd(0x1e5)]=_0x436b8d,this['clsService']=_0xb2218a,this['jwtService']=_0x3fef10,this[_0x1edcfd(0x219)]=_0x2510d1,this[_0x1edcfd(0x220)]=_0x38c4fc,this[_0x1edcfd(0x268)]=_0x3ff9c0,this[_0x1edcfd(0x263)]=_0x35b40e,this[_0x1edcfd(0x20f)]=_0x20f03b;}[_0x10e70c(0x1f0)](_0x3df66b){const _0x4a2915=_0x10e70c,{id:_0x276246,username:_0x2d9ec7,role:_0x8b12a5,openId:_0xdcf27a,email:_0x10fe02,client:_0x53c45d,saasId:_0x496930}=_0x3df66b;return this['jwtService'][_0x4a2915(0x26a)]({'id':_0x276246,'username':_0x2d9ec7,'role':_0x8b12a5,'openId':_0xdcf27a,'email':_0x10fe02,'client':_0x53c45d,'saasId':_0x496930});}async['loginByAdmin'](_0x4dc942){const _0x531aa6=_0x10e70c,{username:_0xe40e0d,password:_0x134c3c}=_0x4dc942;if(!_0xe40e0d||!_0x134c3c)throw new common_1[(_0x531aa6(0x2a4))](_0x531aa6(0x211),common_1['HttpStatus'][_0x531aa6(0x1e0)]);const _0x134921=await this[_0x531aa6(0x219)][_0x531aa6(0x2a2)](_0xe40e0d);if(!_0x134921)throw new common_1[(_0x531aa6(0x2a4))](_0x531aa6(0x21a),common_1[_0x531aa6(0x28a)][_0x531aa6(0x1e0)]);if((0x0,utils_1[_0x531aa6(0x278)])(_0x134c3c,_0x134921[_0x531aa6(0x235)]))throw new common_1[(_0x531aa6(0x2a4))](_0x531aa6(0x247),common_1['HttpStatus']['BAD_REQUEST']);return this[_0x531aa6(0x1f0)](_0x134921);}async['changeEmail'](_0x6bcc74,_0x24d126){const _0x11bef7=_0x10e70c,_0xe43dc5=await this['globalConfigService'][_0x11bef7(0x1e8)]([_0x11bef7(0x26e),_0x11bef7(0x1d5),'registerSuccessEmaileAppend',_0x11bef7(0x21c),_0x11bef7(0x201)]);try{const _0x39180f=await this[_0x11bef7(0x263)][_0x11bef7(0x21d)](_0x6bcc74,verification_constant_1[_0x11bef7(0x22c)][_0x11bef7(0x283)]),{type:_0x3acfd1,userId:_0x1134bf}=_0x39180f;if(_0x3acfd1!==verification_constant_1[_0x11bef7(0x22c)][_0x11bef7(0x283)])throw new common_1[(_0x11bef7(0x2a4))](_0x11bef7(0x231),common_1[_0x11bef7(0x28a)]['BAD_REQUEST']);let _0x1c4bed=await this[_0x11bef7(0x29c)]['findOne']({'where':{'id':_0x1134bf}});_0x1c4bed[_0x11bef7(0x266)]=_0x6bcc74[_0x11bef7(0x266)],_0x1c4bed=await this['userEntity']['save'](_0x1c4bed);const {id:_0x291800,username:_0x198e88,email:_0x369d0c}=_0x1c4bed;_0x24d126['redirect'](_0x11bef7(0x252)+_0x291800['toString']()[_0x11bef7(0x28c)](0x4,'0')+_0x11bef7(0x213)+_0x198e88+'&email='+_0x369d0c+_0x11bef7(0x1e1)+_0xe43dc5[_0x11bef7(0x26e)]+_0x11bef7(0x2ab)+_0xe43dc5[_0x11bef7(0x1d5)]+_0x11bef7(0x1fc)+_0xe43dc5[_0x11bef7(0x21b)]);}catch(_0x2a8366){const _0x3f6e02=_0x2a8366[_0x11bef7(0x290)];_0x24d126['redirect'](_0x11bef7(0x2a8)+_0x3f6e02+'&registerFailEmailTitle='+_0xe43dc5[_0x11bef7(0x21c)]+_0x11bef7(0x233)+_0xe43dc5['registerFailEmailTeamName']);}}async['captcha'](_0x4633ce){const _0x4617fd=_0x10e70c,_0x52511b=await this[_0x4617fd(0x20f)][_0x4617fd(0x256)](),{color:color=_0x4617fd(0x243)}=_0x4633ce,_0x4ae1d4=svgCaptcha[_0x4617fd(0x274)]({'background':color,'height':0x22,'width':0x78,'noise':0x3}),_0x194e45=_0x4ae1d4[_0x4617fd(0x1d2)],_0x18ca10=(0x0,utils_1['createRandomUid'])(),_0x274df5=_0x52511b+':CAPTCHA:'+_0x18ca10;return await this['redisCacheService'][_0x4617fd(0x281)]({'key':_0x274df5,'val':_0x4ae1d4['text']},0x5*0x3c),{'svgCode':_0x4ae1d4[_0x4617fd(0x293)],'code':_0x18ca10};}async[_0x10e70c(0x26d)](_0x3d72a1){const _0x5e4c4f=_0x10e70c;_0x3d72a1[_0x5e4c4f(0x28f)]&&await this[_0x5e4c4f(0x263)][_0x5e4c4f(0x28b)](_0x3d72a1);const {phone:_0x1990ad}=_0x3d72a1,_0x14ff89=await this[_0x5e4c4f(0x20f)][_0x5e4c4f(0x256)](),_0x151cf5=_0x14ff89+_0x5e4c4f(0x24f)+_0x1990ad,_0x3aed92=await this['redisCacheService'][_0x5e4c4f(0x253)](_0x151cf5);if(_0x3aed92&&_0x3aed92>0x0)throw new common_1['HttpException'](_0x3aed92+'秒内不得重复发送短信！',common_1[_0x5e4c4f(0x28a)]['BAD_REQUEST']);const _0x1554e0=(0x0,utils_1['createRandomCode'])(),_0x166156={'phone':_0x1990ad,'code':_0x1554e0};return await this[_0x5e4c4f(0x263)][_0x5e4c4f(0x26d)](_0x166156),await this[_0x5e4c4f(0x268)][_0x5e4c4f(0x281)]({'key':_0x151cf5,'val':_0x1554e0},0x1*0x3c),_0x5e4c4f(0x25e);}async[_0x10e70c(0x245)](_0xa3ea06){const _0xe22c6b=_0x10e70c;try{var _0x9068cf=/^[a-zA-Z0-9]+([_.w-]+[a-zA-Z0-9]+)*@[a-zA-Z0-9]+([-.w-]+[a-zA-Z0-9]+)*.[a-zA-Z0-9]+$/;if(!_0x9068cf[_0xe22c6b(0x295)](_0xa3ea06))throw new Error(_0xe22c6b(0x217));const _0x426952=await this[_0xe22c6b(0x29c)]['findOne']({'where':{'email':_0xa3ea06}});if(_0x426952)throw new Error(_0xe22c6b(0x212));const _0x2a4224=await this[_0xe22c6b(0x20f)][_0xe22c6b(0x1e8)]([_0xe22c6b(0x1e9),_0xe22c6b(0x242),_0xe22c6b(0x29a),'registerVerifyEmailFrom',_0xe22c6b(0x27c)]),_0x27c0e5=(0x0,utils_1[_0xe22c6b(0x1de)])(),_0x13e7d4=_0x2a4224[_0xe22c6b(0x27c)]?Number(_0x2a4224[_0xe22c6b(0x27c)]):0x1e*0x3c;await this['redisCacheService'][_0xe22c6b(0x281)]({'key':redisKey_constant_1[_0xe22c6b(0x258)]+_0xa3ea06,'val':_0x27c0e5},_0x13e7d4*0x3c),await this[_0xe22c6b(0x220)][_0xe22c6b(0x269)]({'to':_0xa3ea06,'template':_0xe22c6b(0x223),'subject':'来自'+_0x2a4224['registerVerifyEmailFrom']+_0xe22c6b(0x214),'context':{'baseUrl':_0x2a4224[_0xe22c6b(0x1e9)],'code':_0x27c0e5,..._0x2a4224}});}catch(_0x565c36){throw new common_1[(_0xe22c6b(0x2a4))](_0x565c36[_0xe22c6b(0x282)],common_1['HttpStatus'][_0xe22c6b(0x1e0)]);}}async['getPhoneInMini'](_0x284e72){const _0x4fd57e=_0x10e70c;try{const _0x3e0b8f=await this[_0x4fd57e(0x268)][_0x4fd57e(0x265)]({'key':redisKey_constant_1[_0x4fd57e(0x27d)]}),_0x55ab86=await axios_1[_0x4fd57e(0x21e)][_0x4fd57e(0x276)](_0x4fd57e(0x1fe)+_0x3e0b8f,{'code':_0x284e72});if(_0x55ab86[_0x4fd57e(0x293)][_0x4fd57e(0x22b)])throw new Error(_0x55ab86['data'][_0x4fd57e(0x26f)]);return _0x55ab86[_0x4fd57e(0x293)][_0x4fd57e(0x264)][_0x4fd57e(0x1d1)];}catch(_0x249075){common_1[_0x4fd57e(0x1d4)][_0x4fd57e(0x29b)]('getPhoneInMini:\x20',_0x249075);throw new common_1[(_0x4fd57e(0x2a4))](_0x249075[_0x4fd57e(0x282)],common_1[_0x4fd57e(0x28a)][_0x4fd57e(0x1e0)]);}}async['phoneWithOpenId4regist'](_0x190397){const _0x59da88=_0x10e70c;try{if(!_0x190397[_0x59da88(0x20b)]&&!_0x190397[_0x59da88(0x229)]&&!_0x190397[_0x59da88(0x2a7)])throw new Error(_0x59da88(0x218));let _0x1b56bf=_0x59da88(0x20b),_0x62d408={};if(_0x190397[_0x59da88(0x20b)])_0x1b56bf=_0x59da88(0x20b);else _0x190397[_0x59da88(0x229)]?_0x1b56bf=_0x59da88(0x229):_0x1b56bf=_0x59da88(0x2a7);_0x62d408[_0x1b56bf]=_0x190397[_0x1b56bf];const _0xfd3d31=await this[_0x59da88(0x29c)][_0x59da88(0x1ee)]({'where':_0x62d408});if(_0xfd3d31&&_0xfd3d31['phone'])return![];const _0x19d869=await this[_0x59da88(0x29c)][_0x59da88(0x1ee)]({'where':{'phone':_0x190397['phone']}});if(_0x19d869)return!_0x19d869[_0x1b56bf];return!![];}catch(_0x3b9960){throw new common_1[(_0x59da88(0x2a4))](_0x3b9960['message'],common_1[_0x59da88(0x28a)][_0x59da88(0x1e0)]);}}async[_0x10e70c(0x25d)](_0x4200ae,_0x392dfd){const _0x1435de=_0x10e70c,_0x34b574=(0x0,utils_1[_0x1435de(0x296)])(this['clsService']);try{if(_0x4200ae[_0x1435de(0x26c)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/['test'](_0x4200ae['username']))throw new Error(_0x1435de(0x2aa));if(!_0x4200ae['password'])throw new Error(_0x1435de(0x200));}else{if(!_0x4200ae[_0x1435de(0x20b)]&&!_0x4200ae[_0x1435de(0x229)]&&!_0x4200ae[_0x1435de(0x2a7)])throw new Error(_0x1435de(0x2a5));}if(_0x4200ae[_0x1435de(0x259)]&&!_0x4200ae[_0x1435de(0x27b)])throw new Error('验证码不能为空！');let _0x4baa4a=null;if(_0x4200ae['phone'])await this[_0x1435de(0x29f)](_0x4200ae[_0x1435de(0x259)],_0x4200ae[_0x1435de(0x27b)]),_0x4baa4a=await this[_0x1435de(0x29c)][_0x1435de(0x1ee)]({'where':{'phone':_0x4200ae[_0x1435de(0x259)],'saasId':_0x34b574}});else{if(_0x4200ae[_0x1435de(0x20b)]||_0x4200ae[_0x1435de(0x229)]||_0x4200ae[_0x1435de(0x2a7)]){let _0x73eb31=_0x1435de(0x20b),_0x5e5501={'saasId':_0x34b574};if(_0x4200ae[_0x1435de(0x20b)])_0x73eb31=_0x1435de(0x20b);else _0x4200ae[_0x1435de(0x229)]?_0x73eb31=_0x1435de(0x229):_0x73eb31=_0x1435de(0x2a7);_0x5e5501[_0x73eb31]=_0x4200ae[_0x73eb31],_0x4baa4a=await this[_0x1435de(0x29c)][_0x1435de(0x1ee)]({'where':_0x5e5501});if(_0x4baa4a)throw new Error(_0x1435de(0x27f));}else{_0x4baa4a=await this[_0x1435de(0x29c)][_0x1435de(0x1ee)]({'where':{'username':_0x4200ae[_0x1435de(0x26c)],'saasId':_0x34b574}});if(_0x4baa4a)throw new Error(_0x1435de(0x27f));}}const _0x4e46be=new user_entity_1[(_0x1435de(0x24b))]();for(let _0x3cd48e in _0x4200ae){_0x4200ae[_0x3cd48e]&&(_0x4e46be[_0x3cd48e]=_0x4200ae[_0x3cd48e]);}_0x4baa4a?_0x4e46be['id']=_0x4baa4a['id']:(_0x4e46be[_0x1435de(0x235)]&&(_0x4e46be[_0x1435de(0x235)]=bcrypt[_0x1435de(0x285)](_0x4200ae['password'],0xa)),_0x4e46be[_0x1435de(0x1e6)]=user_constant_1[_0x1435de(0x260)]['ACTIVE'],!_0x4e46be['nickname']&&(_0x4e46be[_0x1435de(0x240)]=_0x4e46be[_0x1435de(0x240)]||'小智'),!_0x4e46be[_0x1435de(0x205)]&&(_0x4e46be[_0x1435de(0x205)]=await this[_0x1435de(0x20f)][_0x1435de(0x1e8)]([_0x1435de(0x22d)])));_0x4e46be[_0x1435de(0x225)]=_0x34b574;const _0x59d467=await this[_0x1435de(0x219)][_0x1435de(0x261)](_0x4e46be);!_0x4baa4a&&this[_0x1435de(0x273)](_0x59d467,_0x4200ae['invitedBy']);const _0x17b772=(0x0,utils_1['getClientIp'])(_0x392dfd),_0xf44ea5=this[_0x1435de(0x1f0)](_0x59d467);return await this['userService'][_0x1435de(0x254)](_0x59d467['id'],_0x17b772),await this[_0x1435de(0x268)][_0x1435de(0x20d)](_0x59d467['id'],_0xf44ea5),_0xf44ea5;}catch(_0x98b490){if(_0x98b490 instanceof common_1[_0x1435de(0x2a4)])throw _0x98b490;else throw new common_1[(_0x1435de(0x2a4))](_0x98b490[_0x1435de(0x282)],common_1[_0x1435de(0x28a)][_0x1435de(0x1e0)]);}}async[_0x10e70c(0x29e)](_0x490221,_0xd1b22d){const _0x485bc7=_0x10e70c,_0x3a8397=(0x0,utils_1['getReqSaasId'])(this['clsService']);await this[_0x485bc7(0x29f)](_0x490221[_0x485bc7(0x259)],_0x490221['phoneCode']);let _0x49f1b1=await this['userEntity'][_0x485bc7(0x1ee)]({'where':{'phone':_0x490221['phone'],'saasId':_0x3a8397}});if(!_0x49f1b1){const _0x37adb5=new user_entity_1[(_0x485bc7(0x24b))]();_0x37adb5[_0x485bc7(0x259)]=_0x490221['phone'],_0x37adb5[_0x485bc7(0x240)]=_0x490221[_0x485bc7(0x259)],_0x37adb5[_0x485bc7(0x1e6)]=user_constant_1[_0x485bc7(0x260)][_0x485bc7(0x215)],_0x37adb5[_0x485bc7(0x205)]=await this['globalConfigService'][_0x485bc7(0x1e8)]([_0x485bc7(0x22d)]),_0x49f1b1=await this[_0x485bc7(0x219)][_0x485bc7(0x261)](_0x37adb5),this['invitationRewards'](_0x49f1b1,_0x490221['invitedBy']);}const _0x43d0a3=(0x0,utils_1[_0x485bc7(0x216)])(_0xd1b22d),_0x4195f9=this[_0x485bc7(0x1f0)](_0x49f1b1);return await this[_0x485bc7(0x219)][_0x485bc7(0x254)](_0x49f1b1['id'],_0x43d0a3),await this[_0x485bc7(0x268)][_0x485bc7(0x20d)](_0x49f1b1['id'],_0x4195f9),_0x4195f9;}async['loginV4'](_0x4485b2,_0x443d77){const _0x405341=_0x10e70c;try{const _0x261618=(0x0,utils_1[_0x405341(0x296)])(this['clsService']),_0x52a09e=await this['userEntity'][_0x405341(0x1ee)]({'where':[{'username':_0x4485b2[_0x405341(0x26c)],'saasId':_0x261618},{'email':_0x4485b2['username'],'saasId':_0x261618},{'phone':_0x4485b2['username'],'saasId':_0x261618}]});if(!_0x52a09e)throw new Error(_0x405341(0x2a9));if(!_0x52a09e[_0x405341(0x235)])throw new Error(_0x405341(0x2a9));if(!bcrypt[_0x405341(0x1df)](_0x4485b2[_0x405341(0x235)],_0x52a09e[_0x405341(0x235)]))throw new Error(_0x405341(0x2a9));_0x52a09e[_0x405341(0x26c)]&&!_0x52a09e[_0x405341(0x1f7)]&&await this['userService'][_0x405341(0x20a)](_0x52a09e);const _0x58f03a=(0x0,utils_1['getClientIp'])(_0x443d77),_0x50fac2=this['signToken'](_0x52a09e);await this[_0x405341(0x219)][_0x405341(0x254)](_0x52a09e['id'],_0x58f03a),await this[_0x405341(0x268)][_0x405341(0x20d)](_0x52a09e['id'],_0x50fac2);if((0x0,utils_1[_0x405341(0x1f5)])(_0x52a09e[_0x405341(0x251)])){let _0x3af83f;_0x52a09e[_0x405341(0x251)]===Role_constant_1[_0x405341(0x1db)]['AGENT']?_0x3af83f=await this[_0x405341(0x1e5)]['findOne']({'where':{'code':_0x52a09e[_0x405341(0x251)]}}):_0x3af83f=await this[_0x405341(0x1e5)]['findOne']({'where':{'code':_0x52a09e['role'],'saasId':_0x261618}});if(!_0x3af83f)throw new Error('角色信息异常！');await this['redisCacheService'][_0x405341(0x281)]({'key':'access:'+_0x52a09e['id'],'val':_0x3af83f[_0x405341(0x27a)]});}return _0x50fac2;}catch(_0x241e73){throw new common_1[(_0x405341(0x2a4))](_0x241e73[_0x405341(0x282)],common_1[_0x405341(0x28a)][_0x405341(0x1e0)]);}}async[_0x10e70c(0x1f6)](_0x5575a7){const _0x43b42e=_0x10e70c;try{const _0x16eb50=new Login_vo_1[(_0x43b42e(0x21e))](),_0x3db453=(0x0,utils_1[_0x43b42e(0x296)])(this[_0x43b42e(0x277)]),_0x653044=await axios_1[_0x43b42e(0x21e)]['get'](_0x43b42e(0x22e),{'params':{'appid':store_1[_0x43b42e(0x287)][_0x43b42e(0x28e)],'secret':store_1[_0x43b42e(0x287)]['WE_MINI_APPSECRET'],'js_code':_0x5575a7,'grant_type':_0x43b42e(0x1e2)}}),_0x278d1d=_0x653044[_0x43b42e(0x293)];if(_0x278d1d['errcode'])throw new Error(_0x278d1d['errmsg']);const _0x342bf7=await this[_0x43b42e(0x29c)]['findOne']({'where':{'miniOpenId':_0x278d1d[_0x43b42e(0x284)],'saasId':_0x3db453}});return!_0x342bf7?this['redisCacheService'][_0x43b42e(0x281)]({'key':redisKey_constant_1[_0x43b42e(0x204)]+_0x278d1d[_0x43b42e(0x284)],'val':_0x278d1d[_0x43b42e(0x206)]||null}):(_0x16eb50[_0x43b42e(0x24a)]=this[_0x43b42e(0x1f0)](_0x342bf7),await this[_0x43b42e(0x268)][_0x43b42e(0x20d)](_0x342bf7['id'],_0x16eb50[_0x43b42e(0x24a)])),_0x16eb50[_0x43b42e(0x284)]=_0x278d1d[_0x43b42e(0x284)],_0x16eb50;}catch(_0x429d88){common_1['Logger'][_0x43b42e(0x29b)](_0x43b42e(0x207),_0x429d88);throw new common_1[(_0x43b42e(0x2a4))](_0x429d88[_0x43b42e(0x282)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x10e70c(0x2a1)](_0x46a221){const _0x4bb57f=_0x10e70c,_0x10b1bf=new WeAppLogin_vo_1[(_0x4bb57f(0x22f))](),_0x1d64c9=(0x0,utils_1[_0x4bb57f(0x296)])(this[_0x4bb57f(0x277)]);try{const _0x5b787f=await axios_1[_0x4bb57f(0x21e)][_0x4bb57f(0x265)]('https://api.weixin.qq.com/sns/oauth2/access_token?appid='+store_1[_0x4bb57f(0x287)][_0x4bb57f(0x1dc)]+'&secret='+store_1[_0x4bb57f(0x287)]['WE_APP_APPSECRET']+_0x4bb57f(0x227)+_0x46a221+_0x4bb57f(0x1ed));if(_0x5b787f[_0x4bb57f(0x293)][_0x4bb57f(0x22b)])throw new Error(_0x5b787f[_0x4bb57f(0x293)][_0x4bb57f(0x26f)]);const _0x16b057=_0x5b787f[_0x4bb57f(0x293)],_0x1c40b3=await this[_0x4bb57f(0x29c)]['findOne']({'where':{'weAppOpenId':_0x16b057[_0x4bb57f(0x284)],'saasId':_0x1d64c9}});return!_0x1c40b3?this[_0x4bb57f(0x268)][_0x4bb57f(0x281)]({'key':redisKey_constant_1[_0x4bb57f(0x234)]+_0x16b057[_0x4bb57f(0x284)],'val':_0x16b057[_0x4bb57f(0x206)]||null}):(_0x10b1bf[_0x4bb57f(0x24a)]=this[_0x4bb57f(0x1f0)](_0x1c40b3),await this['redisCacheService']['saveToken'](_0x1c40b3['id'],_0x10b1bf[_0x4bb57f(0x24a)])),_0x10b1bf['openid']=_0x16b057['openid'],_0x10b1bf['accessToken']=_0x16b057['access_token'],_0x10b1bf;}catch(_0x239945){common_1[_0x4bb57f(0x1d4)][_0x4bb57f(0x29b)](_0x4bb57f(0x1da),_0x239945);throw new common_1[(_0x4bb57f(0x2a4))](_0x239945[_0x4bb57f(0x282)],common_1[_0x4bb57f(0x28a)][_0x4bb57f(0x1e0)]);}}async[_0x10e70c(0x1d9)](_0x478d43,_0x275502){const _0x4fabcf=_0x10e70c,_0x45a38d=await this[_0x4fabcf(0x20f)][_0x4fabcf(0x1e8)]([_0x4fabcf(0x26e),_0x4fabcf(0x1d5),_0x4fabcf(0x21b),_0x4fabcf(0x21c),_0x4fabcf(0x201)]);try{const _0x10123e=await this['verificationService'][_0x4fabcf(0x21d)](_0x478d43,verification_constant_1[_0x4fabcf(0x22c)]['Registration']),{type:_0x490a74,userId:_0x191b30}=_0x10123e;if(_0x490a74!==verification_constant_1[_0x4fabcf(0x22c)][_0x4fabcf(0x1d8)])throw new common_1[(_0x4fabcf(0x2a4))](_0x4fabcf(0x231),common_1[_0x4fabcf(0x28a)][_0x4fabcf(0x1e0)]);const _0x4ea5cc=await this[_0x4fabcf(0x219)]['getUserStatus'](_0x191b30);if(_0x4ea5cc===user_constant_1[_0x4fabcf(0x260)]['ACTIVE'])throw new common_1[(_0x4fabcf(0x2a4))](_0x4fabcf(0x294),common_1[_0x4fabcf(0x28a)][_0x4fabcf(0x1e0)]);await this[_0x4fabcf(0x219)][_0x4fabcf(0x298)](_0x10123e[_0x4fabcf(0x272)],user_constant_1['UserStatusEnum'][_0x4fabcf(0x215)]);const _0x469274=await this[_0x4fabcf(0x219)][_0x4fabcf(0x1f8)](_0x10123e[_0x4fabcf(0x272)]),{username:_0x45e425,email:_0x1ce7e0,id:_0x5e93dc,invitedBy:_0x21b782}=_0x469274;let _0x3fbae4;_0x21b782&&(_0x3fbae4=await this['userService']['qureyUserInfoByInviteCode'](_0x21b782)),await this['userService'][_0x4fabcf(0x23b)](_0x469274,_0x3fbae4),_0x275502[_0x4fabcf(0x210)]('/api/auth/registerSuccess?id='+_0x5e93dc['toString']()[_0x4fabcf(0x28c)](0x4,'0')+'&username='+_0x45e425+'&email='+_0x1ce7e0+_0x4fabcf(0x1e1)+_0x45a38d[_0x4fabcf(0x26e)]+'&registerSuccessEmailTeamName='+_0x45a38d[_0x4fabcf(0x1d5)]+_0x4fabcf(0x1fc)+_0x45a38d[_0x4fabcf(0x21b)]);}catch(_0x2884d4){console[_0x4fabcf(0x1d7)](_0x4fabcf(0x23f),_0x2884d4);const _0x121ce9=_0x2884d4[_0x4fabcf(0x290)];_0x275502[_0x4fabcf(0x210)]('/api/auth/registerError?message='+_0x121ce9+'&registerFailEmailTitle='+_0x45a38d['registerFailEmailTitle']+'&registerFailEmailTeamName='+_0x45a38d['registerFailEmailTeamName']);}}async['getInfo'](_0x46f3c7){const _0x4d045f=_0x10e70c,_0x16d332=await this[_0x4d045f(0x219)][_0x4d045f(0x250)]({'id':_0x46f3c7[_0x4d045f(0x291)]['id']});return{'userInfo':_0x16d332};}async[_0x10e70c(0x297)](_0x17770a,_0x2fa6e0){const _0x204fb7=_0x10e70c,{id:_0x5d9fe2,client:_0x17643a}=_0x17770a[_0x204fb7(0x291)];if(_0x17643a&&Number(_0x17643a)>0x0)throw new common_1['HttpException']('无权此操作、请联系管理员！',common_1[_0x204fb7(0x28a)][_0x204fb7(0x1e0)]);const {oldPassword:_0x1ed44a,password:_0x29658a}=_0x2fa6e0,_0x5ad0e2=await this[_0x204fb7(0x29c)]['findOne']({'where':{'id':_0x5d9fe2}});if(_0x5ad0e2['password']){if(!_0x1ed44a)throw new common_1[(_0x204fb7(0x2a4))](_0x204fb7(0x1f1),common_1['HttpStatus'][_0x204fb7(0x1e0)]);const _0x9eb0a5=bcrypt[_0x204fb7(0x1df)](_0x1ed44a,_0x5ad0e2[_0x204fb7(0x235)]);if(!_0x9eb0a5)throw new common_1[(_0x204fb7(0x2a4))](_0x204fb7(0x2a3),common_1[_0x204fb7(0x28a)][_0x204fb7(0x1e0)]);}return _0x5ad0e2[_0x204fb7(0x235)]=bcrypt[_0x204fb7(0x285)](_0x29658a,0xa),await this[_0x204fb7(0x29c)][_0x204fb7(0x24c)](_0x5ad0e2),'密码修改成功';}async['updateEmail'](_0x2181bc,_0x3f556a){const _0x343049=_0x10e70c,_0xbd59e0=_0x2181bc[_0x343049(0x291)]['id'],_0x1a2f81=await this[_0x343049(0x29c)]['findOne']({'where':{'email':_0x3f556a[_0x343049(0x266)]}});if(_0x1a2f81)throw new common_1['HttpException'](_0x343049(0x24d),axios_1[_0x343049(0x280)][_0x343049(0x208)]);const _0x57bd40=await this['userEntity'][_0x343049(0x1ee)]({'where':{'id':_0xbd59e0}}),_0x2e5028=await this[_0x343049(0x20f)]['getConfigByKeys'](['isVerifyEmail','registerBaseUrl','registerVerifyEmailTitle','registerVerifyEmailDesc',_0x343049(0x202),'registerVerifyExpir']);_0x57bd40[_0x343049(0x266)]=_0x3f556a[_0x343049(0x266)];const _0x4d3f25=_0x2e5028[_0x343049(0x27c)]?Number(_0x2e5028[_0x343049(0x27c)]):0x1e*0x3c,_0x51a824=await this['verificationService']['createVerification'](_0x57bd40,verification_constant_1[_0x343049(0x22c)][_0x343049(0x283)],_0x4d3f25),{code:_0x834718,email:_0x37c8c5,id:_0x56ed82}=_0x51a824,{registerVerifyEmailFrom:_0x4f3010}=_0x2e5028;await this[_0x343049(0x220)][_0x343049(0x269)]({'to':_0x37c8c5,'template':_0x343049(0x1f9),'subject':'来自'+_0x4f3010+_0x343049(0x1f2),'context':{'id':_0x56ed82,'code':_0x834718,'email':_0x37c8c5,..._0x2e5028,'baseUrl':_0x2e5028[_0x343049(0x1e9)]}});}async['getPhoneStatus'](_0x5c0fed){const _0x2a196b=_0x10e70c,_0x1169bf=await this['userEntity'][_0x2a196b(0x246)]({'where':{'phone':_0x5c0fed}});return _0x1169bf>0x0;}async[_0x10e70c(0x230)](_0xc0d0d){const _0x49db0e=_0x10e70c;return await this[_0x49db0e(0x29f)](_0xc0d0d[_0x49db0e(0x259)],_0xc0d0d[_0x49db0e(0x27b)]),await this['userEntity'][_0x49db0e(0x24c)]({'id':_0xc0d0d[_0x49db0e(0x272)],'phone':_0xc0d0d['phone']}),!![];}async[_0x10e70c(0x25b)](){const _0x59143b=_0x10e70c;try{const _0x40123c=process[_0x59143b(0x1fd)][_0x59143b(0x299)];if(_0x40123c===_0x59143b(0x29d)||_0x40123c===_0x59143b(0x239)||_0x40123c===_0x59143b(0x25a)){const _0x5b5785=await axios_1[_0x59143b(0x21e)]['get'](_0x59143b(0x1d0));await this[_0x59143b(0x268)][_0x59143b(0x281)]({'key':redisKey_constant_1[_0x59143b(0x27d)],'val':_0x5b5785[_0x59143b(0x293)]['data']});}else{const _0x37a5d5=await axios_1[_0x59143b(0x21e)]['post']('https://api.weixin.qq.com/cgi-bin/stable_token',{'grant_type':'client_credential','appid':store_1['WechatConfig'][_0x59143b(0x28e)],'secret':store_1[_0x59143b(0x287)][_0x59143b(0x222)],'force_refresh':![]});await this[_0x59143b(0x268)][_0x59143b(0x281)]({'key':redisKey_constant_1[_0x59143b(0x27d)],'val':_0x37a5d5['data']['access_token']});}}catch(_0x1ff1a7){common_1[_0x59143b(0x1d4)][_0x59143b(0x29b)]('wechat\x20获取access_token\x20失败：',_0x1ff1a7);}}[_0x10e70c(0x25c)](_0x3b169c){const _0x585c7c=_0x10e70c,_0x249b50={'id':_0x3b169c,'openId':null,'client':null,'role':'visitor','username':'游客'+_0x3b169c,'email':_0x3b169c+_0x585c7c(0x224),'saasId':(0x0,utils_1[_0x585c7c(0x296)])(this[_0x585c7c(0x277)])};return this[_0x585c7c(0x1f0)](_0x249b50);}async[_0x10e70c(0x2a0)](_0x5f1c6d,_0x38f405){const _0x4d0366=_0x10e70c,{status:_0x10ce61}=_0x5f1c6d;if(_0x10ce61!==user_constant_1[_0x4d0366(0x260)]['ACTIVE'])throw new common_1[(_0x4d0366(0x2a4))](user_constant_1[_0x4d0366(0x1ea)][_0x10ce61],common_1[_0x4d0366(0x28a)][_0x4d0366(0x1e0)]);const _0x37da3c=(0x0,utils_1[_0x4d0366(0x216)])(_0x38f405),_0x467029=this[_0x4d0366(0x1f0)](_0x5f1c6d);return await this['userService']['savaLoginIp'](_0x5f1c6d['id'],_0x37da3c),await this[_0x4d0366(0x268)]['saveToken'](_0x5f1c6d['id'],_0x467029),_0x467029;}async['validatePhoneCode'](_0x42b6fd,_0x4bce00){const _0x426b68=_0x10e70c,_0x34e4e3=await this['globalConfigService'][_0x426b68(0x256)](),_0x48d3d2=_0x34e4e3+_0x426b68(0x24f)+_0x42b6fd;if(_0x4bce00===_0x426b68(0x1e7))return;const _0x141278=await this[_0x426b68(0x268)][_0x426b68(0x265)]({'key':_0x48d3d2});if(!_0x141278)throw new common_1[(_0x426b68(0x2a4))](_0x426b68(0x289),common_1[_0x426b68(0x28a)]['BAD_REQUEST']);if(_0x4bce00!==_0x141278)throw new common_1['HttpException'](_0x426b68(0x1dd),common_1[_0x426b68(0x28a)][_0x426b68(0x1e0)]);}async[_0x10e70c(0x273)](_0x22e01d,_0x54d2a2){const _0x57acbb=_0x10e70c;let _0x2c6325;_0x54d2a2&&(_0x2c6325=await this[_0x57acbb(0x219)][_0x57acbb(0x1eb)](_0x54d2a2)),await this[_0x57acbb(0x219)][_0x57acbb(0x23b)](_0x22e01d,_0x2c6325);}};AuthService=__decorate([(0x0,common_1[_0x10e70c(0x1e4)])(),__param(0x0,(0x0,typeorm_1[_0x10e70c(0x241)])(user_entity_1[_0x10e70c(0x24b)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(role_entity_1[_0x10e70c(0x209)])),__metadata('design:paramtypes',[typeorm_2[_0x10e70c(0x237)],typeorm_2[_0x10e70c(0x237)],nestjs_cls_1[_0x10e70c(0x2a6)],jwt_1['JwtService'],user_service_1[_0x10e70c(0x286)],mailer_service_1[_0x10e70c(0x23d)],redisCache_service_1[_0x10e70c(0x238)],verification_service_1[_0x10e70c(0x1fa)],globalConfig_service_1[_0x10e70c(0x226)]])],AuthService),exports[_0x10e70c(0x26b)]=AuthService;