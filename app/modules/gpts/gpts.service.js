'use strict';const _0x251832=_0x3aec;(function(_0x5deb1b,_0x1914cd){const _0x30b149=_0x3aec,_0x277cb0=_0x5deb1b();while(!![]){try{const _0x309add=parseInt(_0x30b149(0x126))/0x1+-parseInt(_0x30b149(0xac))/0x2*(-parseInt(_0x30b149(0xbf))/0x3)+-parseInt(_0x30b149(0x135))/0x4+-parseInt(_0x30b149(0xf1))/0x5+parseInt(_0x30b149(0x138))/0x6+parseInt(_0x30b149(0x116))/0x7*(parseInt(_0x30b149(0x123))/0x8)+-parseInt(_0x30b149(0x109))/0x9*(parseInt(_0x30b149(0x100))/0xa);if(_0x309add===_0x1914cd)break;else _0x277cb0['push'](_0x277cb0['shift']());}catch(_0x2b4602){_0x277cb0['push'](_0x277cb0['shift']());}}}(_0x5f02,0xf139a));var __decorate=this&&this[_0x251832(0x101)]||function(_0x1824c8,_0x1cb5ad,_0x3b0f19,_0x3cebc6){const _0x39b643=_0x251832;var _0x4fd8c2=arguments['length'],_0x1c4de5=_0x4fd8c2<0x3?_0x1cb5ad:_0x3cebc6===null?_0x3cebc6=Object[_0x39b643(0x134)](_0x1cb5ad,_0x3b0f19):_0x3cebc6,_0xb4155f;if(typeof Reflect===_0x39b643(0xfa)&&typeof Reflect[_0x39b643(0x137)]===_0x39b643(0xc2))_0x1c4de5=Reflect[_0x39b643(0x137)](_0x1824c8,_0x1cb5ad,_0x3b0f19,_0x3cebc6);else{for(var _0x23a9c2=_0x1824c8[_0x39b643(0x110)]-0x1;_0x23a9c2>=0x0;_0x23a9c2--)if(_0xb4155f=_0x1824c8[_0x23a9c2])_0x1c4de5=(_0x4fd8c2<0x3?_0xb4155f(_0x1c4de5):_0x4fd8c2>0x3?_0xb4155f(_0x1cb5ad,_0x3b0f19,_0x1c4de5):_0xb4155f(_0x1cb5ad,_0x3b0f19))||_0x1c4de5;}return _0x4fd8c2>0x3&&_0x1c4de5&&Object[_0x39b643(0xb7)](_0x1cb5ad,_0x3b0f19,_0x1c4de5),_0x1c4de5;},__metadata=this&&this['__metadata']||function(_0x4a24d9,_0x200ed1){const _0x1b899b=_0x251832;if(typeof Reflect===_0x1b899b(0xfa)&&typeof Reflect[_0x1b899b(0x10f)]==='function')return Reflect['metadata'](_0x4a24d9,_0x200ed1);},__param=this&&this[_0x251832(0x13d)]||function(_0x3f398f,_0x4d932c){return function(_0x228126,_0x10b265){_0x4d932c(_0x228126,_0x10b265,_0x3f398f);};};function _0x3aec(_0x3dd190,_0x927036){const _0x5f0297=_0x5f02();return _0x3aec=function(_0x3aecca,_0x3f3360){_0x3aecca=_0x3aecca-0xa4;let _0x3389c7=_0x5f0297[_0x3aecca];return _0x3389c7;},_0x3aec(_0x3dd190,_0x927036);}Object[_0x251832(0xb7)](exports,_0x251832(0x106),{'value':!![]}),exports[_0x251832(0xe3)]=void 0x0;const common_1=require(_0x251832(0x129)),typeorm_1=require(_0x251832(0xf9)),gpts_group_entity_1=require(_0x251832(0xe9)),typeorm_2=require('typeorm'),gpts_model_entity_1=require(_0x251832(0xeb)),gpts_chat_entity_1=require(_0x251832(0x125)),chatLog_service_1=require(_0x251832(0xd6)),utils_1=require(_0x251832(0x13e)),models_service_1=require(_0x251832(0xc4)),userApps_entity_1=require('../app/userApps.entity'),model_constant_1=require(_0x251832(0x119)),nestjs_cls_1=require(_0x251832(0xe1));let GptsService=class GptsService{constructor(_0x1770f6,_0x81d01a,_0x4d7c44,_0x39a76e,_0x14ae12,_0x46f0b3,_0x2dd969){const _0x242a68=_0x251832;this['userAppsEntity']=_0x1770f6,this['gptsGroupEntity']=_0x81d01a,this[_0x242a68(0x136)]=_0x4d7c44,this[_0x242a68(0xa5)]=_0x39a76e,this[_0x242a68(0xd3)]=_0x14ae12,this[_0x242a68(0xa8)]=_0x46f0b3,this[_0x242a68(0xb3)]=_0x2dd969;}async[_0x251832(0x117)](_0x2fc25d){const _0x18789c=_0x251832;try{const _0x506c0f=_0x2fc25d[_0x18789c(0xd1)],_0x14de32=(0x0,utils_1[_0x18789c(0xc8)])(this[_0x18789c(0xd3)]),_0x4883e9=await this[_0x18789c(0xed)][_0x18789c(0xf6)]({'where':{'groupName':_0x506c0f,'saasId':_0x14de32}});if(_0x4883e9)throw new common_1['HttpException'](_0x18789c(0xbd),common_1[_0x18789c(0x11d)][_0x18789c(0xdc)]);return await this['gptsGroupEntity'][_0x18789c(0x11e)]({..._0x2fc25d,'saasId':_0x14de32}),!![];}catch(_0x41f7ea){throw new common_1['HttpException'](_0x41f7ea[_0x18789c(0xab)],common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x251832(0xe7)](_0x22fd44){const _0x41ae34=_0x251832;try{const _0x2fc8eb=await this[_0x41ae34(0xed)][_0x41ae34(0xf6)]({'where':{'id':_0x22fd44['id']}});if(!_0x2fc8eb)throw new common_1[(_0x41ae34(0xdd))](_0x41ae34(0xb9),common_1['HttpStatus'][_0x41ae34(0xdc)]);return await this[_0x41ae34(0xed)][_0x41ae34(0x111)]({'id':_0x22fd44['id']},_0x22fd44),!![];}catch(_0x1bb76a){throw new common_1[(_0x41ae34(0xdd))](_0x1bb76a[_0x41ae34(0xab)],common_1[_0x41ae34(0x11d)][_0x41ae34(0xdc)]);}}async[_0x251832(0x10c)](_0x3347a6){const _0x2a75ce=_0x251832;try{const _0x4c8c39=_0x3347a6['id'],_0x1f9715=await this[_0x2a75ce(0xed)][_0x2a75ce(0xf6)]({'where':{'id':_0x4c8c39}});if(!_0x1f9715)throw new common_1['HttpException'](_0x2a75ce(0xe0),common_1['HttpStatus'][_0x2a75ce(0xdc)]);const _0x223531=await this[_0x2a75ce(0x136)][_0x2a75ce(0xe6)]({'where':{'groupId':_0x1f9715['id']}});if(_0x223531>0x0)throw new common_1[(_0x2a75ce(0xdd))]('当前分类存在应用,不允许删除！',common_1[_0x2a75ce(0x11d)][_0x2a75ce(0xdc)]);else await this['gptsGroupEntity'][_0x2a75ce(0xf5)]({'id':_0x4c8c39});}catch(_0xc7d19a){throw new common_1[(_0x2a75ce(0xdd))](_0xc7d19a['message'],common_1[_0x2a75ce(0x11d)][_0x2a75ce(0xdc)]);}}async['handleQueryGroup'](_0x50a5ae,_0x315482){const _0x547d5e=_0x251832;try{const _0x57dac7=(0x0,utils_1[_0x547d5e(0xc8)])(this['clsService']),{page:page=0x1,size:size=0x14,status:_0x1990c1,saasId:_0x525f9e,groupName:_0x300d69}=_0x50a5ae,_0xec7de3={};return _0x300d69&&(_0xec7de3['groupName']=_0x300d69),_0x1990c1>=0x0&&(_0xec7de3[_0x547d5e(0xff)]=_0x1990c1),(0x0,utils_1[_0x547d5e(0x132)])(this['clsService'])?(0x0,utils_1[_0x547d5e(0x12b)])(_0x525f9e)&&(_0xec7de3[_0x547d5e(0xbc)]=_0x525f9e):_0xec7de3[_0x547d5e(0xbc)]=_0x57dac7,await this['gptsGroupEntity'][_0x547d5e(0xb4)]({'where':_0xec7de3,'skip':(page-0x1)*size,'take':size,'order':{'weight':_0x547d5e(0xfd),'id':'DESC'}})[_0x547d5e(0x12c)](([_0x50f838,_0x3fde76])=>({'rows':_0x50f838,'count':_0x3fde76}))[_0x547d5e(0x118)](_0x58e7e9=>{throw new Error(_0x58e7e9);});}catch(_0x2bec0a){console['log'](_0x547d5e(0xe5),_0x2bec0a);throw new common_1['HttpException'](_0x2bec0a,common_1[_0x547d5e(0x11d)][_0x547d5e(0xdc)]);}}async['handleGetGroup'](_0x4840f2,_0x4bd867){const _0x5215ea=_0x251832;try{const {groupId:_0x233bbd}=_0x4840f2;return await this['gptsGroupEntity'][_0x5215ea(0xf6)]({'where':{'id':Number(_0x233bbd)}})[_0x5215ea(0x12c)](_0x56d212=>{return _0x56d212;})[_0x5215ea(0x118)](_0xd79a59=>{throw new Error(_0xd79a59);});}catch(_0x590564){console[_0x5215ea(0x13a)](_0x5215ea(0xe5),_0x590564);throw new common_1[(_0x5215ea(0xdd))](_0x590564,common_1[_0x5215ea(0x11d)][_0x5215ea(0xdc)]);}}async[_0x251832(0x102)](_0x52c586,_0x51938){const _0x5cbd4b=_0x251832;try{const _0x369a63=_0x52c586['user']['id'],_0x26916b=(0x0,utils_1[_0x5cbd4b(0xc8)])(this[_0x5cbd4b(0xd3)]),_0x22bc0b=Object[_0x5cbd4b(0xb0)](new gpts_model_entity_1[(_0x5cbd4b(0x10e))](),_0x51938);_0x22bc0b['status']=Number(_0x51938[_0x5cbd4b(0xff)]);if(_0x22bc0b['id']){const _0xd3f862=await this[_0x5cbd4b(0x136)][_0x5cbd4b(0xf6)]({'where':{'id':_0x22bc0b['id']}});if(!_0xd3f862)throw new common_1[(_0x5cbd4b(0xdd))](_0x5cbd4b(0xaf),common_1[_0x5cbd4b(0x11d)][_0x5cbd4b(0xdc)]);if(_0xd3f862[_0x5cbd4b(0xcb)]!==_0x22bc0b[_0x5cbd4b(0xcb)])throw new common_1['HttpException'](_0x5cbd4b(0x13f),common_1[_0x5cbd4b(0x11d)]['BAD_REQUEST']);return await this[_0x5cbd4b(0x136)][_0x5cbd4b(0x111)]({'id':_0x22bc0b['id']},{..._0x22bc0b,'useCount':_0x22bc0b['useCount']??_0xd3f862[_0x5cbd4b(0x114)],'collectCount':_0x22bc0b[_0x5cbd4b(0xb8)]??_0xd3f862['collectCount']})[_0x5cbd4b(0x12c)](_0x331c6a=>_0x331c6a[_0x5cbd4b(0xe2)]>0x0)[_0x5cbd4b(0x118)](_0x52907f=>{throw new Error(_0x52907f);});}else{const _0x114e46=await this['gptsGroupEntity']['findOne']({'where':{'id':_0x22bc0b[_0x5cbd4b(0xca)]}});if(!_0x114e46)throw new common_1[(_0x5cbd4b(0xdd))](_0x5cbd4b(0xb6),common_1[_0x5cbd4b(0x11d)][_0x5cbd4b(0xdc)]);return await this[_0x5cbd4b(0x136)][_0x5cbd4b(0x11e)]({..._0x22bc0b,'saasId':_0x26916b,'userId':_0x52c586[_0x5cbd4b(0xba)][_0x5cbd4b(0x12f)]?_0x369a63:null})['then'](_0x3d964e=>!!_0x3d964e)[_0x5cbd4b(0x118)](_0xa94ab6=>{throw new Error(_0xa94ab6);});}}catch(_0x4fa65a){throw new common_1[(_0x5cbd4b(0xdd))](_0x4fa65a,common_1[_0x5cbd4b(0x11d)][_0x5cbd4b(0xdc)]);}}async['getExistGpts'](){const _0x5ad7b1=_0x251832;return await this[_0x5ad7b1(0x136)][_0x5ad7b1(0xbe)]()[_0x5ad7b1(0x12c)](_0x165f0c=>_0x165f0c['map'](_0x20bc10=>_0x20bc10[_0x5ad7b1(0xf3)]));}async[_0x251832(0x103)](_0x5ad42e){const _0x365274=_0x251832;try{const _0x429b4a=(0x0,utils_1['getReqSaasId'])(this[_0x365274(0xd3)]),_0x539f7a=await this[_0x365274(0x140)](),_0x3e4dcb=_0x5ad42e['filter'](_0x4ae1fd=>!_0x539f7a[_0x365274(0x11b)](_0x4ae1fd[_0x365274(0xf3)]))[_0x365274(0x105)](_0x2ba392=>({'groupId':_0x2ba392[_0x365274(0xca)],'relModel':_0x2ba392[_0x365274(0x11f)],'logo':_0x2ba392[_0x365274(0xa7)],'desc':_0x2ba392['desc'],'modelName':_0x2ba392[_0x365274(0xf3)],'modelId':_0x2ba392[_0x365274(0x112)],'saasId':_0x429b4a}));return await this[_0x365274(0x136)][_0x365274(0x11e)](_0x3e4dcb)[_0x365274(0x118)](_0x226756=>{throw new Error(_0x226756);});}catch(_0x123fbd){console[_0x365274(0x13a)](_0x365274(0xe5),_0x123fbd);throw new common_1['HttpException'](_0x123fbd,common_1[_0x365274(0x11d)][_0x365274(0xdc)]);}}async['handleQueryGpts'](_0x5f5828,_0x5d93ce){const _0x23d14b=_0x251832;try{const _0x2b9e6c=(0x0,utils_1[_0x23d14b(0xf7)])(this[_0x23d14b(0xd3)]),_0x2e0d3a=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x24bfd4=new Set(),_0x145a74=new Map(),{modelId:_0x5eeb91,modelName:_0x4d74ff,groupId:_0x4094b9,back:_0x585238,status:_0x3b95ed,page:page=0x1,size:size=0x14,saasId:_0x37dd20}=_0x5f5828,_0x540dfe={'delFlag':![]};_0x2b9e6c?_0x540dfe[_0x23d14b(0x10d)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x23d14b(0xcd)])(_0x2b9e6c),(0x0,typeorm_2[_0x23d14b(0x13b)])()):_0x540dfe[_0x23d14b(0x10d)]=(0x0,typeorm_2[_0x23d14b(0x13b)])();(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1[_0x23d14b(0x12b)])(_0x37dd20)&&(_0x540dfe[_0x23d14b(0xbc)]=_0x37dd20):_0x540dfe[_0x23d14b(0xbc)]=_0x2e0d3a;!_0x585238?_0x540dfe['status']=0x1:(_0x3b95ed!==undefined&&_0x3b95ed!==null&&(_0x540dfe[_0x23d14b(0xff)]=_0x3b95ed),delete _0x540dfe['userId']);_0x5eeb91&&(_0x540dfe[_0x23d14b(0x112)]=_0x5eeb91),_0x4094b9&&(_0x540dfe[_0x23d14b(0xca)]=_0x4094b9),_0x4d74ff&&(_0x540dfe[_0x23d14b(0xf3)]=(0x0,typeorm_2[_0x23d14b(0x12e)])('%'+_0x4d74ff+'%'));const [_0x4c00ec,_0x4bbdf4]=await this[_0x23d14b(0x136)]['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x540dfe,'order':{'sortId':_0x23d14b(0xfd)}});if(_0x4c00ec[_0x23d14b(0x110)]){const _0x43b77a=[],_0x39a6e7=[];_0x4c00ec['forEach'](_0x214fed=>{const _0x2f3cfb=_0x23d14b;_0x43b77a[_0x2f3cfb(0x122)](_0x214fed['id']),_0x39a6e7[_0x2f3cfb(0x122)](_0x214fed[_0x2f3cfb(0xca)]);});if(_0x2b9e6c){const _0x16352e=await this[_0x23d14b(0x11c)][_0x23d14b(0xbe)]({'where':{'userId':_0x2b9e6c,'appId':(0x0,typeorm_2['In'])(_0x43b77a)}});_0x16352e[_0x23d14b(0xae)](_0x5b2baa=>_0x24bfd4['add'](_0x5b2baa['appId']));}const _0x44ba43=await this['gptsGroupEntity'][_0x23d14b(0xbe)]({'where':{'id':(0x0,typeorm_2['In'])(_0x39a6e7)}});_0x44ba43[_0x23d14b(0xae)](_0x4723e0=>_0x145a74[_0x23d14b(0xb5)](_0x4723e0['id'],_0x4723e0));}return{'count':_0x4bbdf4,'rows':_0x4c00ec['map'](_0x44219e=>({..._0x44219e,'collected':_0x24bfd4['has'](_0x44219e['id']),'groupName':_0x145a74[_0x23d14b(0xcf)](_0x44219e[_0x23d14b(0xca)])?.[_0x23d14b(0xd1)]}))};}catch(_0x568630){console[_0x23d14b(0x13a)](_0x23d14b(0xe5),_0x568630);throw new common_1[(_0x23d14b(0xdd))](_0x568630,common_1[_0x23d14b(0x11d)][_0x23d14b(0xdc)]);}}async[_0x251832(0xc0)](_0x5be765,_0x497379){const _0x3061a9=_0x251832,_0x4d26ca=(0x0,utils_1[_0x3061a9(0xf7)])(this[_0x3061a9(0xd3)]),_0xee91e3=(0x0,utils_1[_0x3061a9(0xc8)])(this['clsService']),_0x3312c9={'take':0x1e};if(_0x497379==_0x3061a9(0x12a))_0x3312c9['where']={'status':0x1,'delFlag':![],'recommend':!![]},_0x3312c9[_0x3061a9(0xa9)]={'createdAt':_0x3061a9(0xfd)};else{if(_0x497379===_0x3061a9(0xce))_0x3312c9[_0x3061a9(0xc9)]={'status':0x1,'delFlag':![]},_0x3312c9[_0x3061a9(0xa9)]={'useCount':'DESC'};else{if(_0x497379===_0x3061a9(0x121))_0x3312c9[_0x3061a9(0xc9)]={'status':0x1,'delFlag':![]},_0x3312c9[_0x3061a9(0xa9)]={'collectCount':_0x3061a9(0xfd)};else{if(_0x497379===_0x3061a9(0x11a)){if(!_0x4d26ca)throw new common_1[(_0x3061a9(0xdd))](_0x3061a9(0x120),common_1['HttpStatus'][_0x3061a9(0xef)]);_0x3312c9[_0x3061a9(0xc9)]={'status':0x1,'delFlag':![],'userId':_0x4d26ca},_0x3312c9['order']={'createdAt':'DESC'};}else _0x3312c9[_0x3061a9(0xc9)]={'status':0x1,'delFlag':![]},_0x3312c9[_0x3061a9(0xa9)]={'createdAt':'DESC'};}}}_0x3312c9[_0x3061a9(0xc9)][_0x3061a9(0xbc)]=_0xee91e3;const _0x444ed3=await this['gptsModelEntity']['find'](_0x3312c9),_0x3b5688=new Set(),_0x565750=new Map(),_0x536095=new Map(),_0x222b32=[],_0x277728=[];_0x444ed3[_0x3061a9(0xae)](_0x76ad17=>{const _0x23cbb3=_0x3061a9;_0x222b32[_0x23cbb3(0x122)](_0x76ad17['id']),_0x277728[_0x23cbb3(0x122)](_0x76ad17[_0x23cbb3(0xca)]);});if(_0x222b32[_0x3061a9(0x110)]){if(_0x4d26ca){const _0x4c15d7=await this[_0x3061a9(0x11c)][_0x3061a9(0xbe)]({'where':{'userId':_0x4d26ca,'appId':(0x0,typeorm_2['In'])(_0x222b32)}});_0x4c15d7[_0x3061a9(0xae)](_0x4f5d97=>_0x3b5688[_0x3061a9(0xee)](_0x4f5d97[_0x3061a9(0x104)]));const _0x5d60f5=await this[_0x3061a9(0xb3)]['getLastByUserAndAppIds'](_0x4d26ca,_0x222b32);_0x5d60f5[_0x3061a9(0xae)](_0x564d37=>_0x565750['set'](_0x564d37[_0x3061a9(0x104)],_0x564d37[_0x3061a9(0xc3)]));}const _0x38ad21=await this[_0x3061a9(0xed)][_0x3061a9(0xbe)]({'where':{'id':(0x0,typeorm_2['In'])(_0x277728)}});_0x38ad21[_0x3061a9(0xae)](_0x8a286e=>_0x536095[_0x3061a9(0xb5)](_0x8a286e['id'],_0x8a286e));}return _0x444ed3[_0x3061a9(0x105)](_0x3f312d=>({..._0x3f312d,'collected':_0x3b5688['has'](_0x3f312d['id']),'lastTime':_0x565750[_0x3061a9(0xcf)](_0x3f312d['id'])||null,'groupName':_0x536095[_0x3061a9(0xcf)](_0x3f312d[_0x3061a9(0xca)])?.['groupName']}));}async[_0x251832(0xd0)](_0x5a824a){const _0x524fe0=_0x251832;try{const {id:_0x21c9c5}=_0x5a824a,_0x59ec79=await this[_0x524fe0(0x136)][_0x524fe0(0xf6)]({'where':{'id':_0x21c9c5}});if(!_0x59ec79)throw new common_1['HttpException'](_0x524fe0(0xb1),common_1[_0x524fe0(0x11d)][_0x524fe0(0xdc)]);return await this['gptsModelEntity'][_0x524fe0(0xf5)](_0x21c9c5)[_0x524fe0(0x12c)](_0x1b4f90=>_0x1b4f90['affected']>0x0)[_0x524fe0(0x118)](_0x11f843=>{throw new Error(_0x11f843);});}catch(_0x44c0b0){console[_0x524fe0(0x13a)](_0x524fe0(0xe5),_0x44c0b0);throw new common_1[(_0x524fe0(0xdd))](_0x44c0b0,common_1[_0x524fe0(0x11d)][_0x524fe0(0xdc)]);}}async[_0x251832(0xc5)](_0x38c99d,_0x5df499){const _0x47befc=_0x251832,_0x4cd309=_0x38c99d[_0x47befc(0x104)],_0xc2613a=_0x5df499[_0x47befc(0x139)]['id'],_0x56ae20=(0x0,utils_1[_0x47befc(0xc8)])(this[_0x47befc(0xd3)]);let _0x565f3a=null,_0x5a23cd={'title':_0x47befc(0x107),'userId':_0xc2613a,'saasId':_0x56ae20};try{_0x565f3a=await this['gptsModelEntity'][_0x47befc(0xf6)]({'where':{'id':_0x4cd309}});if(!_0x565f3a)throw new Error('非法操作、您在使用一个不存在的应用！');if(_0x565f3a[_0x47befc(0xff)]!==0x1)throw new Error('非法操作、您在使用一个未启用的应用！');const _0x1ea745=await this[_0x47befc(0xa5)][_0x47befc(0xe6)]({'where':{'modelId':_0x4cd309,'userId':_0xc2613a,'isDelete':![]}});if(_0x1ea745>0x0)throw new Error(_0x47befc(0xf0));_0x5a23cd[_0x47befc(0x112)]=_0x565f3a['id'],_0x5a23cd[_0x47befc(0xad)]=_0x565f3a[_0x47befc(0x112)],_0x5a23cd[_0x47befc(0xca)]=_0x565f3a[_0x47befc(0xca)],_0x5a23cd[_0x47befc(0xf2)]=_0x565f3a['desc']||'',_0x5a23cd[_0x47befc(0xa7)]=_0x565f3a['logo']||'',_0x5a23cd[_0x47befc(0x12d)]=_0x565f3a[_0x47befc(0xf3)],_0x5a23cd[_0x47befc(0xe8)]=_0x565f3a[_0x47befc(0xe8)]||'';let _0x1c1acb=await this[_0x47befc(0xa8)][_0x47befc(0xfc)](model_constant_1['EModelType'][_0x47befc(0xea)]);_0x1c1acb[_0x47befc(0xd4)][_0x47befc(0xd7)]=_0x565f3a[_0x47befc(0xd7)],_0x1c1acb['modelInfo']['modelName']=_0x565f3a[_0x47befc(0xf3)],_0x1c1acb[_0x47befc(0xd4)]['canUpload']=_0x565f3a[_0x47befc(0xc1)];_0x565f3a['gptsApp']?_0x1c1acb[_0x47befc(0xd4)][_0x47befc(0xad)]=_0x565f3a[_0x47befc(0x112)]:_0x1c1acb[_0x47befc(0xd4)][_0x47befc(0xad)]=_0x565f3a['relModel'];_0x5a23cd[_0x47befc(0x10b)]=JSON[_0x47befc(0xd2)](_0x1c1acb);const _0x3aae55=await this[_0x47befc(0xa5)]['save'](_0x5a23cd);return _0x565f3a&&(_0x565f3a['useCount']=_0x565f3a[_0x47befc(0x114)]+Math[_0x47befc(0xa6)](Math['random']()*0xa),await this['gptsModelEntity'][_0x47befc(0x11e)](_0x565f3a)),_0x3aae55;}catch(_0x3f7898){throw new common_1[(_0x47befc(0xdd))](_0x3f7898['message'],common_1[_0x47befc(0x11d)][_0x47befc(0xdc)]);}}async[_0x251832(0xd5)](_0x2a312a){const _0x4e8bcc=_0x251832;try{const _0x6db282=_0x2a312a[_0x4e8bcc(0x139)]['id'],_0x2c6f07={'userId':_0x6db282,'isDelete':![]},_0xa44437=await this['gptsChatEntity']['find']({'where':_0x2c6f07,'order':{'isSticky':_0x4e8bcc(0xfd),'id':_0x4e8bcc(0xfd)}}),_0x5d7a29=new Set(),_0x3e0dac=new Map(),_0x2c310e=new Map(),_0x5c87cf=[],_0x2e449b=[];_0xa44437[_0x4e8bcc(0xae)](_0x4c94d8=>{const _0x15bdfe=_0x4e8bcc;_0x5c87cf[_0x15bdfe(0x122)](_0x4c94d8['modelId']),_0x2e449b['push'](_0x4c94d8[_0x15bdfe(0xca)]);});if(_0x5c87cf[_0x4e8bcc(0x110)]){const _0x3c810e=await this[_0x4e8bcc(0x11c)]['find']({'where':{'userId':_0x6db282,'appId':(0x0,typeorm_2['In'])(_0x5c87cf)}});_0x3c810e[_0x4e8bcc(0xae)](_0x5bb035=>_0x5d7a29[_0x4e8bcc(0xee)](_0x5bb035['appId']));const _0x382cf2=await this['gptsModelEntity'][_0x4e8bcc(0xbe)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5c87cf),'status':0x1,'delFlag':![]}});_0x382cf2['forEach'](_0x3ff31a=>_0x3e0dac['set'](_0x3ff31a['id'],_0x3ff31a));const _0x178dbc=await this[_0x4e8bcc(0xed)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x2e449b)}});_0x178dbc[_0x4e8bcc(0xae)](_0x5e3b8f=>_0x2c310e['set'](_0x5e3b8f['id'],_0x5e3b8f));}return _0xa44437[_0x4e8bcc(0x105)](_0x3d791b=>{const _0x3527d8=_0x4e8bcc,_0x55c3a5=_0x3e0dac['get'](_0x3d791b['modelId']);if(_0x55c3a5?.[_0x3527d8(0xcb)]){const _0xcaedca=JSON[_0x3527d8(0xec)](_0x3d791b[_0x3527d8(0x10b)]);_0xcaedca[_0x3527d8(0xd4)][_0x3527d8(0xad)]=_0x55c3a5['modelId'],_0x3d791b['config']=JSON[_0x3527d8(0xd2)](_0xcaedca);}return{..._0x3d791b,'modelName':_0x3d791b[_0x3527d8(0x12d)],'gptsApp':_0x55c3a5?.['gptsApp'],'collected':_0x5d7a29[_0x3527d8(0xda)](_0x3d791b[_0x3527d8(0x112)]),'groupName':_0x2c310e[_0x3527d8(0xcf)](_0x3d791b[_0x3527d8(0xca)])?.[_0x3527d8(0xd1)]};});}catch(_0x5da538){console['log'](_0x4e8bcc(0xe5),_0x5da538);throw new common_1[(_0x4e8bcc(0xdd))](_0x5da538,common_1[_0x4e8bcc(0x11d)][_0x4e8bcc(0xdc)]);}}async[_0x251832(0x128)](_0x2ac131,_0x54fef5){const _0x31e1f9=_0x251832,{title:_0x1b73ec,isSticky:_0x3f9eb8,groupId:_0x9337c8,config:_0x36dc24}=_0x2ac131,{id:_0x14928e}=_0x54fef5['user'],_0x48847b=await this[_0x31e1f9(0xa5)]['findOne']({'where':{'id':_0x9337c8,'userId':_0x14928e}});if(!_0x48847b)throw new common_1[(_0x31e1f9(0xdd))]('GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！',common_1[_0x31e1f9(0x11d)][_0x31e1f9(0xdc)]);const _0x3faaae={};_0x3faaae[_0x31e1f9(0x12d)]=_0x1b73ec||_0x48847b[_0x31e1f9(0x12d)],_0x3faaae[_0x31e1f9(0x10b)]=_0x36dc24||_0x48847b[_0x31e1f9(0x10b)],_0x3faaae['isSticky']=_0x3f9eb8??_0x48847b[_0x31e1f9(0xf4)];const _0x1f29b0=await this[_0x31e1f9(0xa5)][_0x31e1f9(0x111)]({'id':_0x9337c8},_0x3faaae);if(_0x1f29b0[_0x31e1f9(0xe2)])return!![];else throw new common_1[(_0x31e1f9(0xdd))](_0x31e1f9(0xc7),common_1['HttpStatus']['BAD_REQUEST']);}async[_0x251832(0xfe)](_0x56cea3,_0x37a44c){const _0x242791=_0x251832;try{const {groupId:_0x509b73}=_0x56cea3,{id:_0x48d604}=_0x37a44c[_0x242791(0x139)],_0x8c90e4=await this[_0x242791(0xa5)][_0x242791(0xf6)]({'where':{'id':_0x509b73,'userId':_0x48d604}})[_0x242791(0x118)](_0x588261=>{const _0x2bd679=_0x242791;common_1[_0x2bd679(0xfb)][_0x2bd679(0x133)](_0x588261);throw new Error(_0x588261);});if(!_0x8c90e4)throw new Error(_0x242791(0xf8));await this['chatLogService']['removeLogsBatch']({'userId':_0x48d604,'ids':[_0x509b73]})[_0x242791(0x118)](_0xed4235=>{throw new Error(_0xed4235);});const _0x29e31b=await this[_0x242791(0xa5)][_0x242791(0xf5)]({'id':_0x509b73})['catch'](_0x305cc0=>{throw new Error(_0x305cc0);});if(!_0x29e31b)throw new Error(_0x242791(0x127));return!![];}catch(_0x183690){throw new common_1[(_0x242791(0xdd))](_0x183690,common_1[_0x242791(0x11d)][_0x242791(0xdc)]);}}async[_0x251832(0xaa)](_0x56ae3f){const _0xb56c08=_0x251832;try{const {id:_0x3117fa}=_0x56ae3f[_0xb56c08(0x139)],_0x5cd7f7=await this[_0xb56c08(0xa5)][_0xb56c08(0xbe)]({'where':{'userId':_0x3117fa}})[_0xb56c08(0x118)](_0xf22312=>{const _0x53e534=_0xb56c08;common_1[_0x53e534(0xfb)][_0x53e534(0x133)](_0xf22312);throw new Error(_0xf22312);});if(!_0x5cd7f7||_0x5cd7f7[_0xb56c08(0x110)]===0x0)throw new Error(_0xb56c08(0x130));const _0x3379ec=_0x5cd7f7[_0xb56c08(0x105)](_0x454bbb=>_0x454bbb[_0xb56c08(0xca)]);await this[_0xb56c08(0xb3)]['removeLogsBatch']({'ids':_0x3379ec,'userId':_0x3117fa})['catch'](_0xacec62=>{throw new Error(_0xacec62);});const _0xdcbadd=await this[_0xb56c08(0xa5)][_0xb56c08(0xf5)]({'userId':_0x3117fa,'isSticky':![]})[_0xb56c08(0x118)](_0x388e4e=>{throw new Error(_0x388e4e);});if(!_0xdcbadd)throw new Error(_0xb56c08(0xcc));return!![];}catch(_0x2dd6c3){throw new common_1[(_0xb56c08(0xdd))](_0x2dd6c3,common_1[_0xb56c08(0x11d)][_0xb56c08(0xdc)]);}}async[_0x251832(0x124)](_0x4576aa){const _0x19adb8=_0x251832;return await this['gptsChatEntity'][_0x19adb8(0xf6)]({'where':{'id':_0x4576aa}});}async['getCurrentModelByChatGroupId'](_0x3c77d8){const _0x5725bb=_0x251832,_0x1daf21=await this[_0x5725bb(0xa5)][_0x5725bb(0xf6)]({'where':{'id':_0x3c77d8}}),_0x1aa72c=await this[_0x5725bb(0x136)][_0x5725bb(0xf6)]({'where':{'id':_0x1daf21[_0x5725bb(0x112)]}}),_0x3cb59e=await this['modelsService'][_0x5725bb(0x13c)](model_constant_1[_0x5725bb(0xe4)][_0x5725bb(0xea)]);return _0x3cb59e[_0x5725bb(0xf3)]=_0x1aa72c[_0x5725bb(0xf3)],_0x3cb59e['model']=_0x1aa72c[_0x5725bb(0x112)]||_0x1aa72c[_0x5725bb(0x11f)],_0x3cb59e;}async['saveGptsUseLog'](_0x50056a,_0x393d67){const _0x27afa2=_0x251832;await this[_0x27afa2(0xed)][_0x27afa2(0xdf)]()['update'](gpts_group_entity_1[_0x27afa2(0xbb)])[_0x27afa2(0xb5)]({'useCount':()=>'useCount\x20+\x201','useToken':()=>'useToken\x20+\x20'+_0x393d67})['where'](_0x27afa2(0xd9),{'id':_0x50056a})[_0x27afa2(0x113)]();}async[_0x251832(0xdb)](_0x40e14d,_0x396da9){const _0x16402b=_0x251832,_0x391aeb={'id':_0x40e14d};return _0x396da9!=null&&_0x396da9!==undefined&&(_0x391aeb['status']=_0x396da9),this[_0x16402b(0x136)][_0x16402b(0xf6)]({'where':_0x391aeb});}};function _0x5f02(){const _0x4ce565=['@nestjs/common','recommend','isDefined','then','title','Like','fingerprint','当前用户没有创建GPT对话！','design:paramtypes','isPlatform','error','getOwnPropertyDescriptor','7837928cqrTFF','gptsModelEntity','decorate','11573382cLScFB','user','log','IsNull','getRandomKey','__param','../../common/utils','应用类型不可更改！','getExistGpts','ModelsService','gptsChatEntity','ceil','logo','modelsService','order','delAllGptsChat','message','36hXSTHY','model','forEach','模型不存在！','assign','gpts不存在,无法删除！','Repository','chatLogService','findAndCount','set','应用分类不存在！','defineProperty','collectCount','模型组不存在！','headers','GptsGroupEntity','saasId','分类已存在！','find','322923xUNPMX','listByFrontType','canUpload','function','createdAt','../models/models.service','handleCreateChat','InjectRepository','更新对话失败！','getReqSaasId','where','groupId','gptsApp','清空失败！','Equal','popular','get','handleRemoveGpts','groupName','stringify','clsService','modelInfo','handleGetChat','../chatLog/chatLog.service','canAudio','ClsService','id\x20=\x20:id','has','getAppById','BAD_REQUEST','HttpException','ChatLogService','createQueryBuilder','应用分类不存在,无法删除！','nestjs-cls','affected','GptsService','EModelType','error:\x20','count','handleUpdateGroup','demoData','./gpts.group.entity','APP','./gpts.model.entity','parse','gptsGroupEntity','add','UNAUTHORIZED','当前应用已经开启了一个对话无需新建了！','238225GiMAOe','desc','modelName','isSticky','delete','findOne','getUserId','非法操作、您在删除一个非法资源！','@nestjs/typeorm','object','Logger','getModelByType','DESC','delGptsChat','status','646790FsCGJn','__decorate','handleAddGpts','handleAddGptsBatch','appId','map','__esModule','新对话','UserAppsEntity','333CLWdRP','Injectable','config','handleRemoveGroup','userId','GptsModelEntity','metadata','length','update','modelId','execute','useCount','GptsChatEntity','50239NeAMTe','handleAddGroup','catch','../../common/constants/model.constant','mine','includes','userAppsEntity','HttpStatus','save','relModel','请先登录！','favorite','push','408LqbdLY','getGroupInfoFromId','./gpts.chat.entity','1155846rVgbVY','删除失败！','updateGptsChat'];_0x5f02=function(){return _0x4ce565;};return _0x5f02();}GptsService=__decorate([(0x0,common_1[_0x251832(0x10a)])(),__param(0x0,(0x0,typeorm_1[_0x251832(0xc6)])(userApps_entity_1[_0x251832(0x108)])),__param(0x1,(0x0,typeorm_1[_0x251832(0xc6)])(gpts_group_entity_1[_0x251832(0xbb)])),__param(0x2,(0x0,typeorm_1[_0x251832(0xc6)])(gpts_model_entity_1[_0x251832(0x10e)])),__param(0x3,(0x0,typeorm_1[_0x251832(0xc6)])(gpts_chat_entity_1[_0x251832(0x115)])),__metadata(_0x251832(0x131),[typeorm_2[_0x251832(0xb2)],typeorm_2[_0x251832(0xb2)],typeorm_2[_0x251832(0xb2)],typeorm_2['Repository'],nestjs_cls_1[_0x251832(0xd8)],models_service_1[_0x251832(0xa4)],chatLog_service_1[_0x251832(0xde)]])],GptsService),exports[_0x251832(0xe3)]=GptsService;