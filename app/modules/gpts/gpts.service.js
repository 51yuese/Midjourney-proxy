'use strict';function _0x9698(_0x539c88,_0x11c3bb){const _0x59ebe4=_0x59eb();return _0x9698=function(_0x9698f6,_0x3e5a67){_0x9698f6=_0x9698f6-0x151;let _0xc749e3=_0x59ebe4[_0x9698f6];return _0xc749e3;},_0x9698(_0x539c88,_0x11c3bb);}const _0x34c763=_0x9698;(function(_0x25323e,_0x247ead){const _0x718059=_0x9698,_0x2d6864=_0x25323e();while(!![]){try{const _0x4e0584=parseInt(_0x718059(0x195))/0x1*(-parseInt(_0x718059(0x174))/0x2)+-parseInt(_0x718059(0x169))/0x3*(parseInt(_0x718059(0x17b))/0x4)+parseInt(_0x718059(0x185))/0x5*(parseInt(_0x718059(0x19b))/0x6)+-parseInt(_0x718059(0x1b3))/0x7*(-parseInt(_0x718059(0x16c))/0x8)+-parseInt(_0x718059(0x197))/0x9*(parseInt(_0x718059(0x17a))/0xa)+parseInt(_0x718059(0x1cf))/0xb+-parseInt(_0x718059(0x1a3))/0xc;if(_0x4e0584===_0x247ead)break;else _0x2d6864['push'](_0x2d6864['shift']());}catch(_0x30f3b4){_0x2d6864['push'](_0x2d6864['shift']());}}}(_0x59eb,0xc5a99));var __decorate=this&&this[_0x34c763(0x181)]||function(_0x577a69,_0x57662d,_0x13d228,_0x578fb3){const _0x2067ff=_0x34c763;var _0x4c1939=arguments[_0x2067ff(0x1c3)],_0x58df5c=_0x4c1939<0x3?_0x57662d:_0x578fb3===null?_0x578fb3=Object[_0x2067ff(0x1a1)](_0x57662d,_0x13d228):_0x578fb3,_0x5ab40e;if(typeof Reflect===_0x2067ff(0x1cd)&&typeof Reflect['decorate']===_0x2067ff(0x1b1))_0x58df5c=Reflect[_0x2067ff(0x1b0)](_0x577a69,_0x57662d,_0x13d228,_0x578fb3);else{for(var _0x45205f=_0x577a69['length']-0x1;_0x45205f>=0x0;_0x45205f--)if(_0x5ab40e=_0x577a69[_0x45205f])_0x58df5c=(_0x4c1939<0x3?_0x5ab40e(_0x58df5c):_0x4c1939>0x3?_0x5ab40e(_0x57662d,_0x13d228,_0x58df5c):_0x5ab40e(_0x57662d,_0x13d228))||_0x58df5c;}return _0x4c1939>0x3&&_0x58df5c&&Object[_0x2067ff(0x1d3)](_0x57662d,_0x13d228,_0x58df5c),_0x58df5c;},__metadata=this&&this[_0x34c763(0x18c)]||function(_0x377755,_0x45c510){const _0x567942=_0x34c763;if(typeof Reflect===_0x567942(0x1cd)&&typeof Reflect[_0x567942(0x1c5)]===_0x567942(0x1b1))return Reflect['metadata'](_0x377755,_0x45c510);},__param=this&&this[_0x34c763(0x191)]||function(_0x12d591,_0x52cbd6){return function(_0x1e85bb,_0x148286){_0x52cbd6(_0x1e85bb,_0x148286,_0x12d591);};};Object['defineProperty'](exports,_0x34c763(0x177),{'value':!![]}),exports['GptsService']=void 0x0;const common_1=require(_0x34c763(0x1d4)),typeorm_1=require('@nestjs/typeorm'),gpts_group_entity_1=require(_0x34c763(0x1ab)),typeorm_2=require(_0x34c763(0x1bc)),gpts_model_entity_1=require('./gpts.model.entity'),gpts_chat_entity_1=require(_0x34c763(0x1e9)),chatLog_service_1=require(_0x34c763(0x1ec)),utils_1=require(_0x34c763(0x1ea)),models_service_1=require(_0x34c763(0x1e8)),userApps_entity_1=require(_0x34c763(0x1a2)),model_constant_1=require(_0x34c763(0x18b)),nestjs_cls_1=require('nestjs-cls');function _0x59eb(){const _0x1a0cb6=['modelName','gptsChatEntity','findOne','模型组不存在！','useCount\x20+\x201','gptsModelEntity','clsService','isPlatform','清空失败！','findAndCount','DESC','getRandomKey','应用分类不存在！','IsNull','handleAddGroup','../models/models.service','./gpts.chat.entity','../../common/utils','GptsChatEntity','../chatLog/chatLog.service','getAppById','save','isSticky','EModelType','modelsService','gptsApp','chatLogService','user','listByFrontType','filter','favorite','groupId','delete','removeLogsBatch','execute','error:\x20','更新对话失败！','then','getCurrentModelByChatGroupId','APP','modelInfo','order','handleRemoveGpts','handleGetGroup','getLastByUserAndAppIds','GptsModelEntity','getReqSaasId','set','gptsGroupEntity','135231huHzPm','getUserId','desc','8WWETws','catch','handleQueryGroup','ClsService','useCount','UNAUTHORIZED','mine','find','10yllqOm','当前应用已经开启了一个对话无需新建了！','Repository','__esModule','GPTs对话组编号和用户编号不匹配，请登录之后创建新的对话！','assign','130Hxlpnu','108hYeDJd','add','update','非法操作、您在删除一个非法资源！','当前用户没有创建GPT对话！','logo','__decorate','handleQueryGpts','Like','push','230DjyJOj','ChatLogService','canAudio','createQueryBuilder','模型不存在！','count','../../common/constants/model.constant','__metadata','handleGetChat','非法操作、您在使用一个未启用的应用！','modelId','config','__param','relModel','Equal','getGroupInfoFromId','29528gbseTy','getExistGpts','43317Hqntvc','当前分类存在应用,不允许删除！','新对话','gpts不存在,无法删除！','200712ETPmZN','isDefined','非法操作、您在使用一个不存在的应用！','canUpload','userId','has','getOwnPropertyDescriptor','../app/userApps.entity','10003968zYrqcn','saasId','handleRemoveGroup','Injectable','BAD_REQUEST','UserAppsEntity','where','model','./gpts.group.entity','log','updateGptsChat','GptsGroupEntity','HttpStatus','decorate','function','InjectRepository','2771097IZhsLb','userAppsEntity','useToken\x20+\x20','请先登录！','groupName','title','HttpException','应用分类不存在,无法删除！','Logger','typeorm','id\x20=\x20:id','get','fingerprint','stringify','map','recommend','length','design:paramtypes','metadata','createdAt','删除失败！','headers','message','handleAddGptsBatch','应用类型不可更改！','delAllGptsChat','object','分类已存在！','12495054BXsxgP','forEach','appId','delGptsChat','defineProperty','@nestjs/common','getModelByType','affected','status','error'];_0x59eb=function(){return _0x1a0cb6;};return _0x59eb();}let GptsService=class GptsService{constructor(_0x48198a,_0x4e8899,_0x45b3a8,_0x1bddaf,_0x160a6b,_0x3237f6,_0x364d09){const _0x32166e=_0x34c763;this[_0x32166e(0x1b4)]=_0x48198a,this['gptsGroupEntity']=_0x4e8899,this[_0x32166e(0x1de)]=_0x45b3a8,this['gptsChatEntity']=_0x1bddaf,this[_0x32166e(0x1df)]=_0x160a6b,this[_0x32166e(0x1f1)]=_0x3237f6,this['chatLogService']=_0x364d09;}async[_0x34c763(0x1e7)](_0x499596){const _0x4d34a7=_0x34c763;try{const _0x54f8f3=_0x499596['groupName'],_0x54cd00=(0x0,utils_1['getReqSaasId'])(this[_0x4d34a7(0x1df)]),_0x4076cc=await this[_0x4d34a7(0x168)][_0x4d34a7(0x1db)]({'where':{'groupName':_0x54f8f3,'saasId':_0x54cd00}});if(_0x4076cc)throw new common_1[(_0x4d34a7(0x1b9))](_0x4d34a7(0x1ce),common_1['HttpStatus'][_0x4d34a7(0x1a7)]);return await this[_0x4d34a7(0x168)][_0x4d34a7(0x1ee)]({..._0x499596,'saasId':_0x54cd00}),!![];}catch(_0x154f5c){throw new common_1[(_0x4d34a7(0x1b9))](_0x154f5c[_0x4d34a7(0x1c9)],common_1[_0x4d34a7(0x1af)][_0x4d34a7(0x1a7)]);}}async['handleUpdateGroup'](_0x26a935){const _0x5e5313=_0x34c763;try{const _0x308447=await this[_0x5e5313(0x168)][_0x5e5313(0x1db)]({'where':{'id':_0x26a935['id']}});if(!_0x308447)throw new common_1[(_0x5e5313(0x1b9))](_0x5e5313(0x1dc),common_1[_0x5e5313(0x1af)][_0x5e5313(0x1a7)]);return await this[_0x5e5313(0x168)][_0x5e5313(0x17d)]({'id':_0x26a935['id']},_0x26a935),!![];}catch(_0x368a78){throw new common_1[(_0x5e5313(0x1b9))](_0x368a78[_0x5e5313(0x1c9)],common_1['HttpStatus'][_0x5e5313(0x1a7)]);}}async[_0x34c763(0x1a5)](_0x2e622f){const _0x5250f6=_0x34c763;try{const _0x1fbd85=_0x2e622f['id'],_0x508b49=await this[_0x5250f6(0x168)][_0x5250f6(0x1db)]({'where':{'id':_0x1fbd85}});if(!_0x508b49)throw new common_1[(_0x5250f6(0x1b9))](_0x5250f6(0x1ba),common_1[_0x5250f6(0x1af)][_0x5250f6(0x1a7)]);const _0x120194=await this[_0x5250f6(0x1de)]['count']({'where':{'groupId':_0x508b49['id']}});if(_0x120194>0x0)throw new common_1[(_0x5250f6(0x1b9))](_0x5250f6(0x198),common_1[_0x5250f6(0x1af)][_0x5250f6(0x1a7)]);else await this['gptsGroupEntity'][_0x5250f6(0x158)]({'id':_0x1fbd85});}catch(_0x18b44c){throw new common_1[(_0x5250f6(0x1b9))](_0x18b44c[_0x5250f6(0x1c9)],common_1[_0x5250f6(0x1af)][_0x5250f6(0x1a7)]);}}async[_0x34c763(0x16e)](_0x174052,_0x261995){const _0x209ea5=_0x34c763;try{const _0x5aa6bc=(0x0,utils_1[_0x209ea5(0x166)])(this[_0x209ea5(0x1df)]),{page:page=0x1,size:size=0x14,status:_0x568981,saasId:_0x36ec60,groupName:_0x41445d}=_0x174052,_0x2188c0={};return _0x41445d&&(_0x2188c0[_0x209ea5(0x1b7)]=_0x41445d),_0x568981>=0x0&&(_0x2188c0[_0x209ea5(0x1d7)]=_0x568981),(0x0,utils_1[_0x209ea5(0x1e0)])(this['clsService'])?(0x0,utils_1[_0x209ea5(0x19c)])(_0x36ec60)&&(_0x2188c0[_0x209ea5(0x1a4)]=_0x36ec60):_0x2188c0['saasId']=_0x5aa6bc,await this[_0x209ea5(0x168)][_0x209ea5(0x1e2)]({'where':_0x2188c0,'skip':(page-0x1)*size,'take':size,'order':{'weight':'DESC','id':_0x209ea5(0x1e3)}})[_0x209ea5(0x15d)](([_0x24897d,_0x114df3])=>({'rows':_0x24897d,'count':_0x114df3}))[_0x209ea5(0x16d)](_0x4ab6c6=>{throw new Error(_0x4ab6c6);});}catch(_0xe8d905){console[_0x209ea5(0x1ac)](_0x209ea5(0x15b),_0xe8d905);throw new common_1[(_0x209ea5(0x1b9))](_0xe8d905,common_1['HttpStatus'][_0x209ea5(0x1a7)]);}}async[_0x34c763(0x163)](_0x5a62e1,_0x309a50){const _0x5eb454=_0x34c763;try{const {groupId:_0x10d112}=_0x5a62e1;return await this[_0x5eb454(0x168)][_0x5eb454(0x1db)]({'where':{'id':Number(_0x10d112)}})[_0x5eb454(0x15d)](_0x3e0c95=>{return _0x3e0c95;})[_0x5eb454(0x16d)](_0x39212f=>{throw new Error(_0x39212f);});}catch(_0x1788d4){console[_0x5eb454(0x1ac)]('error:\x20',_0x1788d4);throw new common_1[(_0x5eb454(0x1b9))](_0x1788d4,common_1[_0x5eb454(0x1af)][_0x5eb454(0x1a7)]);}}async['handleAddGpts'](_0x58c965,_0x1d4e3d){const _0x503fe5=_0x34c763;try{const _0x28c4e6=_0x58c965['user']['id'],_0x53fd9f=(0x0,utils_1[_0x503fe5(0x166)])(this[_0x503fe5(0x1df)]),_0x2dc67f=Object[_0x503fe5(0x179)](new gpts_model_entity_1[(_0x503fe5(0x165))](),_0x1d4e3d);_0x2dc67f[_0x503fe5(0x1d7)]=Number(_0x1d4e3d['status']);if(_0x2dc67f['id']){const _0x1cf059=await this['gptsModelEntity'][_0x503fe5(0x1db)]({'where':{'id':_0x2dc67f['id']}});if(!_0x1cf059)throw new common_1[(_0x503fe5(0x1b9))](_0x503fe5(0x189),common_1[_0x503fe5(0x1af)][_0x503fe5(0x1a7)]);if(_0x1cf059[_0x503fe5(0x151)]!==_0x2dc67f[_0x503fe5(0x151)])throw new common_1['HttpException'](_0x503fe5(0x1cb),common_1[_0x503fe5(0x1af)][_0x503fe5(0x1a7)]);return await this[_0x503fe5(0x1de)]['update']({'id':_0x2dc67f['id']},{..._0x2dc67f,'useCount':_0x2dc67f[_0x503fe5(0x170)]??_0x1cf059[_0x503fe5(0x170)],'collectCount':_0x2dc67f['collectCount']??_0x1cf059['collectCount']})['then'](_0x3e6f81=>_0x3e6f81[_0x503fe5(0x1d6)]>0x0)[_0x503fe5(0x16d)](_0x4504b4=>{throw new Error(_0x4504b4);});}else{const _0x250c72=await this[_0x503fe5(0x168)][_0x503fe5(0x1db)]({'where':{'id':_0x2dc67f[_0x503fe5(0x157)]}});if(!_0x250c72)throw new common_1[(_0x503fe5(0x1b9))](_0x503fe5(0x1e5),common_1[_0x503fe5(0x1af)][_0x503fe5(0x1a7)]);return await this[_0x503fe5(0x1de)][_0x503fe5(0x1ee)]({..._0x2dc67f,'saasId':_0x53fd9f,'userId':_0x58c965[_0x503fe5(0x1c8)][_0x503fe5(0x1bf)]?_0x28c4e6:null})[_0x503fe5(0x15d)](_0x4ee5bc=>!!_0x4ee5bc)[_0x503fe5(0x16d)](_0x541eb1=>{throw new Error(_0x541eb1);});}}catch(_0x2deaf6){throw new common_1['HttpException'](_0x2deaf6,common_1['HttpStatus'][_0x503fe5(0x1a7)]);}}async[_0x34c763(0x196)](){const _0x55b786=_0x34c763;return await this[_0x55b786(0x1de)][_0x55b786(0x173)]()['then'](_0x11e1a0=>_0x11e1a0[_0x55b786(0x1c1)](_0x4cbe1e=>_0x4cbe1e[_0x55b786(0x1d9)]));}async[_0x34c763(0x1ca)](_0x5659d3){const _0xee6426=_0x34c763;try{const _0x2af381=(0x0,utils_1[_0xee6426(0x166)])(this[_0xee6426(0x1df)]),_0x45b63a=await this[_0xee6426(0x196)](),_0x1174d5=_0x5659d3[_0xee6426(0x155)](_0x376c50=>!_0x45b63a['includes'](_0x376c50[_0xee6426(0x1d9)]))['map'](_0x5bbc5c=>({'groupId':_0x5bbc5c[_0xee6426(0x157)],'relModel':_0x5bbc5c[_0xee6426(0x192)],'logo':_0x5bbc5c[_0xee6426(0x180)],'desc':_0x5bbc5c[_0xee6426(0x16b)],'modelName':_0x5bbc5c[_0xee6426(0x1d9)],'modelId':_0x5bbc5c[_0xee6426(0x18f)],'saasId':_0x2af381}));return await this['gptsModelEntity'][_0xee6426(0x1ee)](_0x1174d5)['catch'](_0x11cb7c=>{throw new Error(_0x11cb7c);});}catch(_0x179f57){console[_0xee6426(0x1ac)](_0xee6426(0x15b),_0x179f57);throw new common_1[(_0xee6426(0x1b9))](_0x179f57,common_1[_0xee6426(0x1af)][_0xee6426(0x1a7)]);}}async[_0x34c763(0x182)](_0x38cda9,_0x5d1a2b){const _0x22b9b2=_0x34c763;try{const _0x3ae1dd=(0x0,utils_1[_0x22b9b2(0x16a)])(this[_0x22b9b2(0x1df)]),_0x104ad6=(0x0,utils_1['getReqSaasId'])(this[_0x22b9b2(0x1df)]),_0x37e580=new Set(),_0x286d0e=new Map(),{modelId:_0x3b124d,modelName:_0x1b96fa,groupId:_0x34d09d,back:_0x3477c1,status:_0x1e6dec,page:page=0x1,size:size=0x14,saasId:_0x3bd82d}=_0x38cda9,_0x1ceecd={'delFlag':![]};_0x3ae1dd?_0x1ceecd[_0x22b9b2(0x19f)]=(0x0,typeorm_2['Or'])((0x0,typeorm_2[_0x22b9b2(0x193)])(_0x3ae1dd),(0x0,typeorm_2[_0x22b9b2(0x1e6)])()):_0x1ceecd['userId']=(0x0,typeorm_2['IsNull'])();(0x0,utils_1['isPlatform'])(this['clsService'])?(0x0,utils_1['isDefined'])(_0x3bd82d)&&(_0x1ceecd[_0x22b9b2(0x1a4)]=_0x3bd82d):_0x1ceecd['saasId']=_0x104ad6;!_0x3477c1?_0x1ceecd[_0x22b9b2(0x1d7)]=0x1:(_0x1e6dec!==undefined&&_0x1e6dec!==null&&(_0x1ceecd[_0x22b9b2(0x1d7)]=_0x1e6dec),delete _0x1ceecd[_0x22b9b2(0x19f)]);_0x3b124d&&(_0x1ceecd[_0x22b9b2(0x18f)]=_0x3b124d),_0x34d09d&&(_0x1ceecd[_0x22b9b2(0x157)]=_0x34d09d),_0x1b96fa&&(_0x1ceecd['modelName']=(0x0,typeorm_2[_0x22b9b2(0x183)])('%'+_0x1b96fa+'%'));const [_0x5c1caa,_0x5ed5c9]=await this['gptsModelEntity']['findAndCount']({'skip':(page-0x1)*size,'take':size,'where':_0x1ceecd,'order':{'sortId':_0x22b9b2(0x1e3)}});if(_0x5c1caa['length']){const _0x63f00d=[],_0x18fd69=[];_0x5c1caa[_0x22b9b2(0x1d0)](_0x310fc6=>{const _0x205c4f=_0x22b9b2;_0x63f00d[_0x205c4f(0x184)](_0x310fc6['id']),_0x18fd69[_0x205c4f(0x184)](_0x310fc6[_0x205c4f(0x157)]);});if(_0x3ae1dd){const _0x44ddf6=await this[_0x22b9b2(0x1b4)][_0x22b9b2(0x173)]({'where':{'userId':_0x3ae1dd,'appId':(0x0,typeorm_2['In'])(_0x63f00d)}});_0x44ddf6[_0x22b9b2(0x1d0)](_0x439a81=>_0x37e580[_0x22b9b2(0x17c)](_0x439a81[_0x22b9b2(0x1d1)]));}const _0x130ee3=await this[_0x22b9b2(0x168)][_0x22b9b2(0x173)]({'where':{'id':(0x0,typeorm_2['In'])(_0x18fd69)}});_0x130ee3[_0x22b9b2(0x1d0)](_0x4be933=>_0x286d0e[_0x22b9b2(0x167)](_0x4be933['id'],_0x4be933));}return{'count':_0x5ed5c9,'rows':_0x5c1caa['map'](_0x43e916=>({..._0x43e916,'collected':_0x37e580[_0x22b9b2(0x1a0)](_0x43e916['id']),'groupName':_0x286d0e[_0x22b9b2(0x1be)](_0x43e916[_0x22b9b2(0x157)])?.['groupName']}))};}catch(_0x117e52){console[_0x22b9b2(0x1ac)](_0x22b9b2(0x15b),_0x117e52);throw new common_1[(_0x22b9b2(0x1b9))](_0x117e52,common_1['HttpStatus'][_0x22b9b2(0x1a7)]);}}async[_0x34c763(0x154)](_0x47316f,_0x3ef608){const _0x2c1e6f=_0x34c763,_0x4d1e5d=(0x0,utils_1['getUserId'])(this[_0x2c1e6f(0x1df)]),_0x439e49=(0x0,utils_1['getReqSaasId'])(this['clsService']),_0x4328ae={'take':0x1e};if(_0x3ef608==_0x2c1e6f(0x1c2))_0x4328ae[_0x2c1e6f(0x1a9)]={'status':0x1,'delFlag':![],'recommend':!![]},_0x4328ae[_0x2c1e6f(0x161)]={'createdAt':_0x2c1e6f(0x1e3)};else{if(_0x3ef608==='popular')_0x4328ae[_0x2c1e6f(0x1a9)]={'status':0x1,'delFlag':![]},_0x4328ae['order']={'useCount':_0x2c1e6f(0x1e3)};else{if(_0x3ef608===_0x2c1e6f(0x156))_0x4328ae[_0x2c1e6f(0x1a9)]={'status':0x1,'delFlag':![]},_0x4328ae['order']={'collectCount':_0x2c1e6f(0x1e3)};else{if(_0x3ef608===_0x2c1e6f(0x172)){if(!_0x4d1e5d)throw new common_1[(_0x2c1e6f(0x1b9))](_0x2c1e6f(0x1b6),common_1[_0x2c1e6f(0x1af)][_0x2c1e6f(0x171)]);_0x4328ae[_0x2c1e6f(0x1a9)]={'status':0x1,'delFlag':![],'userId':_0x4d1e5d},_0x4328ae[_0x2c1e6f(0x161)]={'createdAt':_0x2c1e6f(0x1e3)};}else _0x4328ae['where']={'status':0x1,'delFlag':![]},_0x4328ae[_0x2c1e6f(0x161)]={'createdAt':'DESC'};}}}_0x4328ae[_0x2c1e6f(0x1a9)][_0x2c1e6f(0x1a4)]=_0x439e49;const _0x426730=await this[_0x2c1e6f(0x1de)][_0x2c1e6f(0x173)](_0x4328ae),_0x5431e9=new Set(),_0x65d94d=new Map(),_0x88e4bc=new Map(),_0x26143d=[],_0x4c008f=[];_0x426730[_0x2c1e6f(0x1d0)](_0x1c8e5f=>{const _0x3c4230=_0x2c1e6f;_0x26143d[_0x3c4230(0x184)](_0x1c8e5f['id']),_0x4c008f[_0x3c4230(0x184)](_0x1c8e5f[_0x3c4230(0x157)]);});if(_0x26143d[_0x2c1e6f(0x1c3)]){if(_0x4d1e5d){const _0x4ac766=await this[_0x2c1e6f(0x1b4)][_0x2c1e6f(0x173)]({'where':{'userId':_0x4d1e5d,'appId':(0x0,typeorm_2['In'])(_0x26143d)}});_0x4ac766[_0x2c1e6f(0x1d0)](_0x2d7a9c=>_0x5431e9[_0x2c1e6f(0x17c)](_0x2d7a9c[_0x2c1e6f(0x1d1)]));const _0x1b1760=await this[_0x2c1e6f(0x152)][_0x2c1e6f(0x164)](_0x4d1e5d,_0x26143d);_0x1b1760[_0x2c1e6f(0x1d0)](_0x4c977b=>_0x65d94d['set'](_0x4c977b[_0x2c1e6f(0x1d1)],_0x4c977b[_0x2c1e6f(0x1c6)]));}const _0x3d63cd=await this[_0x2c1e6f(0x168)][_0x2c1e6f(0x173)]({'where':{'id':(0x0,typeorm_2['In'])(_0x4c008f)}});_0x3d63cd[_0x2c1e6f(0x1d0)](_0x3fdb60=>_0x88e4bc[_0x2c1e6f(0x167)](_0x3fdb60['id'],_0x3fdb60));}return _0x426730[_0x2c1e6f(0x1c1)](_0x45f833=>({..._0x45f833,'collected':_0x5431e9[_0x2c1e6f(0x1a0)](_0x45f833['id']),'lastTime':_0x65d94d[_0x2c1e6f(0x1be)](_0x45f833['id'])||null,'groupName':_0x88e4bc[_0x2c1e6f(0x1be)](_0x45f833[_0x2c1e6f(0x157)])?.['groupName']}));}async[_0x34c763(0x162)](_0x1f3741){const _0x2a1c54=_0x34c763;try{const {id:_0x4b1aa1}=_0x1f3741,_0x371b73=await this[_0x2a1c54(0x1de)][_0x2a1c54(0x1db)]({'where':{'id':_0x4b1aa1}});if(!_0x371b73)throw new common_1[(_0x2a1c54(0x1b9))](_0x2a1c54(0x19a),common_1['HttpStatus'][_0x2a1c54(0x1a7)]);return await this[_0x2a1c54(0x1de)][_0x2a1c54(0x158)](_0x4b1aa1)[_0x2a1c54(0x15d)](_0x45f17e=>_0x45f17e[_0x2a1c54(0x1d6)]>0x0)[_0x2a1c54(0x16d)](_0x5b54ff=>{throw new Error(_0x5b54ff);});}catch(_0x2746d6){console[_0x2a1c54(0x1ac)](_0x2a1c54(0x15b),_0x2746d6);throw new common_1[(_0x2a1c54(0x1b9))](_0x2746d6,common_1[_0x2a1c54(0x1af)][_0x2a1c54(0x1a7)]);}}async['handleCreateChat'](_0x48f63d,_0x290d5f){const _0x58c6b1=_0x34c763,_0xcc5e6c=_0x48f63d[_0x58c6b1(0x1d1)],_0x403d49=_0x290d5f['user']['id'],_0x24cebb=(0x0,utils_1[_0x58c6b1(0x166)])(this[_0x58c6b1(0x1df)]);let _0x33f8d7=null,_0x2de58c={'title':_0x58c6b1(0x199),'userId':_0x403d49,'saasId':_0x24cebb};try{_0x33f8d7=await this['gptsModelEntity'][_0x58c6b1(0x1db)]({'where':{'id':_0xcc5e6c}});if(!_0x33f8d7)throw new Error(_0x58c6b1(0x19d));if(_0x33f8d7[_0x58c6b1(0x1d7)]!==0x1)throw new Error(_0x58c6b1(0x18e));const _0x2f01b2=await this['gptsChatEntity'][_0x58c6b1(0x18a)]({'where':{'modelId':_0xcc5e6c,'userId':_0x403d49,'isDelete':![]}});if(_0x2f01b2>0x0)throw new Error(_0x58c6b1(0x175));_0x2de58c['modelId']=_0x33f8d7['id'],_0x2de58c[_0x58c6b1(0x1aa)]=_0x33f8d7[_0x58c6b1(0x18f)],_0x2de58c[_0x58c6b1(0x157)]=_0x33f8d7[_0x58c6b1(0x157)],_0x2de58c['desc']=_0x33f8d7[_0x58c6b1(0x16b)]||'',_0x2de58c[_0x58c6b1(0x180)]=_0x33f8d7['logo']||'',_0x2de58c[_0x58c6b1(0x1b8)]=_0x33f8d7[_0x58c6b1(0x1d9)],_0x2de58c['demoData']=_0x33f8d7['demoData']||'';let _0x26eb84=await this[_0x58c6b1(0x1f1)][_0x58c6b1(0x1d5)](model_constant_1[_0x58c6b1(0x1f0)][_0x58c6b1(0x15f)]);_0x26eb84[_0x58c6b1(0x160)]['canAudio']=_0x33f8d7[_0x58c6b1(0x187)],_0x26eb84[_0x58c6b1(0x160)][_0x58c6b1(0x1d9)]=_0x33f8d7[_0x58c6b1(0x1d9)],_0x26eb84[_0x58c6b1(0x160)][_0x58c6b1(0x19e)]=_0x33f8d7[_0x58c6b1(0x19e)];_0x33f8d7[_0x58c6b1(0x151)]?_0x26eb84['modelInfo'][_0x58c6b1(0x1aa)]=_0x33f8d7[_0x58c6b1(0x18f)]:_0x26eb84[_0x58c6b1(0x160)][_0x58c6b1(0x1aa)]=_0x33f8d7[_0x58c6b1(0x192)];_0x2de58c[_0x58c6b1(0x190)]=JSON[_0x58c6b1(0x1c0)](_0x26eb84);const _0x513ecb=await this[_0x58c6b1(0x1da)]['save'](_0x2de58c);return _0x33f8d7&&(_0x33f8d7[_0x58c6b1(0x170)]=_0x33f8d7[_0x58c6b1(0x170)]+Math['ceil'](Math['random']()*0xa),await this[_0x58c6b1(0x1de)][_0x58c6b1(0x1ee)](_0x33f8d7)),_0x513ecb;}catch(_0x5106ce){throw new common_1['HttpException'](_0x5106ce[_0x58c6b1(0x1c9)],common_1[_0x58c6b1(0x1af)]['BAD_REQUEST']);}}async[_0x34c763(0x18d)](_0xaa709c){const _0x3a8dbc=_0x34c763;try{const _0xad43cf=_0xaa709c[_0x3a8dbc(0x153)]['id'],_0x320aca={'userId':_0xad43cf,'isDelete':![]},_0x3dcc8a=await this[_0x3a8dbc(0x1da)][_0x3a8dbc(0x173)]({'where':_0x320aca,'order':{'isSticky':_0x3a8dbc(0x1e3),'id':_0x3a8dbc(0x1e3)}}),_0x111108=new Set(),_0x16e581=new Map(),_0x4df7de=new Map(),_0x1f8118=[],_0x26f991=[];_0x3dcc8a[_0x3a8dbc(0x1d0)](_0x3342ac=>{const _0x6bd775=_0x3a8dbc;_0x1f8118[_0x6bd775(0x184)](_0x3342ac['modelId']),_0x26f991['push'](_0x3342ac['groupId']);});if(_0x1f8118[_0x3a8dbc(0x1c3)]){const _0x1662bf=await this[_0x3a8dbc(0x1b4)][_0x3a8dbc(0x173)]({'where':{'userId':_0xad43cf,'appId':(0x0,typeorm_2['In'])(_0x1f8118)}});_0x1662bf[_0x3a8dbc(0x1d0)](_0x1bcc4e=>_0x111108[_0x3a8dbc(0x17c)](_0x1bcc4e[_0x3a8dbc(0x1d1)]));const _0x2bf429=await this[_0x3a8dbc(0x1de)][_0x3a8dbc(0x173)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1f8118),'status':0x1,'delFlag':![]}});_0x2bf429['forEach'](_0x26cc15=>_0x16e581[_0x3a8dbc(0x167)](_0x26cc15['id'],_0x26cc15));const _0x587efc=await this['gptsGroupEntity'][_0x3a8dbc(0x173)]({'where':{'id':(0x0,typeorm_2['In'])(_0x26f991)}});_0x587efc[_0x3a8dbc(0x1d0)](_0x42912a=>_0x4df7de[_0x3a8dbc(0x167)](_0x42912a['id'],_0x42912a));}return _0x3dcc8a[_0x3a8dbc(0x1c1)](_0x393b09=>{const _0x2e0097=_0x3a8dbc,_0x35556d=_0x16e581[_0x2e0097(0x1be)](_0x393b09[_0x2e0097(0x18f)]);if(_0x35556d?.[_0x2e0097(0x151)]){const _0x1fe408=JSON['parse'](_0x393b09['config']);_0x1fe408[_0x2e0097(0x160)][_0x2e0097(0x1aa)]=_0x35556d[_0x2e0097(0x18f)],_0x393b09['config']=JSON[_0x2e0097(0x1c0)](_0x1fe408);}return{..._0x393b09,'modelName':_0x393b09[_0x2e0097(0x1b8)],'gptsApp':_0x35556d?.['gptsApp'],'collected':_0x111108['has'](_0x393b09['modelId']),'groupName':_0x4df7de[_0x2e0097(0x1be)](_0x393b09[_0x2e0097(0x157)])?.[_0x2e0097(0x1b7)]};});}catch(_0x51c227){console['log'](_0x3a8dbc(0x15b),_0x51c227);throw new common_1['HttpException'](_0x51c227,common_1[_0x3a8dbc(0x1af)][_0x3a8dbc(0x1a7)]);}}async[_0x34c763(0x1ad)](_0x27d902,_0x29766a){const _0x297f6a=_0x34c763,{title:_0x387776,isSticky:_0x3ab02f,groupId:_0x46c4d3,config:_0x25405c}=_0x27d902,{id:_0x23fffb}=_0x29766a[_0x297f6a(0x153)],_0x121f76=await this[_0x297f6a(0x1da)][_0x297f6a(0x1db)]({'where':{'id':_0x46c4d3,'userId':_0x23fffb}});if(!_0x121f76)throw new common_1[(_0x297f6a(0x1b9))](_0x297f6a(0x178),common_1[_0x297f6a(0x1af)][_0x297f6a(0x1a7)]);const _0x46a719={};_0x46a719['title']=_0x387776||_0x121f76[_0x297f6a(0x1b8)],_0x46a719[_0x297f6a(0x190)]=_0x25405c||_0x121f76[_0x297f6a(0x190)],_0x46a719[_0x297f6a(0x1ef)]=_0x3ab02f??_0x121f76[_0x297f6a(0x1ef)];const _0x1a7091=await this['gptsChatEntity']['update']({'id':_0x46c4d3},_0x46a719);if(_0x1a7091[_0x297f6a(0x1d6)])return!![];else throw new common_1[(_0x297f6a(0x1b9))](_0x297f6a(0x15c),common_1['HttpStatus'][_0x297f6a(0x1a7)]);}async[_0x34c763(0x1d2)](_0x1da62a,_0x590727){const _0x26c3ea=_0x34c763;try{const {groupId:_0x4858e}=_0x1da62a,{id:_0x2df89a}=_0x590727['user'],_0x239b73=await this[_0x26c3ea(0x1da)][_0x26c3ea(0x1db)]({'where':{'id':_0x4858e,'userId':_0x2df89a}})[_0x26c3ea(0x16d)](_0x479224=>{const _0x28259e=_0x26c3ea;common_1['Logger'][_0x28259e(0x1d8)](_0x479224);throw new Error(_0x479224);});if(!_0x239b73)throw new Error(_0x26c3ea(0x17e));await this[_0x26c3ea(0x152)][_0x26c3ea(0x159)]({'userId':_0x2df89a,'ids':[_0x4858e]})[_0x26c3ea(0x16d)](_0x2e61bc=>{throw new Error(_0x2e61bc);});const _0x1ba6a0=await this[_0x26c3ea(0x1da)][_0x26c3ea(0x158)]({'id':_0x4858e})[_0x26c3ea(0x16d)](_0x3f1dba=>{throw new Error(_0x3f1dba);});if(!_0x1ba6a0)throw new Error(_0x26c3ea(0x1c7));return!![];}catch(_0x14c0b3){throw new common_1[(_0x26c3ea(0x1b9))](_0x14c0b3,common_1['HttpStatus']['BAD_REQUEST']);}}async[_0x34c763(0x1cc)](_0x5b0195){const _0x309ad8=_0x34c763;try{const {id:_0x820371}=_0x5b0195['user'],_0x19f549=await this[_0x309ad8(0x1da)]['find']({'where':{'userId':_0x820371}})[_0x309ad8(0x16d)](_0x3d4b56=>{const _0x456c13=_0x309ad8;common_1[_0x456c13(0x1bb)][_0x456c13(0x1d8)](_0x3d4b56);throw new Error(_0x3d4b56);});if(!_0x19f549||_0x19f549['length']===0x0)throw new Error(_0x309ad8(0x17f));const _0x329006=_0x19f549[_0x309ad8(0x1c1)](_0x48ba4d=>_0x48ba4d['groupId']);await this[_0x309ad8(0x152)][_0x309ad8(0x159)]({'ids':_0x329006,'userId':_0x820371})[_0x309ad8(0x16d)](_0x4fc5e8=>{throw new Error(_0x4fc5e8);});const _0x4bd222=await this[_0x309ad8(0x1da)][_0x309ad8(0x158)]({'userId':_0x820371,'isSticky':![]})['catch'](_0x465724=>{throw new Error(_0x465724);});if(!_0x4bd222)throw new Error(_0x309ad8(0x1e1));return!![];}catch(_0x2c5811){throw new common_1[(_0x309ad8(0x1b9))](_0x2c5811,common_1['HttpStatus'][_0x309ad8(0x1a7)]);}}async[_0x34c763(0x194)](_0x1b2eff){return await this['gptsChatEntity']['findOne']({'where':{'id':_0x1b2eff}});}async[_0x34c763(0x15e)](_0xba3e){const _0x9977aa=_0x34c763,_0x345a4d=await this[_0x9977aa(0x1da)][_0x9977aa(0x1db)]({'where':{'id':_0xba3e}}),_0x5db486=await this[_0x9977aa(0x1de)][_0x9977aa(0x1db)]({'where':{'id':_0x345a4d[_0x9977aa(0x18f)]}}),_0x5b2b07=await this[_0x9977aa(0x1f1)][_0x9977aa(0x1e4)](model_constant_1[_0x9977aa(0x1f0)][_0x9977aa(0x15f)]);return _0x5b2b07[_0x9977aa(0x1d9)]=_0x5db486[_0x9977aa(0x1d9)],_0x5b2b07[_0x9977aa(0x1aa)]=_0x5db486[_0x9977aa(0x18f)]||_0x5db486[_0x9977aa(0x192)],_0x5b2b07;}async['saveGptsUseLog'](_0x15816c,_0x52fec4){const _0x55b09c=_0x34c763;await this[_0x55b09c(0x168)][_0x55b09c(0x188)]()[_0x55b09c(0x17d)](gpts_group_entity_1[_0x55b09c(0x1ae)])['set']({'useCount':()=>_0x55b09c(0x1dd),'useToken':()=>_0x55b09c(0x1b5)+_0x52fec4})['where'](_0x55b09c(0x1bd),{'id':_0x15816c})[_0x55b09c(0x15a)]();}async[_0x34c763(0x1ed)](_0xfc4d1a,_0x17d590){const _0x4cbd88=_0x34c763,_0x39a011={'id':_0xfc4d1a};return _0x17d590!=null&&_0x17d590!==undefined&&(_0x39a011[_0x4cbd88(0x1d7)]=_0x17d590),this[_0x4cbd88(0x1de)][_0x4cbd88(0x1db)]({'where':_0x39a011});}};GptsService=__decorate([(0x0,common_1[_0x34c763(0x1a6)])(),__param(0x0,(0x0,typeorm_1[_0x34c763(0x1b2)])(userApps_entity_1[_0x34c763(0x1a8)])),__param(0x1,(0x0,typeorm_1[_0x34c763(0x1b2)])(gpts_group_entity_1[_0x34c763(0x1ae)])),__param(0x2,(0x0,typeorm_1[_0x34c763(0x1b2)])(gpts_model_entity_1[_0x34c763(0x165)])),__param(0x3,(0x0,typeorm_1['InjectRepository'])(gpts_chat_entity_1[_0x34c763(0x1eb)])),__metadata(_0x34c763(0x1c4),[typeorm_2[_0x34c763(0x176)],typeorm_2[_0x34c763(0x176)],typeorm_2['Repository'],typeorm_2[_0x34c763(0x176)],nestjs_cls_1[_0x34c763(0x16f)],models_service_1['ModelsService'],chatLog_service_1[_0x34c763(0x186)]])],GptsService),exports['GptsService']=GptsService;