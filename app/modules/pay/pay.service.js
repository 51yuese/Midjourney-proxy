'use strict';function _0x22c5(){const _0x3adafc=['payHupiSecret','payMpay','object','../../common/utils/date','微信支付通知params:\x20','native','queryHupi','payHupi','transactions_jsapi','createRandomNonceStr','sign','appid','addBalanceToOrder','../order/order.entity','@nestjs/common','hupi','校验签名','getOwnPropertyDescriptor','payAliAppAppId','pay','product_code','wechatpay-node-v3','230pZEkty','payAliAppSecret','OrderEntity','attach','log','sdkExec','MD5','2246454RJLjDU','payWeChatPublicKey','epay\x20--->\x20res:\x20','InjectRepository','WE_APP_APPID','decorate','支付通知验证失败:\x20','SUCCESS','return_url','connection','exec','payEpaySecret','payWeChatH5Name','status','response','money','sign_type','transactions_app','HttpStatus','userService','payWeChatH5Url','payEpayNotifyUrl','App支付结果返回值:\x20','用户openId:\x20','alipay-sdk','epay','wxpay','TRADE_SUCCESS','payEpay','findOne','CramiPackageEntity','failed','支付请求失败!','__esModule','payer','createHash','trade_status','getMiniOpenIdByUserId','length','POST','jsapi','data','hash','device','unsupported\x20pay\x20type','payType:\x20','name','alipay\x20result:\x20','transactions_h5','33562FyMMMw','payWeChat','套餐不存在!','join','../userBalance/userBalance.service','redisCacheService','defineProperty','total','del','md5','param','channel','bizContent','clientip','event_type','PayService','pid','includes','TRANSACTION.SUCCESS','89163SkkTbH','toString','globalConfigService','payAliPublicSecret','payAliWebSecret','type','order_no','toDate','notify_url','orderEntity','crypto','getOpenIdByUserId','payPlatform','app','goodsId','alipay.trade.page.pay','订单不存在!','payEpayApiQueryUrl','now','payMpayApiQueryUrl','success','FAST_INSTANT_TRADE_PAY','design:paramtypes','payAliWebAppId','affected','total_fee','onModuleInit','BAD_REQUEST','32gIkSFj','notifyEpay','toFixed','orderId','GlobalConfigService','__metadata','time','scene_info','payEpayPid','message','payMpayApiPayUrl','key','微信H5支付失败！','text','queryMpay','alipay.trade.query','sort','errRaw','payAli','Repository','UserBalanceService','192.168.1.100','payMpayPid','update','setNotifyUrl','transaction','cancel','HttpException','pageExec','7AMBCMj','1786179UahJeW','payMpayReturnUrl','wechat','digest','校验签名通过','transactions_native','userBalanceService','transaction_id','cancelWxOrder','969470SDoNcp','4792117HSkBBm','wx-native','status:\x20','trade_state','payEpayReturnUrl','../redisCache/redisCache.service','queryEpay','keys','typeorm','notifyHupi','alipay.trade.app.pay','act','alipay','method','__param','payWeChatAppId','payHupiAppId','notifyWeChat','payWeChatMchId','../../common/constants/redisKey.constant','getConfigByKeys','6493488EaMPkL','payWeChatNotifyUrl','query','submit.php','payWeChatPrivateKey','jsapi支付结果返回值:\x20','post','payWeMiniAppId','RedisCacheService','../user/user.service','@nestjs/typeorm','https://api.xunhupay.com/payment/do.html','1.1','PKCS1','get','out_trade_no','../../common/utils','cramiPackageEntity','../crami/cramiPackage.entity','axios','4urfAks','resource','支付请求失败:\x20','close','function','version','metadata','payHupiReturnUrl','default','notifyMpay','mini','nonce_str'];_0x22c5=function(){return _0x3adafc;};return _0x22c5();}const _0x1b117b=_0x3b09;(function(_0x55d826,_0x5a0b19){const _0x360d06=_0x3b09,_0x556057=_0x55d826();while(!![]){try{const _0x35b0d=-parseInt(_0x360d06(0x1d7))/0x1*(-parseInt(_0x360d06(0x12c))/0x2)+parseInt(_0x360d06(0x14a))/0x3+parseInt(_0x360d06(0x17d))/0x4*(-parseInt(_0x360d06(0x153))/0x5)+-parseInt(_0x360d06(0x1a6))/0x6+parseInt(_0x360d06(0x149))/0x7*(-parseInt(_0x360d06(0x169))/0x8)+-parseInt(_0x360d06(0x110))/0x9*(-parseInt(_0x360d06(0x19f))/0xa)+parseInt(_0x360d06(0x154))/0xb;if(_0x35b0d===_0x5a0b19)break;else _0x556057['push'](_0x556057['shift']());}catch(_0x1dc816){_0x556057['push'](_0x556057['shift']());}}}(_0x22c5,0x658a0));function _0x3b09(_0x436cd4,_0x5aac70){const _0x22c58e=_0x22c5();return _0x3b09=function(_0x3b098e,_0x54b12d){_0x3b098e=_0x3b098e-0x108;let _0x24321f=_0x22c58e[_0x3b098e];return _0x24321f;},_0x3b09(_0x436cd4,_0x5aac70);}var __decorate=this&&this['__decorate']||function(_0x2fc5ed,_0x183f3a,_0x589c55,_0x44d2c6){const _0x4284a7=_0x3b09;var _0x45ee64=arguments['length'],_0x4a8f5f=_0x45ee64<0x3?_0x183f3a:_0x44d2c6===null?_0x44d2c6=Object[_0x4284a7(0x19a)](_0x183f3a,_0x589c55):_0x44d2c6,_0x4a8aec;if(typeof Reflect===_0x4284a7(0x18b)&&typeof Reflect[_0x4284a7(0x1ab)]==='function')_0x4a8f5f=Reflect[_0x4284a7(0x1ab)](_0x2fc5ed,_0x183f3a,_0x589c55,_0x44d2c6);else{for(var _0x24617b=_0x2fc5ed[_0x4284a7(0x1cc)]-0x1;_0x24617b>=0x0;_0x24617b--)if(_0x4a8aec=_0x2fc5ed[_0x24617b])_0x4a8f5f=(_0x45ee64<0x3?_0x4a8aec(_0x4a8f5f):_0x45ee64>0x3?_0x4a8aec(_0x183f3a,_0x589c55,_0x4a8f5f):_0x4a8aec(_0x183f3a,_0x589c55))||_0x4a8f5f;}return _0x45ee64>0x3&&_0x4a8f5f&&Object[_0x4284a7(0x1dd)](_0x183f3a,_0x589c55,_0x4a8f5f),_0x4a8f5f;},__metadata=this&&this[_0x1b117b(0x131)]||function(_0x2ce7a0,_0x67c5db){const _0x27947b=_0x1b117b;if(typeof Reflect===_0x27947b(0x18b)&&typeof Reflect[_0x27947b(0x183)]===_0x27947b(0x181))return Reflect[_0x27947b(0x183)](_0x2ce7a0,_0x67c5db);},__param=this&&this[_0x1b117b(0x162)]||function(_0xa6ea68,_0xa37b62){return function(_0x9abaf0,_0xfa8c03){_0xa37b62(_0x9abaf0,_0xfa8c03,_0xa6ea68);};};Object[_0x1b117b(0x1dd)](exports,_0x1b117b(0x1c7),{'value':!![]}),exports[_0x1b117b(0x10c)]=void 0x0;const typeorm_1=require(_0x1b117b(0x173)),typeorm_2=require(_0x1b117b(0x15c)),common_1=require(_0x1b117b(0x197)),crypto=require(_0x1b117b(0x11a)),axios_1=require(_0x1b117b(0x17c)),order_entity_1=require(_0x1b117b(0x196)),cramiPackage_entity_1=require(_0x1b117b(0x17b)),userBalance_service_1=require(_0x1b117b(0x1db)),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x1b117b(0x179)),user_service_1=require(_0x1b117b(0x172)),redisCache_service_1=require(_0x1b117b(0x159)),redisKey_constant_1=require(_0x1b117b(0x167)),date_1=require(_0x1b117b(0x18c)),WxPay=require(_0x1b117b(0x19e)),AlipaySdk=require(_0x1b117b(0x1be));let PayService=class PayService{constructor(_0x2ff8f8,_0x5b48d9,_0x47f7df,_0x4ecf53,_0x29e273,_0xcafeda,_0x3e65df){const _0x358717=_0x1b117b;this[_0x358717(0x17a)]=_0x2ff8f8,this[_0x358717(0x119)]=_0x5b48d9,this[_0x358717(0x150)]=_0x47f7df,this[_0x358717(0x112)]=_0x4ecf53,this[_0x358717(0x1b9)]=_0x29e273,this[_0x358717(0x1dc)]=_0xcafeda,this[_0x358717(0x1af)]=_0x3e65df;}async[_0x1b117b(0x12a)](){}async['notify'](_0x5ca89f){const _0x34da61=_0x1b117b;if(_0x5ca89f[_0x34da61(0x1e1)]==_0x34da61(0x1bf))return this[_0x34da61(0x12d)](_0x5ca89f);if(_0x5ca89f[_0x34da61(0x1a2)]==_0x34da61(0x198))return this[_0x34da61(0x15d)](_0x5ca89f);if(typeof _0x5ca89f['resource']==_0x34da61(0x18b))return this[_0x34da61(0x165)](_0x5ca89f);return this[_0x34da61(0x186)](_0x5ca89f);}async[_0x1b117b(0x19c)](_0x4cc2c3,_0x1b2e72,_0x9feaff=_0x1b117b(0x1c0)){const _0x1b288a=_0x1b117b,_0x45e70e=await this[_0x1b288a(0x119)][_0x1b288a(0x1c3)]({'where':{'userId':_0x4cc2c3,'orderId':_0x1b2e72}});if(!_0x45e70e)throw new common_1[(_0x1b288a(0x147))](_0x1b288a(0x120),common_1[_0x1b288a(0x1b8)]['BAD_REQUEST']);const _0x378f6a=await this[_0x1b288a(0x17a)]['findOne']({'where':{'id':_0x45e70e['goodsId']}});if(!_0x378f6a)throw new common_1[(_0x1b288a(0x147))](_0x1b288a(0x1d9),common_1[_0x1b288a(0x1b8)][_0x1b288a(0x12b)]);console['log']('本次支付类型:\x20',_0x45e70e[_0x1b288a(0x11c)]);try{if(_0x45e70e['payPlatform']==_0x1b288a(0x160))return this['payAli'](_0x4cc2c3,_0x1b2e72,_0x9feaff);if(_0x45e70e['payPlatform']==_0x1b288a(0x14c))return this[_0x1b288a(0x1d8)](_0x4cc2c3,_0x1b2e72,_0x9feaff);if(_0x45e70e['payPlatform']==_0x1b288a(0x1bf))return this['payEpay'](_0x4cc2c3,_0x1b2e72,_0x9feaff);if(_0x45e70e[_0x1b288a(0x11c)]=='mpay')return this[_0x1b288a(0x18a)](_0x4cc2c3,_0x1b2e72,_0x9feaff);if(_0x45e70e[_0x1b288a(0x11c)]==_0x1b288a(0x198))return this[_0x1b288a(0x190)](_0x4cc2c3,_0x1b2e72,_0x9feaff);}catch(_0x170a09){console['log'](_0x1b288a(0x17f),_0x170a09);throw new common_1[(_0x1b288a(0x147))](_0x1b288a(0x1c6),common_1[_0x1b288a(0x1b8)][_0x1b288a(0x12b)]);}}async[_0x1b117b(0x16b)](_0x2975d5){const _0x405c30=_0x1b117b,_0x179e63=await this[_0x405c30(0x119)][_0x405c30(0x1c3)]({'where':{'orderId':_0x2975d5}});if(!_0x179e63)throw new common_1['HttpException'](_0x405c30(0x120),common_1['HttpStatus']['BAD_REQUEST']);return _0x179e63;}async['notifyHupi'](_0x1b07a0){const _0x21668c=_0x1b117b,_0x3a92eb=await this['globalConfigService'][_0x21668c(0x168)]([_0x21668c(0x189)]),_0x1eed6c=_0x1b07a0[_0x21668c(0x1d0)];delete _0x1b07a0['hash'];if(this[_0x21668c(0x193)](_0x1b07a0,_0x3a92eb)!=_0x1eed6c)return _0x21668c(0x1c5);const _0x68720b=await this[_0x21668c(0x119)]['findOne']({'where':{'orderId':_0x1b07a0['trade_order_id'],'status':0x0}});if(!_0x68720b)return _0x21668c(0x1c5);await this[_0x21668c(0x150)][_0x21668c(0x195)](_0x68720b);const _0x5088f9=await this['orderEntity']['update']({'orderId':_0x1b07a0['trade_order_id']},{'status':0x1,'paydAt':(0x0,date_1[_0x21668c(0x185)])()[_0x21668c(0x117)]()});if(_0x5088f9[_0x21668c(0x128)]!=0x1)return'failed';return _0x21668c(0x124);}async[_0x1b117b(0x190)](_0xa7b332,_0x41e6e8,_0x585138=_0x1b117b(0x1c0)){const _0x257b8e=_0x1b117b,_0x2e91ab=await this['orderEntity']['findOne']({'where':{'userId':_0xa7b332,'orderId':_0x41e6e8}});if(!_0x2e91ab)throw new common_1['HttpException'](_0x257b8e(0x120),common_1[_0x257b8e(0x1b8)][_0x257b8e(0x12b)]);const _0x1ffd89=await this[_0x257b8e(0x17a)][_0x257b8e(0x1c3)]({'where':{'id':_0x2e91ab[_0x257b8e(0x11e)]}});if(!_0x1ffd89)throw new common_1['HttpException']('套餐不存在!',common_1[_0x257b8e(0x1b8)][_0x257b8e(0x12b)]);const {payHupiAppId:_0x160e05,payHupiSecret:_0x2d9b27,payHupiNotifyUrl:_0x12c9f4,payHupiReturnUrl:_0x15a985,payHupiGatewayUrl:_0x4caa64}=await this[_0x257b8e(0x112)][_0x257b8e(0x168)]([_0x257b8e(0x164),_0x257b8e(0x189),'payHupiNotifyUrl',_0x257b8e(0x184),'payHupiGatewayUrl']),_0x3ded7d={};_0x3ded7d[_0x257b8e(0x182)]=_0x257b8e(0x175),_0x3ded7d[_0x257b8e(0x194)]=_0x160e05,_0x3ded7d[_0x257b8e(0x132)]=(Date[_0x257b8e(0x122)]()/0x3e8)[_0x257b8e(0x12e)](0x0),_0x3ded7d[_0x257b8e(0x188)]=(0x0,utils_1[_0x257b8e(0x192)])(0x20),_0x3ded7d['trade_order_id']=_0x41e6e8,_0x3ded7d['title']=_0x1ffd89[_0x257b8e(0x1d4)],_0x3ded7d[_0x257b8e(0x129)]=_0x2e91ab['total'],_0x3ded7d['notify_url']=_0x12c9f4,_0x3ded7d[_0x257b8e(0x1ae)]=_0x15a985,_0x3ded7d['attach']='hupi',_0x3ded7d[_0x257b8e(0x1d0)]=this['sign'](_0x3ded7d,_0x2d9b27);const {data:{errcode:_0x1dff42,errmsg:_0x53c8da,url_qrcode:_0x1aaa18,url:_0x42df5f}}=await axios_1[_0x257b8e(0x185)][_0x257b8e(0x16f)](_0x4caa64||_0x257b8e(0x174),_0x3ded7d);if(_0x1dff42!=0x0)throw new common_1[(_0x257b8e(0x147))](_0x53c8da,common_1[_0x257b8e(0x1b8)][_0x257b8e(0x12b)]);return{'url_qrcode':_0x1aaa18,'url':_0x42df5f};}async[_0x1b117b(0x18f)](_0x3f72ea){const _0x41d76e=_0x1b117b,{payHupiAppId:_0x714443,payHupiSecret:_0xb3ab9e}=await this[_0x41d76e(0x112)]['getConfigByKeys']([_0x41d76e(0x164),_0x41d76e(0x189)]),_0x5a1bfe={};_0x5a1bfe['version']=_0x41d76e(0x175),_0x5a1bfe['appid']=_0x714443,_0x5a1bfe['time']=(Date[_0x41d76e(0x122)]()/0x3e8)[_0x41d76e(0x12e)](0x0),_0x5a1bfe['nonce_str']=(0x0,utils_1[_0x41d76e(0x192)])(0x20),_0x5a1bfe['out_trade_order']=_0x3f72ea,_0x5a1bfe[_0x41d76e(0x1d0)]=this[_0x41d76e(0x193)](_0x5a1bfe,_0xb3ab9e);const {data:{errcode:_0x222302,errmsg:_0x107a4e,data:_0x2bc45b}}=await axios_1[_0x41d76e(0x185)][_0x41d76e(0x16f)]('https://api.xunhupay.com/payment/query.html',_0x5a1bfe);if(_0x222302!=0x0)throw new common_1[(_0x41d76e(0x147))](_0x107a4e,common_1[_0x41d76e(0x1b8)][_0x41d76e(0x12b)]);return _0x2bc45b;}async[_0x1b117b(0x12d)](_0x5c32ba){const _0x1d5fdd=_0x1b117b,_0x55d4fd=_0x5c32ba[_0x1d5fdd(0x193)];delete _0x5c32ba[_0x1d5fdd(0x193)],delete _0x5c32ba[_0x1d5fdd(0x1b6)];const _0x209eba=await this[_0x1d5fdd(0x112)][_0x1d5fdd(0x168)]([_0x1d5fdd(0x1b1)]);if(this[_0x1d5fdd(0x193)](_0x5c32ba,_0x209eba)!=_0x55d4fd)return'failed';console['log'](_0x1d5fdd(0x14e));const _0x1e77e9=await this[_0x1d5fdd(0x119)][_0x1d5fdd(0x1c3)]({'where':{'orderId':_0x5c32ba[_0x1d5fdd(0x178)],'status':0x0}});if(!_0x1e77e9)return'failed';const _0x1d2648=_0x5c32ba['trade_status']==_0x1d5fdd(0x1c1)?0x1:0x2,_0xd65a2=await this[_0x1d5fdd(0x119)]['update']({'orderId':_0x5c32ba[_0x1d5fdd(0x178)]},{'status':_0x1d2648,'paydAt':(0x0,date_1[_0x1d5fdd(0x185)])()[_0x1d5fdd(0x117)]()});_0x1d2648===0x1&&await this[_0x1d5fdd(0x150)][_0x1d5fdd(0x195)](_0x1e77e9);if(_0xd65a2['affected']!=0x1)return _0x1d5fdd(0x1c5);return'success';}async[_0x1b117b(0x1c2)](_0x2ffb3c,_0x5da43c,_0x57f6a1=_0x1b117b(0x160)){const _0x5cbd14=_0x1b117b,_0xb49361=await this[_0x5cbd14(0x119)]['findOne']({'where':{'userId':_0x2ffb3c,'orderId':_0x5da43c}});if(!_0xb49361)throw new common_1[(_0x5cbd14(0x147))]('订单不存在!',common_1[_0x5cbd14(0x1b8)][_0x5cbd14(0x12b)]);const _0x52baf7=await this['cramiPackageEntity'][_0x5cbd14(0x1c3)]({'where':{'id':_0xb49361['goodsId']}});if(!_0x52baf7)throw new common_1['HttpException']('套餐不存在!',common_1[_0x5cbd14(0x1b8)][_0x5cbd14(0x12b)]);const {payEpayPid:_0x31fba3,payEpaySecret:_0x2d8855,payEpayNotifyUrl:_0x4e022e,payEpayReturnUrl:_0x2b7fe1,payEpayApiPayUrl:_0x132e66}=await this[_0x5cbd14(0x112)][_0x5cbd14(0x168)]([_0x5cbd14(0x134),_0x5cbd14(0x1b1),_0x5cbd14(0x1bb),_0x5cbd14(0x158),'payEpayApiPayUrl']);let _0x4324d9;_0x31fba3[_0x5cbd14(0x1cc)]<=0x10?_0x4324d9=Number(_0x31fba3):_0x4324d9=BigInt(_0x31fba3);const _0x5e51be={};_0x5e51be[_0x5cbd14(0x10d)]=_0x4324d9,_0x5e51be[_0x5cbd14(0x115)]=_0x57f6a1,_0x5e51be[_0x5cbd14(0x178)]=_0x5da43c,_0x5e51be[_0x5cbd14(0x1d4)]=_0x52baf7['name'],_0x5e51be['money']=_0xb49361[_0x5cbd14(0x1de)],_0x5e51be[_0x5cbd14(0x10a)]=_0x5cbd14(0x141),_0x5e51be[_0x5cbd14(0x1d1)]='pc',_0x5e51be[_0x5cbd14(0x118)]=_0x4e022e,_0x5e51be[_0x5cbd14(0x1ae)]=_0x2b7fe1,_0x5e51be[_0x5cbd14(0x1e1)]=_0x5cbd14(0x1bf),_0x5e51be[_0x5cbd14(0x193)]=this[_0x5cbd14(0x193)](_0x5e51be,_0x2d8855),_0x5e51be['sign_type']='MD5';const _0x4e7cd6=new URLSearchParams(_0x5e51be)[_0x5cbd14(0x111)](),_0x18511e=_0x132e66+'?'+_0x4e7cd6;if(_0x132e66[_0x5cbd14(0x10e)](_0x5cbd14(0x16c)))return{'url_qrcode':null,'redirectUrl':_0x18511e,'channel':_0x57f6a1,'isRedirect':!![]};else{const _0xbc89b5=await axios_1[_0x5cbd14(0x185)]['get'](_0x132e66,{'params':_0x5e51be});console[_0x5cbd14(0x1a3)](_0x5cbd14(0x1a8),_0xbc89b5[_0x5cbd14(0x1cf)]);const {data:{code:_0x1e6f0b,msg:_0x58c08c,qrcode:_0x46d9fb}}=_0xbc89b5;if(_0x1e6f0b!=0x1)throw new common_1[(_0x5cbd14(0x147))](_0x58c08c,common_1['HttpStatus'][_0x5cbd14(0x12b)]);return{'url_qrcode':_0x46d9fb,'redirectUrl':null,'channel':_0x57f6a1,'isRedirect':![]};}}async[_0x1b117b(0x15a)](_0x5e9805){const _0x394bd6=_0x1b117b,{payEpayPid:_0x21b883,payEpaySecret:_0x4608de,payEpayApiQueryUrl:_0x584a17}=await this[_0x394bd6(0x112)][_0x394bd6(0x168)]([_0x394bd6(0x134),_0x394bd6(0x1b1),_0x394bd6(0x121)]),_0x20a727={};_0x20a727[_0x394bd6(0x15f)]='order',_0x20a727[_0x394bd6(0x178)]=_0x5e9805,_0x20a727[_0x394bd6(0x10d)]=_0x21b883,_0x20a727[_0x394bd6(0x137)]=_0x4608de;const {data:{code:_0x1caeea,msg:_0x47f517,data:_0x258126}}=await axios_1[_0x394bd6(0x185)][_0x394bd6(0x177)](_0x584a17,{'params':_0x20a727});if(_0x1caeea!=0x1)throw new common_1[(_0x394bd6(0x147))](_0x47f517,common_1[_0x394bd6(0x1b8)][_0x394bd6(0x12b)]);return _0x258126;}async[_0x1b117b(0x186)](_0x2cd84f){const _0x120cd3=_0x1b117b,_0x3a4d43=_0x2cd84f['sign'];delete _0x2cd84f[_0x120cd3(0x193)],delete _0x2cd84f[_0x120cd3(0x1b6)];const _0x316be7=await this['globalConfigService'][_0x120cd3(0x168)](['payMpaySecret']);console['log'](_0x120cd3(0x199));if(this[_0x120cd3(0x193)](_0x2cd84f,_0x316be7)!=_0x3a4d43)return'failed';console[_0x120cd3(0x1a3)]('校验签名通过');const _0x2538ce=await this['orderEntity'][_0x120cd3(0x1c3)]({'where':{'orderId':_0x2cd84f[_0x120cd3(0x178)],'status':0x0}});if(!_0x2538ce)return _0x120cd3(0x1c5);const _0x267a06=_0x2cd84f[_0x120cd3(0x1ca)]==_0x120cd3(0x1c1)?0x1:0x2;console[_0x120cd3(0x1a3)](_0x120cd3(0x156),_0x267a06);const _0x44e957=await this['orderEntity']['update']({'orderId':_0x2cd84f[_0x120cd3(0x178)]},{'status':_0x267a06,'paydAt':(0x0,date_1[_0x120cd3(0x185)])()[_0x120cd3(0x117)]()});_0x267a06===0x1&&await this[_0x120cd3(0x150)][_0x120cd3(0x195)](_0x2538ce);if(_0x44e957[_0x120cd3(0x128)]!=0x1)return'failed';return _0x120cd3(0x124);}async[_0x1b117b(0x18a)](_0x35e36b,_0x4e3c98,_0x86cc89=_0x1b117b(0x1c0)){const _0x1c73b=_0x1b117b,_0x5442e0=await this[_0x1c73b(0x119)][_0x1c73b(0x1c3)]({'where':{'userId':_0x35e36b,'orderId':_0x4e3c98}});if(!_0x5442e0)throw new common_1[(_0x1c73b(0x147))](_0x1c73b(0x120),common_1[_0x1c73b(0x1b8)][_0x1c73b(0x12b)]);const _0x452dab=await this[_0x1c73b(0x17a)]['findOne']({'where':{'id':_0x5442e0[_0x1c73b(0x11e)]}});if(!_0x452dab)throw new common_1[(_0x1c73b(0x147))](_0x1c73b(0x1d9),common_1[_0x1c73b(0x1b8)][_0x1c73b(0x12b)]);const {payMpayPid:_0x14e9e7,payMpaySecret:_0x290aaa,payMpayNotifyUrl:_0x5f2dbc,payMpayReturnUrl:_0x241a78,payMpayApiPayUrl:_0x57498d}=await this[_0x1c73b(0x112)]['getConfigByKeys']([_0x1c73b(0x142),'payMpaySecret','payMpayNotifyUrl',_0x1c73b(0x14b),_0x1c73b(0x136)]),_0x3f72f7={};_0x3f72f7[_0x1c73b(0x10d)]=Number(_0x14e9e7),_0x3f72f7['type']=_0x86cc89,_0x3f72f7['out_trade_no']=_0x4e3c98,_0x3f72f7[_0x1c73b(0x1d4)]=_0x452dab[_0x1c73b(0x1d4)],_0x3f72f7[_0x1c73b(0x1b5)]=_0x5442e0[_0x1c73b(0x1de)],_0x3f72f7[_0x1c73b(0x118)]=_0x5f2dbc,_0x3f72f7[_0x1c73b(0x1ae)]=_0x241a78,_0x3f72f7['sign']=this['sign'](_0x3f72f7,_0x290aaa),_0x3f72f7[_0x1c73b(0x1b6)]=_0x1c73b(0x1a5);const _0xabe612=new URLSearchParams(_0x3f72f7)[_0x1c73b(0x111)](),_0x33e6d2=_0x57498d+'?'+_0xabe612;return{'url_qrcode':null,'redirectUrl':_0x33e6d2,'channel':_0x86cc89,'isRedirect':!![]};}async[_0x1b117b(0x13a)](_0x18a009){const _0x52957e=_0x1b117b,{payMpayApiQueryUrl:_0x2831b0}=await this[_0x52957e(0x112)][_0x52957e(0x168)]([_0x52957e(0x142),'payMpaySecret',_0x52957e(0x123)]),_0x36e61c={};_0x36e61c[_0x52957e(0x115)]=0x2,_0x36e61c[_0x52957e(0x116)]=_0x18a009;const {data:{code:_0x500d69,msg:_0x39b8e3,data:_0x257fd8}}=await axios_1[_0x52957e(0x185)][_0x52957e(0x177)](_0x2831b0,{'params':_0x36e61c});if(_0x500d69!=0x1)throw new common_1[(_0x52957e(0x147))](_0x39b8e3,common_1[_0x52957e(0x1b8)][_0x52957e(0x12b)]);return _0x257fd8;}async[_0x1b117b(0x165)](_0x4ca291){const _0x19bc2c=_0x1b117b;console[_0x19bc2c(0x1a3)](_0x19bc2c(0x18d),_0x4ca291);const {payWeChatAppId:_0x49f259,payWeChatMchId:_0x3f80a8,payWeChatSecret:_0x3e5751,payWeChatPublicKey:_0x21e5c1,payWeChatPrivateKey:_0x276cc2}=await this[_0x19bc2c(0x112)][_0x19bc2c(0x168)]([_0x19bc2c(0x163),_0x19bc2c(0x166),'payWeChatSecret',_0x19bc2c(0x1a7),_0x19bc2c(0x16d)]),_0x163d4b=new WxPay({'appid':_0x49f259,'mchid':_0x3f80a8,'publicKey':_0x21e5c1,'privateKey':_0x276cc2});let _0x1cad85;try{if(_0x4ca291[_0x19bc2c(0x10b)]==_0x19bc2c(0x10f)){const {ciphertext:_0x5c82c5,associated_data:_0x328fbd,nonce:_0x1a32e5}=_0x4ca291[_0x19bc2c(0x17e)],_0x425393=_0x163d4b['decipher_gcm'](_0x5c82c5,_0x328fbd,_0x1a32e5,_0x3e5751),_0xd00b3e=_0x425393['out_trade_no'];_0x1cad85=redisKey_constant_1['PAY_UPDATE_ORDER']+_0xd00b3e,await this['redisCacheService']['set']({'key':_0x1cad85,'val':'lock'});const _0x35e8ff=await this[_0x19bc2c(0x119)]['findOne']({'where':{'orderId':_0xd00b3e,'status':0x0}});if(!_0x35e8ff)return _0x19bc2c(0x1c5);if([0x1,0x2,0x3][_0x19bc2c(0x10e)](_0x35e8ff[_0x19bc2c(0x1b3)]))return _0x19bc2c(0x124);const _0x325720=await this[_0x19bc2c(0x1af)][_0x19bc2c(0x145)](async _0x2c86b9=>{const _0x48cabe=_0x19bc2c,_0x3fc16a=_0x425393[_0x48cabe(0x157)]==_0x48cabe(0x1ad)?0x1:0x2,_0x48d258=await this[_0x48cabe(0x119)]['update']({'orderId':_0xd00b3e},{'status':_0x3fc16a,'paydAt':(0x0,date_1['default'])()['toDate'](),'tradeId':_0x425393[_0x48cabe(0x151)]});return _0x3fc16a===0x1&&await this[_0x48cabe(0x150)]['addBalanceToOrder'](_0x35e8ff),_0x48d258;});if(_0x325720[_0x19bc2c(0x128)]!=0x1)return _0x19bc2c(0x1c5);}return _0x19bc2c(0x124);}catch(_0x449e38){return console['log']('error:\x20',_0x449e38),console['log'](_0x19bc2c(0x1ac),_0x449e38),_0x19bc2c(0x1c5);}finally{_0x1cad85&&await this[_0x19bc2c(0x1dc)][_0x19bc2c(0x1df)]({'key':_0x1cad85});}}async[_0x1b117b(0x13e)](_0x5aa326,_0x5e6ccd,_0x37195a){const _0x5a8b9f=_0x1b117b,_0x585426=await this[_0x5a8b9f(0x119)][_0x5a8b9f(0x1c3)]({'where':{'userId':_0x5aa326,'orderId':_0x5e6ccd}});if(!_0x585426)throw new common_1[(_0x5a8b9f(0x147))](_0x5a8b9f(0x120),common_1[_0x5a8b9f(0x1b8)][_0x5a8b9f(0x12b)]);const _0x35d4fe=await this[_0x5a8b9f(0x17a)][_0x5a8b9f(0x1c3)]({'where':{'id':_0x585426[_0x5a8b9f(0x11e)]}});if(!_0x35d4fe)throw new common_1[(_0x5a8b9f(0x147))](_0x5a8b9f(0x1d9),common_1['HttpStatus']['BAD_REQUEST']);const _0x650807={'bizContent':{'out_trade_no':_0x5e6ccd,'total_amount':_0x585426[_0x5a8b9f(0x1de)],'subject':_0x35d4fe['name']}};let _0x54c21a,_0x25fe89,_0x33d27d,_0x40726e,_0x262e2f;const {payAliPublicSecret:_0x2b6bfc,payAliWebAppId:_0x36d237,payAliWebSecret:_0x22081d,payAliAppAppId:_0x25a211,payAliAppSecret:_0x5628f7,payWeChatNotifyUrl:_0x59d36e}=await this[_0x5a8b9f(0x112)][_0x5a8b9f(0x168)]([_0x5a8b9f(0x113),_0x5a8b9f(0x127),_0x5a8b9f(0x114),_0x5a8b9f(0x19b),_0x5a8b9f(0x1a0),'payWeChatNotifyUrl']);_0x37195a===_0x5a8b9f(0x18e)&&(_0x650807[_0x5a8b9f(0x161)]=_0x5a8b9f(0x1cd),_0x54c21a=_0x36d237,_0x33d27d=_0x5a8b9f(0x148),_0x25fe89=_0x22081d,_0x40726e=_0x5a8b9f(0x11f),_0x262e2f=_0x5a8b9f(0x125));_0x37195a==='app'&&(_0x33d27d=_0x5a8b9f(0x1a4),_0x54c21a=_0x25a211,_0x25fe89=_0x5628f7,_0x40726e=_0x5a8b9f(0x15e),_0x262e2f='QUICK_MSECURITY_PAY');const _0x261314=new AlipaySdk({'appId':_0x54c21a,'keyType':_0x5a8b9f(0x176),'privateKey':_0x25fe89,'alipayPublicKey':_0x2b6bfc});_0x650807[_0x5a8b9f(0x144)]=_0x59d36e,_0x650807[_0x5a8b9f(0x109)][_0x5a8b9f(0x19d)]=_0x262e2f;const _0x5e9f15=await _0x261314[_0x33d27d](_0x40726e,_0x650807);return console[_0x5a8b9f(0x1a3)](_0x5a8b9f(0x1d5),_0x5e9f15),_0x37195a===_0x5a8b9f(0x18e)?{'form':_0x5e9f15}:{'data':_0x5e9f15};}async['queryAliPay'](_0xd569d7,_0x3394b4){const _0x5bae77=_0x1b117b;let _0x46e0cb,_0x5ca782;const {payAliPublicSecret:_0x8d6685,payAliWebAppId:_0xa67ed8,payAliWebSecret:_0x9190a1,payAliAppAppId:_0x330acd,payAliAppSecret:_0x1cc017,payWeChatNotifyUrl:_0x339085}=await this[_0x5bae77(0x112)][_0x5bae77(0x168)](['payAliPublicSecret',_0x5bae77(0x127),_0x5bae77(0x114),_0x5bae77(0x19b),_0x5bae77(0x1a0),_0x5bae77(0x16a)]);_0x3394b4===_0x5bae77(0x18e)&&(_0x46e0cb=_0xa67ed8,_0x5ca782=_0x9190a1);_0x3394b4===_0x5bae77(0x11d)&&(_0x46e0cb=_0x330acd,_0x5ca782=_0x1cc017);const _0x283f19=new AlipaySdk({'appId':_0x46e0cb,'keyType':'PKCS1','privateKey':_0x5ca782,'alipayPublicKey':_0x8d6685}),_0xe45e37=await _0x283f19[_0x5bae77(0x1b0)](_0x5bae77(0x13b),{'bizContent':{'out_trade_no':_0xd569d7}});return console[_0x5bae77(0x1a3)](_0xe45e37),_0xe45e37;}async['payWeChat'](_0x10f50d,_0x2a2f51,_0x5410c8=_0x1b117b(0x18e)){const _0xe56980=_0x1b117b;console['log'](_0xe56980(0x1d3),_0x5410c8);const _0x1391c0=await this['orderEntity'][_0xe56980(0x1c3)]({'where':{'userId':_0x10f50d,'orderId':_0x2a2f51}});if(!_0x1391c0)throw new common_1[(_0xe56980(0x147))](_0xe56980(0x120),common_1[_0xe56980(0x1b8)][_0xe56980(0x12b)]);const _0x4e5f3d=await this[_0xe56980(0x17a)]['findOne']({'where':{'id':_0x1391c0[_0xe56980(0x11e)]}});if(!_0x4e5f3d)throw new common_1[(_0xe56980(0x147))](_0xe56980(0x1d9),common_1[_0xe56980(0x1b8)]['BAD_REQUEST']);const {payWeChatAppId:_0x4d624c,payWeMiniAppId:_0x106719,payWeChatMchId:_0x21cd2a,payWeChatPublicKey:_0x28157f,payWeChatPrivateKey:_0x22f9cc,payWeChatNotifyUrl:_0x30bcdc,payWeChatH5Name:_0x5a6b3f,payWeChatH5Url:_0x44b9ee,WE_APP_APPID:_0x4fd958,WE_APP_APPSECRET:_0x5adb3a}=await this[_0xe56980(0x112)][_0xe56980(0x168)]([_0xe56980(0x163),_0xe56980(0x170),_0xe56980(0x166),_0xe56980(0x1a7),_0xe56980(0x16d),'payWeChatNotifyUrl',_0xe56980(0x1b2),_0xe56980(0x1ba),_0xe56980(0x1aa)]),_0x5a7fce=new WxPay({'appid':_0x5410c8===_0xe56980(0x187)?_0x106719:_0x4d624c,'mchid':_0x21cd2a,'publicKey':_0x28157f,'privateKey':_0x22f9cc}),_0x237c99={'appid':_0x5410c8===_0xe56980(0x187)?_0x106719:_0x4d624c,'mchid':_0x21cd2a,'description':_0x4e5f3d[_0xe56980(0x1d4)],'out_trade_no':_0x2a2f51,'notify_url':_0x30bcdc,'amount':{'total':Number(_0x1391c0[_0xe56980(0x1de)]*0x64)},'scene_info':{'payer_client_ip':'192.168.1.100'}};console[_0xe56980(0x1a3)]('wechat-pay:\x20',_0x237c99);if(_0x5410c8=='h5'){_0x237c99[_0xe56980(0x133)]['h5_info']={'type':'Wap','app_name':_0x5a6b3f,'app_url':_0x44b9ee};const _0x368fa4=await _0x5a7fce[_0xe56980(0x1d6)](_0x237c99);if(_0x368fa4[_0xe56980(0x1b3)]===0x193){const _0x482e3b=_0x368fa4?.[_0xe56980(0x13d)]?.[_0xe56980(0x1b4)]?.[_0xe56980(0x139)]?.[_0xe56980(0x135)];throw new common_1[(_0xe56980(0x147))](_0x368fa4?.[_0xe56980(0x135)]||_0xe56980(0x138),common_1[_0xe56980(0x1b8)]['BAD_REQUEST']);}const {h5_url:_0x453b3a}=_0x368fa4;return{'url':_0x453b3a};}if(_0x5410c8===_0xe56980(0x11d)){_0x237c99[_0xe56980(0x194)]=_0x4fd958;const _0x59a6a7=await _0x5a7fce[_0xe56980(0x1b7)](_0x237c99);return console[_0xe56980(0x1a3)](_0xe56980(0x1bc),_0x59a6a7),_0x59a6a7;}if(_0x5410c8=='mini'){const _0x7c7211=await this[_0xe56980(0x1b9)][_0xe56980(0x1cb)](_0x10f50d);_0x237c99[_0xe56980(0x1c8)]={'openid':_0x7c7211};const _0x4aa73c=await _0x5a7fce[_0xe56980(0x191)](_0x237c99);return console[_0xe56980(0x1a3)](_0xe56980(0x16e),_0x4aa73c),_0x4aa73c;}if(_0x5410c8==_0xe56980(0x1ce)){const _0x4d61ee=await this[_0xe56980(0x1b9)][_0xe56980(0x11b)](_0x10f50d);console['log'](_0xe56980(0x1bd),_0x4d61ee),_0x237c99[_0xe56980(0x1c8)]={'openid':_0x4d61ee};const _0x1fe83b=await _0x5a7fce[_0xe56980(0x191)](_0x237c99);return console[_0xe56980(0x1a3)](_0xe56980(0x16e),_0x1fe83b),_0x1fe83b;}if(_0x5410c8=='native'){const _0x5d16fe=await _0x5a7fce[_0xe56980(0x14f)](_0x237c99),{code_url:_0x5e3670}=_0x5d16fe;return!_0x5e3670&&console[_0xe56980(0x1a3)](_0xe56980(0x155),_0x5d16fe),{'url_qrcode':_0x5e3670,'isRedirect':![]};}throw new common_1[(_0xe56980(0x147))](_0xe56980(0x1d2),common_1['HttpStatus']['BAD_REQUEST']);}async['queryWeChat'](_0x38c660,_0x3cafbe){const _0x48fa43=_0x1b117b,{payWeChatAppId:_0x4583bf,payWeMiniAppId:_0x22822,payWeChatMchId:_0x3d9e00,payWeChatPublicKey:_0x1b30c4,payWeChatPrivateKey:_0x4ab4dc}=await this[_0x48fa43(0x112)][_0x48fa43(0x168)]([_0x48fa43(0x163),_0x48fa43(0x170),'payWeChatMchId',_0x48fa43(0x1a7),_0x48fa43(0x16d)]),_0x4be670=new WxPay({'appid':_0x3cafbe===_0x48fa43(0x187)?_0x22822:_0x4583bf,'mchid':_0x3d9e00,'publicKey':_0x1b30c4,'privateKey':_0x4ab4dc}),_0x2aa7f5=await _0x4be670[_0x48fa43(0x16b)]({'out_trade_no':_0x38c660});return _0x2aa7f5;}async[_0x1b117b(0x146)](_0x1ddfec){const _0x23e953=_0x1b117b;_0x1ddfec[_0x23e953(0x11c)]==='wechat'&&await this[_0x23e953(0x152)](_0x1ddfec);}async[_0x1b117b(0x152)](_0x618442){const _0x1383c0=_0x1b117b,{payWeChatAppId:_0x47696f,payWeMiniAppId:_0x21b4fa,payWeChatMchId:_0x503273,payWeChatPublicKey:_0x5a1600,payWeChatPrivateKey:_0x28803b}=await this['globalConfigService'][_0x1383c0(0x168)]([_0x1383c0(0x163),_0x1383c0(0x170),'payWeChatMchId',_0x1383c0(0x1a7),_0x1383c0(0x16d),'payWeChatNotifyUrl',_0x1383c0(0x1b2),_0x1383c0(0x1ba)]),_0x2d5a2d=new WxPay({'appid':_0x618442[_0x1383c0(0x108)]===_0x1383c0(0x187)?_0x21b4fa:_0x47696f,'mchid':_0x503273,'publicKey':_0x5a1600,'privateKey':_0x28803b});await _0x2d5a2d[_0x1383c0(0x180)](_0x618442[_0x1383c0(0x12f)]);}[_0x1b117b(0x193)](_0x31c862,_0x3e3f23){const _0x5a7b2=_0x1b117b,_0x5d3158=Object[_0x5a7b2(0x15b)](_0x31c862)[_0x5a7b2(0x13c)]()['map'](_0x395a79=>_0x395a79+'='+_0x31c862[_0x395a79])[_0x5a7b2(0x1da)]('&')+_0x3e3f23;return crypto[_0x5a7b2(0x1c9)](_0x5a7b2(0x1e0))[_0x5a7b2(0x143)](_0x5d3158)[_0x5a7b2(0x14d)]('hex');}};PayService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,typeorm_1[_0x1b117b(0x1a9)])(cramiPackage_entity_1[_0x1b117b(0x1c4)])),__param(0x1,(0x0,typeorm_1[_0x1b117b(0x1a9)])(order_entity_1[_0x1b117b(0x1a1)])),__metadata(_0x1b117b(0x126),[typeorm_2['Repository'],typeorm_2[_0x1b117b(0x13f)],userBalance_service_1[_0x1b117b(0x140)],globalConfig_service_1[_0x1b117b(0x130)],user_service_1['UserService'],redisCache_service_1[_0x1b117b(0x171)],typeorm_2['Connection']])],PayService),exports[_0x1b117b(0x10c)]=PayService;