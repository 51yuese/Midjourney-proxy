'use strict';const _0x1509e6=_0x3a33;(function(_0x23c07c,_0x26d535){const _0x1a380b=_0x3a33,_0x5bf271=_0x23c07c();while(!![]){try{const _0x36b0d4=parseInt(_0x1a380b(0xe2))/0x1+-parseInt(_0x1a380b(0x78))/0x2+-parseInt(_0x1a380b(0xfe))/0x3+-parseInt(_0x1a380b(0xe5))/0x4*(-parseInt(_0x1a380b(0xa5))/0x5)+parseInt(_0x1a380b(0x7d))/0x6+parseInt(_0x1a380b(0x9e))/0x7*(parseInt(_0x1a380b(0x11d))/0x8)+-parseInt(_0x1a380b(0xa0))/0x9;if(_0x36b0d4===_0x26d535)break;else _0x5bf271['push'](_0x5bf271['shift']());}catch(_0x14dfbe){_0x5bf271['push'](_0x5bf271['shift']());}}}(_0x4cfa,0x519b4));function _0x3a33(_0x3fb27b,_0x2282ce){const _0x4cfa1f=_0x4cfa();return _0x3a33=function(_0x3a3364,_0x535678){_0x3a3364=_0x3a3364-0x66;let _0x4e6775=_0x4cfa1f[_0x3a3364];return _0x4e6775;},_0x3a33(_0x3fb27b,_0x2282ce);}function _0x4cfa(){const _0x4294af=['transactions_jsapi','epay','notify_url','536554bXwTpg','InjectRepository','set','4UYhSRx','payEpayApiPayUrl','total','key','hupi','payMpay','payHupiNotifyUrl','length','log','payEpayReturnUrl','payWeChatNotifyUrl','POST','MD5','FAST_INSTANT_TRADE_PAY','cancelWxOrder','getMiniOpenIdByUserId','hex','../user/user.service','sdkExec','mini','payWeChatSecret','toDate','transactions_native','payWeChatMchId','UserBalanceService','447138ZToGAB','clientip','transactions_h5','微信支付通知params:\x20','version','notifyEpay','query','trade_order_id','../../common/utils','defineProperty','app','toFixed','本次支付类型:\x20','type','del','errRaw','@nestjs/common','getConfigByKeys','__decorate','RedisCacheService','payMpayApiQueryUrl','../crami/cramiPackage.entity','userBalanceService','payHupiSecret','hash','attach','lock','用户openId:\x20','sign','校验签名通过','__param','5202056cnhErx','../order/order.entity','status','payAliWebAppId','payAli','https://api.xunhupay.com/payment/do.html','trade_status','192.168.1.100','payAliWebSecret','pageExec','Repository','payMpayReturnUrl','payEpayNotifyUrl','submit.php','1.1','queryWeChat','alipay.trade.query','addBalanceToOrder','transactions_app','wechat','PayService','total_fee','queryEpay','__metadata','nonce_str','payWeChatAppId','metadata','jsapi支付结果返回值:\x20','OrderEntity','globalConfigService','HttpStatus','error:\x20','resource','message','微信H5支付失败！','payHupiGatewayUrl','UserService','payMpayPid','userService','crypto','transaction_id','530932rmNZSO','getOpenIdByUserId','includes','payEpaySecret','queryHupi','829746uekwyq','payPlatform','校验签名','wxpay','decipher_gcm','failed','param','axios','findOne','payEpay','payAliAppSecret','App支付结果返回值:\x20','close','BAD_REQUEST','object','join','wechatpay-node-v3','digest','get','payer','GlobalConfigService','pid','notifyMpay','update','decorate','payWeChatH5Name','text','redisCacheService','h5_info','data','alipay','payWeChatPrivateKey','payMpayApiPayUrl','7jMOBBI','connection','9973017KOfiyK','payEpayApiQueryUrl','epay\x20--->\x20res:\x20','payWeChat','cancel','2658915ZZDuCf','notifyHupi','payEpayPid','Wap','keys','orderEntity','name','sign_type','map','affected','notify','payWeChatPublicKey','CramiPackageEntity','onModuleInit','QUICK_MSECURITY_PAY','payMpaySecret','time','alipay.trade.page.pay','goodsId','payAliAppAppId','TRADE_SUCCESS','queryMpay','wx-native','cramiPackageEntity','orderId','status:\x20','sort','payWeMiniAppId','trade_state','exec','notifyWeChat','套餐不存在!','pay','支付请求失败!','createRandomNonceStr','success','getOwnPropertyDescriptor','out_trade_no','post','return_url','payMpayNotifyUrl','method','__esModule','order_no','now','default','channel','订单不存在!','toString','payHupiAppId','function','mpay','native','Injectable','appid','HttpException','../../common/constants/redisKey.constant','design:paramtypes'];_0x4cfa=function(){return _0x4294af;};return _0x4cfa();}var __decorate=this&&this[_0x1509e6(0x110)]||function(_0x9cdc36,_0x40c9ed,_0x15ad75,_0x1888f9){const _0x1e3d2d=_0x1509e6;var _0x46b487=arguments[_0x1e3d2d(0xec)],_0x4da899=_0x46b487<0x3?_0x40c9ed:_0x1888f9===null?_0x1888f9=Object[_0x1e3d2d(0xc9)](_0x40c9ed,_0x15ad75):_0x1888f9,_0x1764c7;if(typeof Reflect===_0x1e3d2d(0x8b)&&typeof Reflect['decorate']===_0x1e3d2d(0xd7))_0x4da899=Reflect[_0x1e3d2d(0x95)](_0x9cdc36,_0x40c9ed,_0x15ad75,_0x1888f9);else{for(var _0x4ab8a0=_0x9cdc36[_0x1e3d2d(0xec)]-0x1;_0x4ab8a0>=0x0;_0x4ab8a0--)if(_0x1764c7=_0x9cdc36[_0x4ab8a0])_0x4da899=(_0x46b487<0x3?_0x1764c7(_0x4da899):_0x46b487>0x3?_0x1764c7(_0x40c9ed,_0x15ad75,_0x4da899):_0x1764c7(_0x40c9ed,_0x15ad75))||_0x4da899;}return _0x46b487>0x3&&_0x4da899&&Object['defineProperty'](_0x40c9ed,_0x15ad75,_0x4da899),_0x4da899;},__metadata=this&&this[_0x1509e6(0x66)]||function(_0x4494f8,_0x4e3158){const _0x32b662=_0x1509e6;if(typeof Reflect==='object'&&typeof Reflect[_0x32b662(0x69)]===_0x32b662(0xd7))return Reflect[_0x32b662(0x69)](_0x4494f8,_0x4e3158);},__param=this&&this[_0x1509e6(0x11c)]||function(_0x5a5863,_0x51a989){return function(_0x5ea47e,_0x13c586){_0x51a989(_0x5ea47e,_0x13c586,_0x5a5863);};};Object[_0x1509e6(0x107)](exports,_0x1509e6(0xcf),{'value':!![]}),exports[_0x1509e6(0x131)]=void 0x0;const typeorm_1=require('@nestjs/typeorm'),typeorm_2=require('typeorm'),common_1=require(_0x1509e6(0x10e)),crypto=require(_0x1509e6(0x76)),axios_1=require(_0x1509e6(0x84)),order_entity_1=require(_0x1509e6(0x11e)),cramiPackage_entity_1=require(_0x1509e6(0x113)),userBalance_service_1=require('../userBalance/userBalance.service'),globalConfig_service_1=require('../globalConfig/globalConfig.service'),utils_1=require(_0x1509e6(0x106)),user_service_1=require(_0x1509e6(0xf6)),redisCache_service_1=require('../redisCache/redisCache.service'),redisKey_constant_1=require(_0x1509e6(0xdd)),date_1=require('../../common/utils/date'),WxPay=require(_0x1509e6(0x8d)),AlipaySdk=require('alipay-sdk');let PayService=class PayService{constructor(_0x5ca922,_0x131576,_0x4cc952,_0x4eb9b2,_0x215681,_0x4347fd,_0x2883f9){const _0x2c4dd8=_0x1509e6;this['cramiPackageEntity']=_0x5ca922,this[_0x2c4dd8(0xaa)]=_0x131576,this[_0x2c4dd8(0x114)]=_0x4cc952,this[_0x2c4dd8(0x6c)]=_0x4eb9b2,this['userService']=_0x215681,this[_0x2c4dd8(0x98)]=_0x4347fd,this[_0x2c4dd8(0x9f)]=_0x2883f9;}async[_0x1509e6(0xb2)](){}async[_0x1509e6(0xaf)](_0x3361ec){const _0x38f0ff=_0x1509e6;if(_0x3361ec[_0x38f0ff(0x83)]==_0x38f0ff(0xe0))return this[_0x38f0ff(0x103)](_0x3361ec);if(_0x3361ec[_0x38f0ff(0x117)]==_0x38f0ff(0xe9))return this[_0x38f0ff(0xa6)](_0x3361ec);if(typeof _0x3361ec[_0x38f0ff(0x6f)]=='object')return this[_0x38f0ff(0xc3)](_0x3361ec);return this[_0x38f0ff(0x93)](_0x3361ec);}async[_0x1509e6(0xc5)](_0x39622a,_0x2c1ddd,_0x44ccb5=_0x1509e6(0x80)){const _0x6128d2=_0x1509e6,_0x310e30=await this[_0x6128d2(0xaa)]['findOne']({'where':{'userId':_0x39622a,'orderId':_0x2c1ddd}});if(!_0x310e30)throw new common_1[(_0x6128d2(0xdc))](_0x6128d2(0xd4),common_1[_0x6128d2(0x6d)]['BAD_REQUEST']);const _0x4c7079=await this['cramiPackageEntity'][_0x6128d2(0x85)]({'where':{'id':_0x310e30[_0x6128d2(0xb7)]}});if(!_0x4c7079)throw new common_1[(_0x6128d2(0xdc))](_0x6128d2(0xc4),common_1[_0x6128d2(0x6d)][_0x6128d2(0x8a)]);console[_0x6128d2(0xed)](_0x6128d2(0x10a),_0x310e30[_0x6128d2(0x7e)]);try{if(_0x310e30[_0x6128d2(0x7e)]==_0x6128d2(0x9b))return this[_0x6128d2(0x121)](_0x39622a,_0x2c1ddd,_0x44ccb5);if(_0x310e30['payPlatform']==_0x6128d2(0x130))return this[_0x6128d2(0xa3)](_0x39622a,_0x2c1ddd,_0x44ccb5);if(_0x310e30[_0x6128d2(0x7e)]==_0x6128d2(0xe0))return this[_0x6128d2(0x86)](_0x39622a,_0x2c1ddd,_0x44ccb5);if(_0x310e30[_0x6128d2(0x7e)]==_0x6128d2(0xd8))return this[_0x6128d2(0xea)](_0x39622a,_0x2c1ddd,_0x44ccb5);if(_0x310e30['payPlatform']=='hupi')return this['payHupi'](_0x39622a,_0x2c1ddd,_0x44ccb5);}catch(_0x16b06c){console[_0x6128d2(0xed)]('支付请求失败:\x20',_0x16b06c);throw new common_1['HttpException'](_0x6128d2(0xc6),common_1['HttpStatus'][_0x6128d2(0x8a)]);}}async[_0x1509e6(0x104)](_0x538747){const _0x538bfc=_0x1509e6,_0xc8bf47=await this['orderEntity'][_0x538bfc(0x85)]({'where':{'orderId':_0x538747}});if(!_0xc8bf47)throw new common_1[(_0x538bfc(0xdc))](_0x538bfc(0xd4),common_1[_0x538bfc(0x6d)][_0x538bfc(0x8a)]);return _0xc8bf47;}async[_0x1509e6(0xa6)](_0xbdced5){const _0xcab2e9=_0x1509e6,_0x3e974c=await this['globalConfigService'][_0xcab2e9(0x10f)]([_0xcab2e9(0x115)]),_0x4392be=_0xbdced5[_0xcab2e9(0x116)];delete _0xbdced5[_0xcab2e9(0x116)];if(this[_0xcab2e9(0x11a)](_0xbdced5,_0x3e974c)!=_0x4392be)return _0xcab2e9(0x82);const _0x151519=await this[_0xcab2e9(0xaa)][_0xcab2e9(0x85)]({'where':{'orderId':_0xbdced5[_0xcab2e9(0x105)],'status':0x0}});if(!_0x151519)return _0xcab2e9(0x82);await this[_0xcab2e9(0x114)][_0xcab2e9(0x12e)](_0x151519);const _0x11e580=await this['orderEntity']['update']({'orderId':_0xbdced5[_0xcab2e9(0x105)]},{'status':0x1,'paydAt':(0x0,date_1['default'])()[_0xcab2e9(0xfa)]()});if(_0x11e580[_0xcab2e9(0xae)]!=0x1)return _0xcab2e9(0x82);return _0xcab2e9(0xc8);}async['payHupi'](_0x5a799d,_0x5b0211,_0xcdbaef=_0x1509e6(0x80)){const _0x5646cd=_0x1509e6,_0x240242=await this['orderEntity'][_0x5646cd(0x85)]({'where':{'userId':_0x5a799d,'orderId':_0x5b0211}});if(!_0x240242)throw new common_1[(_0x5646cd(0xdc))]('订单不存在!',common_1[_0x5646cd(0x6d)]['BAD_REQUEST']);const _0x5498aa=await this[_0x5646cd(0xbc)][_0x5646cd(0x85)]({'where':{'id':_0x240242['goodsId']}});if(!_0x5498aa)throw new common_1[(_0x5646cd(0xdc))](_0x5646cd(0xc4),common_1[_0x5646cd(0x6d)][_0x5646cd(0x8a)]);const {payHupiAppId:_0x220daa,payHupiSecret:_0xb9f85a,payHupiNotifyUrl:_0x1685bc,payHupiReturnUrl:_0x2a811c,payHupiGatewayUrl:_0x13c8b0}=await this[_0x5646cd(0x6c)][_0x5646cd(0x10f)]([_0x5646cd(0xd6),_0x5646cd(0x115),_0x5646cd(0xeb),'payHupiReturnUrl',_0x5646cd(0x72)]),_0x10b33f={};_0x10b33f[_0x5646cd(0x102)]=_0x5646cd(0x12b),_0x10b33f[_0x5646cd(0xdb)]=_0x220daa,_0x10b33f[_0x5646cd(0xb5)]=(Date['now']()/0x3e8)[_0x5646cd(0x109)](0x0),_0x10b33f[_0x5646cd(0x67)]=(0x0,utils_1[_0x5646cd(0xc7)])(0x20),_0x10b33f[_0x5646cd(0x105)]=_0x5b0211,_0x10b33f['title']=_0x5498aa[_0x5646cd(0xab)],_0x10b33f[_0x5646cd(0x132)]=_0x240242[_0x5646cd(0xe7)],_0x10b33f[_0x5646cd(0xe1)]=_0x1685bc,_0x10b33f[_0x5646cd(0xcc)]=_0x2a811c,_0x10b33f[_0x5646cd(0x117)]=_0x5646cd(0xe9),_0x10b33f[_0x5646cd(0x116)]=this[_0x5646cd(0x11a)](_0x10b33f,_0xb9f85a);const {data:{errcode:_0x56ee4e,errmsg:_0x61568c,url_qrcode:_0x4c544c,url:_0x357756}}=await axios_1[_0x5646cd(0xd2)][_0x5646cd(0xcb)](_0x13c8b0||_0x5646cd(0x122),_0x10b33f);if(_0x56ee4e!=0x0)throw new common_1[(_0x5646cd(0xdc))](_0x61568c,common_1[_0x5646cd(0x6d)][_0x5646cd(0x8a)]);return{'url_qrcode':_0x4c544c,'url':_0x357756};}async[_0x1509e6(0x7c)](_0x4fa699){const _0x44523b=_0x1509e6,{payHupiAppId:_0x576474,payHupiSecret:_0x4254c6}=await this[_0x44523b(0x6c)][_0x44523b(0x10f)]([_0x44523b(0xd6),_0x44523b(0x115)]),_0x37a5a0={};_0x37a5a0[_0x44523b(0x102)]=_0x44523b(0x12b),_0x37a5a0[_0x44523b(0xdb)]=_0x576474,_0x37a5a0['time']=(Date[_0x44523b(0xd1)]()/0x3e8)[_0x44523b(0x109)](0x0),_0x37a5a0[_0x44523b(0x67)]=(0x0,utils_1[_0x44523b(0xc7)])(0x20),_0x37a5a0['out_trade_order']=_0x4fa699,_0x37a5a0[_0x44523b(0x116)]=this[_0x44523b(0x11a)](_0x37a5a0,_0x4254c6);const {data:{errcode:_0x5d90cf,errmsg:_0x5b9fbd,data:_0x78b544}}=await axios_1[_0x44523b(0xd2)][_0x44523b(0xcb)]('https://api.xunhupay.com/payment/query.html',_0x37a5a0);if(_0x5d90cf!=0x0)throw new common_1[(_0x44523b(0xdc))](_0x5b9fbd,common_1[_0x44523b(0x6d)]['BAD_REQUEST']);return _0x78b544;}async[_0x1509e6(0x103)](_0x48c90){const _0x1edd8a=_0x1509e6,_0x3f73ec=_0x48c90[_0x1edd8a(0x11a)];delete _0x48c90[_0x1edd8a(0x11a)],delete _0x48c90[_0x1edd8a(0xac)];const _0x1f96c3=await this['globalConfigService']['getConfigByKeys']([_0x1edd8a(0x7b)]);if(this[_0x1edd8a(0x11a)](_0x48c90,_0x1f96c3)!=_0x3f73ec)return _0x1edd8a(0x82);console[_0x1edd8a(0xed)]('校验签名通过');const _0x43beb1=await this[_0x1edd8a(0xaa)][_0x1edd8a(0x85)]({'where':{'orderId':_0x48c90[_0x1edd8a(0xca)],'status':0x0}});if(!_0x43beb1)return _0x1edd8a(0x82);const _0x252523=_0x48c90[_0x1edd8a(0x123)]==_0x1edd8a(0xb9)?0x1:0x2,_0x535abb=await this[_0x1edd8a(0xaa)]['update']({'orderId':_0x48c90[_0x1edd8a(0xca)]},{'status':_0x252523,'paydAt':(0x0,date_1['default'])()[_0x1edd8a(0xfa)]()});_0x252523===0x1&&await this[_0x1edd8a(0x114)][_0x1edd8a(0x12e)](_0x43beb1);if(_0x535abb[_0x1edd8a(0xae)]!=0x1)return'failed';return _0x1edd8a(0xc8);}async[_0x1509e6(0x86)](_0x59d329,_0x18fecb,_0x83f9c9=_0x1509e6(0x9b)){const _0xd77741=_0x1509e6,_0x3ebf93=await this[_0xd77741(0xaa)][_0xd77741(0x85)]({'where':{'userId':_0x59d329,'orderId':_0x18fecb}});if(!_0x3ebf93)throw new common_1[(_0xd77741(0xdc))](_0xd77741(0xd4),common_1[_0xd77741(0x6d)][_0xd77741(0x8a)]);const _0x4471ee=await this[_0xd77741(0xbc)]['findOne']({'where':{'id':_0x3ebf93[_0xd77741(0xb7)]}});if(!_0x4471ee)throw new common_1['HttpException']('套餐不存在!',common_1[_0xd77741(0x6d)][_0xd77741(0x8a)]);const {payEpayPid:_0x25a807,payEpaySecret:_0x12f729,payEpayNotifyUrl:_0xffaa58,payEpayReturnUrl:_0x13f023,payEpayApiPayUrl:_0x6e2890}=await this[_0xd77741(0x6c)][_0xd77741(0x10f)]([_0xd77741(0xa7),_0xd77741(0x7b),_0xd77741(0x129),_0xd77741(0xee),_0xd77741(0xe6)]);let _0x5a7266;_0x25a807[_0xd77741(0xec)]<=0x10?_0x5a7266=Number(_0x25a807):_0x5a7266=BigInt(_0x25a807);const _0x40c86e={};_0x40c86e[_0xd77741(0x92)]=_0x5a7266,_0x40c86e[_0xd77741(0x10b)]=_0x83f9c9,_0x40c86e[_0xd77741(0xca)]=_0x18fecb,_0x40c86e['name']=_0x4471ee[_0xd77741(0xab)],_0x40c86e['money']=_0x3ebf93['total'],_0x40c86e[_0xd77741(0xff)]=_0xd77741(0x124),_0x40c86e['device']='pc',_0x40c86e['notify_url']=_0xffaa58,_0x40c86e[_0xd77741(0xcc)]=_0x13f023,_0x40c86e[_0xd77741(0x83)]=_0xd77741(0xe0),_0x40c86e[_0xd77741(0x11a)]=this[_0xd77741(0x11a)](_0x40c86e,_0x12f729),_0x40c86e[_0xd77741(0xac)]=_0xd77741(0xf1);const _0x4637a4=new URLSearchParams(_0x40c86e)[_0xd77741(0xd5)](),_0x2a9f09=_0x6e2890+'?'+_0x4637a4;if(_0x6e2890[_0xd77741(0x7a)](_0xd77741(0x12a)))return{'url_qrcode':null,'redirectUrl':_0x2a9f09,'channel':_0x83f9c9,'isRedirect':!![]};else{const _0x2f56d3=await axios_1[_0xd77741(0xd2)][_0xd77741(0x8f)](_0x6e2890,{'params':_0x40c86e});console[_0xd77741(0xed)](_0xd77741(0xa2),_0x2f56d3[_0xd77741(0x9a)]);const {data:{code:_0x2e03d2,msg:_0x8377f9,qrcode:_0x3130a5}}=_0x2f56d3;if(_0x2e03d2!=0x1)throw new common_1[(_0xd77741(0xdc))](_0x8377f9,common_1['HttpStatus'][_0xd77741(0x8a)]);return{'url_qrcode':_0x3130a5,'redirectUrl':null,'channel':_0x83f9c9,'isRedirect':![]};}}async[_0x1509e6(0x133)](_0x32958b){const _0x40c45e=_0x1509e6,{payEpayPid:_0x16d559,payEpaySecret:_0x4c803a,payEpayApiQueryUrl:_0x539f79}=await this['globalConfigService'][_0x40c45e(0x10f)](['payEpayPid',_0x40c45e(0x7b),_0x40c45e(0xa1)]),_0x2ffa4f={};_0x2ffa4f['act']='order',_0x2ffa4f[_0x40c45e(0xca)]=_0x32958b,_0x2ffa4f[_0x40c45e(0x92)]=_0x16d559,_0x2ffa4f[_0x40c45e(0xe8)]=_0x4c803a;const {data:{code:_0x5b66a0,msg:_0x1127b6,data:_0x1977f4}}=await axios_1[_0x40c45e(0xd2)]['get'](_0x539f79,{'params':_0x2ffa4f});if(_0x5b66a0!=0x1)throw new common_1[(_0x40c45e(0xdc))](_0x1127b6,common_1[_0x40c45e(0x6d)][_0x40c45e(0x8a)]);return _0x1977f4;}async[_0x1509e6(0x93)](_0x1c7b8e){const _0x5c5489=_0x1509e6,_0x545a75=_0x1c7b8e[_0x5c5489(0x11a)];delete _0x1c7b8e[_0x5c5489(0x11a)],delete _0x1c7b8e[_0x5c5489(0xac)];const _0x598822=await this[_0x5c5489(0x6c)][_0x5c5489(0x10f)](['payMpaySecret']);console[_0x5c5489(0xed)](_0x5c5489(0x7f));if(this[_0x5c5489(0x11a)](_0x1c7b8e,_0x598822)!=_0x545a75)return _0x5c5489(0x82);console[_0x5c5489(0xed)](_0x5c5489(0x11b));const _0x19b0f8=await this[_0x5c5489(0xaa)]['findOne']({'where':{'orderId':_0x1c7b8e[_0x5c5489(0xca)],'status':0x0}});if(!_0x19b0f8)return _0x5c5489(0x82);const _0x58e1cd=_0x1c7b8e['trade_status']==_0x5c5489(0xb9)?0x1:0x2;console[_0x5c5489(0xed)](_0x5c5489(0xbe),_0x58e1cd);const _0x30c191=await this[_0x5c5489(0xaa)][_0x5c5489(0x94)]({'orderId':_0x1c7b8e[_0x5c5489(0xca)]},{'status':_0x58e1cd,'paydAt':(0x0,date_1[_0x5c5489(0xd2)])()[_0x5c5489(0xfa)]()});_0x58e1cd===0x1&&await this['userBalanceService'][_0x5c5489(0x12e)](_0x19b0f8);if(_0x30c191[_0x5c5489(0xae)]!=0x1)return _0x5c5489(0x82);return _0x5c5489(0xc8);}async[_0x1509e6(0xea)](_0x1bdd5c,_0x5d696b,_0x446429=_0x1509e6(0x80)){const _0x7bc197=_0x1509e6,_0x283a79=await this[_0x7bc197(0xaa)][_0x7bc197(0x85)]({'where':{'userId':_0x1bdd5c,'orderId':_0x5d696b}});if(!_0x283a79)throw new common_1[(_0x7bc197(0xdc))](_0x7bc197(0xd4),common_1['HttpStatus'][_0x7bc197(0x8a)]);const _0x5da7c0=await this['cramiPackageEntity'][_0x7bc197(0x85)]({'where':{'id':_0x283a79[_0x7bc197(0xb7)]}});if(!_0x5da7c0)throw new common_1['HttpException']('套餐不存在!',common_1[_0x7bc197(0x6d)][_0x7bc197(0x8a)]);const {payMpayPid:_0x2ebaa0,payMpaySecret:_0x43c8b4,payMpayNotifyUrl:_0x6b5104,payMpayReturnUrl:_0x139e39,payMpayApiPayUrl:_0x42e6ad}=await this['globalConfigService'][_0x7bc197(0x10f)]([_0x7bc197(0x74),_0x7bc197(0xb4),_0x7bc197(0xcd),_0x7bc197(0x128),_0x7bc197(0x9d)]),_0x305718={};_0x305718[_0x7bc197(0x92)]=Number(_0x2ebaa0),_0x305718[_0x7bc197(0x10b)]=_0x446429,_0x305718[_0x7bc197(0xca)]=_0x5d696b,_0x305718[_0x7bc197(0xab)]=_0x5da7c0[_0x7bc197(0xab)],_0x305718['money']=_0x283a79[_0x7bc197(0xe7)],_0x305718[_0x7bc197(0xe1)]=_0x6b5104,_0x305718[_0x7bc197(0xcc)]=_0x139e39,_0x305718[_0x7bc197(0x11a)]=this[_0x7bc197(0x11a)](_0x305718,_0x43c8b4),_0x305718[_0x7bc197(0xac)]='MD5';const _0x262269=new URLSearchParams(_0x305718)[_0x7bc197(0xd5)](),_0x208d47=_0x42e6ad+'?'+_0x262269;return{'url_qrcode':null,'redirectUrl':_0x208d47,'channel':_0x446429,'isRedirect':!![]};}async[_0x1509e6(0xba)](_0x104dea){const _0x25d897=_0x1509e6,{payMpayApiQueryUrl:_0x1cee37}=await this['globalConfigService']['getConfigByKeys']([_0x25d897(0x74),_0x25d897(0xb4),_0x25d897(0x112)]),_0x3070f3={};_0x3070f3[_0x25d897(0x10b)]=0x2,_0x3070f3[_0x25d897(0xd0)]=_0x104dea;const {data:{code:_0xfab2d2,msg:_0x2b8ad0,data:_0x105574}}=await axios_1[_0x25d897(0xd2)][_0x25d897(0x8f)](_0x1cee37,{'params':_0x3070f3});if(_0xfab2d2!=0x1)throw new common_1[(_0x25d897(0xdc))](_0x2b8ad0,common_1[_0x25d897(0x6d)]['BAD_REQUEST']);return _0x105574;}async[_0x1509e6(0xc3)](_0x2e09bb){const _0x1e56ee=_0x1509e6;console[_0x1e56ee(0xed)](_0x1e56ee(0x101),_0x2e09bb);const {payWeChatAppId:_0xe16ddd,payWeChatMchId:_0x1f74ef,payWeChatSecret:_0x52308b,payWeChatPublicKey:_0xb7213,payWeChatPrivateKey:_0x12c176}=await this[_0x1e56ee(0x6c)][_0x1e56ee(0x10f)]([_0x1e56ee(0x68),_0x1e56ee(0xfc),_0x1e56ee(0xf9),_0x1e56ee(0xb0),'payWeChatPrivateKey']),_0x437186=new WxPay({'appid':_0xe16ddd,'mchid':_0x1f74ef,'publicKey':_0xb7213,'privateKey':_0x12c176});let _0x5116a7;try{if(_0x2e09bb['event_type']=='TRANSACTION.SUCCESS'){const {ciphertext:_0x54b9c0,associated_data:_0x4f4c13,nonce:_0x4ab32c}=_0x2e09bb['resource'],_0x30c179=_0x437186[_0x1e56ee(0x81)](_0x54b9c0,_0x4f4c13,_0x4ab32c,_0x52308b),_0x22f12e=_0x30c179[_0x1e56ee(0xca)];_0x5116a7=redisKey_constant_1['PAY_UPDATE_ORDER']+_0x22f12e,await this[_0x1e56ee(0x98)][_0x1e56ee(0xe4)]({'key':_0x5116a7,'val':_0x1e56ee(0x118)});const _0x408250=await this[_0x1e56ee(0xaa)][_0x1e56ee(0x85)]({'where':{'orderId':_0x22f12e,'status':0x0}});if(!_0x408250)return _0x1e56ee(0x82);if([0x1,0x2,0x3][_0x1e56ee(0x7a)](_0x408250[_0x1e56ee(0x11f)]))return _0x1e56ee(0xc8);const _0x4d4bc3=await this['connection']['transaction'](async _0xc9fa6d=>{const _0x295fc0=_0x1e56ee,_0x4a569e=_0x30c179[_0x295fc0(0xc1)]=='SUCCESS'?0x1:0x2,_0x2416d1=await this[_0x295fc0(0xaa)][_0x295fc0(0x94)]({'orderId':_0x22f12e},{'status':_0x4a569e,'paydAt':(0x0,date_1[_0x295fc0(0xd2)])()[_0x295fc0(0xfa)](),'tradeId':_0x30c179[_0x295fc0(0x77)]});return _0x4a569e===0x1&&await this[_0x295fc0(0x114)][_0x295fc0(0x12e)](_0x408250),_0x2416d1;});if(_0x4d4bc3[_0x1e56ee(0xae)]!=0x1)return _0x1e56ee(0x82);}return _0x1e56ee(0xc8);}catch(_0x1426e0){return console[_0x1e56ee(0xed)](_0x1e56ee(0x6e),_0x1426e0),console['log']('支付通知验证失败:\x20',_0x1426e0),_0x1e56ee(0x82);}finally{_0x5116a7&&await this[_0x1e56ee(0x98)][_0x1e56ee(0x10c)]({'key':_0x5116a7});}}async[_0x1509e6(0x121)](_0xc51243,_0xb09ad,_0x4b1762){const _0x54ccb4=_0x1509e6,_0x3b5144=await this['orderEntity'][_0x54ccb4(0x85)]({'where':{'userId':_0xc51243,'orderId':_0xb09ad}});if(!_0x3b5144)throw new common_1['HttpException'](_0x54ccb4(0xd4),common_1[_0x54ccb4(0x6d)][_0x54ccb4(0x8a)]);const _0x3f65f3=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x3b5144[_0x54ccb4(0xb7)]}});if(!_0x3f65f3)throw new common_1[(_0x54ccb4(0xdc))]('套餐不存在!',common_1['HttpStatus'][_0x54ccb4(0x8a)]);const _0x5042d1={'bizContent':{'out_trade_no':_0xb09ad,'total_amount':_0x3b5144[_0x54ccb4(0xe7)],'subject':_0x3f65f3[_0x54ccb4(0xab)]}};let _0x1ff5de,_0x222336,_0x25c441,_0x163e1e,_0x223da7;const {payAliPublicSecret:_0xd7c3d5,payAliWebAppId:_0x16b883,payAliWebSecret:_0x275e23,payAliAppAppId:_0x47041c,payAliAppSecret:_0x22266a,payWeChatNotifyUrl:_0x42ec82}=await this[_0x54ccb4(0x6c)]['getConfigByKeys'](['payAliPublicSecret',_0x54ccb4(0x120),_0x54ccb4(0x125),_0x54ccb4(0xb8),_0x54ccb4(0x87),_0x54ccb4(0xef)]);_0x4b1762==='native'&&(_0x5042d1[_0x54ccb4(0xce)]=_0x54ccb4(0xf0),_0x1ff5de=_0x16b883,_0x25c441=_0x54ccb4(0x126),_0x222336=_0x275e23,_0x163e1e=_0x54ccb4(0xb6),_0x223da7=_0x54ccb4(0xf2));_0x4b1762===_0x54ccb4(0x108)&&(_0x25c441=_0x54ccb4(0xf7),_0x1ff5de=_0x47041c,_0x222336=_0x22266a,_0x163e1e='alipay.trade.app.pay',_0x223da7=_0x54ccb4(0xb3));const _0x53b90f=new AlipaySdk({'appId':_0x1ff5de,'keyType':'PKCS1','privateKey':_0x222336,'alipayPublicKey':_0xd7c3d5});_0x5042d1['setNotifyUrl']=_0x42ec82,_0x5042d1['bizContent']['product_code']=_0x223da7;const _0x9e474=await _0x53b90f[_0x25c441](_0x163e1e,_0x5042d1);return console[_0x54ccb4(0xed)]('alipay\x20result:\x20',_0x9e474),_0x4b1762===_0x54ccb4(0xd9)?{'form':_0x9e474}:{'data':_0x9e474};}async['queryAliPay'](_0x2eb849,_0x5104c7){const _0x55f9de=_0x1509e6;let _0x5c6e62,_0x58bf58;const {payAliPublicSecret:_0xb33f6d,payAliWebAppId:_0x3a1f6e,payAliWebSecret:_0x4552bd,payAliAppAppId:_0x279387,payAliAppSecret:_0x371288,payWeChatNotifyUrl:_0xc676f8}=await this[_0x55f9de(0x6c)][_0x55f9de(0x10f)](['payAliPublicSecret',_0x55f9de(0x120),_0x55f9de(0x125),_0x55f9de(0xb8),_0x55f9de(0x87),'payWeChatNotifyUrl']);_0x5104c7==='native'&&(_0x5c6e62=_0x3a1f6e,_0x58bf58=_0x4552bd);_0x5104c7===_0x55f9de(0x108)&&(_0x5c6e62=_0x279387,_0x58bf58=_0x371288);const _0x262a24=new AlipaySdk({'appId':_0x5c6e62,'keyType':'PKCS1','privateKey':_0x58bf58,'alipayPublicKey':_0xb33f6d}),_0x4ef515=await _0x262a24[_0x55f9de(0xc2)](_0x55f9de(0x12d),{'bizContent':{'out_trade_no':_0x2eb849}});return console[_0x55f9de(0xed)](_0x4ef515),_0x4ef515;}async[_0x1509e6(0xa3)](_0x40cdf4,_0x352496,_0xfc5ad9=_0x1509e6(0xd9)){const _0x45e8f9=_0x1509e6;console[_0x45e8f9(0xed)]('payType:\x20',_0xfc5ad9);const _0x4d5eda=await this[_0x45e8f9(0xaa)][_0x45e8f9(0x85)]({'where':{'userId':_0x40cdf4,'orderId':_0x352496}});if(!_0x4d5eda)throw new common_1[(_0x45e8f9(0xdc))]('订单不存在!',common_1['HttpStatus']['BAD_REQUEST']);const _0x3c3024=await this['cramiPackageEntity']['findOne']({'where':{'id':_0x4d5eda['goodsId']}});if(!_0x3c3024)throw new common_1[(_0x45e8f9(0xdc))]('套餐不存在!',common_1[_0x45e8f9(0x6d)][_0x45e8f9(0x8a)]);const {payWeChatAppId:_0x55b619,payWeMiniAppId:_0x53564c,payWeChatMchId:_0xec4285,payWeChatPublicKey:_0xf36933,payWeChatPrivateKey:_0x37016f,payWeChatNotifyUrl:_0x5b227d,payWeChatH5Name:_0x1807a2,payWeChatH5Url:_0x565d20,WE_APP_APPID:_0x58fb62,WE_APP_APPSECRET:_0x1d3265}=await this[_0x45e8f9(0x6c)]['getConfigByKeys']([_0x45e8f9(0x68),_0x45e8f9(0xc0),_0x45e8f9(0xfc),'payWeChatPublicKey',_0x45e8f9(0x9c),_0x45e8f9(0xef),_0x45e8f9(0x96),'payWeChatH5Url','WE_APP_APPID']),_0x487878=new WxPay({'appid':_0xfc5ad9===_0x45e8f9(0xf8)?_0x53564c:_0x55b619,'mchid':_0xec4285,'publicKey':_0xf36933,'privateKey':_0x37016f}),_0x246dfc={'appid':_0xfc5ad9===_0x45e8f9(0xf8)?_0x53564c:_0x55b619,'mchid':_0xec4285,'description':_0x3c3024[_0x45e8f9(0xab)],'out_trade_no':_0x352496,'notify_url':_0x5b227d,'amount':{'total':Number(_0x4d5eda[_0x45e8f9(0xe7)]*0x64)},'scene_info':{'payer_client_ip':_0x45e8f9(0x124)}};console[_0x45e8f9(0xed)]('wechat-pay:\x20',_0x246dfc);if(_0xfc5ad9=='h5'){_0x246dfc['scene_info'][_0x45e8f9(0x99)]={'type':_0x45e8f9(0xa8),'app_name':_0x1807a2,'app_url':_0x565d20};const _0xe8086c=await _0x487878[_0x45e8f9(0x100)](_0x246dfc);if(_0xe8086c[_0x45e8f9(0x11f)]===0x193){const _0x2387be=_0xe8086c?.[_0x45e8f9(0x10d)]?.['response']?.[_0x45e8f9(0x97)]?.['message'];throw new common_1['HttpException'](_0xe8086c?.[_0x45e8f9(0x70)]||_0x45e8f9(0x71),common_1[_0x45e8f9(0x6d)][_0x45e8f9(0x8a)]);}const {h5_url:_0x15b244}=_0xe8086c;return{'url':_0x15b244};}if(_0xfc5ad9===_0x45e8f9(0x108)){_0x246dfc['appid']=_0x58fb62;const _0x5ac5f6=await _0x487878[_0x45e8f9(0x12f)](_0x246dfc);return console['log'](_0x45e8f9(0x88),_0x5ac5f6),_0x5ac5f6;}if(_0xfc5ad9==_0x45e8f9(0xf8)){const _0x41d721=await this[_0x45e8f9(0x75)][_0x45e8f9(0xf4)](_0x40cdf4);_0x246dfc[_0x45e8f9(0x90)]={'openid':_0x41d721};const _0x2ac7db=await _0x487878[_0x45e8f9(0xdf)](_0x246dfc);return console[_0x45e8f9(0xed)](_0x45e8f9(0x6a),_0x2ac7db),_0x2ac7db;}if(_0xfc5ad9=='jsapi'){const _0x2195f0=await this[_0x45e8f9(0x75)][_0x45e8f9(0x79)](_0x40cdf4);console[_0x45e8f9(0xed)](_0x45e8f9(0x119),_0x2195f0),_0x246dfc[_0x45e8f9(0x90)]={'openid':_0x2195f0};const _0x1080e9=await _0x487878['transactions_jsapi'](_0x246dfc);return console['log'](_0x45e8f9(0x6a),_0x1080e9),_0x1080e9;}if(_0xfc5ad9=='native'){const _0x53c83b=await _0x487878[_0x45e8f9(0xfb)](_0x246dfc),{code_url:_0x38dd6e}=_0x53c83b;return!_0x38dd6e&&console['log'](_0x45e8f9(0xbb),_0x53c83b),{'url_qrcode':_0x38dd6e,'isRedirect':![]};}throw new common_1[(_0x45e8f9(0xdc))]('unsupported\x20pay\x20type',common_1[_0x45e8f9(0x6d)]['BAD_REQUEST']);}async[_0x1509e6(0x12c)](_0x247af0,_0x213e14){const _0x20f6c7=_0x1509e6,{payWeChatAppId:_0x300461,payWeMiniAppId:_0x2c6612,payWeChatMchId:_0x41354b,payWeChatPublicKey:_0x36fc28,payWeChatPrivateKey:_0x520281}=await this[_0x20f6c7(0x6c)][_0x20f6c7(0x10f)]([_0x20f6c7(0x68),_0x20f6c7(0xc0),_0x20f6c7(0xfc),'payWeChatPublicKey',_0x20f6c7(0x9c)]),_0x1c161a=new WxPay({'appid':_0x213e14==='mini'?_0x2c6612:_0x300461,'mchid':_0x41354b,'publicKey':_0x36fc28,'privateKey':_0x520281}),_0x4ecd7d=await _0x1c161a[_0x20f6c7(0x104)]({'out_trade_no':_0x247af0});return _0x4ecd7d;}async[_0x1509e6(0xa4)](_0x76ae3e){const _0x5b845d=_0x1509e6;_0x76ae3e['payPlatform']===_0x5b845d(0x130)&&await this[_0x5b845d(0xf3)](_0x76ae3e);}async[_0x1509e6(0xf3)](_0x3d5bd0){const _0x6d17d1=_0x1509e6,{payWeChatAppId:_0x511dba,payWeMiniAppId:_0x40ac7c,payWeChatMchId:_0x2bdd9f,payWeChatPublicKey:_0x335405,payWeChatPrivateKey:_0x1ae8cc}=await this[_0x6d17d1(0x6c)]['getConfigByKeys']([_0x6d17d1(0x68),_0x6d17d1(0xc0),_0x6d17d1(0xfc),'payWeChatPublicKey',_0x6d17d1(0x9c),_0x6d17d1(0xef),'payWeChatH5Name','payWeChatH5Url']),_0x4d613e=new WxPay({'appid':_0x3d5bd0[_0x6d17d1(0xd3)]===_0x6d17d1(0xf8)?_0x40ac7c:_0x511dba,'mchid':_0x2bdd9f,'publicKey':_0x335405,'privateKey':_0x1ae8cc});await _0x4d613e[_0x6d17d1(0x89)](_0x3d5bd0[_0x6d17d1(0xbd)]);}[_0x1509e6(0x11a)](_0x399a76,_0x52c827){const _0x59d18b=_0x1509e6,_0x98152=Object[_0x59d18b(0xa9)](_0x399a76)[_0x59d18b(0xbf)]()[_0x59d18b(0xad)](_0x2c7846=>_0x2c7846+'='+_0x399a76[_0x2c7846])[_0x59d18b(0x8c)]('&')+_0x52c827;return crypto['createHash']('md5')[_0x59d18b(0x94)](_0x98152)[_0x59d18b(0x8e)](_0x59d18b(0xf5));}};PayService=__decorate([(0x0,common_1[_0x1509e6(0xda)])(),__param(0x0,(0x0,typeorm_1[_0x1509e6(0xe3)])(cramiPackage_entity_1[_0x1509e6(0xb1)])),__param(0x1,(0x0,typeorm_1['InjectRepository'])(order_entity_1[_0x1509e6(0x6b)])),__metadata(_0x1509e6(0xde),[typeorm_2[_0x1509e6(0x127)],typeorm_2['Repository'],userBalance_service_1[_0x1509e6(0xfd)],globalConfig_service_1[_0x1509e6(0x91)],user_service_1[_0x1509e6(0x73)],redisCache_service_1[_0x1509e6(0x111)],typeorm_2['Connection']])],PayService),exports[_0x1509e6(0x131)]=PayService;