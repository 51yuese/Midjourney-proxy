'use strict';const _0x192ab9=_0x2f75;(function(_0x2620ac,_0x2dd8fc){const _0xe17ad8=_0x2f75,_0x32d4fa=_0x2620ac();while(!![]){try{const _0x4e91d0=parseInt(_0xe17ad8(0x9f))/0x1+-parseInt(_0xe17ad8(0x8d))/0x2*(parseInt(_0xe17ad8(0xb4))/0x3)+-parseInt(_0xe17ad8(0xad))/0x4+-parseInt(_0xe17ad8(0xa0))/0x5*(-parseInt(_0xe17ad8(0xc8))/0x6)+parseInt(_0xe17ad8(0xbb))/0x7+parseInt(_0xe17ad8(0x90))/0x8+parseInt(_0xe17ad8(0xb1))/0x9*(parseInt(_0xe17ad8(0x92))/0xa);if(_0x4e91d0===_0x2dd8fc)break;else _0x32d4fa['push'](_0x32d4fa['shift']());}catch(_0x459159){_0x32d4fa['push'](_0x32d4fa['shift']());}}}(_0x2f37,0xaa616));function _0x2f37(){const _0x4125f8=['sendPhoneCode','length','2017-05-25','1730880NBrbVO','createdAt','verifyCode','@nestjs/typeorm','5415993uUoBqJ','findOne','BAD_REQUEST','3lOTieC','../../common/utils','确实必要参数错误！','object','stringify','Code','__decorate','3348023ATzvrO','DESC','redisCacheService','request','S内不得重新发送','USED','defineProperty','HttpException','验证码发送失败！','../../common/constants/status.constant','Repository','../redisCache/redisCache.service','__param','687606INlBBE','Injectable','当前验证码已被使用！','getTime','verifycationEntity','function','1330878ZziOsJ','@alicloud/pop-core','globalConfigService','2797472oZFSaV','验证码不存在','10qjZdol','@nestjs/common','update','Message','HttpStatus','createVerification','now','VerificationUseStatusEnum','verifyCaptcha','getOwnPropertyDescriptor','验证码错误','VerificationService','createRandomCode','251686VsqVPT','5rKzcvH','RedisCacheService','code','used','decorate','图形验证码已过期、请重新输入!','metadata','del','ceil',':CAPTCHA:'];_0x2f37=function(){return _0x4125f8;};return _0x2f37();}function _0x2f75(_0x445c4b,_0x39ff43){const _0x2f37ae=_0x2f37();return _0x2f75=function(_0x2f754a,_0xfe54a5){_0x2f754a=_0x2f754a-0x8c;let _0x8f71d2=_0x2f37ae[_0x2f754a];return _0x8f71d2;},_0x2f75(_0x445c4b,_0x39ff43);}var __decorate=this&&this[_0x192ab9(0xba)]||function(_0x1db826,_0xfb046f,_0x12e069,_0x15ee7a){const _0x3fd42d=_0x192ab9;var _0x21d3e5=arguments[_0x3fd42d(0xab)],_0x38e46c=_0x21d3e5<0x3?_0xfb046f:_0x15ee7a===null?_0x15ee7a=Object[_0x3fd42d(0x9b)](_0xfb046f,_0x12e069):_0x15ee7a,_0x1b3e69;if(typeof Reflect===_0x3fd42d(0xb7)&&typeof Reflect[_0x3fd42d(0xa4)]===_0x3fd42d(0x8c))_0x38e46c=Reflect[_0x3fd42d(0xa4)](_0x1db826,_0xfb046f,_0x12e069,_0x15ee7a);else{for(var _0x119d94=_0x1db826[_0x3fd42d(0xab)]-0x1;_0x119d94>=0x0;_0x119d94--)if(_0x1b3e69=_0x1db826[_0x119d94])_0x38e46c=(_0x21d3e5<0x3?_0x1b3e69(_0x38e46c):_0x21d3e5>0x3?_0x1b3e69(_0xfb046f,_0x12e069,_0x38e46c):_0x1b3e69(_0xfb046f,_0x12e069))||_0x38e46c;}return _0x21d3e5>0x3&&_0x38e46c&&Object['defineProperty'](_0xfb046f,_0x12e069,_0x38e46c),_0x38e46c;},__metadata=this&&this['__metadata']||function(_0x5a7761,_0x17296e){const _0x32f5e8=_0x192ab9;if(typeof Reflect===_0x32f5e8(0xb7)&&typeof Reflect[_0x32f5e8(0xa6)]===_0x32f5e8(0x8c))return Reflect[_0x32f5e8(0xa6)](_0x5a7761,_0x17296e);},__param=this&&this[_0x192ab9(0xc7)]||function(_0x22de13,_0x31f178){return function(_0x886b71,_0x1b747a){_0x31f178(_0x886b71,_0x1b747a,_0x22de13);};};Object[_0x192ab9(0xc1)](exports,'__esModule',{'value':!![]}),exports[_0x192ab9(0x9d)]=void 0x0;const globalConfig_service_1=require('../globalConfig/globalConfig.service'),status_constant_1=require(_0x192ab9(0xc4)),typeorm_1=require(_0x192ab9(0xb0)),typeorm_2=require('typeorm'),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x192ab9(0x93)),utils_1=require(_0x192ab9(0xb5)),redisCache_service_1=require(_0x192ab9(0xc6)),Core=require(_0x192ab9(0x8e));let VerificationService=class VerificationService{constructor(_0x51e210,_0x43e393,_0x3da635){const _0x393b9f=_0x192ab9;this[_0x393b9f(0xcc)]=_0x51e210,this['globalConfigService']=_0x43e393,this[_0x393b9f(0xbd)]=_0x3da635;}async[_0x192ab9(0x97)](_0x4b4da7,_0x13d6b8,_0x23663d=0x1e*0x3c){const _0x5cd8b4=_0x192ab9,_0x4920d1=await this['verifycationEntity'][_0x5cd8b4(0xb2)]({'where':{'userId':_0x4b4da7['id'],'type':_0x13d6b8},'order':{'createdAt':_0x5cd8b4(0xbc)}});if(_0x4920d1&&_0x4920d1[_0x5cd8b4(0xae)][_0x5cd8b4(0xcb)]()+0x1*0x3c*0x3e8>Date[_0x5cd8b4(0x98)]()){const _0x4efd68=Math[_0x5cd8b4(0xa8)]((_0x4920d1[_0x5cd8b4(0xae)]['getTime']()+0x1*0x3c*0x3e8-Date['now']())/0x3e8);throw new common_1[(_0x5cd8b4(0xc2))](_0x4efd68+_0x5cd8b4(0xbf),common_1['HttpStatus'][_0x5cd8b4(0xb3)]);}const _0x5e9c07=(0x0,utils_1[_0x5cd8b4(0x9e)])(),_0x1e3773=new Date(Date[_0x5cd8b4(0x98)]()+_0x23663d*0x3e8),{id:_0x223289,email:_0x5cbba9}=_0x4b4da7,_0x163299={'userId':_0x223289,'type':_0x13d6b8,'code':_0x5e9c07,'expiresAt':_0x1e3773,'email':_0x5cbba9};return await this['verifycationEntity']['save'](_0x163299);}async[_0x192ab9(0xaf)]({code:_0x3e5d10,id:_0x1d4e54},_0x5373b1){const _0x3b64b8=_0x192ab9,_0x54c300=await this['verifycationEntity']['findOne']({'where':{'id':_0x1d4e54,'type':_0x5373b1},'order':{'createdAt':_0x3b64b8(0xbc)}});if(!_0x54c300)throw new common_1[(_0x3b64b8(0xc2))](_0x3b64b8(0x91),common_1[_0x3b64b8(0x96)]['BAD_REQUEST']);if(_0x54c300[_0x3b64b8(0xa3)]===status_constant_1['VerificationUseStatusEnum'][_0x3b64b8(0xc0)])throw new common_1[(_0x3b64b8(0xc2))](_0x3b64b8(0xca),common_1['HttpStatus'][_0x3b64b8(0xb3)]);else _0x54c300[_0x3b64b8(0xa3)]=status_constant_1[_0x3b64b8(0x99)][_0x3b64b8(0xc0)],await this[_0x3b64b8(0xcc)][_0x3b64b8(0x94)]({'id':_0x1d4e54},_0x54c300);if(Number(_0x54c300[_0x3b64b8(0xa2)])!==Number(_0x3e5d10))throw new common_1[(_0x3b64b8(0xc2))](_0x3b64b8(0x9c),common_1['HttpStatus'][_0x3b64b8(0xb3)]);if(_0x54c300['expiresAt']<new Date())throw new common_1['HttpException']('验证码已过期',common_1[_0x3b64b8(0x96)][_0x3b64b8(0xb3)]);return _0x54c300;}async[_0x192ab9(0x9a)](_0x317f2e){const _0x3cb8b5=_0x192ab9,{captchaId:_0x3900a5,captchaCode:_0x170169}=_0x317f2e,_0x4c5600=await this[_0x3cb8b5(0x8f)]['getNamespace'](),_0x754bec=_0x4c5600+_0x3cb8b5(0xa9)+_0x3900a5,_0x43815e=await this[_0x3cb8b5(0xbd)]['get']({'key':_0x754bec});await this['redisCacheService'][_0x3cb8b5(0xa7)]({'key':_0x754bec});if(!_0x43815e)throw new common_1[(_0x3cb8b5(0xc2))](_0x3cb8b5(0xa5),common_1[_0x3cb8b5(0x96)][_0x3cb8b5(0xb3)]);if(!_0x43815e||_0x43815e!==_0x170169)throw new common_1[(_0x3cb8b5(0xc2))]('图形验证码错误、请检查填写!',common_1[_0x3cb8b5(0x96)][_0x3cb8b5(0xb3)]);}async[_0x192ab9(0xaa)](_0x3cbd77){const _0x998b0d=_0x192ab9,{accessKeyId:_0xf35e5f,accessKeySecret:_0x241b6b,SignName:_0x5218e2,TemplateCode:_0x50e9ba}=await this[_0x998b0d(0x8f)]['getPhoneVerifyConfig'](),{phone:_0xf98055,code:_0x5c9a7a}=_0x3cbd77;if(!_0xf98055||!_0x5c9a7a)throw new common_1[(_0x998b0d(0xc2))](_0x998b0d(0xb6),common_1['HttpStatus'][_0x998b0d(0xb3)]);const _0x2ed87e=new Core({'accessKeyId':_0xf35e5f,'accessKeySecret':_0x241b6b,'endpoint':'https://dysmsapi.aliyuncs.com','apiVersion':_0x998b0d(0xac)}),_0x213ea2={'PhoneNumbers':_0xf98055,'SignName':_0x5218e2,'TemplateCode':_0x50e9ba,'TemplateParam':JSON[_0x998b0d(0xb8)]({'code':_0x5c9a7a})},_0x169070={'method':'POST','formatParams':![]};try{const _0x10dfab=await _0x2ed87e[_0x998b0d(0xbe)]('SendSms',_0x213ea2,_0x169070);if(_0x10dfab[_0x998b0d(0xb9)]==='OK')return!![];else throw new common_1[(_0x998b0d(0xc2))](_0x10dfab[_0x998b0d(0x95)]||_0x998b0d(0xc3),common_1['HttpStatus']['BAD_REQUEST']);}catch(_0x25e11f){throw new common_1[(_0x998b0d(0xc2))](_0x25e11f?.['data']?.[_0x998b0d(0x95)]||_0x998b0d(0xc3),common_1['HttpStatus'][_0x998b0d(0xb3)]);}}};VerificationService=__decorate([(0x0,common_1[_0x192ab9(0xc9)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(verifycation_entity_1['VerifycationEntity'])),__metadata('design:paramtypes',[typeorm_2[_0x192ab9(0xc5)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x192ab9(0xa1)]])],VerificationService),exports[_0x192ab9(0x9d)]=VerificationService;