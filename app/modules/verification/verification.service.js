'use strict';function _0x17a5(){const _0x311137=['@alicloud/pop-core','25052iNfdpH','../globalConfig/globalConfig.service','Repository','HttpStatus','VerifycationEntity','stringify','verifyCode','Message','图形验证码错误、请检查填写!','@nestjs/typeorm','length','USED','9QYpvbw','globalConfigService','now','../redisCache/redisCache.service','InjectRepository','decorate','BAD_REQUEST','../../common/utils','2266090LldoTC','https://dysmsapi.aliyuncs.com','1DyDbdV','13057220FOgytO','metadata','redisCacheService','verifycationEntity','code','27XiVmly','DESC','createRandomCode','object','used','2017-05-25','getOwnPropertyDescriptor','get','12xSBFdx','request','createdAt','@nestjs/common','HttpException','VerificationService','findOne','sendPhoneCode','RedisCacheService','S内不得重新发送','POST','87328JzgGRh','getPhoneVerifyConfig','function','验证码已过期','验证码发送失败！','__param','验证码不存在','getTime','expiresAt','__metadata','design:paramtypes','defineProperty','63HRhfUw','update','4090440trmwQy','验证码错误',':CAPTCHA:','1011448BALuYF','555885Nblqgr','ceil','save','VerificationUseStatusEnum','Injectable','Code','verifyCaptcha'];_0x17a5=function(){return _0x311137;};return _0x17a5();}function _0x1730(_0x4e277e,_0x145c56){const _0x17a5c5=_0x17a5();return _0x1730=function(_0x1730ab,_0x204ceb){_0x1730ab=_0x1730ab-0x1ef;let _0x85dea1=_0x17a5c5[_0x1730ab];return _0x85dea1;},_0x1730(_0x4e277e,_0x145c56);}const _0x3bbe12=_0x1730;(function(_0x3eeb93,_0x42ce68){const _0x2fa539=_0x1730,_0xcaf3b9=_0x3eeb93();while(!![]){try{const _0x163ed7=-parseInt(_0x2fa539(0x1f5))/0x1*(parseInt(_0x2fa539(0x21f))/0x2)+-parseInt(_0x2fa539(0x1fb))/0x3*(parseInt(_0x2fa539(0x228))/0x4)+parseInt(_0x2fa539(0x220))/0x5+-parseInt(_0x2fa539(0x21c))/0x6+parseInt(_0x2fa539(0x21a))/0x7*(parseInt(_0x2fa539(0x20e))/0x8)+-parseInt(_0x2fa539(0x234))/0x9*(-parseInt(_0x2fa539(0x1f3))/0xa)+-parseInt(_0x2fa539(0x1f6))/0xb*(-parseInt(_0x2fa539(0x203))/0xc);if(_0x163ed7===_0x42ce68)break;else _0xcaf3b9['push'](_0xcaf3b9['shift']());}catch(_0x23b86e){_0xcaf3b9['push'](_0xcaf3b9['shift']());}}}(_0x17a5,0x5c953));var __decorate=this&&this['__decorate']||function(_0x234a21,_0x449602,_0x4f24a5,_0x212d50){const _0x5defeb=_0x1730;var _0x5f2363=arguments[_0x5defeb(0x232)],_0x4467a5=_0x5f2363<0x3?_0x449602:_0x212d50===null?_0x212d50=Object[_0x5defeb(0x201)](_0x449602,_0x4f24a5):_0x212d50,_0x16fe46;if(typeof Reflect===_0x5defeb(0x1fe)&&typeof Reflect[_0x5defeb(0x1f0)]==='function')_0x4467a5=Reflect[_0x5defeb(0x1f0)](_0x234a21,_0x449602,_0x4f24a5,_0x212d50);else{for(var _0x4e6c71=_0x234a21[_0x5defeb(0x232)]-0x1;_0x4e6c71>=0x0;_0x4e6c71--)if(_0x16fe46=_0x234a21[_0x4e6c71])_0x4467a5=(_0x5f2363<0x3?_0x16fe46(_0x4467a5):_0x5f2363>0x3?_0x16fe46(_0x449602,_0x4f24a5,_0x4467a5):_0x16fe46(_0x449602,_0x4f24a5))||_0x4467a5;}return _0x5f2363>0x3&&_0x4467a5&&Object[_0x5defeb(0x219)](_0x449602,_0x4f24a5,_0x4467a5),_0x4467a5;},__metadata=this&&this[_0x3bbe12(0x217)]||function(_0x5d4a6a,_0x80e733){const _0x27c0da=_0x3bbe12;if(typeof Reflect===_0x27c0da(0x1fe)&&typeof Reflect['metadata']===_0x27c0da(0x210))return Reflect[_0x27c0da(0x1f7)](_0x5d4a6a,_0x80e733);},__param=this&&this[_0x3bbe12(0x213)]||function(_0x172bfa,_0x4f1005){return function(_0x2c3fb5,_0x4246d6){_0x4f1005(_0x2c3fb5,_0x4246d6,_0x172bfa);};};Object[_0x3bbe12(0x219)](exports,'__esModule',{'value':!![]}),exports[_0x3bbe12(0x208)]=void 0x0;const globalConfig_service_1=require(_0x3bbe12(0x229)),status_constant_1=require('../../common/constants/status.constant'),typeorm_1=require(_0x3bbe12(0x231)),typeorm_2=require('typeorm'),verifycation_entity_1=require('./verifycation.entity'),common_1=require(_0x3bbe12(0x206)),utils_1=require(_0x3bbe12(0x1f2)),redisCache_service_1=require(_0x3bbe12(0x237)),Core=require(_0x3bbe12(0x227));let VerificationService=class VerificationService{constructor(_0x2a3974,_0x4c0ccf,_0x1b5e0c){const _0x5c5b79=_0x3bbe12;this[_0x5c5b79(0x1f9)]=_0x2a3974,this[_0x5c5b79(0x235)]=_0x4c0ccf,this['redisCacheService']=_0x1b5e0c;}async['createVerification'](_0x330094,_0x3d677d,_0x4153ff=0x1e*0x3c){const _0x475635=_0x3bbe12,_0x41bf19=await this[_0x475635(0x1f9)]['findOne']({'where':{'userId':_0x330094['id'],'type':_0x3d677d},'order':{'createdAt':_0x475635(0x1fc)}});if(_0x41bf19&&_0x41bf19[_0x475635(0x205)][_0x475635(0x215)]()+0x1*0x3c*0x3e8>Date['now']()){const _0xbb9b65=Math[_0x475635(0x221)]((_0x41bf19[_0x475635(0x205)][_0x475635(0x215)]()+0x1*0x3c*0x3e8-Date[_0x475635(0x236)]())/0x3e8);throw new common_1[(_0x475635(0x207))](_0xbb9b65+_0x475635(0x20c),common_1['HttpStatus']['BAD_REQUEST']);}const _0x284341=(0x0,utils_1[_0x475635(0x1fd)])(),_0x4b426e=new Date(Date['now']()+_0x4153ff*0x3e8),{id:_0x542db7,email:_0x339035}=_0x330094,_0xdadd33={'userId':_0x542db7,'type':_0x3d677d,'code':_0x284341,'expiresAt':_0x4b426e,'email':_0x339035};return await this[_0x475635(0x1f9)][_0x475635(0x222)](_0xdadd33);}async[_0x3bbe12(0x22e)]({code:_0x2be102,id:_0x14cbb7},_0x10c666){const _0x314007=_0x3bbe12,_0x42d662=await this['verifycationEntity'][_0x314007(0x209)]({'where':{'id':_0x14cbb7,'type':_0x10c666},'order':{'createdAt':_0x314007(0x1fc)}});if(!_0x42d662)throw new common_1[(_0x314007(0x207))](_0x314007(0x214),common_1[_0x314007(0x22b)][_0x314007(0x1f1)]);if(_0x42d662[_0x314007(0x1ff)]===status_constant_1[_0x314007(0x223)][_0x314007(0x233)])throw new common_1[(_0x314007(0x207))]('当前验证码已被使用！',common_1['HttpStatus']['BAD_REQUEST']);else _0x42d662[_0x314007(0x1ff)]=status_constant_1[_0x314007(0x223)][_0x314007(0x233)],await this['verifycationEntity'][_0x314007(0x21b)]({'id':_0x14cbb7},_0x42d662);if(Number(_0x42d662[_0x314007(0x1fa)])!==Number(_0x2be102))throw new common_1[(_0x314007(0x207))](_0x314007(0x21d),common_1['HttpStatus']['BAD_REQUEST']);if(_0x42d662[_0x314007(0x216)]<new Date())throw new common_1[(_0x314007(0x207))](_0x314007(0x211),common_1[_0x314007(0x22b)]['BAD_REQUEST']);return _0x42d662;}async[_0x3bbe12(0x226)](_0x11d1e4){const _0xb1de20=_0x3bbe12,{captchaId:_0x3dd219,captchaCode:_0x1922c5}=_0x11d1e4,_0x1750c6=await this[_0xb1de20(0x235)]['getNamespace'](),_0x4527f9=_0x1750c6+_0xb1de20(0x21e)+_0x3dd219,_0x39e328=await this[_0xb1de20(0x1f8)][_0xb1de20(0x202)]({'key':_0x4527f9});await this['redisCacheService']['del']({'key':_0x4527f9});if(!_0x39e328)throw new common_1[(_0xb1de20(0x207))]('图形验证码已过期、请重新输入!',common_1[_0xb1de20(0x22b)][_0xb1de20(0x1f1)]);if(!_0x39e328||_0x39e328!==_0x1922c5)throw new common_1[(_0xb1de20(0x207))](_0xb1de20(0x230),common_1[_0xb1de20(0x22b)][_0xb1de20(0x1f1)]);}async[_0x3bbe12(0x20a)](_0x3ba9eb){const _0x580246=_0x3bbe12,{accessKeyId:_0x4e7199,accessKeySecret:_0x5037b2,SignName:_0x593a70,TemplateCode:_0x39d46d}=await this[_0x580246(0x235)][_0x580246(0x20f)](),{phone:_0x4a3eb1,code:_0x41fa9f}=_0x3ba9eb;if(!_0x4a3eb1||!_0x41fa9f)throw new common_1[(_0x580246(0x207))]('确实必要参数错误！',common_1['HttpStatus'][_0x580246(0x1f1)]);const _0x14b683=new Core({'accessKeyId':_0x4e7199,'accessKeySecret':_0x5037b2,'endpoint':_0x580246(0x1f4),'apiVersion':_0x580246(0x200)}),_0x44a69e={'PhoneNumbers':_0x4a3eb1,'SignName':_0x593a70,'TemplateCode':_0x39d46d,'TemplateParam':JSON[_0x580246(0x22d)]({'code':_0x41fa9f})},_0x541862={'method':_0x580246(0x20d),'formatParams':![]};try{const _0x2ceb32=await _0x14b683[_0x580246(0x204)]('SendSms',_0x44a69e,_0x541862);if(_0x2ceb32[_0x580246(0x225)]==='OK')return!![];else throw new common_1[(_0x580246(0x207))](_0x2ceb32[_0x580246(0x22f)]||_0x580246(0x212),common_1[_0x580246(0x22b)]['BAD_REQUEST']);}catch(_0x1a822d){throw new common_1['HttpException'](_0x1a822d?.['data']?.[_0x580246(0x22f)]||_0x580246(0x212),common_1[_0x580246(0x22b)]['BAD_REQUEST']);}}};VerificationService=__decorate([(0x0,common_1[_0x3bbe12(0x224)])(),__param(0x0,(0x0,typeorm_1[_0x3bbe12(0x1ef)])(verifycation_entity_1[_0x3bbe12(0x22c)])),__metadata(_0x3bbe12(0x218),[typeorm_2[_0x3bbe12(0x22a)],globalConfig_service_1['GlobalConfigService'],redisCache_service_1[_0x3bbe12(0x20b)]])],VerificationService),exports['VerificationService']=VerificationService;