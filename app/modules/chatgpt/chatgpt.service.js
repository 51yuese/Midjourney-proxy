'use strict';const _0x659525=_0x3732;(function(_0x4407c1,_0x54b182){const _0xbf5223=_0x3732,_0x3aa3fc=_0x4407c1();while(!![]){try{const _0x6f0ca=parseInt(_0xbf5223(0x179))/0x1+-parseInt(_0xbf5223(0x1c1))/0x2+-parseInt(_0xbf5223(0x1bb))/0x3*(parseInt(_0xbf5223(0x13c))/0x4)+parseInt(_0xbf5223(0x18d))/0x5*(parseInt(_0xbf5223(0x130))/0x6)+-parseInt(_0xbf5223(0x225))/0x7+-parseInt(_0xbf5223(0x229))/0x8*(parseInt(_0xbf5223(0x23c))/0x9)+-parseInt(_0xbf5223(0x202))/0xa*(-parseInt(_0xbf5223(0x21b))/0xb);if(_0x6f0ca===_0x54b182)break;else _0x3aa3fc['push'](_0x3aa3fc['shift']());}catch(_0x421f57){_0x3aa3fc['push'](_0x3aa3fc['shift']());}}}(_0x495d,0x7f6ab));function _0x3732(_0x2179a2,_0x5a69e7){const _0x495d54=_0x495d();return _0x3732=function(_0x37321c,_0x45ebc5){_0x37321c=_0x37321c-0xf5;let _0x4a0534=_0x495d54[_0x37321c];return _0x4a0534;},_0x3732(_0x2179a2,_0x5a69e7);}var __decorate=this&&this[_0x659525(0x195)]||function(_0x253cce,_0x5f3c0d,_0x5db653,_0x48c27f){const _0x4aad48=_0x659525;var _0x5bc099=arguments[_0x4aad48(0x21f)],_0x2d6b30=_0x5bc099<0x3?_0x5f3c0d:_0x48c27f===null?_0x48c27f=Object[_0x4aad48(0x155)](_0x5f3c0d,_0x5db653):_0x48c27f,_0x328703;if(typeof Reflect===_0x4aad48(0x1fb)&&typeof Reflect[_0x4aad48(0x1b8)]===_0x4aad48(0x189))_0x2d6b30=Reflect[_0x4aad48(0x1b8)](_0x253cce,_0x5f3c0d,_0x5db653,_0x48c27f);else{for(var _0x27e3b0=_0x253cce[_0x4aad48(0x21f)]-0x1;_0x27e3b0>=0x0;_0x27e3b0--)if(_0x328703=_0x253cce[_0x27e3b0])_0x2d6b30=(_0x5bc099<0x3?_0x328703(_0x2d6b30):_0x5bc099>0x3?_0x328703(_0x5f3c0d,_0x5db653,_0x2d6b30):_0x328703(_0x5f3c0d,_0x5db653))||_0x2d6b30;}return _0x5bc099>0x3&&_0x2d6b30&&Object['defineProperty'](_0x5f3c0d,_0x5db653,_0x2d6b30),_0x2d6b30;},__metadata=this&&this[_0x659525(0x13e)]||function(_0x411481,_0x1decd6){const _0x53a581=_0x659525;if(typeof Reflect===_0x53a581(0x1fb)&&typeof Reflect[_0x53a581(0x1c3)]===_0x53a581(0x189))return Reflect['metadata'](_0x411481,_0x1decd6);},__param=this&&this[_0x659525(0x11b)]||function(_0x53d485,_0x1867a7){return function(_0x14f104,_0x6d968){_0x1867a7(_0x14f104,_0x6d968,_0x53d485);};};function _0x495d(){const _0x3ce201=['subTitle','gptsService','333333333333333',',\x20make_instrumental\x20','keyType','gpt-3','chat-error','fileService','listAssetsBychatLogIds','你当前使用的应用已被下架、请删除当前对话开启新的对话吧！','本次调用:\x20','123108sWvTjk','string','__metadata','./helper','openaiModel3MaxTokens16k','你是\x20Kimi，由\x20Moonshot\x20AI\x20提供的人工智能助手，你更擅长中文和英文的对话。你会为用户提供安全，有帮助，','doubaoService','debuctBalance4PPT','openaiTimeoutMs','volc_auc_common','当前模型key已被封禁','../../common/constants/errorMessage.constant','secret','Unauthorized','findOne','EChatType','InjectRepository','getModelByType','MUSIC','openAiErrHandler','isSuper','EModelType','FileService','phone','completionTokens','getOwnPropertyDescriptor','/v1','slideNumber','checkBadWords','images_url','email','openaiModel3MaxTokensRes','removeFile','prompt\x20','This\x20is\x20not\x20a\x20chat\x20model\x20and\x20thus\x20not\x20supported','stringify','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.del_flag\x20=\x200\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','promptTokens','count','from','syncLumaTask','STRUCTURE','school','kimiUpload','map','PPT','绘制图片失败，请稍后试试吧！','\x20OFFSET\x20','extend','400\x20error','模型秘钥错误或模型金额不足，请联系管理员！','pptStructure','pathname','chatVideo','default','test','video-task','arrayBuffer','floor','content','Bearer\x20','395705QYIMHB',',\x20tags\x20','chatMusic','slideType','音乐生成失败，没有响应','schoolLogo','Injectable','end','当前流程所需要的模型已被管理员下架、请联系管理员上架专属模型！','parentMessageId','update','ADDNOTES','unlink','preset','sendMessageFromZhipu','saveUseLog','function','baseURL','env','transition','40GgGQgr','abortController','[耗时打印]文字对话耗时：','importDynamic','statusCode','configDoubaoApi','systemMessage','./store','__decorate','process_url','autoreplyService','Bearer;','complex','ADDPAGE','../api/yooPPT.service','removeSpecialCharacters','createReadStream','mergedOptions','getModelConfig','text','Incorrect\x20API\x20key\x20provided','RECOVER','getCurrentModelByChatGroupId','slice','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.email\x20LIKE\x20(\x27%','originTaskId','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','draw\x20paompt\x20info\x20<======*******======>\x20','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.phone\x20LIKE\x20(\x27%','accessToken','openaiModel4MaxTokensRes','musicTask','userService','pptPage',',\x20continue_clip_id\x20','Please\x20check\x20the\x20back-end\x20console','error','openai','lockKey','remove\x20file\x20%s\x20success','save','lumaTaskService','user','decorate','tts-1','REDIS_HOST','87hhubId','usage','\x20key\x20->\x20','buildOptions','FILE','speech','980078toQKEc','AUC7419233800922468658','metadata','AutoreplyService','system','COVER','conversationId','toISOString','includes','author','gpts','catch','saveChatLog',',\x20mv\x20','setHeader','split','../autoreply/autoreply.service','\x0a\x20Respond\x20using\x20markdown.\x20\x0a\x20Current\x20date:\x20','files','close','uploadFile','yooTaskId','pop','completionParams','abs','thirdId','chatRealTime','\x20--expand_prompt\x20','getUuid','appid','modelInfo','getGroupInfoFromId','path','addOneIfOdd','gomaxAiStore','pptReCover','modelsService','BAD_REQUEST','signal','modelId','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username\x20LIKE\x20(\x27%','../chatLog/chatLog.service','title','defaultBaseUrl','./spark','您的请求已被系统拒绝。您的提示可能存在一些非法的文本。','pptCreateFile','deductBalance4Chat','prompt','getClientIp','log','unifiedFormattingResponse','Result','OpenAiErrorCodeMessage','abort','[耗时打印]文字转语音耗时：','created_at','语音转换失败','object','messageStore','\x20model:\x20','./pptTask.entity','transaction','https://yuyin.qumao518.vip/upload/0001-0-45-1727599485154.mp3','role','10vewKEs','response','准确的回答。同时，你会拒绝一切涉及恐怖主义，种族歧视，黄色暴力等问题的回答。Moonshot\x20AI\x20为专有名词，不','status','voiceChat','HttpException','REDIS_USER','@keyv/redis','pptService','style','OTHER','pptCreateThesis','file','remove\x20file\x20','nestjs-cls','data','validateBalance4Chat','chatProcess','transcriptions','chatTask','REDIS_PORT','suno-v3','resolve','语音转文本失败','16k','30213062mmVHya','requestFromGpt','b64_json','typeorm','length','../gpts/gpts.service','内容提取失败','PPTTaskEntity','当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！','delta','7061285GQkCtU','cwd','music-task','coverId','88472PvmFFU','THESIS','The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.','theme','openaiModel3MaxTokens','getConfigByKeys','http','temperature','.mp3','%\x27)\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','VIDEO','schoolPicture','pptCover','create','服务异常、请重新试试吧！！！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(p.id)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','asyncPPTProgress','configKimiApi','progress','315GBuzkl','当前请求已过载、请稍等会儿再试试吧！','config','mp3','finish_reason','pptCreate','buffer','compileNetwork','__esModule','webroot','join','luma-video','\x20image_end_url\x20','../api/lumaTask.service','getReqSaasId','listUndoneVideo','request','axios','HttpStatus','GlobalConfigService','resCover','../../common/constants/ppt.constant','TTS','code','当前模型key余额已耗尽','request\x20gpt\x20','checkAutoReply','未配置语音模型或语音模型key，请配置并启用语音功能！','fileUrl','maskEmail','../chatGroup/chatGroup.service','setData','connection','chat','pptTaskEntity','ids','视频生成失败，没有响应','DeductionKey','modelType','contents','keyv','PAINT_TYPE','push','ChatgptService','\x20AND\x20p.user_id\x20=\x20','BadwordsService','DRAW','tts','chatgpt','../../common/utils','openaiModel3MaxTokens16kRes','configChatGptApi','openaiModel4MaxTokens32kRes','detail','write','chatGroupService','ChatLogService','sendMessageFromXunFei','pageCount','base64','原始任务不存在！','openaiModel4MaxTokens32k','advisor','userId','pptDetail','forEach','result','asr','user_prompt','XunFeiSpark','CHAT_TYPE','gomaxai-chatlog','validateBeforeChat','GOMAXAI_HOST','parseAndSaveMusic','sendMessage','videoTask','endTime','progressUrl','totalTokens','ChatGPTAPI','openai-draw','groupId','key','size','application/octet-stream;\x20charset=utf-8','当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！','existsSync','\x0a\x20\x20\x20\x20\x20\x20','绘制图片失败，此次绘画被拒绝了！','openaiBaseUrl','同步PPT生成任务进度失败！','gomaxai-default-key','getRandomKey','toLowerCase','response.length','badwordsService','ChatGroupService','\x20回复数不得大于等于模型上下文数,\x20已自动调整为\x20maxTokenRes:\x20','未获取到模型基础配置，请前往后台配置并启用','catalogs','initOpenAi','ASR','sendMessageFromBaidu','https://','get','../../common/constants/model.constant','模型秘钥错误或模型余额不足','params','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20u.nickname\x20LIKE\x20(\x27%','REDIS_PASSWORD','可翻译成其他语言。','https://api.moonshot.cn/v1','./baidu','sunoMusicId','notifyAsr','updated_at','page_count','\x20AND\x20(\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title\x20LIKE\x20(\x27%','emit','[耗时打印]保存文件耗时：','pptx_url','buildSystemMessage','set','You\x20exceeded\x20your\x20current\x20quota,\x20please\x20check\x20your\x20plan\x20and\x20billing\x20details.','\x20--aspect_ratio\x20','pptAddPage','fanyi\x20mj-associate','../globalConfig/globalConfig.service','proxyUrl',',\x20模型名称:\x20','chatLogId','startsWith','Speech_Synthesis7418877984234656063','replace','message','api','pptNote','openAi','PAYMENT_REQUIRED','listByGroupId','GptsService','model','32k','[耗时打印]语音转文字耗时：','%\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20p.sub_title\x20LIKE\x20(\x27%','pptChangeTheme','options','answer','./../user/user.service','modelName','once','提供了错误的模型秘钥','THEME','../../common/constants/balance.constant','https://ark.cn-beijing.volces.com','Logger','pleader','pptDel','当前模型不是聊天模型','checkUserStatus','globalConfigService','Content-type','apiBaseUrl','color','formatModelToken','errMsg','audio','conversationOptions','https://api.openai.com','query','type','__param','PPT\x20任务不存在！','assistant','EPPTTaskType','images','../../common/result','../badwords/badwords.service','chatDraw','apiKey','all','fontName','@nestjs/typeorm','./zhipu','systemPreMessage','chatLogService','parseAndSaveVideo','clsService','getTime','CHAT','bad\x20response\x20status\x20code\x20307','creat','118458xwoFMn'];_0x495d=function(){return _0x3ce201;};return _0x495d();}Object['defineProperty'](exports,_0x659525(0x244),{'value':!![]}),exports[_0x659525(0x267)]=void 0x0;const file_service_1=require('../file/file.service'),user_service_1=require(_0x659525(0x104)),openai_1=require(_0x659525(0x1b2)),common_1=require('@nestjs/common'),errorMessage_constant_1=require(_0x659525(0x147)),utils_1=require(_0x659525(0x26d)),axios_1=require(_0x659525(0x24d)),balance_constant_1=require(_0x659525(0x109)),chatLog_service_1=require(_0x659525(0x1ea)),uuid=require('uuid'),fs=require('fs'),typeorm_1=require(_0x659525(0x21e)),typeorm_2=require(_0x659525(0x126)),badwords_service_1=require(_0x659525(0x121)),autoreply_service_1=require(_0x659525(0x1d1)),globalConfig_service_1=require(_0x659525(0x2bc)),chatGroup_service_1=require(_0x659525(0x25a)),models_service_1=require('../models/models.service'),baidu_1=require(_0x659525(0x2ad)),helper_1=require(_0x659525(0x13f)),store_1=require(_0x659525(0x194)),zhipu_1=require(_0x659525(0x127)),spark_1=require(_0x659525(0x1ed)),model_constant_1=require(_0x659525(0x2a6)),fs_1=require('fs'),path_1=require(_0x659525(0x1e1)),gpts_service_1=require(_0x659525(0x220)),yooPPT_service_1=require(_0x659525(0x19b)),pptTask_entity_1=require(_0x659525(0x1fe)),ppt_constant_1=require(_0x659525(0x251)),lumaTask_service_1=require(_0x659525(0x249)),nestjs_cls_1=require(_0x659525(0x210)),doubao_service_1=require('../api/doubao.service'),crypto_1=require('crypto'),chat_constant_1=require('../../common/constants/chat.constant'),result_1=require(_0x659525(0x120));let ChatgptService=class ChatgptService{constructor(_0x190fee,_0x2155c2,_0x7edc1c,_0x3eb2a5,_0x3e7f2d,_0xa1093a,_0x1639b2,_0x4a9454,_0x59ba39,_0x48c292,_0x36384a,_0x5a0681,_0x12f5f9,_0xb50d58,_0x1a48c8){const _0x17b5a8=_0x659525;this['pptTaskEntity']=_0x190fee,this[_0x17b5a8(0x12b)]=_0x2155c2,this[_0x17b5a8(0x1ad)]=_0x7edc1c,this[_0x17b5a8(0x138)]=_0x3eb2a5,this['gptsService']=_0x3e7f2d,this[_0x17b5a8(0x20a)]=_0xa1093a,this[_0x17b5a8(0x142)]=_0x1639b2,this[_0x17b5a8(0x1e5)]=_0x4a9454,this[_0x17b5a8(0x129)]=_0x59ba39,this[_0x17b5a8(0x1b6)]=_0x48c292,this['badwordsService']=_0x36384a,this[_0x17b5a8(0x197)]=_0x5a0681,this[_0x17b5a8(0x273)]=_0x12f5f9,this[_0x17b5a8(0x110)]=_0xb50d58,this['connection']=_0x1a48c8,this[_0x17b5a8(0x1ec)]=_0x17b5a8(0x118),this['messageStore']=null,this[_0x17b5a8(0x1e3)]=null,this[_0x17b5a8(0x15c)]=_0x51a7a0=>{const _0x2c90c3=_0x17b5a8;return fs[_0x2c90c3(0x185)](_0x51a7a0,_0x4dbf3e=>{const _0x3f28cc=_0x2c90c3;_0x4dbf3e?console[_0x3f28cc(0x1f3)](_0x3f28cc(0x20f),_0x4dbf3e):console[_0x3f28cc(0x1f3)](_0x3f28cc(0x1b4),_0x51a7a0);});};}async['onModuleInit'](){const _0x42c3cb=_0x659525;let _0x3090f6=await(0x0,utils_1['importDynamic'])(_0x42c3cb(0x26c));_0x3090f6=_0x3090f6?.[_0x42c3cb(0x172)]?_0x3090f6[_0x42c3cb(0x172)]:_0x3090f6,this[_0x42c3cb(0xf7)]=_0x3090f6[_0x42c3cb(0x28c)];let _0x2a074c=await(0x0,utils_1[_0x42c3cb(0x190)])(_0x42c3cb(0x264));_0x2a074c=_0x2a074c?.['default']?_0x2a074c[_0x42c3cb(0x172)]:_0x2a074c;let _0x54b557=await(0x0,utils_1[_0x42c3cb(0x190)])(_0x42c3cb(0x209));_0x54b557=_0x54b557?.[_0x42c3cb(0x172)]?_0x54b557[_0x42c3cb(0x172)]:_0x54b557;const _0x177f0a=+process[_0x42c3cb(0x18b)][_0x42c3cb(0x216)],_0xe72762=process[_0x42c3cb(0x18b)][_0x42c3cb(0x1ba)],_0x476d34=process['env'][_0x42c3cb(0x2aa)],_0x5b480a=process['env'][_0x42c3cb(0x208)],_0xdc2163='redis://'+(_0x5b480a||'')+':'+(_0x476d34||'')+'@'+_0xe72762+':'+_0x177f0a,_0x5a07fe=new _0x54b557(_0xdc2163);this[_0x42c3cb(0x1fc)]=new _0x2a074c({'store':_0x5a07fe,'namespace':_0x42c3cb(0x283)}),this['gomaxAiStore']=new store_1['NineStore']({'store':this[_0x42c3cb(0x1fc)],'namespace':'chat'}),!this[_0x42c3cb(0xf9)]&&this[_0x42c3cb(0x2a1)]();}[_0x659525(0x2a1)](){const _0x33c9b3=_0x659525;this[_0x33c9b3(0xf9)]=new openai_1[(_0x33c9b3(0x172))]({'apiKey':_0x33c9b3(0x298),'baseURL':this[_0x33c9b3(0x1ec)]+_0x33c9b3(0x156)});}async[_0x659525(0x19f)](_0x46abcc){const _0xddc7e3=_0x659525,{type:_0x4481e2,groupId:_0x241f57,modelType:_0x2bef35}=_0x46abcc;let _0x54e4f9,_0x4a5a1d;_0x4481e2&&_0x4481e2==='gpts'?(_0x4a5a1d=await this[_0xddc7e3(0x132)][_0xddc7e3(0x1e0)](_0x241f57),_0x54e4f9=_0x4a5a1d[_0xddc7e3(0x1e8)]):_0x4a5a1d=await this[_0xddc7e3(0x273)][_0xddc7e3(0x1e0)](_0x241f57);let _0x3c9c0d;if(_0x4a5a1d)_0x3c9c0d=JSON['parse'](_0x4a5a1d[_0xddc7e3(0x23e)]);else _0x2bef35?_0x3c9c0d=await this[_0xddc7e3(0x1e5)]['getModelByType'](_0x2bef35):_0x3c9c0d=await this[_0xddc7e3(0x1e5)][_0xddc7e3(0x14d)](model_constant_1[_0xddc7e3(0x151)][_0xddc7e3(0x20c)]);if(!_0x3c9c0d)throw new common_1['HttpException'](_0xddc7e3(0x29f),common_1[_0xddc7e3(0x24e)][_0xddc7e3(0x1e6)]);return{'appId':_0x54e4f9,'modelConfig':_0x3c9c0d};}async[_0x659525(0x2b6)](_0x3325bd){const _0x3bc9b4=_0x659525,_0x19b994=this;let _0x533ff9='',_0x200d13='',{type:_0x5a2cff,appId:_0x2717a1,prompt:_0x986358,custom:_0x17a78f,usingNetwork:_0x4391ac,systemMessage:_0x58ce9c,customSystemMessage:_0xc1d56e}=_0x3325bd;const _0x3bb295=async function(){const _0x14e0b1=_0x3732,_0x54b3c3=new Date()[_0x14e0b1(0x1c8)]()[_0x14e0b1(0x1d0)]('T')[0x0];return _0x200d13=await _0x19b994['globalConfigService']['getConfigByKeys']([_0x14e0b1(0x128)]),_0x200d13+(_0x14e0b1(0x1d2)+_0x54b3c3);};if(_0x2717a1){const _0x10542e=await this[_0x3bc9b4(0x132)]['getAppById'](_0x2717a1,0x1);if(!_0x10542e)throw new common_1[(_0x3bc9b4(0x207))](_0x3bc9b4(0x13a),common_1[_0x3bc9b4(0x24e)][_0x3bc9b4(0x1e6)]);_0x10542e[_0x3bc9b4(0x186)]&&(_0x58ce9c=_0x10542e['preset']);}else{if(_0x17a78f)_0x58ce9c=_0x58ce9c;else _0xc1d56e?_0x58ce9c=_0xc1d56e:_0x5a2cff!==_0x3bc9b4(0x1cb)&&(_0x58ce9c=await _0x3bb295());}return _0x4391ac&&(_0x533ff9=await(0x0,utils_1[_0x3bc9b4(0x243)])(_0x986358),!_0x200d13&&(_0x58ce9c=await _0x3bb295())),{'systemMessage':_0x58ce9c,'netWorkPrompt':_0x533ff9};}async['getCurrentModel'](_0x78e5ea){const _0x5e4695=_0x659525,{type:_0xe0a91d,custom:_0x30c279,groupId:_0x3fab08,modelConfig:_0x14b0cb}=_0x78e5ea;let _0x35ab82=null;if(!_0x30c279&&!_0xe0a91d){const _0x4aa49c=await this[_0x5e4695(0x1e5)][_0x5e4695(0x14d)](model_constant_1[_0x5e4695(0x151)][_0x5e4695(0x12d)],_0x14b0cb[_0x5e4695(0x1df)][_0x5e4695(0xfd)]);_0x35ab82=_0x4aa49c[_0x5e4695(0x1df)];}else{if(_0xe0a91d===_0x5e4695(0x1cb))_0x35ab82=await this[_0x5e4695(0x132)][_0x5e4695(0x1a3)](_0x3fab08);else{if(_0xe0a91d===_0x5e4695(0x20e)){const _0x5a162e=await this[_0x5e4695(0x1e5)]['getModelByType'](model_constant_1['EModelType']['FILE'],_0x14b0cb['modelInfo']['model']);_0x35ab82=_0x5a162e[_0x5e4695(0x1df)];}else _0x30c279?_0x35ab82=await this[_0x5e4695(0x1e5)]['getRandomKey'](model_constant_1['EModelType']['OTHER']):_0x35ab82=await this['modelsService'][_0x5e4695(0x299)](model_constant_1[_0x5e4695(0x151)][_0x5e4695(0x12d)]);}}if(!_0x35ab82)throw new common_1['HttpException'](_0x5e4695(0x181),common_1[_0x5e4695(0x24e)][_0x5e4695(0x1e6)]);return _0xe0a91d===_0x5e4695(0x1cb)?_0x14b0cb[_0x5e4695(0x1df)][_0x5e4695(0xfd)]=_0x35ab82[_0x5e4695(0xfd)]:_0x35ab82[_0x5e4695(0xfd)]=_0x14b0cb['modelInfo']['model'],_0x35ab82;}async['validateBeforeChat'](_0x21ecac){const _0x337da0=_0x659525,{user:_0x41fb80,prompt:_0x415634,currentRequestModel:_0x2d0d4a}=_0x21ecac;await this[_0x337da0(0x1ad)]['checkUserStatus'](_0x41fb80),await this[_0x337da0(0x29c)][_0x337da0(0x158)](_0x415634,_0x41fb80['id']),await this[_0x337da0(0x1ad)][_0x337da0(0x212)](_0x41fb80['id'],_0x2d0d4a);}async['buildOptions'](_0x2e0681,_0x593ed6,_0x1c5764){const _0x6d9a8e=_0x659525,_0x15bd99=await this[_0x6d9a8e(0x110)][_0x6d9a8e(0x22e)]([_0x6d9a8e(0x144)]),_0x1db634=Number(_0x15bd99)||0x493e0,_0x2649a6={'timeoutMs':+_0x1db634,'systemMessage':_0x593ed6||'','parentMessageId':_0x2e0681||'','completionParams':{'temperature':0.8,'model':_0x1c5764['model']}};return _0x2649a6;}async['configChatGptApi'](_0x47794c,_0x130aad){const _0x223cc6=_0x659525;let _0x33a2f3=_0x47794c[_0x223cc6(0x2bd)];if(!_0x33a2f3){const _0x59dc41=await this[_0x223cc6(0x110)][_0x223cc6(0x22e)]([_0x223cc6(0x296)]);_0x59dc41?_0x33a2f3=_0x59dc41:_0x33a2f3='https://api.openai.com';}const _0x3a67d5=0x1f40,_0x586266=0x1000,_0x56d904=new this[(_0x223cc6(0xf7))]({'maxModelTokens':_0x3a67d5,'apiBaseUrl':_0x33a2f3+_0x223cc6(0x156),'messageStore':this['messageStore'],'apiKey':(0x0,utils_1[_0x223cc6(0x19c)])(_0x47794c[_0x223cc6(0x28f)]),'maxResponseTokens':_0x586266>=_0x3a67d5?Math[_0x223cc6(0x1d9)](Math['floor'](_0x3a67d5/0x2)):_0x586266});return console[_0x223cc6(0x1f3)]('apiKey',_0x56d904[_0x223cc6(0x123)]),console[_0x223cc6(0x1f3)](_0x223cc6(0x19e),_0x130aad),console[_0x223cc6(0x1f3)](_0x223cc6(0x112),_0x33a2f3+_0x223cc6(0x156)),_0x56d904;}async[_0x659525(0x23a)](_0x199892){const _0x410458=_0x659525,_0x357841=new openai_1[(_0x410458(0x172))]({'baseURL':_0x199892[_0x410458(0x2bd)]+_0x410458(0x156)||_0x410458(0x2ac),'apiKey':_0x199892[_0x410458(0x28f)]});return _0x357841;}async[_0x659525(0x192)](_0x1b1226,_0x554848){const _0x38fe5c=_0x659525;let _0x34fa45=_0x1b1226[_0x38fe5c(0x2bd)]||_0x38fe5c(0x10a);const _0x43395b=0x1f40,_0x4b835e=0x1000,_0x3b67bc=new this[(_0x38fe5c(0xf7))]({'maxModelTokens':_0x43395b,'apiBaseUrl':_0x34fa45+'/api/v3','messageStore':this['messageStore'],'apiKey':(0x0,utils_1['removeSpecialCharacters'])(_0x1b1226[_0x38fe5c(0x28f)]),'maxResponseTokens':_0x4b835e>=_0x43395b?Math['abs'](Math[_0x38fe5c(0x176)](_0x43395b/0x2)):_0x4b835e});return console['log']('apiKey',_0x3b67bc['apiKey']),console[_0x38fe5c(0x1f3)]('mergedOptions',_0x554848),console['log'](_0x38fe5c(0x112),_0x34fa45+'/api/v3'),_0x3b67bc;}async[_0x659525(0x167)](_0x2c30e8,_0x715692,_0xaf67bf=null){const _0x2a5b5d=_0x659525;let _0x16d523=[];for(const _0x4b14c0 of _0x715692){const _0x1744a6=new URL(_0x4b14c0);let _0x1c7598=(0x0,path_1[_0x2a5b5d(0x246)])(process[_0x2a5b5d(0x226)](),'webroot',_0x1744a6[_0x2a5b5d(0x170)]);_0x1c7598=decodeURIComponent(_0x1c7598);const _0x4052a2=await _0x2c30e8[_0x2a5b5d(0x1d3)][_0x2a5b5d(0x236)]({'file':fs[_0x2a5b5d(0x19d)](_0x1c7598),'purpose':'file-extract'});let _0x3392bd=await(await _0x2c30e8[_0x2a5b5d(0x1d3)][_0x2a5b5d(0x177)](_0x4052a2['id']))[_0x2a5b5d(0x1a0)]();_0x16d523[_0x2a5b5d(0x266)]({'role':_0x2a5b5d(0x1c5),'content':_0x3392bd});}return _0x16d523;}async['openAiErrHandler'](_0x4e261f,_0x518eb9){const _0x466175=_0x659525;let _0x220826='',_0x23c6bb=_0x4e261f[_0x466175(0x191)];return!_0x220826&&(_0x220826=errorMessage_constant_1[_0x466175(0x1f6)][_0x23c6bb]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x23c6bb]:'服务异常、请重新试试吧！！！'),_0x4e261f?.[_0x466175(0xf6)][_0x466175(0x1c9)]('The\x20OpenAI\x20account\x20associated\x20with\x20this\x20API\x20key\x20has\x20been\x20deactivated.')&&(await this[_0x466175(0x1e5)][_0x466175(0x1b3)](_0x518eb9['id'],'当前模型key已被封禁、已冻结当前调用Key、尝试重新对话试试吧！',-0x1),_0x220826=_0x466175(0x146)),_0x4e261f?.[_0x466175(0x191)]===0x1ad&&_0x4e261f[_0x466175(0xf6)][_0x466175(0x1c9)](_0x466175(0x2b8))&&(await this['modelsService'][_0x466175(0x1b3)](_0x518eb9['id'],'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x220826=_0x466175(0x254)),_0x4e261f?.[_0x466175(0x191)]===0x191&&_0x4e261f[_0x466175(0xf6)][_0x466175(0x1c9)](_0x466175(0x1a1))&&(await this['modelsService'][_0x466175(0x1b3)](_0x518eb9['id'],_0x466175(0x2a7),-0x2),_0x220826=_0x466175(0x16e)),_0x4e261f?.[_0x466175(0x191)]===0x191&&(_0x220826=_0x466175(0x16e)),_0x4e261f?.['statusCode']===0x191&&_0x4e261f[_0x466175(0xf6)]['includes'](_0x466175(0x149))&&(await this[_0x466175(0x1e5)][_0x466175(0x1b3)](_0x518eb9['id'],_0x466175(0x2a7),-0x2),_0x220826='模型秘钥错误或模型金额不足，请联系管理员！'),_0x4e261f?.[_0x466175(0x191)]===0x194&&_0x4e261f[_0x466175(0xf6)]['includes'](_0x466175(0x15e))&&(await this['modelsService']['lockKey'](_0x518eb9['id'],_0x466175(0x10e),-0x4),_0x220826=_0x466175(0x292)),_0x220826;}async[_0x659525(0x213)](_0x8307f6,_0x4bfd84,_0x260484,_0x57cec6=!![]){const _0x5bb2b8=_0x659525;try{const _0x40cee9=_0x4bfd84[_0x5bb2b8(0x18e)],_0x12770a=(0x0,utils_1[_0x5bb2b8(0x24a)])(this['clsService']),{options:options={},prompt:_0x24dff8,cusromPrompt:_0x304312}=_0x8307f6,{groupId:_0x5bc06b,usingNetwork:_0x4aa610,parentMessageId:_0x4bc973,type:_0x2f3a74}=options,{appId:_0x536ca5,modelConfig:_0x178385}=await this[_0x5bb2b8(0x19f)]({'type':_0x2f3a74,'groupId':_0x5bc06b}),{systemMessage:_0x651a57,netWorkPrompt:_0x4c0bf3}=await this[_0x5bb2b8(0x2b6)]({'type':_0x2f3a74,'appId':_0x536ca5,'prompt':_0x24dff8,'usingNetwork':_0x4aa610,'custom':_0x304312,'systemMessage':_0x8307f6[_0x5bb2b8(0x193)],'customSystemMessage':_0x178385[_0x5bb2b8(0x1df)][_0x5bb2b8(0x193)]}),_0x132f6b=await this['getCurrentModel']({'type':_0x2f3a74,'groupId':_0x5bc06b,'modelConfig':_0x178385,'custom':_0x304312});await this['validateBeforeChat']({'prompt':_0x24dff8,'currentRequestModel':_0x132f6b,'user':_0x4bfd84[_0x5bb2b8(0x1b7)]});const _0x309305=await this[_0x5bb2b8(0x197)][_0x5bb2b8(0x256)](_0x24dff8);_0x260484&&_0x57cec6&&_0x260484['setHeader'](_0x5bb2b8(0x111),_0x5bb2b8(0x291));if(_0x309305){if(_0x260484&&_0x57cec6){const _0x1dbfcf={'message':_0x309305,'code':0x1f4};_0x260484['write'](JSON[_0x5bb2b8(0x15f)](_0x1dbfcf)),_0x260484[_0x5bb2b8(0x180)]();return;}else return _0x309305;}const _0x40eb56=await this[_0x5bb2b8(0x1be)](options[_0x5bb2b8(0x182)],_0x651a57,_0x132f6b);options['model']&&(_0x40eb56[_0x5bb2b8(0x1d8)]['model']=options['model']);let {model:_0x437cdf,rounds:_0x3e8842,keyType:_0x5f44d6,modelType:_0x51bb28,id:_0x139765,topN:_0x35b8fb}=_0x178385[_0x5bb2b8(0x1df)];const {key:_0x5f2df,modelName:_0x40aac6,id:_0x659fa7,accessToken:_0x45d963}=_0x132f6b;_0x437cdf=_0x40eb56[_0x5bb2b8(0x1d8)][_0x5bb2b8(0xfd)];_0x260484&&_0x57cec6&&_0x260484[_0x5bb2b8(0x205)](0xc8);let _0x90e399=null,_0x4607e3=null;const _0xdadc4b=(0x0,utils_1[_0x5bb2b8(0x1f2)])(_0x4bfd84),_0x4e1b95={'appId':_0x536ca5,'curIp':_0xdadc4b,'prompt':_0x24dff8,'groupId':_0x5bc06b,'modelId':_0x139765,'modelType':_0x51bb28,'answer':'','model':_0x437cdf,'role':_0x5bb2b8(0x1b7),'userId':_0x4bfd84[_0x5bb2b8(0x1b7)]['id'],'completionTokens':0x0,'type':balance_constant_1[_0x5bb2b8(0x261)]['CHAT_TYPE'],'logType':_0x2f3a74===_0x5bb2b8(0x1cb)?0x2:0x1,'requestOptions':JSON[_0x5bb2b8(0x15f)]({'options':options,'prompt':_0x24dff8}),'saasId':_0x12770a},_0x240344={..._0x4e1b95,'role':'assistant','requestOptions':JSON[_0x5bb2b8(0x15f)]({'prompt':_0x24dff8,'options':{'model':_0x437cdf,'temperature':_0x35b8fb}})};try{if(_0x260484){let _0x39a003=null,_0xfef295=![];_0x260484['on'](_0x5bb2b8(0x1d4),async()=>{const _0xe1e278=_0x5bb2b8;if(_0xfef295)return;_0x40cee9[_0xe1e278(0x1f7)]();const _0x4168ea=0x0,_0x4b67e9=0x0,_0x378d18=_0x4168ea+_0x4b67e9;_0x4e1b95[_0xe1e278(0x28b)]=_0x4168ea,_0x4e1b95[_0xe1e278(0x161)]=_0x4168ea,await this[_0xe1e278(0x129)][_0xe1e278(0x1cd)](_0x4e1b95),_0x240344['answer']=_0x39a003?.[_0xe1e278(0x1a0)],_0x240344[_0xe1e278(0x28b)]=_0x378d18,_0x240344['promptTokens']=_0x4168ea,_0x240344[_0xe1e278(0x154)]=_0x4b67e9,_0x240344['conversationOptions']=JSON[_0xe1e278(0x15f)]({'conversationId':_0x39a003?.[_0xe1e278(0x1c7)],'model':_0x437cdf,'parentMessageId':_0x39a003?.['id'],'temperature':_0x35b8fb});const _0xa0a851=await this[_0xe1e278(0x129)][_0xe1e278(0x1cd)](_0x240344);await this[_0xe1e278(0x1ad)][_0xe1e278(0x1f0)](_0x4bfd84['user']['id'],_0x132f6b,_0xa0a851['id']);}),_0x260484['on'](_0x5bb2b8(0x1b1),_0x460584=>{const _0x3ab9f3=_0x5bb2b8;console[_0x3ab9f3(0x1f3)](_0x460584);});if(Number(_0x5f44d6)===0x1){let _0x74def5=!![];const _0x35c202=await this['configChatGptApi'](_0x132f6b,_0x40eb56);_0x90e399=await _0x35c202[_0x5bb2b8(0x287)](_0x4aa610?_0x4c0bf3:_0x24dff8,{..._0x40eb56,'onProgress':_0x205f71=>{const _0x5eee4c=_0x5bb2b8;_0x57cec6&&_0x260484['write'](_0x74def5?JSON[_0x5eee4c(0x15f)](_0x205f71):'\x0a'+JSON[_0x5eee4c(0x15f)](_0x205f71)),_0x74def5=![],_0x39a003=_0x205f71;},'abortSignal':_0x40cee9[_0x5bb2b8(0x1e7)]}),_0xfef295=!![];}if(Number(_0x5f44d6)===0x2){let _0x59fc98=!![];const _0x281948=await this[_0x5bb2b8(0x1e3)]['buildMessageFromParentMessageId'](_0x4aa610?_0x4c0bf3:_0x24dff8,{'parentMessageId':_0x4bc973,'maxRounds':(0x0,helper_1[_0x5bb2b8(0x1e2)])(_0x3e8842)});_0x90e399=await(0x0,baidu_1[_0x5bb2b8(0x2a3)])(_0x4aa610?_0x4c0bf3:_0x281948,{'temperature':_0x35b8fb,'accessToken':_0x45d963,'model':_0x437cdf,'onProgress':_0xc49478=>{const _0x52f9ee=_0x5bb2b8;_0x57cec6&&_0x260484['write'](_0x59fc98?JSON[_0x52f9ee(0x15f)](_0xc49478):'\x0a'+JSON['stringify'](_0xc49478)),_0x59fc98=![],_0x39a003=_0xc49478;}}),_0xfef295=!![];}if(Number(_0x5f44d6)===0x3){let _0x31ba68=!![];const _0x43692e=await this[_0x5bb2b8(0x1e3)]['buildMessageFromParentMessageId'](_0x4aa610?_0x4c0bf3:_0x24dff8,{'parentMessageId':_0x4bc973,'maxRounds':(0x0,helper_1[_0x5bb2b8(0x1e2)])(_0x3e8842)});_0x90e399=await(0x0,zhipu_1[_0x5bb2b8(0x187)])(_0x4aa610?_0x4c0bf3:_0x43692e,{'temperature':_0x35b8fb,'key':_0x5f2df,'model':_0x437cdf,'onProgress':_0x406025=>{const _0x22bbc4=_0x5bb2b8;_0x57cec6&&_0x260484[_0x22bbc4(0x272)](_0x31ba68?JSON['stringify'](_0x406025):'\x0a'+JSON['stringify'](_0x406025)),_0x31ba68=![],_0x39a003=_0x406025;}}),_0xfef295=!![];}if(Number(_0x5f44d6)===0x4){let _0x5412f5=!![];const {key:_0x1a0409,appid:_0x2cf1d1,secret:_0x32e32f,model:_0x3c1e78}=_0x132f6b,_0x4b03a6=await this[_0x5bb2b8(0x1e3)]['buildMessageFromParentMessageId'](_0x4aa610?_0x4c0bf3:_0x24dff8,{'parentMessageId':_0x4bc973,'maxRounds':(0x0,helper_1['addOneIfOdd'])(_0x3e8842)}),_0x36e902=new spark_1[(_0x5bb2b8(0x281))]({'appid':_0x2cf1d1,'secret':_0x32e32f,'key':_0x1a0409});_0x90e399=await _0x36e902[_0x5bb2b8(0x275)](_0x4aa610?_0x4c0bf3:_0x4b03a6,{'temperature':_0x35b8fb,'model':_0x3c1e78,'onProgress':_0x3e52cb=>{const _0x3dd19d=_0x5bb2b8;_0x57cec6&&_0x260484[_0x3dd19d(0x272)](_0x5412f5?JSON['stringify'](_0x3e52cb):'\x0a'+JSON[_0x3dd19d(0x15f)](_0x3e52cb)),_0x5412f5=![],_0x39a003=_0x3e52cb;},'abortController':_0x40cee9}),_0xfef295=!![];}if(Number(_0x5f44d6)===0x7){_0x90e399={};const _0x1b2c6c=await this[_0x5bb2b8(0x23a)](_0x132f6b);let _0x248518=!![],_0x36c0ba=[],_0x440202=!![];const _0x59ec60=[],_0xc79726=[],_0x54e0a1=_0x24dff8[_0x5bb2b8(0x1d0)]('\x20');for(let _0x13a796=0x0;_0x13a796<_0x54e0a1[_0x5bb2b8(0x21f)];_0x13a796++){_0x248518&&/^[http:\/\/|https:\/\/]/['test'](_0x54e0a1[_0x13a796])?_0x59ec60['push'](_0x54e0a1[_0x13a796]):(_0x248518=![],_0x54e0a1[_0x13a796]&&_0xc79726[_0x5bb2b8(0x266)](_0x54e0a1[_0x13a796]));}if(options[_0x5bb2b8(0x182)]){const _0x13358f=await this[_0x5bb2b8(0x129)][_0x5bb2b8(0xfb)](options[_0x5bb2b8(0x28e)]);_0x36c0ba=_0x13358f[_0x5bb2b8(0x168)](_0x45555b=>{const _0x351aa2=_0x5bb2b8;return{'role':_0x45555b['role']===_0x351aa2(0x1b7)?_0x351aa2(0x1b7):'system','content':_0x45555b['prompt']||_0x45555b[_0x351aa2(0x103)]};});}const _0x224473=await this['kimiUpload'](_0x1b2c6c,_0x59ec60),_0x4e871f=[..._0x36c0ba,..._0x224473,{'role':'system','content':_0x5bb2b8(0x141)+_0x5bb2b8(0x204)+_0x5bb2b8(0x2ab)},{'role':_0x5bb2b8(0x1b7),'content':_0xc79726[_0x5bb2b8(0x246)]('\x20')}];console['log'](_0x5bb2b8(0x123),_0x1b2c6c['apiKey']),console[_0x5bb2b8(0x1f3)](_0x5bb2b8(0x19e),options),console[_0x5bb2b8(0x1f3)](_0x5bb2b8(0x112),_0x1b2c6c[_0x5bb2b8(0x18a)]+_0x5bb2b8(0x156)),console['log']('messages',JSON[_0x5bb2b8(0x15f)](_0x4e871f));const _0x29c6a3=await _0x1b2c6c[_0x5bb2b8(0x25d)]['completions'][_0x5bb2b8(0x236)]({'stream':!![],..._0x40eb56,'messages':_0x4e871f,'model':_0x132f6b[_0x5bb2b8(0xfd)]});for await(const _0x2edfbd of _0x29c6a3){const _0x501230=_0x2edfbd?.['choices'][0x0],_0x3e23ab=_0x501230?.[_0x5bb2b8(0x224)];_0x90e399[_0x5bb2b8(0x271)]=_0x2edfbd,_0x2edfbd['id']&&(_0x90e399['id']=_0x2edfbd['id']),_0x3e23ab[_0x5bb2b8(0x201)]&&(_0x90e399[_0x5bb2b8(0x201)]=_0x3e23ab[_0x5bb2b8(0x201)]),_0x3e23ab&&_0x3e23ab['content']&&(_0x90e399[_0x5bb2b8(0x1a0)]+=_0x3e23ab[_0x5bb2b8(0x177)],_0x90e399[_0x5bb2b8(0x224)]=_0x3e23ab?.[_0x5bb2b8(0x177)]),_0x501230[_0x5bb2b8(0x240)]&&(_0x90e399[_0x5bb2b8(0x1a0)]=_0x90e399[_0x5bb2b8(0x1a0)]['trim']()),_0x29c6a3&&_0x260484[_0x5bb2b8(0x272)](_0x440202?JSON[_0x5bb2b8(0x15f)](_0x90e399):'\x0a'+JSON['stringify'](_0x90e399)),_0x440202=![],_0x39a003=_0x2edfbd;}}if(Number(_0x5f44d6)===0x8){let _0x39534e=!![];const _0x5bf6d0=await this[_0x5bb2b8(0x192)](_0x132f6b,_0x40eb56);_0x90e399=await _0x5bf6d0[_0x5bb2b8(0x287)](_0x4aa610?_0x4c0bf3:_0x24dff8,{..._0x40eb56,'onProgress':_0x116a6c=>{const _0x2e2eca=_0x5bb2b8;_0x57cec6&&_0x260484[_0x2e2eca(0x272)](_0x39534e?JSON[_0x2e2eca(0x15f)](_0x116a6c):'\x0a'+JSON[_0x2e2eca(0x15f)](_0x116a6c)),_0x39534e=![],_0x39a003=_0x116a6c;},'abortSignal':_0x40cee9[_0x5bb2b8(0x1e7)]}),_0xfef295=!![];}const _0x428b30={'id':this[_0x5bb2b8(0x1e3)]['getUuid'](),'text':_0x24dff8,'role':'user','name':undefined,'usage':null,'parentMessageId':_0x4bc973,'conversationId':_0x90e399?.[_0x5bb2b8(0x1c7)]||null};_0x4607e3={'model':_0x437cdf,'parentMessageId':_0x4bc973},await this[_0x5bb2b8(0x1e3)][_0x5bb2b8(0x25b)](_0x428b30);const _0x2ec596={'id':_0x90e399?.['id']||this[_0x5bb2b8(0x1e3)][_0x5bb2b8(0x1dd)](),'text':_0x90e399[_0x5bb2b8(0x1a0)],'role':_0x5bb2b8(0x11d),'name':undefined,'usage':_0x90e399['usage'],'parentMessageId':_0x428b30['id'],'conversationId':_0x90e399?.[_0x5bb2b8(0x1c7)]};await this[_0x5bb2b8(0x1e3)][_0x5bb2b8(0x25b)](_0x2ec596),_0x4607e3={'model':_0x437cdf,'parentMessageId':_0x428b30['id']};}else{console['log'](_0x5bb2b8(0x2bb));const _0x528f7f=await this[_0x5bb2b8(0x26f)](_0x132f6b,_0x40eb56);_0x90e399=await _0x528f7f[_0x5bb2b8(0x287)](_0x4aa610?_0x4c0bf3:_0x24dff8,_0x40eb56);}const _0x5da93f=(0x0,helper_1[_0x5bb2b8(0x1f4)])(_0x5f44d6,_0x90e399,_0x4607e3),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x5da93f[_0x5bb2b8(0x1bc)];_0x2f3a74==='gpts'?await this[_0x5bb2b8(0x132)]['saveGptsUseLog'](_0x659fa7,total_tokens):await this[_0x5bb2b8(0x1e5)][_0x5bb2b8(0x188)](_0x659fa7,total_tokens);_0x4e1b95[_0x5bb2b8(0x28b)]=total_tokens,await this[_0x5bb2b8(0x129)]['saveChatLog'](_0x4e1b95),_0x240344[_0x5bb2b8(0x103)]=_0x5da93f?.[_0x5bb2b8(0x1a0)],_0x240344[_0x5bb2b8(0x28b)]=total_tokens,_0x240344['promptTokens']=prompt_tokens,_0x240344[_0x5bb2b8(0x154)]=completion_tokens,_0x240344[_0x5bb2b8(0x117)]=JSON[_0x5bb2b8(0x15f)]({'conversationId':_0x90e399[_0x5bb2b8(0x1c7)],'model':_0x437cdf,'parentMessageId':_0x90e399['id'],'temperature':_0x35b8fb});const _0x18ba8b=await this[_0x5bb2b8(0x129)][_0x5bb2b8(0x1cd)](_0x240344);common_1[_0x5bb2b8(0x10b)]['debug'](_0x5bb2b8(0x13b)+_0x4bfd84[_0x5bb2b8(0x1b7)]['id']+_0x5bb2b8(0x1fd)+_0x437cdf+_0x5bb2b8(0x1bd)+_0x5f2df+',\x20模型名称:\x20'+_0x40aac6,'ChatgptService'),_0x90e399['result']&&(_0x90e399[_0x5bb2b8(0x27e)]=''),_0x90e399['is_end']=!![],_0x90e399[_0x5bb2b8(0x2bf)]=_0x18ba8b['id'];if(_0x260484&&_0x57cec6)await this[_0x5bb2b8(0x1ad)][_0x5bb2b8(0x1f0)](_0x4bfd84[_0x5bb2b8(0x1b7)]['id'],_0x132f6b,_0x18ba8b['id']),_0x260484['write']('\x0a'+JSON[_0x5bb2b8(0x15f)](_0x90e399));else return _0x90e399[_0x5bb2b8(0x1a0)];}catch(_0x1660e){_0x240344['answer']=_0x1660e[_0x5bb2b8(0xf6)],_0x240344[_0x5bb2b8(0x115)]=_0x1660e['message'],_0x240344[_0x5bb2b8(0x117)]=JSON[_0x5bb2b8(0x15f)]({'conversationId':_0x90e399?.[_0x5bb2b8(0x1c7)],'model':_0x437cdf,'parentMessageId':_0x90e399?.['id'],'temperature':_0x35b8fb}),await this[_0x5bb2b8(0x129)][_0x5bb2b8(0x1cd)](_0x240344),console['log'](_0x5bb2b8(0x137),_0x5f2df,_0x1660e);const _0x3d9e63=_0x1660e['statusCode'];_0x3d9e63===0x190&&console[_0x5bb2b8(0x1f3)]('400\x20error',_0x1660e,_0x1660e[_0x5bb2b8(0xf6)]);if(_0x1660e[_0x5bb2b8(0x205)]&&_0x1660e['status']===0x192){const _0x5bcd0f={'message':'Catch\x20Error\x20'+_0x1660e['message'],'code':0x192};if(_0x260484&&_0x57cec6){_0x260484[_0x5bb2b8(0x272)](JSON[_0x5bb2b8(0x15f)](_0x5bcd0f)),_0x260484['end']();return;}else throw new common_1[(_0x5bb2b8(0x207))](_0x1660e[_0x5bb2b8(0xf6)],common_1[_0x5bb2b8(0x24e)][_0x5bb2b8(0xfa)]);}if(!_0x3d9e63){if(_0x260484&&_0x57cec6){_0x260484[_0x5bb2b8(0x272)](JSON[_0x5bb2b8(0x15f)]({'message':_0x1660e[_0x5bb2b8(0xf6)],'code':0x1f4})),_0x260484[_0x5bb2b8(0x180)]();return;}else throw new common_1[(_0x5bb2b8(0x207))](_0x1660e['message'],common_1[_0x5bb2b8(0x24e)]['BAD_REQUEST']);}const _0xb4cb1d=await this['openAiErrHandler'](_0x1660e,_0x132f6b),_0x46c15c={'message':_0xb4cb1d||_0x5bb2b8(0x1b0),'code':_0x3d9e63===0x191?0x191:_0x3d9e63||0x1f4};if(_0x260484&&_0x57cec6)_0x260484[_0x5bb2b8(0x191)]=0x190,_0x260484[_0x5bb2b8(0x272)](JSON['stringify'](_0x46c15c));else throw new common_1['HttpException'](_0x46c15c[_0x5bb2b8(0xf6)],common_1[_0x5bb2b8(0x24e)][_0x5bb2b8(0x1e6)]);}finally{_0x260484&&_0x57cec6&&_0x260484[_0x5bb2b8(0x180)]();}}catch(_0x485e13){if(_0x485e13 instanceof common_1['HttpException'])throw _0x485e13;else throw new common_1[(_0x5bb2b8(0x207))](_0x485e13[_0x5bb2b8(0xf6)],common_1['HttpStatus'][_0x5bb2b8(0x1e6)]);}}async[_0x659525(0x1ac)](_0x2d79ea){const _0x3dafb9=_0x659525,{userId:_0x179a8a,prompt:_0x1f5c9b,options:_0x4c5c90,answerLogDTO:_0x21c71d,currentRequestModel:_0x569453}=_0x2d79ea;try{const _0x1816b2=await this[_0x3dafb9(0x26f)](_0x569453,_0x4c5c90),_0x293991=await _0x1816b2['sendMessage'](_0x1f5c9b,{..._0x4c5c90,'onProgress':_0x313fc7=>{}});let _0x58cf0d={'model':_0x4c5c90[_0x3dafb9(0x1d8)][_0x3dafb9(0xfd)],'parentMessageId':_0x4c5c90[_0x3dafb9(0x182)]};const _0x395da9=(0x0,helper_1[_0x3dafb9(0x1f4)])(0x1,_0x293991,_0x58cf0d),{prompt_tokens:prompt_tokens=0x0,completion_tokens:completion_tokens=0x0,total_tokens:total_tokens=0x0}=_0x395da9[_0x3dafb9(0x1bc)];await this['modelsService'][_0x3dafb9(0x188)](_0x569453['id'],total_tokens),_0x21c71d[_0x3dafb9(0x103)]=_0x395da9?.['text'],_0x21c71d[_0x3dafb9(0x28b)]=total_tokens,_0x21c71d[_0x3dafb9(0x161)]=prompt_tokens,_0x21c71d[_0x3dafb9(0x154)]=completion_tokens,_0x21c71d[_0x3dafb9(0x117)]=JSON[_0x3dafb9(0x15f)]({'conversationId':_0x293991[_0x3dafb9(0x1c7)],'model':_0x395da9['model'],'parentMessageId':_0x293991['id'],'temperature':_0x4c5c90[_0x3dafb9(0x1d8)][_0x3dafb9(0x230)]}),await this['chatLogService'][_0x3dafb9(0x1cd)](_0x21c71d),common_1[_0x3dafb9(0x10b)]['debug'](_0x3dafb9(0x13b)+_0x179a8a+_0x3dafb9(0x1fd)+_0x569453[_0x3dafb9(0xfd)]+_0x3dafb9(0x1bd)+_0x569453[_0x3dafb9(0x28f)]+_0x3dafb9(0x2be)+_0x569453[_0x3dafb9(0x105)],_0x3dafb9(0x267));if(!_0x21c71d[_0x3dafb9(0x103)])throw new Error(_0x3dafb9(0x17d));await this[_0x3dafb9(0x129)][_0x3dafb9(0x286)](_0x21c71d);}catch(_0x452484){console[_0x3dafb9(0x1f3)](_0x3dafb9(0x227),_0x569453['key'],_0x452484);const _0x3ab94c=await this['openAiErrHandler'](_0x452484,_0x569453);_0x21c71d['errMsg']=_0x3ab94c,await this[_0x3dafb9(0x129)][_0x3dafb9(0x1cd)](_0x21c71d),await this[_0x3dafb9(0x1ad)]['refundBalance4Chat'](_0x179a8a,_0x569453,_0x21c71d['id']);}}async[_0x659525(0x288)](_0x41ac18){const _0x1212c9=_0x659525,{data:_0x4435ff,answerLogDTO:_0x56cda4,currentRequestModel:_0x2c9ba5}=_0x41ac18;try{let _0x387303;await this[_0x1212c9(0x1ad)][_0x1212c9(0x1f0)](_0x56cda4[_0x1212c9(0x27b)],_0x2c9ba5,_0x56cda4['id']);_0x4435ff[_0x1212c9(0x1da)]?_0x387303=await this[_0x1212c9(0x1b6)][_0x1212c9(0x16c)]({'data':_0x4435ff,'baseURL':_0x2c9ba5[_0x1212c9(0x2bd)],'headers':{'Authorization':_0x1212c9(0x178)+_0x2c9ba5[_0x1212c9(0x28f)]}},_0x4435ff[_0x1212c9(0x1da)]):_0x387303=await this[_0x1212c9(0x1b6)][_0x1212c9(0x12f)]({'data':_0x4435ff,'baseURL':_0x2c9ba5[_0x1212c9(0x2bd)],'headers':{'Authorization':'Bearer\x20'+_0x2c9ba5[_0x1212c9(0x28f)]}});await this[_0x1212c9(0x1e5)][_0x1212c9(0x188)](_0x2c9ba5['id'],0x0),_0x56cda4[_0x1212c9(0x28b)]=0x0,_0x56cda4[_0x1212c9(0x161)]=0x0,_0x56cda4[_0x1212c9(0x154)]=0x0,_0x56cda4['answer']=_0x387303['state'],_0x56cda4[_0x1212c9(0x117)]=JSON[_0x1212c9(0x15f)]({'model':_0x2c9ba5[_0x1212c9(0xfd)],'parentMessageId':_0x387303['id']}),await this['chatLogService'][_0x1212c9(0x1cd)](_0x56cda4),common_1[_0x1212c9(0x10b)]['debug'](_0x1212c9(0x13b)+_0x56cda4[_0x1212c9(0x27b)]+'\x20model:\x20'+_0x2c9ba5['model']+_0x1212c9(0x1bd)+_0x2c9ba5[_0x1212c9(0x28f)]+_0x1212c9(0x2be)+_0x2c9ba5[_0x1212c9(0x105)],_0x1212c9(0x267));if(!_0x56cda4[_0x1212c9(0x103)])throw new Error(_0x1212c9(0x260));await this[_0x1212c9(0x129)][_0x1212c9(0x12a)](_0x56cda4,_0x387303);}catch(_0x327917){console[_0x1212c9(0x1f3)](_0x1212c9(0x174),_0x2c9ba5[_0x1212c9(0x28f)],_0x327917);const _0x410bf9=await this[_0x1212c9(0x14f)](_0x327917,_0x2c9ba5);_0x56cda4[_0x1212c9(0x115)]=_0x410bf9,await this[_0x1212c9(0x129)][_0x1212c9(0x1cd)](_0x56cda4),await this[_0x1212c9(0x1ad)]['refundBalance4Chat'](_0x56cda4[_0x1212c9(0x27b)],_0x2c9ba5,_0x56cda4['id']);}}async[_0x659525(0x215)](_0x14f94c){const _0x6576b8=_0x659525;try{const _0x4161a2=(0x0,utils_1['getReqSaasId'])(this[_0x6576b8(0x12b)]),{req:_0x111671,model:_0x10427a,modelType:_0x18da72,datas:_0x378554}=_0x14f94c,{prompt:_0x276084,options:options={},cusromPrompt:_0x15c589}=_0x378554,{groupId:_0x2cb3e8,usingNetwork:_0x3704c8,type:_0x18ce43}=options,{appId:_0x119c6b,modelConfig:_0x4dfedf}=await this[_0x6576b8(0x19f)]({'modelType':_0x18da72}),{systemMessage:_0x30d3e1,netWorkPrompt:_0x3074be}=await this['buildSystemMessage']({'type':_0x18ce43,'appId':_0x119c6b,'prompt':_0x276084,'usingNetwork':_0x3704c8,'custom':_0x15c589,'systemMessage':_0x378554[_0x6576b8(0x193)],'customSystemMessage':_0x4dfedf[_0x6576b8(0x1df)][_0x6576b8(0x193)]}),_0x466e7e=await this[_0x6576b8(0x1e5)][_0x6576b8(0x299)](_0x18da72);_0x466e7e[_0x6576b8(0xfd)]=_0x10427a,_0x4dfedf[_0x6576b8(0x1df)][_0x6576b8(0xfd)]=_0x10427a,await this[_0x6576b8(0x284)]({'prompt':_0x276084,'currentRequestModel':_0x466e7e,'user':_0x111671[_0x6576b8(0x1b7)]});const _0x265b80=await this[_0x6576b8(0x1be)](options[_0x6576b8(0x182)],_0x30d3e1,_0x466e7e);let {id:_0x320ac5,topN:_0x4e1be2}=_0x4dfedf['modelInfo'];const _0x43ca74=0x0,_0x107eff=0x0,_0x19caf2=_0x43ca74+_0x107eff,_0xf94c26=(0x0,utils_1[_0x6576b8(0x1f2)])(_0x111671),_0x508657={'appId':_0x119c6b,'curIp':_0xf94c26,'prompt':_0x276084,'groupId':_0x2cb3e8,'modelId':_0x320ac5,'modelType':_0x18da72,'answer':'','model':_0x10427a,'role':_0x6576b8(0x1b7),'userId':_0x111671[_0x6576b8(0x1b7)]['id'],'completionTokens':0x0,'totalTokens':_0x19caf2,'type':balance_constant_1[_0x6576b8(0x261)][_0x6576b8(0x282)],'logType':_0x18ce43===_0x6576b8(0x1cb)?0x2:0x1,'requestOptions':JSON[_0x6576b8(0x15f)]({'options':null,'prompt':_0x276084}),'saasId':_0x4161a2},_0x1dc99b={..._0x508657,'role':_0x6576b8(0x11d),'requestOptions':JSON[_0x6576b8(0x15f)]({'prompt':_0x276084,'options':{'model':_0x10427a,'temperature':_0x4e1be2}})};await this[_0x6576b8(0x129)][_0x6576b8(0x1cd)](_0x508657);const _0x5dbb90=await this[_0x6576b8(0x129)]['saveChatLog'](_0x1dc99b);await this[_0x6576b8(0x1ad)]['deductBalance4Chat'](_0x111671[_0x6576b8(0x1b7)]['id'],_0x466e7e,_0x5dbb90['id']);if(_0x18da72===model_constant_1[_0x6576b8(0x151)][_0x6576b8(0x14e)])this[_0x6576b8(0x1ac)]({'userId':_0x111671[_0x6576b8(0x1b7)]['id'],'currentRequestModel':_0x466e7e,'options':_0x265b80,'answerLogDTO':_0x5dbb90,'prompt':_0x3704c8?_0x3074be:_0x276084});else _0x18da72===model_constant_1[_0x6576b8(0x151)]['VIDEO']&&this[_0x6576b8(0x288)]({'data':_0x378554,'currentRequestModel':_0x466e7e,'answerLogDTO':_0x5dbb90});return _0x5dbb90;}catch(_0x3b0604){if(_0x3b0604 instanceof common_1[_0x6576b8(0x207)])throw _0x3b0604;else throw new common_1[(_0x6576b8(0x207))](_0x3b0604[_0x6576b8(0xf6)],common_1['HttpStatus'][_0x6576b8(0x1e6)]);}}async[_0x659525(0x17b)](_0x5cadb2,_0x124e20){const _0x52181c=_0x659525;let {mv:_0x3e82bf,tags:_0x5b1105,title:_0x4f4c60,prompt:_0x13dcd3,continue_at:_0x1a9e36,continue_clip_id:_0x1c2cdf,make_instrumental:_0x241eb6}=_0x5cadb2,_0x59ebbc=_0x52181c(0x15d)+_0x13dcd3;return _0x3e82bf&&(_0x59ebbc=_0x59ebbc+_0x52181c(0x1ce)+_0x3e82bf),_0x5b1105&&(_0x59ebbc=_0x59ebbc+_0x52181c(0x17a)+_0x5b1105),_0x4f4c60&&(_0x59ebbc=_0x59ebbc+',\x20title\x20'+_0x4f4c60),_0x1a9e36&&(_0x59ebbc=_0x59ebbc+',\x20continue_at\x20'+_0x1a9e36),_0x1c2cdf&&(_0x59ebbc=_0x59ebbc+_0x52181c(0x1af)+_0x1c2cdf),_0x59ebbc=_0x59ebbc+_0x52181c(0x134)+_0x241eb6,_0x5cadb2[_0x52181c(0x1f1)]=_0x59ebbc,_0x13dcd3=_0x59ebbc,this[_0x52181c(0x215)]({'req':_0x124e20,'datas':_0x5cadb2,'model':_0x3e82bf||_0x52181c(0x217),'modelType':model_constant_1[_0x52181c(0x151)][_0x52181c(0x14e)]});}async[_0x659525(0x171)](_0x534543,_0x11fbe){const _0x5b4dae=_0x659525;let {model:_0x473acd,prompt:_0xe7582c,expand_prompt:_0x511323,aspect_ratio:_0x4fb240,image_url:_0x208f1f,image_end_url:_0x3480be}=_0x534543,_0x658cd6=_0x5b4dae(0x15d)+_0xe7582c+_0x5b4dae(0x1dc)+_0x511323+_0x5b4dae(0x2b9)+_0x4fb240;return _0x208f1f&&(_0x658cd6=_0x658cd6+'\x20image_url\x20'+_0x208f1f),_0x3480be&&(_0x658cd6=_0x658cd6+_0x5b4dae(0x248)+_0x3480be),_0x534543[_0x5b4dae(0x1f1)]=_0x658cd6,_0x534543[_0x5b4dae(0x280)]=_0xe7582c,this[_0x5b4dae(0x215)]({'req':_0x11fbe,'datas':_0x534543,'model':_0x473acd||_0x5b4dae(0x247),'modelType':model_constant_1['EModelType'][_0x5b4dae(0x233)]});}async[_0x659525(0x164)](){const _0x569e3e=_0x659525,_0x3c9eee=await this[_0x569e3e(0x129)][_0x569e3e(0x24b)]();if(!_0x3c9eee['length'])return;const _0x3c5801=[],_0x15d2be=new Map();_0x3c9eee[_0x569e3e(0x27d)](_0x3fb179=>{const _0x395784=_0x569e3e;_0x3c5801[_0x395784(0x266)](_0x3fb179['id']),_0x15d2be[_0x395784(0x2b7)](_0x3fb179['id'],_0x3fb179);});const _0x235790=await this[_0x569e3e(0x129)][_0x569e3e(0x139)](_0x3c5801),_0x1f5a5d=[],_0x39a45e=new Map();_0x235790[_0x569e3e(0x27d)](_0x4d1605=>{const _0x157714=_0x569e3e;_0x1f5a5d['push'](_0x4d1605['sunoMusicId']),_0x39a45e[_0x157714(0x2b7)](_0x4d1605[_0x157714(0x2ae)],_0x4d1605);});const _0x27ce55=await this[_0x569e3e(0x1e5)]['getRandomKey'](model_constant_1[_0x569e3e(0x151)][_0x569e3e(0x233)]),_0x4f4189=await this[_0x569e3e(0x1b6)]['listTaskByIds']({'baseURL':_0x27ce55[_0x569e3e(0x2bd)],'headers':{'Authorization':'Bearer\x20'+_0x27ce55['key']},'data':{'ids':_0x1f5a5d}});for(let _0x21595c=0x0;_0x21595c<_0x4f4189[_0x569e3e(0x21f)];_0x21595c++){const _0x2d1acc=_0x4f4189[_0x21595c],_0x4945a0=_0x39a45e[_0x569e3e(0x2a5)](_0x2d1acc['task_id']),_0x18f005=_0x15d2be['get'](_0x4945a0[_0x569e3e(0x2bf)]);await this[_0x569e3e(0x129)][_0x569e3e(0x12a)](_0x18f005,_0x2d1acc[_0x569e3e(0x211)]);}}async['requestFromGpt'](_0x45ae92){const _0x342a82=_0x659525,{prompt:_0x4538c8,userId:_0x342e58,abortController:_0x4206f2}=_0x45ae92,_0x355007=await this[_0x342a82(0x1e5)][_0x342a82(0x14d)](model_constant_1[_0x342a82(0x151)]['CHAT']),_0x3451ea=_0x355007[_0x342a82(0x1df)],_0xc613bb=_0x355007[_0x342a82(0x1df)][_0x342a82(0x135)];if(!_0x3451ea)throw new common_1[(_0x342a82(0x207))](_0x342a82(0x181),common_1[_0x342a82(0x24e)][_0x342a82(0x1e6)]);const {id:_0x3846cb}=_0x3451ea;let _0x303895=null,_0x36f27b=null;try{const _0x49bdd5=await this[_0x342a82(0x1be)]('','',_0x3451ea),_0x1da779=await this[_0x342a82(0x26f)](_0x3451ea,_0x49bdd5);_0x303895=await _0x1da779[_0x342a82(0x287)](_0x4538c8,{..._0x49bdd5,'abortSignal':_0x4206f2[_0x342a82(0x1e7)]});const _0x18708f=(0x0,helper_1[_0x342a82(0x1f4)])(_0xc613bb,_0x303895,_0x36f27b),{total_tokens:total_tokens=0x0}=_0x18708f[_0x342a82(0x1bc)];return await this[_0x342a82(0x1e5)][_0x342a82(0x188)](_0x3846cb,total_tokens),await this[_0x342a82(0x1ad)][_0x342a82(0x1f0)](_0x342e58,_0x3451ea,-0x1),_0x303895[_0x342a82(0x1a0)];}catch(_0x3b6f4a){common_1[_0x342a82(0x10b)][_0x342a82(0x1f3)](_0x3b6f4a);const _0x418db9=_0x3b6f4a[_0x342a82(0x191)];console[_0x342a82(0x1f3)](_0x418db9);if(_0x3b6f4a['status']&&_0x3b6f4a['status']===0x192)throw new common_1[(_0x342a82(0x207))](_0x3b6f4a[_0x342a82(0xf6)],common_1[_0x342a82(0x24e)]['PAYMENT_REQUIRED']);if(!_0x418db9)throw new common_1[(_0x342a82(0x207))](_0x3b6f4a['message'],common_1[_0x342a82(0x24e)][_0x342a82(0x1e6)]);let _0x41dcc7=errorMessage_constant_1[_0x342a82(0x1f6)][_0x418db9]?errorMessage_constant_1['OpenAiErrorCodeMessage'][_0x418db9]:_0x342a82(0x237);_0x3b6f4a?.['message']['includes'](_0x342a82(0x22b))&&Number(_0xc613bb)===0x1&&(await this[_0x342a82(0x1e5)][_0x342a82(0x1b3)](_0x3846cb,_0x342a82(0x223),-0x1),_0x41dcc7='当前模型key已被封禁');_0x3b6f4a?.[_0x342a82(0x191)]===0x1ad&&_0x3b6f4a[_0x342a82(0xf6)][_0x342a82(0x1c9)](_0x342a82(0x2b8))&&Number(_0xc613bb)===0x1&&(await this[_0x342a82(0x1e5)]['lockKey'](_0x3846cb,'当前模型key余额已耗尽、已冻结当前调用Key、尝试重新对话试试吧！',-0x3),_0x41dcc7=_0x342a82(0x254));_0x3b6f4a?.[_0x342a82(0x191)]===0x191&&_0x3b6f4a[_0x342a82(0xf6)][_0x342a82(0x1c9)](_0x342a82(0x1a1))&&Number(_0xc613bb)===0x1&&(await this[_0x342a82(0x1e5)][_0x342a82(0x1b3)](_0x3846cb,_0x342a82(0x107),-0x2),_0x41dcc7='提供了错误的模型秘钥、已冻结当前调用Key、请重新尝试对话！');_0x3b6f4a?.[_0x342a82(0x191)]===0x191&&_0x3b6f4a[_0x342a82(0xf6)]['includes'](_0x342a82(0x149))&&Number(_0xc613bb)===0x1&&(await this[_0x342a82(0x1e5)][_0x342a82(0x1b3)](_0x3846cb,'当前模型key余额已耗尽',-0x2),_0x41dcc7='当前模型key余额已耗尽，请充值！');_0x3b6f4a?.['statusCode']===0x194&&_0x3b6f4a['message']['includes'](_0x342a82(0x15e))&&Number(_0xc613bb)===0x1&&(await this['modelsService'][_0x342a82(0x1b3)](_0x3846cb,_0x342a82(0x10e),-0x4),_0x41dcc7='当前模型不是聊天模型、已冻结当前调用Key、请重新尝试对话！');_0x3b6f4a?.[_0x342a82(0x191)]===0x133&&_0x3b6f4a[_0x342a82(0xf6)][_0x342a82(0x1c9)](_0x342a82(0x12e))&&Number(_0xc613bb)===0x1&&(console[_0x342a82(0x1f3)](_0x342a82(0x133)),_0x41dcc7='\x20！');_0x418db9===0x190&&console[_0x342a82(0x1f3)](_0x342a82(0x16d),_0x3b6f4a,_0x3b6f4a[_0x342a82(0xf6)]);const _0x312b5b={'message':_0x41dcc7||_0x342a82(0x1b0),'code':_0x418db9===0x191?0x191:_0x418db9||0x1f4};throw new common_1[(_0x342a82(0x207))](_0x312b5b[_0x342a82(0xf6)],common_1['HttpStatus'][_0x342a82(0x1e6)]);}}async[_0x659525(0x1db)](_0x4fdd6a,_0x3daeaa,_0x119ac2){const _0x5b7aea=_0x659525;try{const {audio:_0x135e65,voice:_0x21583b}=_0x4fdd6a,_0x220ac3=_0x3daeaa[_0x5b7aea(0x18e)],_0x30ba90=await this[_0x5b7aea(0x1e5)]['getRandomAudioKey']();if(!_0x30ba90)throw _0x5b7aea(0x257);const {key:_0x1e5477,proxyUrl:_0x87c249}=_0x30ba90;await this['userService'][_0x5b7aea(0x10f)](_0x3daeaa[_0x5b7aea(0x1b7)]),await this['userService'][_0x5b7aea(0x212)](_0x3daeaa[_0x5b7aea(0x1b7)]['id'],_0x30ba90),console[_0x5b7aea(0x1f3)]('key\x20%s,\x20proxy\x20%s',_0x1e5477,_0x87c249),this[_0x5b7aea(0xf9)][_0x5b7aea(0x123)]=_0x1e5477,this[_0x5b7aea(0xf9)][_0x5b7aea(0x18a)]=(_0x87c249||this[_0x5b7aea(0x1ec)])+'/v1',this[_0x5b7aea(0xf9)]['timeout']=0x989680;const _0x2f4846=await this[_0x5b7aea(0xf9)][_0x5b7aea(0x116)][_0x5b7aea(0x214)][_0x5b7aea(0x236)]({'file':(0x0,fs_1[_0x5b7aea(0x19d)])((0x0,path_1['resolve'])(_0x135e65['path'])),'model':'whisper-1','language':'zh','response_format':'json','temperature':0x0})['then'](_0x9365d6=>_0x9365d6['text'])[_0x5b7aea(0x1cc)](_0x444ea6=>{const _0x4c2119=_0x5b7aea;common_1[_0x4c2119(0x10b)]['error'](_0x444ea6);});console[_0x5b7aea(0x1f3)]('audio2text\x20',_0x2f4846);if(!_0x2f4846){this[_0x5b7aea(0x15c)]((0x0,path_1[_0x5b7aea(0x218)])(_0x135e65[_0x5b7aea(0x1e1)]));throw new common_1[(_0x5b7aea(0x207))](_0x5b7aea(0x219),common_1[_0x5b7aea(0x24e)]['BAD_REQUEST']);}await this[_0x5b7aea(0x1ad)][_0x5b7aea(0x1f0)](_0x3daeaa['user']['id'],_0x30ba90,-0x1);const _0x2bcc04=await this[_0x5b7aea(0x21c)]({'userId':_0x3daeaa[_0x5b7aea(0x1b7)]['id'],'prompt':_0x2f4846,'abortController':_0x220ac3});console[_0x5b7aea(0x1f3)](_0x5b7aea(0x255),_0x2bcc04);if(!_0x2bcc04){this[_0x5b7aea(0x15c)]((0x0,path_1[_0x5b7aea(0x218)])(_0x135e65[_0x5b7aea(0x1e1)]));throw new common_1[(_0x5b7aea(0x207))](_0x5b7aea(0x221),common_1[_0x5b7aea(0x24e)][_0x5b7aea(0x1e6)]);}console['log'](_0x5b7aea(0x29b),_0x2bcc04['length']);let _0x7b6caf=_0x2bcc04[_0x5b7aea(0x21f)]>0x1000?_0x2bcc04['slice'](0x0,0xfff):_0x2bcc04;const _0x31d51a=await this['openAi']['audio'][_0x5b7aea(0x1c0)][_0x5b7aea(0x236)]({'input':_0x7b6caf,'model':_0x5b7aea(0x1b9),'response_format':'aac','voice':_0x21583b,'speed':0x1})['then'](_0x1c137e=>_0x1c137e[_0x5b7aea(0x175)]())[_0x5b7aea(0x1cc)](_0x8e8a48=>{const _0x1de458=_0x5b7aea;common_1[_0x1de458(0x10b)][_0x1de458(0x1b1)](_0x8e8a48);});if(!_0x31d51a){this[_0x5b7aea(0x15c)]((0x0,path_1[_0x5b7aea(0x218)])(_0x135e65['path']));throw new common_1[(_0x5b7aea(0x207))](_0x5b7aea(0x1fa),common_1[_0x5b7aea(0x24e)][_0x5b7aea(0x1e6)]);}await this['userService'][_0x5b7aea(0x1f0)](_0x3daeaa[_0x5b7aea(0x1b7)]['id'],_0x30ba90,-0x1);const _0x1019e6=Buffer[_0x5b7aea(0x163)](_0x31d51a);return _0x119ac2[_0x5b7aea(0x1cf)](_0x5b7aea(0x111),'application/octet-stream'),_0x119ac2[_0x5b7aea(0x272)](_0x1019e6),_0x119ac2['end'](_0x1019e6),this[_0x5b7aea(0x15c)]((0x0,path_1[_0x5b7aea(0x218)])(_0x135e65['path'])),_0x1019e6;}catch(_0x1fcced){if(_0x1fcced instanceof common_1['HttpException'])throw _0x1fcced;else throw new common_1[(_0x5b7aea(0x207))](_0x1fcced['message'],common_1[_0x5b7aea(0x24e)]['BAD_REQUEST']);}}async[_0x659525(0x122)](_0x121e14,_0x165ed5){const _0x30c6f0=_0x659525;common_1[_0x30c6f0(0x10b)][_0x30c6f0(0x1f3)](_0x30c6f0(0x1a8)+_0x121e14[_0x30c6f0(0x1f1)],'DrawService'),await this[_0x30c6f0(0x29c)]['checkBadWords'](_0x121e14[_0x30c6f0(0x1f1)],_0x165ed5['user']['id']),await this['userService'][_0x30c6f0(0x10f)](_0x165ed5['user']);let _0x3dc543=[];const _0xa85b20=await this[_0x30c6f0(0x1e5)]['getRandomKey'](model_constant_1['EModelType'][_0x30c6f0(0x26a)]);await this['userService'][_0x30c6f0(0x212)](_0x165ed5[_0x30c6f0(0x1b7)]['id'],_0xa85b20);const {key:_0x44ae84,model:_0x3f32af,proxyUrl:_0x513672}=await this[_0x30c6f0(0x114)](_0xa85b20),_0x5b7d01=_0x513672+'/v1/images/generations';try{const _0x55f49b=await axios_1[_0x30c6f0(0x172)]['post'](_0x5b7d01,{..._0x121e14,'model':_0x3f32af,'response_format':_0x30c6f0(0x21d)},{'headers':{'Authorization':_0x30c6f0(0x178)+_0x44ae84}});_0x3dc543=_0x55f49b[_0x30c6f0(0x211)][_0x30c6f0(0x211)];}catch(_0x39691e){console['log'](_0x30c6f0(0x28d),_0x39691e);const _0x59c84b=_0x39691e?.[_0x30c6f0(0x203)]?.[_0x30c6f0(0x205)]||0x1f4,_0x24ea05=_0x39691e?.[_0x30c6f0(0x203)]?.[_0x30c6f0(0x211)]?.[_0x30c6f0(0x1b1)]?.[_0x30c6f0(0xf6)];if(_0x59c84b===0x1ad)throw new common_1[(_0x30c6f0(0x207))](_0x30c6f0(0x23d),common_1[_0x30c6f0(0x24e)][_0x30c6f0(0x1e6)]);if(_0x59c84b===0x190||_0x24ea05[_0x30c6f0(0x1c9)]('Your\x20request\x20was\x20rejected\x20as\x20a\x20result\x20of\x20our\x20safety\x20system'))throw new common_1[(_0x30c6f0(0x207))](_0x30c6f0(0x1ee),common_1[_0x30c6f0(0x24e)][_0x30c6f0(0x1e6)]);if(_0x59c84b===0x1f4)throw new common_1['HttpException']('绘制图片失败，请检查你的提示词是否有非法描述！',common_1[_0x30c6f0(0x24e)][_0x30c6f0(0x1e6)]);if(_0x59c84b===0x191)throw new common_1['HttpException'](_0x30c6f0(0x295),common_1[_0x30c6f0(0x24e)]['BAD_REQUEST']);throw new common_1[(_0x30c6f0(0x207))](_0x30c6f0(0x16a),common_1[_0x30c6f0(0x24e)][_0x30c6f0(0x1e6)]);}const _0x27016f=[];for(const _0x1b6545 of _0x3dc543){const _0x41d7f6=_0x1b6545[_0x30c6f0(0x21d)][_0x30c6f0(0xf5)](/^data:image\/\w+;base64,/,''),_0x31086e=uuid['v4']()[_0x30c6f0(0x1a4)](0x0,0xa)+'.png',_0x312790=Buffer[_0x30c6f0(0x163)](_0x41d7f6,_0x30c6f0(0x277));_0x27016f[_0x30c6f0(0x266)](this['fileService'][_0x30c6f0(0x1d5)]({'filename':_0x31086e,'buffer':_0x312790}));}const _0x322ba4=(0x0,utils_1['getClientIp'])(_0x165ed5),_0x44cd5b=await Promise[_0x30c6f0(0x124)](_0x27016f),[_0x2a8cad,_0x9409cd]=_0x121e14[_0x30c6f0(0x290)]['split']('x'),_0x3f5067=_0x44cd5b['map'](_0x4c37e6=>{const _0x7e569c=_0x30c6f0;return this[_0x7e569c(0x129)]['saveChatLog']({'curIp':_0x322ba4,'logType':0x3,'answer':_0x4c37e6,'totalTokens':0x0,'promptTokens':0x0,'model':'DALL-E2','userId':_0x165ed5[_0x7e569c(0x1b7)]['id'],'prompt':_0x121e14[_0x7e569c(0x1f1)],'completionTokens':0x0,'modelType':model_constant_1[_0x7e569c(0x151)][_0x7e569c(0x26a)],'type':balance_constant_1['DeductionKey'][_0x7e569c(0x265)],'fileInfo':JSON[_0x7e569c(0x15f)]({'width':_0x2a8cad,'height':_0x9409cd,'cosUrl':_0x4c37e6})});}),_0x2e890c=await Promise[_0x30c6f0(0x124)](_0x3f5067);return await this['userService'][_0x30c6f0(0x1f0)](_0x165ed5['user']['id'],_0xa85b20,_0x2e890c[0x0]['id']),_0x44cd5b;}async[_0x659525(0x114)](_0x272290){const _0x33d7e1=_0x659525,{openaiModel3MaxTokens:openaiModel3MaxTokens=0x0,openaiModel3MaxTokensRes:openaiModel3MaxTokensRes=0x0,openaiModel3MaxTokens16k:openaiModel3MaxTokens16k=0x0,openaiModel3MaxTokens16kRes:openaiModel3MaxTokens16kRes=0x0,openaiModel4MaxTokens:openaiModel4MaxTokens=0x0,openaiModel4MaxTokensRes:openaiModel4MaxTokensRes=0x0,openaiModel4MaxTokens32k:openaiModel4MaxTokens32k=0x0,openaiModel4MaxTokens32kRes:openaiModel4MaxTokens32kRes=0x0,openaiBaseUrl:openaiBaseUrl=''}=await this[_0x33d7e1(0x110)][_0x33d7e1(0x22e)]([_0x33d7e1(0x22d),_0x33d7e1(0x15b),_0x33d7e1(0x140),_0x33d7e1(0x26e),'openaiModel4MaxTokens',_0x33d7e1(0x1ab),_0x33d7e1(0x279),_0x33d7e1(0x270),_0x33d7e1(0x296)]);let _0x5f07d7=null,_0x3f7953=null,_0x53b124=null;const {model:_0x326407,maxModelTokens:maxModelTokens=0x0,maxResponseTokens:maxResponseTokens=0x0,proxyUrl:_0x1f7309,key:_0x38ebc}=_0x272290;return _0x326407[_0x33d7e1(0x29a)]()['includes']('gpt-4')&&(_0x326407[_0x33d7e1(0x29a)]()[_0x33d7e1(0x1c9)](_0x33d7e1(0xfe))?(_0x5f07d7=maxModelTokens||openaiModel4MaxTokens32k||0x8000,_0x3f7953=maxResponseTokens||openaiModel4MaxTokens32kRes||0x4000):(_0x5f07d7=maxModelTokens||openaiModel4MaxTokens||0x2000,_0x3f7953=maxResponseTokens||openaiModel4MaxTokensRes||0x1000)),_0x326407[_0x33d7e1(0x29a)]()[_0x33d7e1(0x1c9)](_0x33d7e1(0x136))&&(_0x326407[_0x33d7e1(0x29a)]()['includes'](_0x33d7e1(0x21a))?(_0x5f07d7=maxModelTokens||openaiModel3MaxTokens16k||0x4000,_0x3f7953=maxResponseTokens||openaiModel3MaxTokens16kRes||0x2000):(_0x5f07d7=maxModelTokens||openaiModel3MaxTokens||0x1000,_0x3f7953=maxResponseTokens||openaiModel3MaxTokensRes||0x3e8)),_0x53b124=_0x1f7309||openaiBaseUrl||_0x33d7e1(0x118),_0x3f7953>=_0x5f07d7&&(_0x3f7953=Math[_0x33d7e1(0x176)](_0x5f07d7/0x2),common_1[_0x33d7e1(0x10b)]['debug']('key:\x20'+_0x38ebc+_0x33d7e1(0x29e)+_0x3f7953)),{'key':_0x38ebc,'model':_0x326407,'maxToken':_0x5f07d7,'maxTokenRes':_0x3f7953,'proxyUrl':_0x53b124};}async[_0x659525(0x239)](_0x30ae58){const _0x5c5171=_0x659525;try{const _0x58c295=await this[_0x5c5171(0x20a)]['pptResult'](_0x30ae58),_0x499dc4=await this[_0x5c5171(0x25e)]['findOne']({'where':{'yooTaskId':_0x30ae58[_0x5c5171(0x2a8)]['id']}});if(!_0x499dc4)throw new Error(_0x5c5171(0x11c));_0x499dc4[_0x5c5171(0x205)]=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x205)],_0x499dc4['stateDesc']=_0x58c295[_0x5c5171(0x211)]['state_description'],_0x499dc4[_0x5c5171(0x23b)]=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x23b)],_0x499dc4[_0x5c5171(0x28a)]=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x196)],_0x499dc4[_0x5c5171(0x276)]=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x2b1)],_0x499dc4['downUrl']=_0x58c295['data'][_0x5c5171(0x2b5)],_0x499dc4[_0x5c5171(0x11f)]=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x159)],_0x499dc4['startTime']=_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x1f9)],_0x499dc4[_0x5c5171(0x289)]=_0x58c295['data'][_0x5c5171(0x2b0)],await this['pptTaskEntity']['save'](_0x499dc4),_0x58c295[_0x5c5171(0x211)][_0x5c5171(0x205)]===0x1&&setTimeout(()=>this[_0x5c5171(0x239)](_0x30ae58),0xbb8);}catch(_0x33458f){common_1[_0x5c5171(0x10b)]['error'](_0x33458f[_0x5c5171(0xf6)],_0x5c5171(0x297));}}async[_0x659525(0x16f)](_0x340b7c,_0x3c481f){const _0x3a8c04=_0x659525;try{return this[_0x3a8c04(0x25c)][_0x3a8c04(0x1ff)](async()=>{const _0x5912e9=_0x3a8c04,_0x10b058=await this['modelsService']['getModelByType'](model_constant_1[_0x5912e9(0x151)][_0x5912e9(0x169)]);let _0x58095d={'userId':_0x340b7c[_0x5912e9(0x1b7)]['id'],'type':ppt_constant_1[_0x5912e9(0x11e)][_0x5912e9(0x165)],'title':_0x3c481f[_0x5912e9(0x1eb)],'text':_0x3c481f[_0x5912e9(0x1a0)],'theme':_0x3c481f['theme']};_0x58095d=await this[_0x5912e9(0x25e)]['save'](_0x58095d),await this[_0x5912e9(0x1ad)][_0x5912e9(0x143)](_0x340b7c[_0x5912e9(0x1b7)]['id'],_0x58095d['id'],_0x58095d[_0x5912e9(0x11a)]);const _0x53ede7=await this[_0x5912e9(0x20a)]['pptStructure']({'data':_0x3c481f,'baseURL':_0x10b058[_0x5912e9(0x1df)][_0x5912e9(0x2bd)],'headers':{'AccessToken':_0x10b058[_0x5912e9(0x1df)]['accessToken'],'AccessSecret':_0x10b058[_0x5912e9(0x1df)][_0x5912e9(0x148)]}});return _0x58095d[_0x5912e9(0x1eb)]=_0x53ede7[_0x5912e9(0x211)]['title'],_0x58095d[_0x5912e9(0x2a0)]=_0x53ede7['data']['catalogs'],await this[_0x5912e9(0x25e)][_0x5912e9(0x1b5)](_0x58095d),_0x58095d;});}catch(_0x552e07){throw new common_1[(_0x3a8c04(0x207))](_0x552e07[_0x3a8c04(0xf6)],common_1[_0x3a8c04(0x24e)][_0x3a8c04(0x1e6)]);}}['pptCover'](_0x4d850d,_0x352881){const _0x53a1d4=_0x659525;try{return this['connection'][_0x53a1d4(0x1ff)](async()=>{const _0x28e1d6=_0x53a1d4,_0x521ee6=await this['modelsService'][_0x28e1d6(0x14d)](model_constant_1[_0x28e1d6(0x151)][_0x28e1d6(0x169)]);let _0x4b8edf={'userId':_0x4d850d['user']['id'],'type':ppt_constant_1[_0x28e1d6(0x11e)][_0x28e1d6(0x1c6)],'title':_0x352881[_0x28e1d6(0x1eb)],'text':_0x352881[_0x28e1d6(0x1a0)],'author':_0x352881[_0x28e1d6(0x1ca)],'color':_0x352881[_0x28e1d6(0x113)],'style':_0x352881['style']};_0x4b8edf=await this['pptTaskEntity']['save'](_0x4b8edf),await this[_0x28e1d6(0x1ad)]['debuctBalance4PPT'](_0x4d850d[_0x28e1d6(0x1b7)]['id'],_0x4b8edf['id'],_0x4b8edf[_0x28e1d6(0x11a)]);const _0x391e57=await this[_0x28e1d6(0x20a)][_0x28e1d6(0x235)]({'data':{'title':_0x352881[_0x28e1d6(0x1eb)],'count':_0x352881[_0x28e1d6(0x1a0)],'user_name':_0x352881['author'],'color':_0x352881[_0x28e1d6(0x113)],'style':_0x352881[_0x28e1d6(0x20b)]},'baseURL':_0x521ee6[_0x28e1d6(0x1df)][_0x28e1d6(0x2bd)],'headers':{'AccessToken':_0x521ee6['modelInfo'][_0x28e1d6(0x1aa)],'AccessSecret':_0x521ee6[_0x28e1d6(0x1df)][_0x28e1d6(0x148)]}});return _0x4b8edf[_0x28e1d6(0x250)]=_0x391e57[_0x28e1d6(0x211)],await this['pptTaskEntity'][_0x28e1d6(0x1b5)](_0x4b8edf),_0x4b8edf;});}catch(_0x27baed){throw new common_1[(_0x53a1d4(0x207))](_0x27baed[_0x53a1d4(0xf6)],common_1[_0x53a1d4(0x24e)][_0x53a1d4(0x1e6)]);}}['pptReCover'](_0x5a489a,_0x321626){const _0x5571bf=_0x659525;try{return this[_0x5571bf(0x25c)]['transaction'](async()=>{const _0x2df00b=_0x5571bf,_0x328c08=await this[_0x2df00b(0x1e5)][_0x2df00b(0x14d)](model_constant_1['EModelType'][_0x2df00b(0x169)]);let _0x6e6159={'userId':_0x5a489a[_0x2df00b(0x1b7)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x2df00b(0x1a2)],'title':_0x321626[_0x2df00b(0x1eb)],'text':_0x321626['text'],'author':_0x321626['author'],'coverId':_0x321626[_0x2df00b(0x228)]};_0x6e6159=await this['pptTaskEntity'][_0x2df00b(0x1b5)](_0x6e6159),await this[_0x2df00b(0x1ad)][_0x2df00b(0x143)](_0x5a489a[_0x2df00b(0x1b7)]['id'],_0x6e6159['id'],_0x6e6159[_0x2df00b(0x11a)]);const _0x5e8f57=await this[_0x2df00b(0x20a)][_0x2df00b(0x1e4)]({'data':{'title':_0x321626[_0x2df00b(0x1eb)],'count':_0x321626[_0x2df00b(0x1a0)],'user_name':_0x321626[_0x2df00b(0x1ca)],'cover_id':_0x321626['coverId']},'baseURL':_0x328c08[_0x2df00b(0x1df)][_0x2df00b(0x2bd)],'headers':{'AccessToken':_0x328c08[_0x2df00b(0x1df)][_0x2df00b(0x1aa)],'AccessSecret':_0x328c08['modelInfo'][_0x2df00b(0x148)]}});return _0x6e6159[_0x2df00b(0x250)]=_0x5e8f57['data'],await this[_0x2df00b(0x25e)]['save'](_0x6e6159),_0x6e6159;});}catch(_0x3a92fa){throw new common_1[(_0x5571bf(0x207))](_0x3a92fa[_0x5571bf(0xf6)],common_1[_0x5571bf(0x24e)][_0x5571bf(0x1e6)]);}}['pptCreate'](_0x22db45,_0x5266c9){const _0x153d36=_0x659525;try{return this['connection'][_0x153d36(0x1ff)](async()=>{const _0x379d04=_0x153d36;let _0x5184f8;const _0x2109ef=await this[_0x379d04(0x1e5)][_0x379d04(0x14d)](model_constant_1[_0x379d04(0x151)][_0x379d04(0x169)]);if(_0x5266c9['originTaskId']){_0x5184f8=await this['pptTaskEntity'][_0x379d04(0x14a)]({'where':{'id':_0x5266c9[_0x379d04(0x1a6)]}});if(!_0x5184f8)throw new Error(_0x379d04(0x278));}let _0x46e93e={'userId':_0x22db45[_0x379d04(0x1b7)]['id'],'type':ppt_constant_1['EPPTTaskType']['CREATE'],'title':_0x5266c9[_0x379d04(0x1eb)],'subTitle':_0x5266c9[_0x379d04(0x131)],'text':_0x5266c9[_0x379d04(0x1a0)],'catalogs':_0x5266c9['catalogs'],'contents':_0x5266c9[_0x379d04(0x263)],'author':_0x5266c9[_0x379d04(0x1ca)],'fontName':_0x5266c9[_0x379d04(0x125)],'transition':_0x5266c9[_0x379d04(0x18c)],'complex':_0x5266c9[_0x379d04(0x199)],'coverId':_0x5266c9[_0x379d04(0x228)],'originId':_0x5266c9['originTaskId']};_0x46e93e=await this[_0x379d04(0x25e)][_0x379d04(0x1b5)](_0x46e93e),await this[_0x379d04(0x1ad)]['debuctBalance4PPT'](_0x22db45['user']['id'],_0x46e93e['id'],_0x46e93e[_0x379d04(0x11a)]);const _0x481ada=await this[_0x379d04(0x20a)][_0x379d04(0x241)]({'data':{'text':_0x5266c9[_0x379d04(0x1a0)],'custom_data':{'title':_0x5266c9[_0x379d04(0x1eb)],'sub_title':_0x5266c9['subTitle'],'author':_0x5266c9[_0x379d04(0x1ca)],'catalogs':_0x5266c9['catalogs'],'contents':_0x5266c9[_0x379d04(0x263)]},'cover_id':_0x5266c9[_0x379d04(0x228)],'font_name':_0x5266c9['fontName'],'transition':_0x5266c9[_0x379d04(0x18c)],'complex':_0x5266c9[_0x379d04(0x199)],'user_name':_0x5266c9['author'],'id':_0x5184f8[_0x379d04(0x1d6)]},'baseURL':_0x2109ef['modelInfo'][_0x379d04(0x2bd)],'headers':{'AccessToken':_0x2109ef['modelInfo'][_0x379d04(0x1aa)],'AccessSecret':_0x2109ef['modelInfo'][_0x379d04(0x148)]}});return _0x46e93e[_0x379d04(0x1d6)]=_0x481ada[_0x379d04(0x211)]['id'],await this['pptTaskEntity']['save'](_0x46e93e),setTimeout(()=>this[_0x379d04(0x239)]({'baseURL':_0x2109ef[_0x379d04(0x1df)]['proxyUrl'],'headers':{'AccessToken':_0x2109ef[_0x379d04(0x1df)][_0x379d04(0x1aa)],'AccessSecret':_0x2109ef[_0x379d04(0x1df)]['secret']},'params':{'id':_0x46e93e['yooTaskId']}}),0xbb8),_0x46e93e;});}catch(_0xb5f586){throw new common_1['HttpException'](_0xb5f586['message'],common_1[_0x153d36(0x24e)][_0x153d36(0x1e6)]);}}['pptCreateThesis'](_0x40bf91,_0x43c772){const _0x4bda3d=_0x659525;try{return this[_0x4bda3d(0x25c)]['transaction'](async()=>{const _0x3d9723=_0x4bda3d,_0x28b723=await this[_0x3d9723(0x1e5)][_0x3d9723(0x14d)](model_constant_1[_0x3d9723(0x151)][_0x3d9723(0x169)]);let _0x190c88={'userId':_0x40bf91[_0x3d9723(0x1b7)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x3d9723(0x22a)],'title':_0x43c772[_0x3d9723(0x1eb)],'color':_0x43c772[_0x3d9723(0x113)],'style':_0x43c772[_0x3d9723(0x20b)],'fileUrl':_0x43c772[_0x3d9723(0x258)],'pleader':_0x43c772['pleader'],'advisor':_0x43c772[_0x3d9723(0x27a)],'school':_0x43c772[_0x3d9723(0x166)],'schoolLogo':_0x43c772[_0x3d9723(0x17e)],'schoolPicture':_0x43c772[_0x3d9723(0x234)]};_0x190c88=await this[_0x3d9723(0x25e)][_0x3d9723(0x1b5)](_0x190c88),await this[_0x3d9723(0x1ad)][_0x3d9723(0x143)](_0x40bf91[_0x3d9723(0x1b7)]['id'],_0x190c88['id'],_0x190c88[_0x3d9723(0x11a)]);const _0x3794ea=await this['pptService'][_0x3d9723(0x20d)]({'data':{'file_key':_0x43c772['fileUrl'],'title':_0x43c772[_0x3d9723(0x1eb)],'color':_0x43c772[_0x3d9723(0x113)],'style':_0x43c772['style'],'pleader':_0x43c772[_0x3d9723(0x10c)],'advisor':_0x43c772[_0x3d9723(0x27a)],'school':_0x43c772[_0x3d9723(0x166)],'school_logo':_0x43c772['schoolLogo'],'school_picture':_0x43c772[_0x3d9723(0x234)]},'baseURL':_0x28b723[_0x3d9723(0x1df)][_0x3d9723(0x2bd)],'headers':{'AccessToken':_0x28b723['modelInfo'][_0x3d9723(0x1aa)],'AccessSecret':_0x28b723[_0x3d9723(0x1df)][_0x3d9723(0x148)]}});return _0x190c88['yooTaskId']=_0x3794ea[_0x3d9723(0x211)]['id'],await this['pptTaskEntity'][_0x3d9723(0x1b5)](_0x190c88),setTimeout(()=>this[_0x3d9723(0x239)]({'baseURL':_0x28b723['modelInfo'][_0x3d9723(0x2bd)],'headers':{'AccessToken':_0x28b723[_0x3d9723(0x1df)][_0x3d9723(0x1aa)],'AccessSecret':_0x28b723[_0x3d9723(0x1df)]['secret']},'params':{'id':_0x190c88[_0x3d9723(0x1d6)]}}),0xbb8),_0x190c88;});}catch(_0x51b0f7){throw new common_1['HttpException'](_0x51b0f7[_0x4bda3d(0xf6)],common_1[_0x4bda3d(0x24e)][_0x4bda3d(0x1e6)]);}}['pptCreateFile'](_0x809793,_0x11b7f6){const _0x3df6df=_0x659525;try{return this['connection'][_0x3df6df(0x1ff)](async()=>{const _0x2a3d34=_0x3df6df,_0x450daa=await this['modelsService'][_0x2a3d34(0x14d)](model_constant_1[_0x2a3d34(0x151)][_0x2a3d34(0x169)]);let _0x2ffae4={'userId':_0x809793[_0x2a3d34(0x1b7)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x2a3d34(0x1bf)],'fileUrl':_0x11b7f6[_0x2a3d34(0x258)],'coverId':_0x11b7f6[_0x2a3d34(0x228)],'author':_0x11b7f6[_0x2a3d34(0x1ca)]};_0x2ffae4=await this[_0x2a3d34(0x25e)][_0x2a3d34(0x1b5)](_0x2ffae4),await this[_0x2a3d34(0x1ad)][_0x2a3d34(0x143)](_0x809793[_0x2a3d34(0x1b7)]['id'],_0x2ffae4['id'],_0x2ffae4[_0x2a3d34(0x11a)]);const _0x46bf8f=await this[_0x2a3d34(0x20a)][_0x2a3d34(0x1ef)]({'data':{'file_url':_0x11b7f6[_0x2a3d34(0x258)],'cover_id':_0x11b7f6[_0x2a3d34(0x228)],'user_name':_0x11b7f6[_0x2a3d34(0x1ca)]},'baseURL':_0x450daa[_0x2a3d34(0x1df)]['proxyUrl'],'headers':{'AccessToken':_0x450daa[_0x2a3d34(0x1df)][_0x2a3d34(0x1aa)],'AccessSecret':_0x450daa[_0x2a3d34(0x1df)]['secret']}});return _0x2ffae4['yooTaskId']=_0x46bf8f[_0x2a3d34(0x211)]['id'],await this[_0x2a3d34(0x25e)][_0x2a3d34(0x1b5)](_0x2ffae4),setTimeout(()=>this[_0x2a3d34(0x239)]({'baseURL':_0x450daa['modelInfo'][_0x2a3d34(0x2bd)],'headers':{'AccessToken':_0x450daa[_0x2a3d34(0x1df)]['accessToken'],'AccessSecret':_0x450daa[_0x2a3d34(0x1df)][_0x2a3d34(0x148)]},'params':{'id':_0x2ffae4[_0x2a3d34(0x1d6)]}}),0xbb8),_0x2ffae4;});}catch(_0x436e27){throw new common_1[(_0x3df6df(0x207))](_0x436e27[_0x3df6df(0xf6)],common_1[_0x3df6df(0x24e)]['BAD_REQUEST']);}}[_0x659525(0x27c)](_0x21674c){const _0x487307=_0x659525;return this[_0x487307(0x25e)][_0x487307(0x14a)]({'where':{'id':_0x21674c}});}['pptChangeTheme'](_0x1398a4,_0x2c9882){const _0x76f67f=_0x659525;try{return this[_0x76f67f(0x25c)]['transaction'](async()=>{const _0x46552b=_0x76f67f,_0x462fd9=await this[_0x46552b(0x25e)][_0x46552b(0x14a)]({'where':{'id':_0x2c9882[_0x46552b(0x1a6)]}});if(!_0x462fd9)throw new Error(_0x46552b(0x278));const _0x225afb=await this[_0x46552b(0x1e5)][_0x46552b(0x14d)](model_constant_1[_0x46552b(0x151)][_0x46552b(0x169)]);let _0x971124={'userId':_0x1398a4[_0x46552b(0x1b7)]['id'],'type':ppt_constant_1[_0x46552b(0x11e)][_0x46552b(0x108)],'originId':_0x2c9882[_0x46552b(0x1a6)],'coverId':_0x2c9882[_0x46552b(0x228)],'fontName':_0x2c9882[_0x46552b(0x125)],'transition':_0x2c9882[_0x46552b(0x18c)]};_0x971124=await this[_0x46552b(0x25e)]['save'](_0x971124),await this['userService']['debuctBalance4PPT'](_0x1398a4[_0x46552b(0x1b7)]['id'],_0x971124['id'],_0x971124[_0x46552b(0x11a)]);const _0x50c43c=await this[_0x46552b(0x20a)][_0x46552b(0x101)]({'data':{'id':_0x462fd9[_0x46552b(0x1d6)],'cover_id':_0x2c9882[_0x46552b(0x228)],'font_name':_0x2c9882[_0x46552b(0x125)],'transition':_0x2c9882[_0x46552b(0x18c)]},'baseURL':_0x225afb['modelInfo']['proxyUrl'],'headers':{'AccessToken':_0x225afb[_0x46552b(0x1df)][_0x46552b(0x1aa)],'AccessSecret':_0x225afb['modelInfo'][_0x46552b(0x148)]}});return _0x971124['yooTaskId']=_0x50c43c[_0x46552b(0x211)]['id'],await this['pptTaskEntity'][_0x46552b(0x1b5)](_0x971124),setTimeout(()=>this[_0x46552b(0x239)]({'baseURL':_0x225afb[_0x46552b(0x1df)][_0x46552b(0x2bd)],'headers':{'AccessToken':_0x225afb[_0x46552b(0x1df)]['accessToken'],'AccessSecret':_0x225afb[_0x46552b(0x1df)][_0x46552b(0x148)]},'params':{'id':_0x971124[_0x46552b(0x1d6)]}}),0xbb8),_0x971124;});}catch(_0x18b07f){throw new common_1['HttpException'](_0x18b07f[_0x76f67f(0xf6)],common_1[_0x76f67f(0x24e)]['BAD_REQUEST']);}}[_0x659525(0x2ba)](_0x117cb8,_0x1cae8b){const _0xb587c0=_0x659525;try{return this[_0xb587c0(0x25c)][_0xb587c0(0x1ff)](async()=>{const _0x26326b=_0xb587c0,_0x5773dc=await this[_0x26326b(0x25e)]['findOne']({'where':{'id':_0x1cae8b[_0x26326b(0x1a6)]}});if(!_0x5773dc)throw new Error(_0x26326b(0x278));const _0x198fdf=await this[_0x26326b(0x1e5)][_0x26326b(0x14d)](model_constant_1[_0x26326b(0x151)][_0x26326b(0x169)]);let _0x53737d={'userId':_0x117cb8[_0x26326b(0x1b7)]['id'],'type':ppt_constant_1['EPPTTaskType'][_0x26326b(0x19a)],'originId':_0x1cae8b['originTaskId'],'theme':_0x1cae8b['theme'],'text':_0x1cae8b[_0x26326b(0x1a0)],'complex':_0x1cae8b[_0x26326b(0x199)]?String(_0x1cae8b['complex']):'1','author':_0x1cae8b[_0x26326b(0x1ca)],'fontName':_0x1cae8b['fontName'],'transition':_0x1cae8b[_0x26326b(0x18c)],'slideNumber':_0x1cae8b['slideNumber'],'slideType':_0x1cae8b[_0x26326b(0x17c)]};_0x53737d=await this[_0x26326b(0x25e)][_0x26326b(0x1b5)](_0x53737d),await this[_0x26326b(0x1ad)][_0x26326b(0x143)](_0x117cb8[_0x26326b(0x1b7)]['id'],_0x53737d['id'],_0x53737d['type']);const _0x14a33c=await this[_0x26326b(0x20a)]['pptAddPage']({'data':{'id':_0x5773dc[_0x26326b(0x1d6)],'text':_0x1cae8b[_0x26326b(0x1a0)],'complex':_0x1cae8b[_0x26326b(0x199)],'user_name':_0x1cae8b[_0x26326b(0x1ca)],'font_name':_0x1cae8b[_0x26326b(0x125)],'transition':_0x1cae8b[_0x26326b(0x18c)],'slide_number':_0x1cae8b[_0x26326b(0x157)],'slide_type':_0x1cae8b[_0x26326b(0x17c)],'theme':_0x1cae8b[_0x26326b(0x22c)]},'baseURL':_0x198fdf[_0x26326b(0x1df)][_0x26326b(0x2bd)],'headers':{'AccessToken':_0x198fdf[_0x26326b(0x1df)][_0x26326b(0x1aa)],'AccessSecret':_0x198fdf['modelInfo'][_0x26326b(0x148)]}});return _0x53737d['yooTaskId']=_0x14a33c[_0x26326b(0x211)]['id'],await this[_0x26326b(0x25e)][_0x26326b(0x1b5)](_0x53737d),setTimeout(()=>this[_0x26326b(0x239)]({'baseURL':_0x198fdf[_0x26326b(0x1df)][_0x26326b(0x2bd)],'headers':{'AccessToken':_0x198fdf['modelInfo'][_0x26326b(0x1aa)],'AccessSecret':_0x198fdf[_0x26326b(0x1df)][_0x26326b(0x148)]},'params':{'id':_0x53737d['yooTaskId']}}),0xbb8),_0x53737d;});}catch(_0x42d7b0){throw new common_1[(_0xb587c0(0x207))](_0x42d7b0[_0xb587c0(0xf6)],common_1[_0xb587c0(0x24e)][_0xb587c0(0x1e6)]);}}['pptAddNote'](_0x3a8958,_0x23a336){const _0x2a5b0e=_0x659525;try{return this[_0x2a5b0e(0x25c)][_0x2a5b0e(0x1ff)](async()=>{const _0xef0eea=_0x2a5b0e,_0x2e6e68=await this[_0xef0eea(0x25e)]['findOne']({'where':{'id':_0x23a336[_0xef0eea(0x1a6)]}});if(!_0x2e6e68)throw new Error(_0xef0eea(0x278));const _0x3fa80b=await this[_0xef0eea(0x1e5)]['getModelByType'](model_constant_1['EModelType'][_0xef0eea(0x169)]);let _0x2b1778={'userId':_0x3a8958[_0xef0eea(0x1b7)]['id'],'type':ppt_constant_1[_0xef0eea(0x11e)][_0xef0eea(0x184)],'originId':_0x23a336[_0xef0eea(0x1a6)],'notes':_0x23a336};_0x2b1778=await this[_0xef0eea(0x25e)][_0xef0eea(0x1b5)](_0x2b1778),await this[_0xef0eea(0x1ad)][_0xef0eea(0x143)](_0x3a8958[_0xef0eea(0x1b7)]['id'],_0x2b1778['id'],_0x2b1778[_0xef0eea(0x11a)]);const _0x5f3c7c=await this['pptService'][_0xef0eea(0xf8)]({'data':{..._0x23a336,'id':_0x2e6e68[_0xef0eea(0x1d6)]},'baseURL':_0x3fa80b[_0xef0eea(0x1df)][_0xef0eea(0x2bd)],'headers':{'AccessToken':_0x3fa80b[_0xef0eea(0x1df)]['accessToken'],'AccessSecret':_0x3fa80b['modelInfo'][_0xef0eea(0x148)]}});return _0x2b1778[_0xef0eea(0x1d6)]=_0x5f3c7c[_0xef0eea(0x211)]['id'],await this[_0xef0eea(0x25e)][_0xef0eea(0x1b5)](_0x2b1778),setTimeout(()=>this[_0xef0eea(0x239)]({'baseURL':_0x3fa80b[_0xef0eea(0x1df)][_0xef0eea(0x2bd)],'headers':{'AccessToken':_0x3fa80b[_0xef0eea(0x1df)][_0xef0eea(0x1aa)],'AccessSecret':_0x3fa80b[_0xef0eea(0x1df)][_0xef0eea(0x148)]},'params':{'id':_0x2b1778['yooTaskId']}}),0xbb8),_0x2b1778;});}catch(_0x24bba8){throw new common_1[(_0x2a5b0e(0x207))](_0x24bba8[_0x2a5b0e(0xf6)],common_1[_0x2a5b0e(0x24e)][_0x2a5b0e(0x1e6)]);}}async[_0x659525(0x1ae)](_0x34e671,_0x8531fb){const _0x2770fc=_0x659525,_0x57445b=_0x8531fb[_0x2770fc(0x1b7)]['id'],{page:page=0x1,size:size=0x14,keyword:_0x565c18,userKeyword:_0x31808a}=_0x34e671,_0x5df94e=_0x2770fc(0x160)+(_0x565c18?_0x2770fc(0x2b2)+_0x565c18+_0x2770fc(0x100)+_0x565c18+_0x2770fc(0x1a7):'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x31808a?_0x2770fc(0x1e9)+_0x31808a+_0x2770fc(0x2a9)+_0x31808a+_0x2770fc(0x1a9)+_0x31808a+_0x2770fc(0x1a5)+_0x31808a+_0x2770fc(0x232):'')+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0x57445b?_0x2770fc(0x268)+_0x57445b:'')+'\x0a\x20\x20\x20\x20\x20\x20',_0x342a30=await this[_0x2770fc(0x25c)][_0x2770fc(0x119)](_0x2770fc(0x238)+_0x5df94e+_0x2770fc(0x294)),_0x34ef55=await this[_0x2770fc(0x25c)][_0x2770fc(0x119)]('\x0a\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.type,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.user_id\x20AS\x20userId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.title,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.sub_title\x20AS\x20subTitle,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.TEXT,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.theme,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.catalogs,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.contents,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.notes,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.author,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.color,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.style,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.font_name\x20AS\x20fontName,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.transition,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.complex,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.cover_id\x20AS\x20coverId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.origin_id\x20AS\x20originId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.file_url\x20AS\x20fileUrl,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.pleader,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.advisor,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_logo\x20AS\x20schoolLogo,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.school_picture\x20AS\x20schoolPicture,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_number\x20AS\x20slideNumber,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.slide_type\x20AS\x20slideType,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.yoo_task_id\x20AS\x20yooTaskId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.res_cover\x20AS\x20resCover,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.updatedAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ppt_task\x20p\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u\x20ON\x20p.user_id\x20=\x20u.id\x0a\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x5df94e+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20p.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20'+size+_0x2770fc(0x16b)+(page-0x1)*size+_0x2770fc(0x294));return!(0x0,utils_1[_0x2770fc(0x150)])(this[_0x2770fc(0x12b)])&&_0x34ef55[_0x2770fc(0x27d)](_0xdbffe7=>{const _0x126ab3=_0x2770fc;_0xdbffe7[_0x126ab3(0x15a)]=(0x0,utils_1[_0x126ab3(0x259)])(_0xdbffe7['email']),_0xdbffe7[_0x126ab3(0x153)]=(0x0,utils_1[_0x126ab3(0x259)])(_0xdbffe7['phone']);}),{'rows':_0x34ef55,'count':Number(_0x342a30[0x0]?.[_0x2770fc(0x162)]||0x0)};}async[_0x659525(0x10d)](_0x3f7592,_0x4b15e3){const _0x10fd6d=_0x659525;if(!_0x3f7592['ids']||!_0x3f7592[_0x10fd6d(0x25f)]['length'])return!![];const _0x1b5a06={'id':(0x0,typeorm_1['In'])(_0x3f7592[_0x10fd6d(0x25f)])};return _0x4b15e3&&(_0x1b5a06[_0x10fd6d(0x27b)]=_0x4b15e3),await this['pptTaskEntity'][_0x10fd6d(0x183)](_0x1b5a06,{'delFlag':0x1}),!![];}async['tts'](_0x470fd8,_0x4b8973){const _0x18a550=_0x659525;try{let _0x1175b6='';return await this['connection']['transaction'](async()=>{const _0x3dbf98=_0x3732,_0x43d6b4=(0x0,utils_1[_0x3dbf98(0x24a)])(this['clsService']),{modelInfo:_0x157d47}=await this['modelsService'][_0x3dbf98(0x14d)](model_constant_1[_0x3dbf98(0x151)][_0x3dbf98(0x252)],_0x3dbf98(0x2c1));await this[_0x3dbf98(0x284)]({'prompt':_0x4b8973['request']['text'],'user':_0x470fd8['user'],'currentRequestModel':_0x157d47});const _0x557d5f={'curIp':(0x0,utils_1[_0x3dbf98(0x1f2)])(_0x470fd8),'prompt':_0x4b8973[_0x3dbf98(0x24c)][_0x3dbf98(0x1a0)],'modelId':_0x157d47['id'],'modelType':_0x157d47[_0x3dbf98(0x262)],'answer':'','model':_0x157d47[_0x3dbf98(0xfd)],'role':_0x3dbf98(0x1b7),'userId':_0x470fd8[_0x3dbf98(0x1b7)]['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0x3dbf98(0x261)][_0x3dbf98(0x282)],'logType':0x1,'requestOptions':JSON[_0x3dbf98(0x15f)](_0x4b8973),'saasId':_0x43d6b4},_0x5362bc={..._0x557d5f,'role':_0x3dbf98(0x11d),'requestOptions':JSON[_0x3dbf98(0x15f)]({'prompt':_0x4b8973['request']['text'],'options':{'model':_0x157d47['model']}})};await this['chatLogService'][_0x3dbf98(0x1cd)](_0x557d5f),await this['chatLogService'][_0x3dbf98(0x1cd)](_0x5362bc),await this[_0x3dbf98(0x1ad)]['deductBalance4Chat'](_0x470fd8['user']['id'],_0x157d47,_0x5362bc['id']);const _0x96ccd0={'app':{'appid':_0x157d47[_0x3dbf98(0x1de)],'token':_0x157d47[_0x3dbf98(0x1de)],'cluster':'volcano_tts'},'user':{'uid':String(_0x470fd8[_0x3dbf98(0x1b7)]['id'])},'audio':{'voice_type':'BV700_streaming','encoding':_0x3dbf98(0x23f)},'request':{'reqid':(0x0,crypto_1['randomUUID'])(),'text':_0x4b8973['request'][_0x3dbf98(0x1a0)],'operation':_0x3dbf98(0x119)}},_0x2cb704=await this[_0x3dbf98(0x142)][_0x3dbf98(0x26b)]({'data':_0x96ccd0,'headers':{'Authorization':_0x3dbf98(0x198)+_0x157d47[_0x3dbf98(0x1aa)]}}),_0x1165f2=chat_constant_1['EChatType']['TTS']+'-'+_0x43d6b4+'-'+_0x470fd8[_0x3dbf98(0x1b7)]['id']+'-'+new Date()['getTime']()+'.mp3';let _0x1bf39c=(0x0,path_1[_0x3dbf98(0x246)])(process[_0x3dbf98(0x226)](),_0x3dbf98(0x245),'upload'),_0x18e969='/upload';_0x18e969=_0x18e969+'/'+_0x1165f2;!(0x0,fs_1[_0x3dbf98(0x293)])(_0x1bf39c)&&(0x0,fs_1['mkdirSync'])(_0x1bf39c,{'recursive':!![]});_0x1bf39c=(0x0,path_1['join'])(_0x1bf39c,_0x1165f2),(0x0,fs_1['writeFileSync'])(_0x1bf39c,_0x2cb704['data'],_0x3dbf98(0x277));let _0xedcc96=process[_0x3dbf98(0x18b)][_0x3dbf98(0x285)];_0xedcc96[_0x3dbf98(0x2c0)](_0x3dbf98(0x22f))?_0x1175b6=_0xedcc96+_0x18e969:_0x1175b6=_0x3dbf98(0x2a4)+_0xedcc96+_0x18e969,_0x5362bc[_0x3dbf98(0x103)]=_0x1175b6,await this['chatLogService'][_0x3dbf98(0x1cd)](_0x5362bc);}),_0x1175b6;}catch(_0x3de13b){throw new common_1[(_0x18a550(0x207))](_0x3de13b[_0x18a550(0xf6)],common_1['HttpStatus'][_0x18a550(0x1e6)]);}}async['asr'](_0x38b234,_0x524d74,_0x1c8e1d){const _0xc273ae=_0x659525;try{let _0x9f3032,_0x575bf1;return await this[_0xc273ae(0x25c)]['transaction'](async()=>{const _0xc33c4a=_0xc273ae,_0xc3edd2=(0x0,utils_1['getReqSaasId'])(this[_0xc33c4a(0x12b)]),{modelInfo:_0x68488a}=await this[_0xc33c4a(0x1e5)][_0xc33c4a(0x14d)](model_constant_1['EModelType']['ASR'],_0xc33c4a(0x1c2));await this[_0xc33c4a(0x1ad)][_0xc33c4a(0x212)](_0x38b234[_0xc33c4a(0x1b7)]['id'],_0x68488a);const _0x31a00f={'groupId':_0x1c8e1d,'curIp':(0x0,utils_1['getClientIp'])(_0x38b234),'prompt':_0x524d74,'modelId':_0x68488a['id'],'modelType':_0x68488a['modelType'],'answer':'','model':_0x68488a['model'],'role':_0xc33c4a(0x1b7),'userId':_0x38b234['user']['id'],'completionTokens':0x0,'totalTokens':0x0,'type':balance_constant_1[_0xc33c4a(0x261)][_0xc33c4a(0x282)],'logType':0x1,'requestOptions':JSON[_0xc33c4a(0x15f)]({'url':_0x524d74}),'saasId':_0xc3edd2},_0x366cb5={..._0x31a00f,'role':'assistant','requestOptions':JSON['stringify']({'prompt':_0x524d74,'options':{'model':_0x68488a['model']}})};await this[_0xc33c4a(0x129)][_0xc33c4a(0x1cd)](_0x31a00f),await this[_0xc33c4a(0x129)][_0xc33c4a(0x1cd)](_0x366cb5),await this[_0xc33c4a(0x1ad)][_0xc33c4a(0x1f0)](_0x38b234[_0xc33c4a(0x1b7)]['id'],_0x68488a,_0x366cb5['id']);let _0x51a516=process[_0xc33c4a(0x18b)][_0xc33c4a(0x285)];!/^http/[_0xc33c4a(0x173)](_0x51a516)&&(_0x51a516=_0xc33c4a(0x2a4)+_0x51a516);const _0x2aa86c={'app':{'appid':_0x68488a[_0xc33c4a(0x1de)],'token':_0x68488a[_0xc33c4a(0x1de)],'cluster':_0xc33c4a(0x145)},'user':{'uid':String(_0x38b234[_0xc33c4a(0x1b7)]['id'])},'audio':{'url':_0x524d74,'format':_0x524d74['split']('.')[_0xc33c4a(0x1d7)]()},'request':{'callback':_0x51a516+'/api/chatgpt/notify-asr'}},_0x2e76b9=await this['doubaoService'][_0xc33c4a(0x27f)]({'data':_0x2aa86c,'headers':{'Authorization':_0xc33c4a(0x198)+_0x68488a['accessToken']}});_0x9f3032=_0x2e76b9['id'],_0x575bf1=await this[_0xc33c4a(0x129)]['saveChatLog'](_0x366cb5);}),new Promise(_0x1ee51d=>{const _0x21f70f=_0xc273ae;utils_1['EE'][_0x21f70f(0x106)](chat_constant_1[_0x21f70f(0x14b)][_0x21f70f(0x2a2)]+'-'+_0x9f3032,async _0x25931e=>{const _0x15a013=_0x21f70f;_0x575bf1[_0x15a013(0x103)]=_0x25931e['text'],_0x575bf1=await this['chatLogService']['saveChatLog'](_0x575bf1),_0x1ee51d(_0x575bf1);});});}catch(_0x35044e){throw new common_1['HttpException'](_0x35044e['message'],common_1['HttpStatus']['BAD_REQUEST']);}}[_0x659525(0x2af)](_0x989b93){const _0x37c666=_0x659525;_0x989b93[_0x37c666(0x253)]===0x3e8&&utils_1['EE'][_0x37c666(0x2b3)](chat_constant_1[_0x37c666(0x14b)]['ASR']+'-'+_0x989b93['id'],_0x989b93);}async[_0x659525(0x206)](_0x27a226,_0x3a298c,_0xbafaf5,_0x242073){const _0x1d1aa8=_0x659525;try{let _0x17e89e=_0x1d1aa8(0x200);await this[_0x1d1aa8(0x25c)][_0x1d1aa8(0x1ff)](async()=>{const _0x36cf63=_0x1d1aa8;let _0x22e425=new Date()[_0x36cf63(0x12c)](),_0x2cab19=new Date()[_0x36cf63(0x12c)]();const _0x57c043=_0x27a226[_0x36cf63(0x1b7)]['id'],_0xaebf40=(0x0,utils_1[_0x36cf63(0x24a)])(this[_0x36cf63(0x12b)]),_0x33fba8=chat_constant_1[_0x36cf63(0x14b)][_0x36cf63(0x2a2)]+'-'+_0xaebf40+'-'+_0x57c043+'-'+new Date()[_0x36cf63(0x12c)]()+_0x36cf63(0x231),_0x1136a6=await this[_0x36cf63(0x138)]['upload2Local']({'filename':_0x33fba8,'buffer':_0x242073[_0x36cf63(0x242)]});_0x2cab19=new Date()['getTime'](),console[_0x36cf63(0x1f3)](_0x36cf63(0x2b4),_0x2cab19-_0x22e425),_0x17e89e=_0x1136a6||_0x1136a6;const _0x193beb=await this['asr'](_0x27a226,_0x1136a6,_0xbafaf5?.['options']?.[_0x36cf63(0x28e)]);_0x22e425=new Date()[_0x36cf63(0x12c)](),console['log'](_0x36cf63(0xff),_0x22e425-_0x2cab19),_0xbafaf5['prompt']=_0x193beb[_0x36cf63(0x103)];typeof _0xbafaf5[_0x36cf63(0x102)]===_0x36cf63(0x13d)&&(_0xbafaf5[_0x36cf63(0x102)]=JSON['parse'](_0xbafaf5[_0x36cf63(0x102)]));const _0x1fde6a=await this[_0x36cf63(0x213)](_0xbafaf5,_0x27a226,_0x3a298c,![]);_0x2cab19=new Date()[_0x36cf63(0x12c)](),console[_0x36cf63(0x1f3)](_0x36cf63(0x18f),_0x2cab19-_0x22e425);const _0x416e52=await this[_0x36cf63(0x26b)](_0x27a226,{'request':{'text':_0x1fde6a}});return _0x22e425=new Date()[_0x36cf63(0x12c)](),console[_0x36cf63(0x1f3)](_0x36cf63(0x1f8),_0x22e425-_0x2cab19),_0x416e52;}),_0x3a298c['status'](0xc8)['json'](result_1[_0x1d1aa8(0x1f5)]['success'](_0x17e89e));}catch(_0x46a426){throw new common_1[(_0x1d1aa8(0x207))](_0x46a426[_0x1d1aa8(0xf6)],common_1['HttpStatus'][_0x1d1aa8(0x1e6)]);}}};ChatgptService=__decorate([(0x0,common_1[_0x659525(0x17f)])(),__param(0x0,(0x0,typeorm_2[_0x659525(0x14c)])(pptTask_entity_1[_0x659525(0x222)])),__metadata('design:paramtypes',[typeorm_1['Repository'],nestjs_cls_1['ClsService'],user_service_1['UserService'],file_service_1[_0x659525(0x152)],gpts_service_1[_0x659525(0xfc)],yooPPT_service_1['YooPPTService'],doubao_service_1['DoubaoService'],models_service_1['ModelsService'],chatLog_service_1[_0x659525(0x274)],lumaTask_service_1['LumaTaskService'],badwords_service_1[_0x659525(0x269)],autoreply_service_1[_0x659525(0x1c4)],chatGroup_service_1[_0x659525(0x29d)],globalConfig_service_1[_0x659525(0x24f)],typeorm_1['Connection']])],ChatgptService),exports[_0x659525(0x267)]=ChatgptService;