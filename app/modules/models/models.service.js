'use strict';function _0x46b0(_0x1f3b66,_0x23ee71){const _0x16f448=_0x16f4();return _0x46b0=function(_0x46b023,_0x1e1192){_0x46b023=_0x46b023-0xa7;let _0x55c9bb=_0x16f448[_0x46b023];return _0x55c9bb;},_0x46b0(_0x1f3b66,_0x23ee71);}const _0x2bf7b0=_0x46b0;(function(_0x12073c,_0x30699b){const _0x5e2626=_0x46b0,_0x313af3=_0x12073c();while(!![]){try{const _0x1af7ef=parseInt(_0x5e2626(0xb1))/0x1+parseInt(_0x5e2626(0xdf))/0x2+parseInt(_0x5e2626(0x11b))/0x3*(parseInt(_0x5e2626(0xf6))/0x4)+parseInt(_0x5e2626(0xb4))/0x5+-parseInt(_0x5e2626(0x11a))/0x6+parseInt(_0x5e2626(0xfe))/0x7+-parseInt(_0x5e2626(0xfc))/0x8*(parseInt(_0x5e2626(0x107))/0x9);if(_0x1af7ef===_0x30699b)break;else _0x313af3['push'](_0x313af3['shift']());}catch(_0x2b6200){_0x313af3['push'](_0x313af3['shift']());}}}(_0x16f4,0x6ad8a));var __decorate=this&&this[_0x2bf7b0(0xe9)]||function(_0x6b49a7,_0x4c5562,_0x335669,_0x34d7fe){const _0x5e64ae=_0x2bf7b0;var _0x39f306=arguments['length'],_0x559045=_0x39f306<0x3?_0x4c5562:_0x34d7fe===null?_0x34d7fe=Object[_0x5e64ae(0xbd)](_0x4c5562,_0x335669):_0x34d7fe,_0x44043b;if(typeof Reflect===_0x5e64ae(0x114)&&typeof Reflect[_0x5e64ae(0x121)]===_0x5e64ae(0xcd))_0x559045=Reflect[_0x5e64ae(0x121)](_0x6b49a7,_0x4c5562,_0x335669,_0x34d7fe);else{for(var _0x25e765=_0x6b49a7['length']-0x1;_0x25e765>=0x0;_0x25e765--)if(_0x44043b=_0x6b49a7[_0x25e765])_0x559045=(_0x39f306<0x3?_0x44043b(_0x559045):_0x39f306>0x3?_0x44043b(_0x4c5562,_0x335669,_0x559045):_0x44043b(_0x4c5562,_0x335669))||_0x559045;}return _0x39f306>0x3&&_0x559045&&Object['defineProperty'](_0x4c5562,_0x335669,_0x559045),_0x559045;},__metadata=this&&this[_0x2bf7b0(0xda)]||function(_0x495ccf,_0x59e492){const _0x14cf80=_0x2bf7b0;if(typeof Reflect===_0x14cf80(0x114)&&typeof Reflect[_0x14cf80(0xd9)]===_0x14cf80(0xcd))return Reflect[_0x14cf80(0xd9)](_0x495ccf,_0x59e492);},__param=this&&this[_0x2bf7b0(0xc0)]||function(_0x4d33c5,_0xc77a6c){return function(_0x4a50c1,_0x4f8a8f){_0xc77a6c(_0x4a50c1,_0x4f8a8f,_0x4d33c5);};};Object[_0x2bf7b0(0xea)](exports,_0x2bf7b0(0xf5),{'value':!![]}),exports[_0x2bf7b0(0xc9)]=void 0x0;const common_1=require(_0x2bf7b0(0xc4)),typeorm_1=require(_0x2bf7b0(0xba)),typeorm_2=require(_0x2bf7b0(0x111)),models_entity_1=require(_0x2bf7b0(0xf0)),status_constant_1=require(_0x2bf7b0(0xac)),baidu_1=require(_0x2bf7b0(0xb0)),utils_1=require(_0x2bf7b0(0xf8)),model_constant_1=require(_0x2bf7b0(0xe6)),redisCache_service_1=require('../redisCache/redisCache.service'),user_service_1=require(_0x2bf7b0(0xa8)),redisKey_constant_1=require(_0x2bf7b0(0xb6)),nestjs_cls_1=require(_0x2bf7b0(0xc2));function _0x16f4(){const _0x465024=['sort','modelsEntity','Repository','metadata','__metadata','getModelByType','model','getModelByIds','ModelsEntity','540148hITVsP','useToken\x20+\x20','名称已存在，请修改名称','find','queryModels','reduce','Like','../../common/constants/model.constant','暂未配置音乐模型，请联系管理员','getUserById','__decorate','defineProperty','modelTypes','暂未配置相关模型，请联系管理员！','assign','length','keys','./models.entity','modelName','keyPoolIndexMap','clsService','error','__esModule','388DzoIyD','keyStatus','../../common/utils','proxyUrl','get','message','160XPuVXu','modelDel','4336213hcscuH','DESC','Logger','refreshBaiduAccesstoken','Not','modelSave','forEach','data','findAndCount','477297nvWHgK','keyList','modelType','Injectable','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','MUSIC','HttpException','缺失必要参数！','/v1/models','modelMaps','typeorm','VIP_FREE','BAD_REQUEST','object','keyInfo','update','lifetimeVip','displaySort','RedisCacheService','2292198YimCMH','6546MHBSij','initCalcKey','getCurrentModelKeyInfo','key','getRole','getAllKey','decorate','front','isSuper','../user/user.service','createQueryBuilder','where','delModel','../../common/constants/status.constant','push','floor','HttpStatus','../chatgpt/baidu','576016WTdtoS','findOne','userService','1015660nKinkf','getAccessToken','../../common/constants/redisKey.constant','lockKey','ModelsMapCn','hideString','@nestjs/typeorm','filter','getRandomAudioKey','getOwnPropertyDescriptor','keyType','status','__param','json','nestjs-cls','getModelByName','@nestjs/common','then','redisCacheService','val','onModuleInit','ModelsService','keyPoolMap','key:\x20','vipExpire','function','getRandomKey','UserService','getMusicModel','InjectRepository','map','ClsService','当前未指定特殊模型KEY、前往后台设置！','secret'];_0x16f4=function(){return _0x465024;};return _0x16f4();}let ModelsService=class ModelsService{constructor(_0xedc85f,_0x1e0e98,_0x2d107f,_0x10b35e){const _0x5e6578=_0x2bf7b0;this[_0x5e6578(0xd7)]=_0xedc85f,this[_0x5e6578(0xf3)]=_0x1e0e98,this[_0x5e6578(0xb3)]=_0x2d107f,this[_0x5e6578(0xc6)]=_0x10b35e,this[_0x5e6578(0xeb)]=[],this[_0x5e6578(0x110)]={},this[_0x5e6578(0x108)]={},this[_0x5e6578(0xca)]={},this['keyPoolIndexMap']={};}async[_0x2bf7b0(0xc8)](){const _0x3e2849=_0x2bf7b0;await this[_0x3e2849(0x11c)](),await this[_0x3e2849(0x101)]();}async['getOfficialModels'](){const _0x226062=_0x2bf7b0,_0x2cba42='https://apiv.chatgpt-3.vip',_0x438936=_0x2cba42+_0x226062(0x10f);return await fetch(_0x438936,{'method':_0x226062(0xfa),'headers':{'Authorization':_0x226062(0x10b)}})[_0x226062(0xc5)](async _0x4b4861=>{const _0xa68a43=_0x226062,_0x27622b=await _0x4b4861[_0xa68a43(0xc1)]();return _0x27622b[_0xa68a43(0x105)];});}async[_0x2bf7b0(0x11c)](){const _0x2fc0cd=_0x2bf7b0;this[_0x2fc0cd(0xca)]={},this[_0x2fc0cd(0xf2)]={},this['keyList']={},this[_0x2fc0cd(0x110)]={},this[_0x2fc0cd(0xeb)]=[];const _0xffa466=await this['modelsEntity'][_0x2fc0cd(0xe2)]({'where':{'status':!![]}}),_0x3cef3c=_0xffa466[_0x2fc0cd(0xe4)]((_0x256ca2,_0x15138c)=>{const _0x2e1faa=_0x2fc0cd;return!_0x256ca2[_0x15138c[_0x2e1faa(0xbe)]]?_0x256ca2[_0x15138c['keyType']]=[_0x15138c]:_0x256ca2[_0x15138c[_0x2e1faa(0xbe)]][_0x2e1faa(0xad)](_0x15138c),_0x256ca2;},{});this[_0x2fc0cd(0xeb)]=Object[_0x2fc0cd(0xef)](_0x3cef3c)[_0x2fc0cd(0xd2)](_0x17efdb=>{const _0x5c37b6=_0x2fc0cd;return{'label':status_constant_1[_0x5c37b6(0xb8)][_0x17efdb],'val':_0x17efdb};}),this['modelMaps']=_0x3cef3c,this['keyList']={},_0xffa466[_0x2fc0cd(0x104)](_0xfbd48f=>{const _0x48ea0c=_0x2fc0cd,{keyType:_0x26f847,model:_0x258740,keyWeight:_0x433e8b}=_0xfbd48f;if(!this[_0x48ea0c(0xca)][_0x258740])this[_0x48ea0c(0xca)][_0x258740]=[];for(let _0x269407=0x0;_0x269407<_0x433e8b;_0x269407++){this[_0x48ea0c(0xca)][_0x258740][_0x48ea0c(0xad)](_0xfbd48f);}if(!this[_0x48ea0c(0xf2)][_0x258740])this[_0x48ea0c(0xf2)][_0x258740]=0x0;if(!this[_0x48ea0c(0x108)][_0x26f847])this[_0x48ea0c(0x108)][_0x26f847]={};if(!this[_0x48ea0c(0x108)][_0x26f847][_0x258740])this[_0x48ea0c(0x108)][_0x26f847][_0x258740]=[];this['keyList'][_0x26f847][_0x258740]['push'](_0xfbd48f);});}async[_0x2bf7b0(0xb7)](_0x1729f6,_0x2bc8ca,_0x29c6fb=-0x1){const _0xc8fd65=_0x2bf7b0,_0x385c3b=await this[_0xc8fd65(0xd7)][_0xc8fd65(0x116)]({'id':_0x1729f6},{'status':![],'keyStatus':_0x29c6fb,'remark':_0x2bc8ca});common_1[_0xc8fd65(0x100)][_0xc8fd65(0xf4)](_0xc8fd65(0xcb)+_0x1729f6+'\x20欠费或被官方封禁导致不可用，已被系统自动锁定'),await this['initCalcKey']();}async[_0x2bf7b0(0xc3)](_0x40ff0d){const _0x28cac4=_0x2bf7b0;return this[_0x28cac4(0xd7)][_0x28cac4(0xb2)]({'where':{'modelName':_0x40ff0d}});}async[_0x2bf7b0(0x11d)](_0x4ccadb){const _0x2799fe=_0x2bf7b0;if(!this[_0x2799fe(0xca)][_0x4ccadb])throw new common_1['HttpException']('当前调用模型已经被移除、请重新选择模型！',common_1[_0x2799fe(0xaf)]['BAD_REQUEST']);this['keyPoolIndexMap'][_0x4ccadb]++;const _0xb4b51e=this[_0x2799fe(0xf2)][_0x4ccadb];if(_0xb4b51e>=this[_0x2799fe(0xca)][_0x4ccadb][_0x2799fe(0xee)])this['keyPoolIndexMap'][_0x4ccadb]=0x0;return this[_0x2799fe(0xca)][_0x4ccadb][this[_0x2799fe(0xf2)][_0x4ccadb]];}async[_0x2bf7b0(0xdb)](_0x3cbf33,_0x32ce95){const _0x50e95e=_0x2bf7b0,_0x93a8c6={'modelType':_0x3cbf33,'status':!![],'keyStatus':0x1};_0x32ce95&&(_0x93a8c6['model']=_0x32ce95);const _0x5c618e=await this[_0x50e95e(0xd7)]['find']({'where':_0x93a8c6,'order':{'displaySort':_0x50e95e(0xff)}});if(!_0x5c618e[_0x50e95e(0xee)])throw new Error(_0x50e95e(0xec));const _0x473ed8=_0x5c618e[0x0],_0x3a737a=this[_0x50e95e(0xeb)][_0x50e95e(0xe2)](_0x2b2b3e=>Number(_0x2b2b3e[_0x50e95e(0xc7)])===_0x473ed8[_0x50e95e(0xbe)]);return{'modelTypeInfo':_0x3a737a,'modelInfo':{..._0x473ed8,'topN':0.8,'systemMessage':'','rounds':0x8}};}async['setModel'](_0x552886){const _0x3dd9bc=_0x2bf7b0;try{return await this['modelSave'](_0x552886),await this['initCalcKey'](),_0x552886[_0x3dd9bc(0xbe)]===0x2&&this['refreshBaiduAccesstoken'](),!![];}catch(_0xb25893){console['log']('error:\x20',_0xb25893);throw new common_1[(_0x3dd9bc(0x10d))](_0xb25893[_0x3dd9bc(0xfb)],common_1[_0x3dd9bc(0xaf)][_0x3dd9bc(0x113)]);}}async[_0x2bf7b0(0x103)](_0x479f08){const _0x5a106a=_0x2bf7b0;_0x479f08[_0x5a106a(0xbf)]&&(_0x479f08[_0x5a106a(0xf7)]=0x1);if(_0x479f08['id']){const _0x1533cb=await this['modelsEntity'][_0x5a106a(0xb2)]({'where':{'id':(0x0,typeorm_2[_0x5a106a(0x102)])(_0x479f08['id']),'modelName':_0x479f08[_0x5a106a(0xf1)],'modelType':_0x479f08['modelType']}});if(_0x1533cb)throw new Error('名称已存在，请修改名称');await this[_0x5a106a(0xd7)][_0x5a106a(0x116)]({'id':_0x479f08['id']},_0x479f08);}else{const _0x18da9e=await this['modelsEntity']['findOne']({'where':{'modelName':_0x479f08['modelName'],'modelType':_0x479f08['modelType']}});if(_0x18da9e)throw new Error(_0x5a106a(0xe1));await this[_0x5a106a(0xd7)]['save'](_0x479f08);}}async[_0x2bf7b0(0xab)]({id:_0x4ddf43}){const _0x242433=_0x2bf7b0;if(!_0x4ddf43)throw new common_1[(_0x242433(0x10d))](_0x242433(0x10e),common_1[_0x242433(0xaf)][_0x242433(0x113)]);return await this[_0x242433(0xfd)]([_0x4ddf43]),await this[_0x242433(0x11c)](),!![];}async[_0x2bf7b0(0xfd)](_0x1d756c){const _0x45752a=_0x2bf7b0;if(!_0x1d756c||!_0x1d756c[_0x45752a(0xee)])return!![];return await this[_0x45752a(0xd7)]['delete']({'id':(0x0,typeorm_2['In'])(_0x1d756c)}),!![];}async[_0x2bf7b0(0xe3)](_0x2eccab,_0x5666fc){const _0x10bbaf=_0x2bf7b0,_0x362064=(0x0,utils_1[_0x10bbaf(0x11f)])(this['clsService']),_0x2a40a7=(0x0,utils_1['getUserId'])(this[_0x10bbaf(0xf3)]),{keyType:_0x334dc6,key:_0x342994,status:_0x1aeb8f,model:_0x594121,modelName:_0x47a2b1,modelType:_0x269b46,page:page=0x1,size:size=0xa,upload:_0x565ab1}=_0x5666fc;let _0x1a5989={};_0x594121&&(_0x1a5989[_0x10bbaf(0xdc)]=_0x594121);_0x342994&&(_0x1a5989[_0x10bbaf(0x11e)]=(0x0,typeorm_2['Like'])('%'+_0x342994+'%'));_0x334dc6&&(_0x1a5989['keyType']=_0x334dc6);_0x269b46&&(_0x1a5989[_0x10bbaf(0x109)]=_0x269b46);_0x1aeb8f!==undefined&&(_0x1a5989[_0x10bbaf(0xbf)]=_0x1aeb8f);_0x47a2b1&&(_0x1a5989[_0x10bbaf(0xf1)]=(0x0,typeorm_2[_0x10bbaf(0xe5)])('%'+_0x47a2b1+'%'));_0x565ab1!==undefined&&(_0x1a5989['canUpload']=Boolean(_0x565ab1));!(0x0,utils_1[_0x10bbaf(0xa7)])(this[_0x10bbaf(0xf3)])&&(_0x1a5989[_0x10bbaf(0x122)]=!![],_0x1a5989[_0x10bbaf(0xbf)]=!![]);const [_0x5bc1c3,_0x3cce83]=await this[_0x10bbaf(0xd7)][_0x10bbaf(0x106)]({'where':_0x1a5989,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':'DESC','createdAt':_0x10bbaf(0xff)}});!(0x0,utils_1[_0x10bbaf(0xa7)])(this['clsService'])&&_0x5bc1c3[_0x10bbaf(0x104)](_0x151c04=>{const _0x117d61=_0x10bbaf;_0x151c04[_0x117d61(0x11e)]=(0x0,utils_1[_0x117d61(0xb9)])(_0x151c04[_0x117d61(0x11e)]),_0x151c04[_0x117d61(0xd5)]=(0x0,utils_1['hideString'])(_0x151c04[_0x117d61(0xd5)]),_0x151c04[_0x117d61(0xf9)]=(0x0,utils_1['hideString'])(_0x151c04[_0x117d61(0xf9)]);});if(_0x2a40a7){const _0x10432f=await this['userService'][_0x10bbaf(0xe8)](_0x2a40a7);if(_0x10432f[_0x10bbaf(0xcc)]||_0x10432f[_0x10bbaf(0x117)]){const _0x3ddcff=[];for(let _0x56cfb7=0x0;_0x56cfb7<_0x5bc1c3['length'];_0x56cfb7++){const _0x549cbd=_0x5bc1c3[_0x56cfb7],_0x50c587=redisKey_constant_1[_0x10bbaf(0x112)]+'-'+_0x2a40a7+'-'+_0x549cbd['id'],_0x3f392b=await await this['redisCacheService'][_0x10bbaf(0xfa)]({'key':_0x50c587});_0x3ddcff[_0x10bbaf(0xad)](Object['assign']({},_0x549cbd,{'used':_0x3f392b||0x0}));}return{'rows':_0x3ddcff,'count':_0x3cce83};}}return{'rows':_0x5bc1c3,'count':_0x3cce83};}['getModelById'](_0x46d663){const _0x55265c=_0x2bf7b0;return this['modelsEntity'][_0x55265c(0xb2)]({'where':{'id':_0x46d663}});}[_0x2bf7b0(0xdd)](_0x30068f){const _0x2fe974=_0x2bf7b0;return this['modelsEntity'][_0x2fe974(0xe2)]({'where':{'id':(0x0,typeorm_2['In'])(_0x30068f)}});}async['modelsList'](_0x3998aa=0x0){const _0x10b047=_0x2bf7b0,_0x27654c=(0x0,utils_1['deepClone'])(this[_0x10b047(0x110)]);return Object['keys'](_0x27654c)[_0x10b047(0x104)](_0x1f178a=>{const _0x369286=_0x10b047;let _0x4c87ec=_0x27654c[_0x1f178a];if(_0x3998aa===0x0)_0x4c87ec=_0x4c87ec[_0x369286(0xbb)](_0x2a8376=>Boolean(_0x2a8376[_0x369286(0x122)]))[_0x369286(0xd6)]((_0x27dd33,_0x4300b7)=>_0x4300b7[_0x369286(0x118)]-_0x27dd33[_0x369286(0x118)]);else _0x3998aa===0x2&&(_0x4c87ec=_0x4c87ec[_0x369286(0xbb)](_0x244b6e=>!Boolean(_0x244b6e[_0x369286(0x122)]))[_0x369286(0xd6)]((_0x4d4eee,_0x151aeb)=>_0x151aeb[_0x369286(0x118)]-_0x4d4eee['displaySort']));_0x27654c[_0x1f178a]=_0x4c87ec['map'](_0x45caeb=>Object[_0x369286(0xed)]({},_0x45caeb));}),{'modelTypeList':this[_0x10b047(0xeb)],'modelMaps':_0x27654c};}async['saveUseLog'](_0x4739ba,_0x2ecf7d){const _0x14296c=_0x2bf7b0;await this['modelsEntity'][_0x14296c(0xa9)]()[_0x14296c(0x116)](models_entity_1['ModelsEntity'])['set']({'useCount':()=>'useCount\x20+\x201','useToken':()=>_0x14296c(0xe0)+_0x2ecf7d})[_0x14296c(0xaa)]('id\x20=\x20:id',{'id':_0x4739ba})['execute']();}async[_0x2bf7b0(0x101)](){const _0x3ac328=_0x2bf7b0,_0x540560=await this[_0x3ac328(0xd7)][_0x3ac328(0xe2)]({'where':{'keyType':0x2}}),_0xb1c78={};_0x540560[_0x3ac328(0x104)](_0x4da0e9=>{const _0x49b72b=_0x3ac328,{key:_0x13e14a,secret:_0x151e30}=_0x4da0e9;!_0xb1c78[_0x49b72b(0x11e)]?_0xb1c78[_0x13e14a]=[{'keyInfo':_0x4da0e9}]:_0xb1c78[_0x13e14a][_0x49b72b(0xad)](_0x4da0e9);}),Object[_0x3ac328(0xef)](_0xb1c78)['forEach'](async _0x33fa3a=>{const _0x3a6ff3=_0x3ac328,{secret:_0x29046b,id:_0x47c797}=_0xb1c78[_0x33fa3a][0x0][_0x3a6ff3(0x115)],_0x58f281=await(0x0,baidu_1[_0x3a6ff3(0xb5)])(_0x33fa3a,_0x29046b);await this['modelsEntity'][_0x3a6ff3(0x116)]({'key':_0x33fa3a},{'accessToken':_0x58f281});}),setTimeout(()=>{const _0x4c3444=_0x3ac328;this[_0x4c3444(0x11c)]();},0x3e8);}async[_0x2bf7b0(0xce)](_0x2a29be){const _0x4dff72=_0x2bf7b0,_0x1aa562=await this[_0x4dff72(0xd7)]['find']({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x2a29be},'order':{'displaySort':_0x4dff72(0xff)}});if(!_0x1aa562[_0x4dff72(0xee)])throw new common_1[(_0x4dff72(0x10d))](_0x4dff72(0xd4),common_1[_0x4dff72(0xaf)][_0x4dff72(0x113)]);return _0x1aa562[0x0];}async[_0x2bf7b0(0xbc)](){const _0x376493=_0x2bf7b0,_0x4abbc1=await this[_0x376493(0xd7)]['find']({'where':{'status':!![],'keyStatus':0x1,'canAudio':!![]}});if(!_0x4abbc1[_0x376493(0xee)])throw new common_1['HttpException']('当前未指定语音对话模型KEY、前往后台设置把！',common_1[_0x376493(0xaf)][_0x376493(0x113)]);return _0x4abbc1[0x0];}async[_0x2bf7b0(0x120)](){const _0x3158e1=_0x2bf7b0;return await this[_0x3158e1(0xd7)][_0x3158e1(0xe2)]();}async[_0x2bf7b0(0xd0)](){const _0x215e9d=_0x2bf7b0;try{const _0x318281=await this[_0x215e9d(0xd7)][_0x215e9d(0xe2)]({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1['EModelType'][_0x215e9d(0x10c)]}});if(_0x318281[_0x215e9d(0xee)]===0x0)throw new Error(_0x215e9d(0xe7));return _0x318281[Math[_0x215e9d(0xae)](Math['random']()*_0x318281['length'])];}catch(_0x943fc2){throw new common_1['HttpException'](_0x943fc2[_0x215e9d(0xfb)],common_1[_0x215e9d(0xaf)][_0x215e9d(0x113)]);}}};ModelsService=__decorate([(0x0,common_1[_0x2bf7b0(0x10a)])(),__param(0x0,(0x0,typeorm_1[_0x2bf7b0(0xd1)])(models_entity_1[_0x2bf7b0(0xde)])),__metadata('design:paramtypes',[typeorm_2[_0x2bf7b0(0xd8)],nestjs_cls_1[_0x2bf7b0(0xd3)],user_service_1[_0x2bf7b0(0xcf)],redisCache_service_1[_0x2bf7b0(0x119)]])],ModelsService),exports[_0x2bf7b0(0xc9)]=ModelsService;