'use strict';const _0x11100b=_0x425e;function _0x425e(_0x3b4596,_0x1c1656){const _0x4d8eb7=_0x4d8e();return _0x425e=function(_0x425edf,_0x48f999){_0x425edf=_0x425edf-0x194;let _0x325d2d=_0x4d8eb7[_0x425edf];return _0x325d2d;},_0x425e(_0x3b4596,_0x1c1656);}(function(_0xb91bcc,_0x1d94cc){const _0x5eb31d=_0x425e,_0x519343=_0xb91bcc();while(!![]){try{const _0x2f55b6=parseInt(_0x5eb31d(0x1b6))/0x1+parseInt(_0x5eb31d(0x1ab))/0x2+parseInt(_0x5eb31d(0x20e))/0x3*(parseInt(_0x5eb31d(0x1fc))/0x4)+parseInt(_0x5eb31d(0x1b5))/0x5*(parseInt(_0x5eb31d(0x1a1))/0x6)+parseInt(_0x5eb31d(0x1ae))/0x7+-parseInt(_0x5eb31d(0x201))/0x8*(parseInt(_0x5eb31d(0x1bc))/0x9)+parseInt(_0x5eb31d(0x1cf))/0xa*(-parseInt(_0x5eb31d(0x1aa))/0xb);if(_0x2f55b6===_0x1d94cc)break;else _0x519343['push'](_0x519343['shift']());}catch(_0x5e2450){_0x519343['push'](_0x519343['shift']());}}}(_0x4d8e,0xa1516));var __decorate=this&&this[_0x11100b(0x208)]||function(_0x1d6418,_0x1b3cd0,_0x2cd333,_0x266b89){const _0x331c65=_0x11100b;var _0x5066d=arguments[_0x331c65(0x1df)],_0x7d8ade=_0x5066d<0x3?_0x1b3cd0:_0x266b89===null?_0x266b89=Object[_0x331c65(0x1d9)](_0x1b3cd0,_0x2cd333):_0x266b89,_0x4e2359;if(typeof Reflect===_0x331c65(0x1a5)&&typeof Reflect[_0x331c65(0x20f)]===_0x331c65(0x1db))_0x7d8ade=Reflect[_0x331c65(0x20f)](_0x1d6418,_0x1b3cd0,_0x2cd333,_0x266b89);else{for(var _0x15566c=_0x1d6418[_0x331c65(0x1df)]-0x1;_0x15566c>=0x0;_0x15566c--)if(_0x4e2359=_0x1d6418[_0x15566c])_0x7d8ade=(_0x5066d<0x3?_0x4e2359(_0x7d8ade):_0x5066d>0x3?_0x4e2359(_0x1b3cd0,_0x2cd333,_0x7d8ade):_0x4e2359(_0x1b3cd0,_0x2cd333))||_0x7d8ade;}return _0x5066d>0x3&&_0x7d8ade&&Object['defineProperty'](_0x1b3cd0,_0x2cd333,_0x7d8ade),_0x7d8ade;},__metadata=this&&this[_0x11100b(0x1d5)]||function(_0xee6692,_0x335a77){const _0x35c142=_0x11100b;if(typeof Reflect==='object'&&typeof Reflect['metadata']===_0x35c142(0x1db))return Reflect[_0x35c142(0x1d7)](_0xee6692,_0x335a77);},__param=this&&this['__param']||function(_0x3bbaf9,_0x2d34c5){return function(_0x533e19,_0xc4e8bb){_0x2d34c5(_0x533e19,_0xc4e8bb,_0x3bbaf9);};};Object[_0x11100b(0x1bf)](exports,'__esModule',{'value':!![]}),exports['ModelsService']=void 0x0;const common_1=require(_0x11100b(0x1e0)),typeorm_1=require(_0x11100b(0x1f6)),typeorm_2=require('typeorm'),models_entity_1=require('./models.entity'),status_constant_1=require(_0x11100b(0x1fe)),baidu_1=require(_0x11100b(0x1e4)),utils_1=require(_0x11100b(0x1b4)),model_constant_1=require(_0x11100b(0x1dd)),redisCache_service_1=require('../redisCache/redisCache.service'),user_service_1=require(_0x11100b(0x1f8)),redisKey_constant_1=require(_0x11100b(0x20d)),nestjs_cls_1=require('nestjs-cls');let ModelsService=class ModelsService{constructor(_0x434a0d,_0x181bac,_0x4b9147,_0x2e5f03){const _0x4e7c82=_0x11100b;this[_0x4e7c82(0x1e3)]=_0x434a0d,this[_0x4e7c82(0x1ad)]=_0x181bac,this[_0x4e7c82(0x1a9)]=_0x4b9147,this[_0x4e7c82(0x199)]=_0x2e5f03,this[_0x4e7c82(0x1d2)]=[],this['modelMaps']={},this[_0x4e7c82(0x200)]={},this[_0x4e7c82(0x1a6)]={},this[_0x4e7c82(0x1ac)]={};}async['onModuleInit'](){const _0x216117=_0x11100b;await this[_0x216117(0x1e8)](),await this['refreshBaiduAccesstoken']();}async['getOfficialModels'](){const _0x4dd9a5=_0x11100b,_0x1015c9=_0x4dd9a5(0x1a0),_0x539cf7=_0x1015c9+_0x4dd9a5(0x1d8);return await fetch(_0x539cf7,{'method':_0x4dd9a5(0x1a2),'headers':{'Authorization':_0x4dd9a5(0x1f3)}})[_0x4dd9a5(0x19b)](async _0x44f59a=>{const _0x9ce191=_0x4dd9a5,_0x2a313a=await _0x44f59a[_0x9ce191(0x1e6)]();return _0x2a313a[_0x9ce191(0x1e9)];});}async[_0x11100b(0x1e8)](){const _0x2395cd=_0x11100b;this[_0x2395cd(0x1a6)]={},this[_0x2395cd(0x1ac)]={},this[_0x2395cd(0x200)]={},this[_0x2395cd(0x19a)]={},this['modelTypes']=[];const _0x41e1c3=await this['modelsEntity'][_0x2395cd(0x1fb)]({'where':{'status':!![]}}),_0x970442=_0x41e1c3['reduce']((_0xdf1407,_0x43e59a)=>{const _0x507f7d=_0x2395cd;return!_0xdf1407[_0x43e59a[_0x507f7d(0x1cb)]]?_0xdf1407[_0x43e59a[_0x507f7d(0x1cb)]]=[_0x43e59a]:_0xdf1407[_0x43e59a['keyType']][_0x507f7d(0x1ec)](_0x43e59a),_0xdf1407;},{});this[_0x2395cd(0x1d2)]=Object[_0x2395cd(0x1b8)](_0x970442)[_0x2395cd(0x1eb)](_0x40ab46=>{const _0x289296=_0x2395cd;return{'label':status_constant_1[_0x289296(0x1ce)][_0x40ab46],'val':_0x40ab46};}),this[_0x2395cd(0x19a)]=_0x970442,this[_0x2395cd(0x200)]={},_0x41e1c3[_0x2395cd(0x1c4)](_0x212e22=>{const _0x20f45f=_0x2395cd,{keyType:_0x528414,model:_0xa27e47,keyWeight:_0x4d340d}=_0x212e22;if(!this['keyPoolMap'][_0xa27e47])this[_0x20f45f(0x1a6)][_0xa27e47]=[];for(let _0x2c8180=0x0;_0x2c8180<_0x4d340d;_0x2c8180++){this[_0x20f45f(0x1a6)][_0xa27e47]['push'](_0x212e22);}if(!this['keyPoolIndexMap'][_0xa27e47])this['keyPoolIndexMap'][_0xa27e47]=0x0;if(!this[_0x20f45f(0x200)][_0x528414])this[_0x20f45f(0x200)][_0x528414]={};if(!this[_0x20f45f(0x200)][_0x528414][_0xa27e47])this['keyList'][_0x528414][_0xa27e47]=[];this[_0x20f45f(0x200)][_0x528414][_0xa27e47][_0x20f45f(0x1ec)](_0x212e22);});}async['lockKey'](_0x4c4e9f,_0xe03072,_0x107058=-0x1){const _0x47d660=_0x11100b,_0x5e3d19=await this[_0x47d660(0x1e3)]['update']({'id':_0x4c4e9f},{'status':![],'keyStatus':_0x107058,'remark':_0xe03072});common_1[_0x47d660(0x1af)][_0x47d660(0x1fd)](_0x47d660(0x1a4)+_0x4c4e9f+_0x47d660(0x19d)),await this['initCalcKey']();}async[_0x11100b(0x202)](_0x5b64f5){const _0x4208d2=_0x11100b;return this['modelsEntity'][_0x4208d2(0x1f0)]({'where':{'modelName':_0x5b64f5}});}async[_0x11100b(0x1c9)](_0x52529b){const _0x539d25=_0x11100b;if(!this[_0x539d25(0x1a6)][_0x52529b])throw new common_1[(_0x539d25(0x1bd))](_0x539d25(0x1d6),common_1[_0x539d25(0x1dc)][_0x539d25(0x1f7)]);this[_0x539d25(0x1ac)][_0x52529b]++;const _0x2667d8=this[_0x539d25(0x1ac)][_0x52529b];if(_0x2667d8>=this[_0x539d25(0x1a6)][_0x52529b][_0x539d25(0x1df)])this['keyPoolIndexMap'][_0x52529b]=0x0;return this[_0x539d25(0x1a6)][_0x52529b][this[_0x539d25(0x1ac)][_0x52529b]];}async[_0x11100b(0x1d3)](_0x27f4bd,_0x34580d){const _0x422781=_0x11100b,_0x20c8a7={'modelType':_0x27f4bd,'status':!![],'keyStatus':0x1};_0x34580d&&(_0x20c8a7[_0x422781(0x1c2)]=_0x34580d);const _0x30877a=await this[_0x422781(0x1e3)][_0x422781(0x1fb)]({'where':_0x20c8a7,'order':{'displaySort':_0x422781(0x1b0)}});if(!_0x30877a[_0x422781(0x1df)])throw new Error('暂未配置相关模型，请联系管理员！');const _0x1493ed=_0x30877a[0x0],_0x9b5cb=this[_0x422781(0x1d2)][_0x422781(0x1fb)](_0x1dd40d=>Number(_0x1dd40d[_0x422781(0x1cd)])===_0x1493ed[_0x422781(0x1cb)]);return{'modelTypeInfo':_0x9b5cb,'modelInfo':{..._0x1493ed,'topN':0.8,'systemMessage':'','rounds':0x8}};}async['setModel'](_0x5727a3){const _0x12792e=_0x11100b;try{return await this['modelSave'](_0x5727a3),await this[_0x12792e(0x1e8)](),_0x5727a3['keyType']===0x2&&this[_0x12792e(0x195)](),!![];}catch(_0x24305f){console[_0x12792e(0x1a3)](_0x12792e(0x19f),_0x24305f);throw new common_1[(_0x12792e(0x1bd))](_0x24305f['message'],common_1['HttpStatus'][_0x12792e(0x1f7)]);}}async[_0x11100b(0x1f4)](_0x4b50e0){const _0x3f105e=_0x11100b;_0x4b50e0[_0x3f105e(0x1a8)]&&(_0x4b50e0[_0x3f105e(0x1ff)]=0x1);if(_0x4b50e0['id']){const _0x472482=await this[_0x3f105e(0x1e3)][_0x3f105e(0x1f0)]({'where':{'id':(0x0,typeorm_2['Not'])(_0x4b50e0['id']),'modelName':_0x4b50e0[_0x3f105e(0x204)],'modelType':_0x4b50e0[_0x3f105e(0x1c5)]}});if(_0x472482)throw new Error('名称已存在，请修改名称');await this[_0x3f105e(0x1e3)][_0x3f105e(0x1ca)]({'id':_0x4b50e0['id']},_0x4b50e0);}else{const _0x48dd88=await this[_0x3f105e(0x1e3)][_0x3f105e(0x1f0)]({'where':{'modelName':_0x4b50e0[_0x3f105e(0x204)],'modelType':_0x4b50e0[_0x3f105e(0x1c5)]}});if(_0x48dd88)throw new Error(_0x3f105e(0x1c7));await this[_0x3f105e(0x1e3)][_0x3f105e(0x1e2)](_0x4b50e0);}}async[_0x11100b(0x1b1)]({id:_0x13d54f}){const _0x43701d=_0x11100b;if(!_0x13d54f)throw new common_1[(_0x43701d(0x1bd))]('缺失必要参数！',common_1[_0x43701d(0x1dc)][_0x43701d(0x1f7)]);return await this['modelDel']([_0x13d54f]),await this['initCalcKey'](),!![];}async[_0x11100b(0x1da)](_0x52f300){const _0x1d56e2=_0x11100b;if(!_0x52f300||!_0x52f300[_0x1d56e2(0x1df)])return!![];return await this[_0x1d56e2(0x1e3)][_0x1d56e2(0x1ee)]({'id':(0x0,typeorm_2['In'])(_0x52f300)}),!![];}async[_0x11100b(0x1de)](_0x414ae8,_0x1d167b){const _0x3c388f=_0x11100b,_0x194ff0=(0x0,utils_1[_0x3c388f(0x197)])(this[_0x3c388f(0x1ad)]),_0x1e62fa=(0x0,utils_1[_0x3c388f(0x1be)])(this[_0x3c388f(0x1ad)]),{keyType:_0x45e5bf,key:_0x135cbb,status:_0x1b7c65,model:_0x277c59,modelName:_0x5bdbfa,modelType:_0x43dd9c,page:page=0x1,size:size=0xa,upload:_0x190aea}=_0x1d167b;let _0x5e9dc6={};_0x277c59&&(_0x5e9dc6[_0x3c388f(0x1c2)]=_0x277c59);_0x135cbb&&(_0x5e9dc6[_0x3c388f(0x20a)]=(0x0,typeorm_2[_0x3c388f(0x194)])('%'+_0x135cbb+'%'));_0x45e5bf&&(_0x5e9dc6[_0x3c388f(0x1cb)]=_0x45e5bf);_0x43dd9c&&(_0x5e9dc6[_0x3c388f(0x1c5)]=_0x43dd9c);_0x1b7c65!==undefined&&(_0x5e9dc6['status']=_0x1b7c65);_0x5bdbfa&&(_0x5e9dc6['modelName']=(0x0,typeorm_2['Like'])('%'+_0x5bdbfa+'%'));_0x190aea!==undefined&&(_0x5e9dc6[_0x3c388f(0x1bb)]=Boolean(_0x190aea));!(0x0,utils_1[_0x3c388f(0x1ba)])(this[_0x3c388f(0x1ad)])&&(_0x5e9dc6[_0x3c388f(0x20b)]=!![],_0x5e9dc6[_0x3c388f(0x1a8)]=!![]);const [_0xecb3a1,_0x4dff43]=await this[_0x3c388f(0x1e3)][_0x3c388f(0x1f1)]({'where':_0x5e9dc6,'skip':(page-0x1)*size,'take':size,'order':{'displaySort':_0x3c388f(0x1b0),'createdAt':'DESC'}});!(0x0,utils_1[_0x3c388f(0x1ba)])(this[_0x3c388f(0x1ad)])&&_0xecb3a1[_0x3c388f(0x1c4)](_0x2e9884=>{const _0x5795ca=_0x3c388f;_0x2e9884[_0x5795ca(0x20a)]=(0x0,utils_1['hideString'])(_0x2e9884['key']),_0x2e9884[_0x5795ca(0x1cc)]=(0x0,utils_1[_0x5795ca(0x1c0)])(_0x2e9884['secret']),_0x2e9884['proxyUrl']=(0x0,utils_1['hideString'])(_0x2e9884[_0x5795ca(0x1b2)]);});if(_0x1e62fa){const _0x3c21d5=await this['userService']['getUserById'](_0x1e62fa);if(_0x3c21d5['vipExpire']||_0x3c21d5['lifetimeVip']){const _0x51087c=[];for(let _0x5d7188=0x0;_0x5d7188<_0xecb3a1['length'];_0x5d7188++){const _0x3e7c22=_0xecb3a1[_0x5d7188],_0x272ac1=redisKey_constant_1['VIP_FREE']+'-'+_0x1e62fa+'-'+_0x3e7c22['id'],_0x2453b6=await await this[_0x3c388f(0x199)]['get']({'key':_0x272ac1});_0x51087c['push'](Object['assign']({},_0x3e7c22,{'used':_0x2453b6||0x0}));}return{'rows':_0x51087c,'count':_0x4dff43};}}return{'rows':_0xecb3a1,'count':_0x4dff43};}[_0x11100b(0x20c)](_0x41a93e){const _0x210dab=_0x11100b;return this[_0x210dab(0x1e3)]['findOne']({'where':{'id':_0x41a93e}});}[_0x11100b(0x1e1)](_0x1f6400){const _0x28fa42=_0x11100b;return this[_0x28fa42(0x1e3)][_0x28fa42(0x1fb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x1f6400)}});}async[_0x11100b(0x1d4)](_0x506806=0x0){const _0xb33100=_0x11100b,_0x25c54c=(0x0,utils_1[_0xb33100(0x1ea)])(this[_0xb33100(0x19a)]);return Object[_0xb33100(0x1b8)](_0x25c54c)[_0xb33100(0x1c4)](_0x216f1d=>{const _0x3160a1=_0xb33100;let _0x952b09=_0x25c54c[_0x216f1d];if(_0x506806===0x0)_0x952b09=_0x952b09[_0x3160a1(0x207)](_0x14eee8=>Boolean(_0x14eee8[_0x3160a1(0x20b)]))[_0x3160a1(0x1fa)]((_0x1580a2,_0x53a399)=>_0x53a399[_0x3160a1(0x1f5)]-_0x1580a2[_0x3160a1(0x1f5)]);else _0x506806===0x2&&(_0x952b09=_0x952b09[_0x3160a1(0x207)](_0x19c72f=>!Boolean(_0x19c72f[_0x3160a1(0x20b)]))[_0x3160a1(0x1fa)]((_0x14a07d,_0x445eb9)=>_0x445eb9[_0x3160a1(0x1f5)]-_0x14a07d[_0x3160a1(0x1f5)]));_0x25c54c[_0x216f1d]=_0x952b09[_0x3160a1(0x1eb)](_0x5307f6=>Object[_0x3160a1(0x1d0)]({},_0x5307f6));}),{'modelTypeList':this[_0xb33100(0x1d2)],'modelMaps':_0x25c54c};}async[_0x11100b(0x1e7)](_0x347272,_0x14d775){const _0x2a25e5=_0x11100b;await this['modelsEntity'][_0x2a25e5(0x1c1)]()[_0x2a25e5(0x1ca)](models_entity_1[_0x2a25e5(0x205)])[_0x2a25e5(0x1c8)]({'useCount':()=>_0x2a25e5(0x1e5),'useToken':()=>_0x2a25e5(0x203)+_0x14d775})[_0x2a25e5(0x196)]('id\x20=\x20:id',{'id':_0x347272})['execute']();}async[_0x11100b(0x195)](){const _0x4c4930=_0x11100b,_0x3a4d7c=await this[_0x4c4930(0x1e3)]['find']({'where':{'keyType':0x2}}),_0x21c90c={};_0x3a4d7c[_0x4c4930(0x1c4)](_0x328734=>{const _0xedc3fa=_0x4c4930,{key:_0x45e9ff,secret:_0x568a2e}=_0x328734;!_0x21c90c[_0xedc3fa(0x20a)]?_0x21c90c[_0x45e9ff]=[{'keyInfo':_0x328734}]:_0x21c90c[_0x45e9ff][_0xedc3fa(0x1ec)](_0x328734);}),Object['keys'](_0x21c90c)[_0x4c4930(0x1c4)](async _0x243332=>{const _0x353745=_0x4c4930,{secret:_0x3ae4ac,id:_0x473cf}=_0x21c90c[_0x243332][0x0]['keyInfo'],_0x5dd4cd=await(0x0,baidu_1[_0x353745(0x1f9)])(_0x243332,_0x3ae4ac);await this[_0x353745(0x1e3)]['update']({'key':_0x243332},{'accessToken':_0x5dd4cd});}),setTimeout(()=>{this['initCalcKey']();},0x3e8);}async['getRandomKey'](_0x45c827){const _0x15f121=_0x11100b,_0x1beb3a=await this[_0x15f121(0x1e3)][_0x15f121(0x1fb)]({'where':{'status':!![],'keyStatus':0x1,'modelType':_0x45c827},'order':{'displaySort':_0x15f121(0x1b0)}});if(!_0x1beb3a[_0x15f121(0x1df)])throw new common_1['HttpException'](_0x15f121(0x1f2),common_1[_0x15f121(0x1dc)][_0x15f121(0x1f7)]);return _0x1beb3a[0x0];}async['getRandomAudioKey'](){const _0x38589e=_0x11100b,_0x1a2cdc=await this['modelsEntity'][_0x38589e(0x1fb)]({'where':{'status':!![],'keyStatus':0x1,'canAudio':!![]}});if(!_0x1a2cdc[_0x38589e(0x1df)])throw new common_1[(_0x38589e(0x1bd))](_0x38589e(0x1ef),common_1[_0x38589e(0x1dc)][_0x38589e(0x1f7)]);return _0x1a2cdc[0x0];}async[_0x11100b(0x1b7)](){return await this['modelsEntity']['find']();}async[_0x11100b(0x1c3)](){const _0x229a4e=_0x11100b;try{const _0x33d5bf=await this[_0x229a4e(0x1e3)][_0x229a4e(0x1fb)]({'where':{'status':!![],'keyStatus':0x1,'modelType':model_constant_1[_0x229a4e(0x206)][_0x229a4e(0x1c6)]}});if(_0x33d5bf['length']===0x0)throw new Error(_0x229a4e(0x1a7));return _0x33d5bf[Math['floor'](Math[_0x229a4e(0x19e)]()*_0x33d5bf['length'])];}catch(_0x2e3c2e){throw new common_1[(_0x229a4e(0x1bd))](_0x2e3c2e[_0x229a4e(0x1b9)],common_1['HttpStatus'][_0x229a4e(0x1f7)]);}}};function _0x4d8e(){const _0x1aa21c=['462752rLrlcc','getModelByName','useToken\x20+\x20','modelName','ModelsEntity','EModelType','filter','__decorate','Repository','key','front','getModelById','../../common/constants/redisKey.constant','42SCMEyH','decorate','Like','refreshBaiduAccesstoken','where','getRole','ClsService','redisCacheService','modelMaps','then','design:paramtypes','\x20欠费或被官方封禁导致不可用，已被系统自动锁定','random','error:\x20','https://apiv.chatgpt-3.vip','84198qQDMon','get','log','key:\x20','object','keyPoolMap','暂未配置音乐模型，请联系管理员','status','userService','11YJKlli','2315340MhGiHr','keyPoolIndexMap','clsService','5994016lgqMWG','Logger','DESC','delModel','proxyUrl','ModelsService','../../common/utils','305SsTIyl','319394wvIaVK','getAllKey','keys','message','isSuper','canUpload','90xpHDqC','HttpException','getUserId','defineProperty','hideString','createQueryBuilder','model','getMusicModel','forEach','modelType','MUSIC','名称已存在，请修改名称','set','getCurrentModelKeyInfo','update','keyType','secret','val','ModelsMapCn','32142550PeytOe','assign','Injectable','modelTypes','getModelByType','modelsList','__metadata','当前调用模型已经被移除、请重新选择模型！','metadata','/v1/models','getOwnPropertyDescriptor','modelDel','function','HttpStatus','../../common/constants/model.constant','queryModels','length','@nestjs/common','getModelByIds','save','modelsEntity','../chatgpt/baidu','useCount\x20+\x201','json','saveUseLog','initCalcKey','data','deepClone','map','push','UserService','delete','当前未指定语音对话模型KEY、前往后台设置把！','findOne','findAndCount','当前未指定特殊模型KEY、前往后台设置！','Bearer\x20sk-bSm3FROxNJ1oIkmd5dDc9b582d3d48E09d12E86eF7FfC0C4','modelSave','displaySort','@nestjs/typeorm','BAD_REQUEST','../user/user.service','getAccessToken','sort','find','361168iuhfrL','error','../../common/constants/status.constant','keyStatus','keyList'];_0x4d8e=function(){return _0x1aa21c;};return _0x4d8e();}ModelsService=__decorate([(0x0,common_1[_0x11100b(0x1d1)])(),__param(0x0,(0x0,typeorm_1['InjectRepository'])(models_entity_1[_0x11100b(0x205)])),__metadata(_0x11100b(0x19c),[typeorm_2[_0x11100b(0x209)],nestjs_cls_1[_0x11100b(0x198)],user_service_1[_0x11100b(0x1ed)],redisCache_service_1['RedisCacheService']])],ModelsService),exports[_0x11100b(0x1b3)]=ModelsService;