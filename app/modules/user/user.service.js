'use strict';const _0x1535f2=_0x2b75;(function(_0x488570,_0x227523){const _0x317371=_0x2b75,_0x4470a0=_0x488570();while(!![]){try{const _0x35a473=-parseInt(_0x317371(0x11f))/0x1*(-parseInt(_0x317371(0x129))/0x2)+-parseInt(_0x317371(0x2cb))/0x3*(parseInt(_0x317371(0x182))/0x4)+-parseInt(_0x317371(0x206))/0x5*(-parseInt(_0x317371(0x1aa))/0x6)+-parseInt(_0x317371(0x1f3))/0x7*(-parseInt(_0x317371(0x1e5))/0x8)+-parseInt(_0x317371(0x210))/0x9*(-parseInt(_0x317371(0x20d))/0xa)+parseInt(_0x317371(0x2b8))/0xb*(-parseInt(_0x317371(0x14c))/0xc)+-parseInt(_0x317371(0x2bd))/0xd;if(_0x35a473===_0x227523)break;else _0x4470a0['push'](_0x4470a0['shift']());}catch(_0x2492ff){_0x4470a0['push'](_0x4470a0['shift']());}}}(_0x444c,0x94a12));var __decorate=this&&this[_0x1535f2(0x1e8)]||function(_0x591a9f,_0x362245,_0x5e53d7,_0x382058){const _0x4ac5e5=_0x1535f2;var _0x46f318=arguments[_0x4ac5e5(0x1fd)],_0x2aae34=_0x46f318<0x3?_0x362245:_0x382058===null?_0x382058=Object['getOwnPropertyDescriptor'](_0x362245,_0x5e53d7):_0x382058,_0xb94ccd;if(typeof Reflect===_0x4ac5e5(0x2ce)&&typeof Reflect['decorate']===_0x4ac5e5(0x27d))_0x2aae34=Reflect[_0x4ac5e5(0x1c6)](_0x591a9f,_0x362245,_0x5e53d7,_0x382058);else{for(var _0x36a778=_0x591a9f[_0x4ac5e5(0x1fd)]-0x1;_0x36a778>=0x0;_0x36a778--)if(_0xb94ccd=_0x591a9f[_0x36a778])_0x2aae34=(_0x46f318<0x3?_0xb94ccd(_0x2aae34):_0x46f318>0x3?_0xb94ccd(_0x362245,_0x5e53d7,_0x2aae34):_0xb94ccd(_0x362245,_0x5e53d7))||_0x2aae34;}return _0x46f318>0x3&&_0x2aae34&&Object['defineProperty'](_0x362245,_0x5e53d7,_0x2aae34),_0x2aae34;},__metadata=this&&this[_0x1535f2(0x2c5)]||function(_0x198e78,_0x4c6774){const _0x363ce7=_0x1535f2;if(typeof Reflect===_0x363ce7(0x2ce)&&typeof Reflect[_0x363ce7(0x1d2)]==='function')return Reflect['metadata'](_0x198e78,_0x4c6774);},__param=this&&this[_0x1535f2(0x1dc)]||function(_0xbc4d52,_0xe10059){return function(_0x4b38b3,_0xa94b21){_0xe10059(_0x4b38b3,_0xa94b21,_0xbc4d52);};};Object[_0x1535f2(0x1f7)](exports,_0x1535f2(0x18a),{'value':!![]}),exports[_0x1535f2(0x18e)]=void 0x0;function _0x2b75(_0x2ac86a,_0x526aae){const _0x444cb7=_0x444c();return _0x2b75=function(_0x2b7580,_0x12b86a){_0x2b7580=_0x2b7580-0x11e;let _0x24c231=_0x444cb7[_0x2b7580];return _0x24c231;},_0x2b75(_0x2ac86a,_0x526aae);}function _0x444c(){const _0x1d3539=['deductBalance4WorkFlow','createdAt',']成功!','action','GPTS','\x27,\x200)\x0a\x20\x20\x20\x20\x20\x20\x20\x20','fast_mjDeduction','queryAll','registerBaseUrl','\x20AND\x20u.userId\x20=\x20','message','fast','TTS','../userBalance/userBalance.service','fetch|listbyids|modal|seed','模型【','当前手机号已注册、请勿重复注册！','邮箱格式错误！','maskIpAddress','saasEntity','UNAUTHORIZED','ids','typeorm','修改用户状态失败！','roleSave','description','Not','registerSendStatus','】会员永久免费','getOpenIdByUserId','rolePage','%\x27\x20OR\x20nickname\x20LIKE\x20\x27%','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20saasId\x20=\x20','create','Connection','saasUpdate','pptOutline','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','Invited','visitor','findByIds','getOne','VIEWER','%\x27\x20OR\x20phone\x20LIKE\x20\x27%','vipDays','insertAccountLog','relax_mjDeduction','@nestjs/common','32468ltQKEN','day','updateViolationCount','LOCKED','formatCreateOrUpdateDate','BAD_REQUEST','userInitVip','该微信已绑定其他账号！','__esModule','../redisCache/redisCache.service','turbo_vip_free','checkUserStatus','UserService','miniOpenId','受邀请注册赠送','\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','userCount','relateType','代理商','registerVerifyEmailDesc','MJ绘画【','findAndCount','floor','UserFavoriteEntity','用户名格式错误,\x20用户名只能由字母+数字，且不包含特殊字符','email','VIP_EXPIRE','updateInfo','您的账户已被封禁、如有疑问、请联系管理员！','push','\x27\x20AND\x20(\x20`name`\x20LIKE\x20\x27%','queryUserByUsername','手机号已被使用！','当前密码错误！','用户名已存在！','query','qureyUserInfoByInviteCode','用户名或者邮箱已被注册！','Tts','queryOne','1848ZLHDdx','SUPER','%\x27\x20OR\x20id\x20=\x20\x27','changeScore4registe','add','INSERT\x20IGNORE\x20INTO\x20users\x20(username,\x20password,\x20status,\x20email,\x20role)\x20VALUES\x20(\x27super\x27,\x20\x27','score','user','生成邀请码失败，请重新试一次吧！','Registe','userEntity','invitedRewardVip','updateStatus','@nestjs-modules/mailer','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20INSERT\x20IGNORE\x20INTO\x20user_role\x20(name,\x20code,\x20saasId)\x20VALUES\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x27超级管理员\x27,\x20\x27','userDefautlAvatar','delUser','EModelType','registerVerifyEmailFrom','startOf','bindWx','REDIS_SUBSCRIBER','重置密码失败！','超级管理员不可被操作！','getMjPrice','name','的账号激活','axios','decorate','无效的邀请码！','\x27,\x200),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x27前台用户\x27,\x20\x27','恭喜您绑定成功、后续可直接扫码登录了！','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20*\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','VerificationService','DESC','type2','subscriber','concat','%\x27\x20OR\x20`code`\x20LIKE\x20\x27%','metadata','favorite','filter','design:paramtypes','status','genUserNames','updateUserStatus','UserStatusErrMsg','czVipFree','没有变更，无需更改！','__param','phone','MUSIC','HttpStatusCode','nickname','模板生成PPT','verifyUserCredentials','../../common/constants/user.constant','修改密码失败、请重新试试吧。','10336LNpEPL','transaction','%\x27\x20OR\x20u.email\x20LIKE\x20\x27%','__decorate','registerIp','userInitVipEntity','vipLeavelName','queryUserInfoByIds','save','UserBalanceService','绑定微信失败、请联系管理员！','saasDel','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(saasId\x20=\x20','UserService\x20Init','6377jaAVfX','diff','disabled','inviteRewardVip','defineProperty','./../globalConfig/globalConfig.service','includes','globalConfigService','UserStatusEnum','error:\x20','length','RoleEntity','set','mailerService','createUser','getConfigByKeys','maskEmail','endOf','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20role,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20AS\x20count\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20role\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','10740SvByta','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20saasId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20AS\x20count\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20GROUP\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20saasId\x0a\x20\x20\x20\x20\x20\x20\x20\x20','startsWith','BadRequest','invitedRewards','assign','封面任务','2393630NflsfA','MailerService','hideString','27yMlUkt','__keyevent@0__:expired','文件生成PPT','\x0a\x20\x20\x20\x20\x20\x20\x20\x20','Music','Inject','queryOneUserInfo','cloneDeep','registerVerifyEmailTitle','deductBalance4Chat','超级管理员','insertAccountVipLog','avatar','getUserByInviteCode','%\x27\x20OR\x20u1.email\x20LIKE\x20\x27%','mj-','relax','./userFavorite.entity','EChangeType','initSaasMap','WORKFLOW','violationCount','generateRandomString','ActionCN','updateVipExpire','%\x27\x20OR\x20u1.nickname\x20LIKE\x20\x27%','\x20AND\x20u.saasId\x20=\x20','\x20AND\x20(vipExpire\x20IS\x20NOT\x20NULL\x20OR\x20lifetimeVip\x20=\x201)','前台用户','账号注册时密码不能为空！','redisCacheService','password','refundBalance4Chat','roleDel','get','getReqSaasId','小工具【','APP','修改用户状态成功！','invitePage','getUserStatus','findOne','\x27)\x0a\x20\x20\x20\x20\x20\x20\x20\x20','type3','connection','num','当前用户不存在！','HttpStatus','VipFree','has','getUserById','ACTIVE','type1','userBalanceService','modelType','BLACKLISTED','toDate','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.id,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.avatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.username,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.nickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.phone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.email,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.createdAt,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.id\x20AS\x20inviterId,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.avatar\x20AS\x20inviterAvatar,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.username\x20AS\x20inviterUsername,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.nickname\x20AS\x20inviterNickname,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.phone\x20AS\x20inviterPhone,\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u1.email\x20AS\x20inviterEmail\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x20u\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u1\x20ON\x20u.invitedBy\x20=\x20u1.inviteCode\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','您的账户已被永久加入黑名单、如有疑问、请联系管理员！','size','queryUserInfoById','validateBalance4MJ','domain','DRAW','CZConfig','\x27,\x200),\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(\x27代理商\x27,\x20\x27','openId','不可将用户置为未激活状态！','price','deductBalance4SD','queryByPage','%\x27\x20OR\x20u.phone\x20LIKE\x20\x27%','../../common/constants/midjourney.constant','increment','getVipLeavelRelById','genUserName','deduct','手机号格式错误！','destroyAccount','PPT','code','modelName','inviterEmail','userId','createVerification','vipLeavelId','saasSave','update','VIDEO','\x20AND\x20saasId\x20=\x20','nestjs-cls','roleEntity','getUserOpenId','updateSignDay','createUserAndVerifycation','verifyUserPassword','deductBalance4MJ','key','@nestjs/typeorm','查询用户不存在！','\x20AND\x20(username\x20LIKE\x20\x27%','updateUserPassword','isDefined','用户名已被使用！','OTHER','isVerifyEmail','ERole','CHAT','pptThesis','function','增加PPT单页','relax_vip_free','%\x27\x20)','-SD','role','changeScore4Other','lastLoginIp','affected','client','管理员赠送','czProxyPrice','count','username','valueOf','turbo','】调用失败退还','Repository','\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20ORDER\x20BY\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.createdAt\x20DESC\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LIMIT\x20','HttpException','createBatch','getSaasById','Chat','getMiniOpenIdByUserId','exists','relateId','registerVerifyExpir','hashSync','角色信息不存在！','InvitationReward','ClsService','\x20AND\x20u.createdAt\x20<=\x20\x27','MoreThan','lifetimeVip','VerificationEnum','%\x27\x20OR\x20u1.phone\x20LIKE\x20\x27%','\x20AND\x20(\x20u1.username\x20LIKE\x20\x27%','random','Draw','】会员每日限免','env','test','clsService','VIP_FREE','userFavoriteEntity','updateUserPsd','更换模板','vipFreeKey','DrawSpeed','../../common/constants/verification.constant','UserInitVipEntity','toLowerCase','getUserListByIds','saasName','当前账户不存在！','\x20AND\x20phone\x20LIKE\x20\x27%','inviterPhone','重新生成封面任务','10802pUMcXD','onModuleInit','\x20AND\x20role\x20=\x20\x27','find','compareSync','16217240DjWUNd','inviteRewards','密码重置为[','desc','getEntity','注册赠送','当前角色编码不可用，请使用其他角色编码','FORBIDDEN','__metadata','vipExpire','UserEntity','邮箱已被使用！','isPlatform','PENDING','411vdfQef','isManage','修改用户信息失败！','object','zh-CN','AGENT','shouldAccess','upscale|describe|picread::retry|faceswap|shorten','saasPage','register','968404RiFKvz','countByInviteCode','saasId','ListSaasByIds','SD绘画会员永久免费','】使用扣减','Between','turbo_mjDeduction','vipFreeNum','forEach','2vfXQTD','lodash','Like','../../common/utils/date','GlobalConfigService','registerRewards','bcryptjs','用户不存在！','AdminGift','\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20*\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_role\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20','verificationService','FILE','PPT【','SD绘画【','Registration','../../common/constants/Role.constant','inviteSendStatus','fast_vip_free','verifyUserRegisterByPhone','../../common/utils','default','\x20AND\x20`status`\x20=\x20','isSuper','mj123456admin','super123456','../../common/constants/redisKey.constant','InjectRepository','修改用户信息成功！','log','Tool','then','saasMap','当前用户信息失效、请重新登录！','RedisCacheService','isEmail','6804oIxgCv','pptCreate','map','yes','LessThanOrEqual','delete'];_0x444c=function(){return _0x1d3539;};return _0x444c();}const globalConfig_service_1=require(_0x1535f2(0x1f8)),user_constant_1=require(_0x1535f2(0x1e3)),mailer_1=require(_0x1535f2(0x1b7)),verification_service_1=require('./../verification/verification.service'),common_1=require(_0x1535f2(0x181)),typeorm_1=require(_0x1535f2(0x272)),typeorm_2=require(_0x1535f2(0x168)),user_entity_1=require('./user.entity'),bcrypt=require(_0x1535f2(0x12f)),_=require(_0x1535f2(0x12a)),verification_constant_1=require(_0x1535f2(0x2af)),userBalance_service_1=require(_0x1535f2(0x15f)),utils_1=require(_0x1535f2(0x13c)),balance_constant_1=require('../../common/constants/balance.constant'),class_validator_1=require('class-validator'),redisKey_constant_1=require(_0x1535f2(0x142)),redisCache_service_1=require(_0x1535f2(0x18b)),model_constant_1=require('../../common/constants/model.constant'),midjourney_constant_1=require(_0x1535f2(0x258)),user_init_vip_entity_1=require('./user_init_vip.entity'),axios_1=require(_0x1535f2(0x1c5)),date_1=require(_0x1535f2(0x12c)),saas_entity_1=require('./saas.entity'),role_entity_1=require('./role.entity'),store_1=require('../../common/store'),nestjs_cls_1=require(_0x1535f2(0x26a)),Role_constant_1=require(_0x1535f2(0x138)),userFavorite_entity_1=require(_0x1535f2(0x221));let UserService=class UserService{constructor(_0x5ea9f1,_0x1ba701,_0x3811b9,_0x2b1945,_0x4dd836,_0x52367d,_0x99feee,_0x49bd3e,_0x107afc,_0x28be36,_0x1fd7ec,_0xe092ab,_0x3886ad){const _0x9212b8=_0x1535f2;this[_0x9212b8(0x1cf)]=_0x5ea9f1,this[_0x9212b8(0x1b4)]=_0x1ba701,this[_0x9212b8(0x165)]=_0x3811b9,this[_0x9212b8(0x26b)]=_0x2b1945,this[_0x9212b8(0x1ea)]=_0x4dd836,this[_0x9212b8(0x2aa)]=_0x52367d,this[_0x9212b8(0x2a8)]=_0x99feee,this[_0x9212b8(0x200)]=_0x49bd3e,this['redisCacheService']=_0x107afc,this[_0x9212b8(0x245)]=_0x28be36,this[_0x9212b8(0x1fa)]=_0x1fd7ec,this['verificationService']=_0xe092ab,this[_0x9212b8(0x23c)]=_0x3886ad;}[_0x1535f2(0x2b9)](){const _0x4f2b35=_0x1535f2;console['log'](_0x4f2b35(0x1f2)),this[_0x4f2b35(0x23c)][_0x4f2b35(0x1a5)](_0x4f2b35(0x1b8)+Role_constant_1['ERole'][_0x4f2b35(0x1ab)]+_0x4f2b35(0x251)+Role_constant_1[_0x4f2b35(0x27a)][_0x4f2b35(0x2d0)]+_0x4f2b35(0x1c8)+Role_constant_1['ERole'][_0x4f2b35(0x17c)]+_0x4f2b35(0x157));const _0x7f142b=bcrypt[_0x4f2b35(0x299)](_0x4f2b35(0x141),0xa);this[_0x4f2b35(0x23c)][_0x4f2b35(0x1a5)](_0x4f2b35(0x1af)+_0x7f142b+'\x27,\x20\x271\x27,\x20\x27defaultSuper@cooper.com\x27,\x20\x27'+Role_constant_1[_0x4f2b35(0x27a)][_0x4f2b35(0x1ab)]+'\x27)'),this[_0x4f2b35(0x223)](),this['subscriber']['pSubscribe'](_0x4f2b35(0x211),async _0x38f5ac=>{const _0x1abf24=_0x4f2b35;if(_0x38f5ac[_0x1abf24(0x208)](redisKey_constant_1[_0x1abf24(0x19c)])){const _0x227b6e=_0x38f5ac['replace'](redisKey_constant_1[_0x1abf24(0x19c)],'');this['userEntity'][_0x1abf24(0x267)]({'id':Number(_0x227b6e)},{'vipExpire':null});}});}async[_0x1535f2(0x223)](){const _0x410090=_0x1535f2,_0x486578=await this['saasEntity'][_0x410090(0x2bb)]({'where':{'deleteFlag':0x0}});store_1[_0x410090(0x148)]['clear'](),_0x486578[_0x410090(0x128)](_0x285189=>store_1[_0x410090(0x148)][_0x410090(0x1ff)](_0x285189[_0x410090(0x24e)],_0x285189['id'])),store_1[_0x410090(0x148)][_0x410090(0x1ff)](process[_0x410090(0x2a6)]['GOMAXAI_HOST'],0x0);}[_0x1535f2(0x2c1)](){const _0x1b50c2=_0x1535f2;return this[_0x1b50c2(0x1b4)];}async[_0x1535f2(0x122)](_0x5f4f5d){const _0xdca111=_0x1535f2;if(!_0x5f4f5d[_0xdca111(0x1fd)])return[];return this[_0xdca111(0x165)][_0xdca111(0x2bb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5f4f5d)}});}async[_0x1535f2(0x2d3)](_0x4db308){const _0x2f8164=_0x1535f2,{page:page=0x1,size:size=0x14,keyword:_0x3f593c}=_0x4db308;let _0x25c7d9;_0x3f593c?_0x25c7d9=[{'deleteFlag':0x0,'name':(0x0,typeorm_2[_0x2f8164(0x12b)])('%'+_0x3f593c+'%')},{'deleteFlag':0x0,'domain':(0x0,typeorm_2[_0x2f8164(0x12b)])('%'+_0x3f593c+'%')}]:_0x25c7d9={'deleteFlag':0x0};const [_0x59a61b,_0x114901]=await this[_0x2f8164(0x165)][_0x2f8164(0x197)]({'where':_0x25c7d9,'skip':(page-0x1)*size,'take':size,'order':{'createdAt':_0x2f8164(0x1cd)}});if(!_0x59a61b['length'])return{'rows':[],'count':_0x114901};const _0x20f558=_0x59a61b[_0x2f8164(0x14e)](_0x1efd37=>_0x1efd37['id']),_0x5a7b5b=new Map(),_0x5ea029=await this[_0x2f8164(0x1b4)][_0x2f8164(0x2bb)]({'where':{'saasId':(0x0,typeorm_2['In'])(_0x20f558),'role':Role_constant_1['ERole']['AGENT']}});_0x5ea029[_0x2f8164(0x128)](_0xf68bae=>{const _0x27b475=_0x2f8164;_0x5a7b5b[_0x27b475(0x1ff)](_0xf68bae['saasId'],_0xf68bae);});const _0x3ed4f2=new Map(),_0x12c698=await this['connection'][_0x2f8164(0x1a5)](_0x2f8164(0x207));_0x12c698[_0x2f8164(0x128)](_0x10400d=>_0x3ed4f2[_0x2f8164(0x1ff)](_0x10400d[_0x2f8164(0x121)],_0x10400d[_0x2f8164(0x289)]));const _0x57dd67=_0x59a61b[_0x2f8164(0x14e)](_0x366462=>{const _0x3ab880=_0x2f8164;let _0x4c31b4=null,_0x156ed5=null,_0x11b8e8=null,_0x5affe5=null;const _0x483ab8=_0x5a7b5b[_0x3ab880(0x232)](_0x366462['id']);return _0x483ab8&&(_0x4c31b4=_0x483ab8['username'],_0x156ed5=_0x483ab8[_0x3ab880(0x1e0)],_0x11b8e8=_0x483ab8[_0x3ab880(0x1dd)],_0x5affe5=_0x483ab8[_0x3ab880(0x19b)]),{..._0x366462,'username':_0x4c31b4,'nickname':_0x156ed5,'phone':_0x11b8e8,'email':_0x5affe5,'userCount':_0x3ed4f2[_0x3ab880(0x232)](_0x366462['id'])||0x0};});return{'rows':_0x57dd67,'count':_0x114901};}async[_0x1535f2(0x293)](_0x382b35){const _0x4a5a8f=_0x1535f2;return this[_0x4a5a8f(0x165)][_0x4a5a8f(0x239)]({'where':{'id':_0x382b35}});}async[_0x1535f2(0x266)](_0x56b7bc){const _0x12fdb6=_0x1535f2,_0x56ff47=(0x0,utils_1[_0x12fdb6(0x233)])(this[_0x12fdb6(0x2a8)]);if(_0x56ff47!==0x0)throw new common_1[(_0x12fdb6(0x291))]('非法访问',common_1['HttpStatus'][_0x12fdb6(0x2c4)]);return await this[_0x12fdb6(0x165)]['save'](_0x56b7bc),this['initSaasMap'](),!![];}async[_0x1535f2(0x175)](_0x47a65a){const _0x81e5b6=_0x1535f2,_0x5edd6a=(0x0,utils_1['getReqSaasId'])(this['clsService']);return await this[_0x81e5b6(0x165)][_0x81e5b6(0x1ed)]({..._0x47a65a,'id':_0x5edd6a}),!![];}async[_0x1535f2(0x1f0)](_0x489e5a){const _0x19697b=_0x1535f2;if(!_0x489e5a[_0x19697b(0x167)]||!_0x489e5a[_0x19697b(0x167)][_0x19697b(0x1fd)])return!![];return await this[_0x19697b(0x165)][_0x19697b(0x267)]({'id':(0x0,typeorm_2['In'])(_0x489e5a[_0x19697b(0x167)])},{'deleteFlag':0x1}),!![];}async[_0x1535f2(0x170)](_0x1ce050,_0x44f659){const _0x2fada0=_0x1535f2,_0x5429cf=await(0x0,utils_1[_0x2fada0(0x233)])(this['clsService']),{page:page=0x1,size:size=0x14,keyword:_0x2dc2a1}=_0x44f659;let _0x50aebb=_0x2fada0(0x172)+_0x5429cf+'\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(saasId\x20=\x200\x20AND\x20`code`\x20=\x20\x27'+Role_constant_1[_0x2fada0(0x27a)][_0x2fada0(0x17c)]+_0x2fada0(0x23a);_0x2dc2a1&&(_0x50aebb=_0x2fada0(0x1f1)+_0x5429cf+'\x20AND\x20(\x20`name`\x20LIKE\x20\x27%'+_0x2dc2a1+_0x2fada0(0x1d1)+_0x2dc2a1+'%\x27\x20))\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20OR\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20(saasId\x20=\x200\x20AND\x20`code`\x20=\x20\x27'+Role_constant_1[_0x2fada0(0x27a)][_0x2fada0(0x17c)]+_0x2fada0(0x1a0)+_0x2dc2a1+'%\x27\x20OR\x20`code`\x20LIKE\x20\x27%'+_0x2dc2a1+'%\x27\x20))\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20');const _0x402c83=await this[_0x2fada0(0x23c)]['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20user_role\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x50aebb+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20'),_0x22646c=await this['connection'][_0x2fada0(0x1a5)](_0x2fada0(0x132)+_0x50aebb+_0x2fada0(0x1ca)+size+'\x20OFFSET\x20'+(page-0x1)*size+'\x0a\x20\x20\x20\x20\x20\x20\x20\x20'),_0x4e1448=_0x22646c[_0x2fada0(0x14e)](_0x4e4a90=>_0x4e4a90['id']);if(_0x4e1448['length']){const _0x35969e=await this[_0x2fada0(0x165)][_0x2fada0(0x239)]({'where':{'id':_0x1ce050[_0x2fada0(0x1b1)][_0x2fada0(0x121)]}}),_0x20c702=new Map(),_0x5e4929=await this[_0x2fada0(0x23c)]['query'](_0x2fada0(0x205));_0x5e4929[_0x2fada0(0x128)](_0x295139=>_0x20c702['set'](_0x295139[_0x2fada0(0x282)],_0x295139[_0x2fada0(0x289)])),_0x22646c[_0x2fada0(0x128)](_0xba90e6=>{const _0x55dc6b=_0x2fada0;_0xba90e6[_0x55dc6b(0x2b3)]=_0x35969e?.['name']||'平台',_0xba90e6[_0x55dc6b(0x192)]=_0x20c702[_0x55dc6b(0x232)](_0xba90e6['code'])||0x0;});}return{'rows':_0x22646c,'count':Number(_0x402c83[0x0]?.['count']||0x0)};}async[_0x1535f2(0x16a)](_0x44aec9,_0xb8a4f1){const _0x1a6f32=_0x1535f2,_0x206746=await(0x0,utils_1['getReqSaasId'])(this['clsService']);if([Role_constant_1[_0x1a6f32(0x27a)][_0x1a6f32(0x1ab)][_0x1a6f32(0x28b)](),Role_constant_1['ERole']['AGENT'][_0x1a6f32(0x28b)](),Role_constant_1[_0x1a6f32(0x27a)]['VIEWER']['valueOf']()]['includes'](_0xb8a4f1[_0x1a6f32(0x260)])&&_0x206746!==0x0)throw new common_1[(_0x1a6f32(0x291))](_0x1a6f32(0x2c3),common_1[_0x1a6f32(0x23f)]['BAD_REQUEST']);return await this[_0x1a6f32(0x26b)][_0x1a6f32(0x1ed)]({..._0xb8a4f1,'saasId':_0x206746,'disabled':_0xb8a4f1[_0x1a6f32(0x1f5)]??0x0}),!![];}async[_0x1535f2(0x231)](_0x332f4d,_0x46d399){const _0x19e67f=_0x1535f2,_0x51f3f3=await(0x0,utils_1[_0x19e67f(0x233)])(this[_0x19e67f(0x2a8)]);if(!_0x46d399['ids']||!_0x46d399[_0x19e67f(0x167)][_0x19e67f(0x1fd)])return!![];const _0x32df9f=await this[_0x19e67f(0x26b)][_0x19e67f(0x2bb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x46d399[_0x19e67f(0x167)]),'saasId':_0x51f3f3}});if(!_0x32df9f[_0x19e67f(0x1fd)])return!![];const _0x5ebcfd=_0x32df9f[_0x19e67f(0x14e)](_0xbafe25=>_0xbafe25[_0x19e67f(0x260)]),_0x3aebff=await this['userEntity'][_0x19e67f(0x289)]({'where':{'role':(0x0,typeorm_2['In'])(_0x5ebcfd),'saasId':_0x51f3f3}});if(_0x3aebff>0x0)throw new common_1[(_0x19e67f(0x291))]('还有用户使用相关角色，无法删除！',common_1[_0x19e67f(0x23f)][_0x19e67f(0x187)]);return await this[_0x19e67f(0x26b)]['delete']({'id':(0x0,typeorm_2['In'])(_0x46d399[_0x19e67f(0x167)])}),!![];}async[_0x1535f2(0x17a)](_0x401b7d){const _0x3a9d79=_0x1535f2;if(!_0x401b7d[_0x3a9d79(0x1fd)])return[];const _0x20d39a=await this[_0x3a9d79(0x1b4)]['find']({'where':{'id':(0x0,typeorm_2['In'])(_0x401b7d)}});return _0x20d39a;}async[_0x1535f2(0x26e)](_0x564415,_0xd7cb7c){const _0x3fc1c7=_0x1535f2,{username:_0x17d073,email:_0x3579c9,password:_0x161c03,invitedBy:_0x4a76c2,client:client=0x0}=_0x564415;if(_0x4a76c2){const _0x1b6f8a=await this[_0x3fc1c7(0x1b4)][_0x3fc1c7(0x239)]({'where':{'inviteCode':_0x4a76c2}});if(!_0x1b6f8a)throw new common_1[(_0x3fc1c7(0x291))](_0x3fc1c7(0x1c7),common_1['HttpStatus'][_0x3fc1c7(0x187)]);}const _0x310049=[{'username':_0x17d073},{'email':_0x3579c9}],_0x1eacd2=await this[_0x3fc1c7(0x1b4)][_0x3fc1c7(0x239)]({'where':_0x310049});if(_0x1eacd2&&_0x1eacd2[_0x3fc1c7(0x1d6)]!==user_constant_1[_0x3fc1c7(0x1fb)][_0x3fc1c7(0x2ca)])throw new common_1[(_0x3fc1c7(0x291))](_0x3fc1c7(0x1a7),common_1['HttpStatus'][_0x3fc1c7(0x187)]);try{const _0x4bebd0=_[_0x3fc1c7(0x217)](_0x564415),_0x5e10ed=bcrypt[_0x3fc1c7(0x299)](_0x161c03,0xa),_0x703bbc=(0x0,utils_1['getClientIp'])(_0xd7cb7c);_0x4bebd0[_0x3fc1c7(0x22f)]=_0x5e10ed,_0x4bebd0[_0x3fc1c7(0x1e9)]=_0x703bbc,_0x4bebd0[_0x3fc1c7(0x286)]=client;let _0x1a220d;if(!_0x1eacd2){const _0x57f7d3=await this['globalConfigService'][_0x3fc1c7(0x202)](['userDefautlAvatar']);_0x4bebd0['avatar']=_0x57f7d3,_0x1a220d=await this['userEntity'][_0x3fc1c7(0x1ed)](_0x4bebd0);}else _0x1a220d=_0x1eacd2;const _0x5e3cef=await this[_0x3fc1c7(0x1fa)][_0x3fc1c7(0x202)]([_0x3fc1c7(0x279),_0x3fc1c7(0x15a),_0x3fc1c7(0x218),_0x3fc1c7(0x195),_0x3fc1c7(0x1bc),_0x3fc1c7(0x298)]),_0x51fc6a=_0x5e3cef[_0x3fc1c7(0x279)]?Number(_0x5e3cef['isVerifyEmail']):0x1;if(_0x51fc6a){const _0x27fa54=_0x5e3cef[_0x3fc1c7(0x298)]?Number(_0x5e3cef[_0x3fc1c7(0x298)]):0x1e*0x3c,_0x5b2397=await this[_0x3fc1c7(0x133)][_0x3fc1c7(0x264)](_0x1a220d,verification_constant_1[_0x3fc1c7(0x2a0)][_0x3fc1c7(0x137)],_0x27fa54),{code:_0x22de2c,email:_0x2246de,id:_0x4c9e77}=_0x5b2397,{registerVerifyEmailFrom:_0x4edf6a}=_0x5e3cef;await this[_0x3fc1c7(0x200)]['sendMail']({'to':_0x2246de,'subject':'来自'+_0x4edf6a+_0x3fc1c7(0x1c4),'template':_0x3fc1c7(0x11e),'context':{'baseUrl':_0x5e3cef['registerBaseUrl'],'code':_0x22de2c,'id':_0x4c9e77,..._0x5e3cef}});}else{const {id:_0x5bcf0f,invitedBy:_0x321afa}=_0x1a220d;await this[_0x3fc1c7(0x1d8)](_0x5bcf0f,user_constant_1['UserStatusEnum']['ACTIVE']);let _0x30f644;_0x321afa&&(_0x30f644=await this[_0x3fc1c7(0x1a6)](_0x321afa)),await this['changeScore4registe'](_0x1a220d,_0x30f644);}return _0x1a220d;}catch(_0x5220d7){console[_0x3fc1c7(0x145)](_0x3fc1c7(0x1fc),_0x5220d7);throw _0x5220d7;}}async[_0x1535f2(0x1e2)](_0x27b7a1){const _0x2d9924=_0x1535f2,{username:_0x53ae53,password:_0x9faeed,uid:uid=0x0,phone:_0x485cbc}=_0x27b7a1;let _0x39fc09=null;if(uid>0x0){_0x39fc09=await this[_0x2d9924(0x1b4)][_0x2d9924(0x239)]({'where':{'id':uid}});if(!_0x39fc09)throw new common_1[(_0x2d9924(0x291))]('当前账户不存在！',common_1[_0x2d9924(0x23f)][_0x2d9924(0x187)]);if(!bcrypt['compareSync'](_0x9faeed,_0x39fc09[_0x2d9924(0x22f)]))throw new common_1['HttpException'](_0x2d9924(0x1a3),common_1['HttpStatus'][_0x2d9924(0x187)]);}if(_0x53ae53&&_0x9faeed){const _0x222406=[{'username':_0x53ae53},{'email':_0x53ae53}];_0x39fc09=await this[_0x2d9924(0x1b4)][_0x2d9924(0x239)]({'where':_0x222406});if(!_0x39fc09)throw new common_1[(_0x2d9924(0x291))](_0x2d9924(0x2b4),common_1['HttpStatus']['BAD_REQUEST']);if(!bcrypt['compareSync'](_0x9faeed,_0x39fc09[_0x2d9924(0x22f)]))throw new common_1[(_0x2d9924(0x291))](_0x2d9924(0x1a3),common_1[_0x2d9924(0x23f)][_0x2d9924(0x187)]);}if(_0x485cbc&&_0x9faeed){const _0x173955=[{'phone':_0x485cbc}];_0x39fc09=await this[_0x2d9924(0x1b4)][_0x2d9924(0x239)]({'where':_0x173955});if(!_0x39fc09)throw new common_1[(_0x2d9924(0x291))]('当前账户不存在！',common_1[_0x2d9924(0x23f)]['BAD_REQUEST']);if(!bcrypt['compareSync'](_0x9faeed,_0x39fc09['password']))throw new common_1[(_0x2d9924(0x291))](_0x2d9924(0x1a3),common_1[_0x2d9924(0x23f)][_0x2d9924(0x187)]);}if(!_0x39fc09)throw new common_1[(_0x2d9924(0x291))](_0x2d9924(0x2b4),common_1[_0x2d9924(0x23f)]['BAD_REQUEST']);if(_0x39fc09[_0x2d9924(0x1d6)]!==user_constant_1['UserStatusEnum'][_0x2d9924(0x243)])throw new common_1['HttpException'](user_constant_1[_0x2d9924(0x1d9)][_0x39fc09[_0x2d9924(0x1d6)]],common_1[_0x2d9924(0x23f)][_0x2d9924(0x187)]);if(_0x39fc09[_0x2d9924(0x28a)]&&!_0x39fc09[_0x2d9924(0x284)]){const _0x4a58ce=await this[_0x2d9924(0x1ea)][_0x2d9924(0x239)]({'where':{'username':_0x39fc09[_0x2d9924(0x28a)]}});_0x4a58ce&&await this[_0x2d9924(0x23c)][_0x2d9924(0x1e6)](async()=>{const _0x21f38d=_0x2d9924;_0x4a58ce['vipDays']===-0x1?_0x39fc09[_0x21f38d(0x29f)]=0x1:_0x39fc09[_0x21f38d(0x2c6)]=(0x0,date_1[_0x21f38d(0x13d)])()[_0x21f38d(0x1ae)](_0x4a58ce[_0x21f38d(0x17e)],_0x21f38d(0x183))['toDate'](),_0x39fc09=await this[_0x21f38d(0x1b4)][_0x21f38d(0x1ed)](_0x39fc09),await this['userInitVipEntity']['delete']({'id':_0x4a58ce['id']});});}return _0x39fc09;}async[_0x1535f2(0x26f)](_0x542526,_0x108404){const _0x1a2c30=_0x1535f2,_0x37f8c8=await this[_0x1a2c30(0x1b4)][_0x1a2c30(0x239)]({'where':{'id':_0x542526}});return bcrypt[_0x1a2c30(0x2bc)](_0x108404,_0x37f8c8[_0x1a2c30(0x22f)]);}async[_0x1535f2(0x1d8)](_0x24bc63,_0x86429f){const _0x30b448=_0x1535f2,_0x3967d8=await this['userEntity']['update']({'id':_0x24bc63},{'status':_0x86429f});return _0x3967d8[_0x30b448(0x285)]>0x0;}async[_0x1535f2(0x238)](_0x24c93c){const _0x26fc80=_0x1535f2,_0x31171f=await this[_0x26fc80(0x1b4)][_0x26fc80(0x239)]({'where':{'id':_0x24c93c}});return _0x31171f[_0x26fc80(0x1d6)];}async[_0x1535f2(0x24c)](_0x553495){const _0xbcadba=_0x1535f2;return await this[_0xbcadba(0x1b4)][_0xbcadba(0x239)]({'where':{'id':_0x553495}});}async[_0x1535f2(0x1ec)](_0xef6eef){const _0x3bba1e=_0x1535f2;return await this[_0x3bba1e(0x1b4)]['findBy']({'id':(0x0,typeorm_2['In'])(_0xef6eef)});}async[_0x1535f2(0x1a1)](_0x164865){const _0x3478d1=_0x1535f2;return await this[_0x3478d1(0x1b4)]['findOne']({'where':{'username':_0x164865}});}async[_0x1535f2(0x2ab)](_0x597ee4){const _0x5afc76=_0x1535f2,{id:_0x571d12,username:_0x59e1e4,password:_0x48ac4b}=_0x597ee4;return await this[_0x5afc76(0x1b4)]['update'](_0x571d12,{'username':_0x59e1e4,'password':_0x48ac4b});}async[_0x1535f2(0x216)](_0x583561){const _0x3ca0cd=_0x1535f2;return await this[_0x3ca0cd(0x1b4)][_0x3ca0cd(0x239)]({'where':{'id':_0x583561}});}async[_0x1535f2(0x18d)](_0x5f318d){const _0x177309=_0x1535f2,{id:_0x588055,role:_0x5a159f}=_0x5f318d;if(_0x5a159f===_0x177309(0x179))return!![];const _0x259907=await this[_0x177309(0x1b4)]['findOne']({'where':{'id':_0x588055}});if(!_0x259907)throw new common_1[(_0x177309(0x291))](_0x177309(0x149),common_1[_0x177309(0x23f)][_0x177309(0x166)]);if(_0x259907[_0x177309(0x1d6)]===user_constant_1[_0x177309(0x1fb)][_0x177309(0x247)])throw new common_1['HttpException'](_0x177309(0x24a),common_1[_0x177309(0x23f)][_0x177309(0x187)]);if(_0x259907['status']===user_constant_1[_0x177309(0x1fb)][_0x177309(0x185)])throw new common_1[(_0x177309(0x291))](_0x177309(0x19e),common_1[_0x177309(0x23f)][_0x177309(0x187)]);}async[_0x1535f2(0x242)](_0x1e2468){const _0xd909c2=_0x1535f2;return await this[_0xd909c2(0x1b4)][_0xd909c2(0x239)]({'where':{'id':_0x1e2468}});}[_0x1535f2(0x2b2)](_0x5da8ba){const _0x556138=_0x1535f2;return this['userEntity'][_0x556138(0x2bb)]({'where':{'id':(0x0,typeorm_2['In'])(_0x5da8ba)}});}async[_0x1535f2(0x21d)](_0x5e3a09){const _0x1ada4d=_0x1535f2;return this[_0x1ada4d(0x1b4)]['findOne']({'where':{'inviteCode':_0x5e3a09}});}async[_0x1535f2(0x26c)](_0x3a8663){const _0x5b7689=_0x1535f2,_0x276a22=(0x0,utils_1[_0x5b7689(0x233)])(this[_0x5b7689(0x2a8)]);return await this[_0x5b7689(0x1b4)][_0x5b7689(0x239)]({'where':{'openId':_0x3a8663,'saasId':_0x276a22}});}async[_0x1535f2(0x120)](_0x36eb1b){const _0x4816e8=_0x1535f2;return this['userEntity'][_0x4816e8(0x289)]({'where':{'invitedBy':_0x36eb1b}});}async[_0x1535f2(0x19d)](_0x48d104,_0x1f3785){const _0xd78a64=_0x1535f2,{id:_0x7616e}=_0x1f3785['user'],_0x3a7d41=await this[_0xd78a64(0x1b4)]['findOne']({'where':{'id':_0x7616e}});if(!_0x3a7d41)throw new common_1['HttpException'](_0xd78a64(0x23e),common_1['HttpStatus'][_0xd78a64(0x187)]);if(_0x48d104[_0xd78a64(0x28a)]&&_0x3a7d41[_0xd78a64(0x28a)]===_0x48d104[_0xd78a64(0x28a)])throw new common_1[(_0xd78a64(0x291))](_0xd78a64(0x1db),common_1[_0xd78a64(0x23f)][_0xd78a64(0x187)]);if(_0x48d104[_0xd78a64(0x28a)]){const _0x47ee73=await this['userEntity'][_0xd78a64(0x239)]({'where':{'username':_0x48d104['username'],'id':(0x0,typeorm_2[_0xd78a64(0x16c)])(_0x7616e)}});if(_0x47ee73)throw new common_1[(_0xd78a64(0x291))](_0xd78a64(0x1a4),common_1[_0xd78a64(0x23f)]['BAD_REQUEST']);}const _0x3373f1=await this[_0xd78a64(0x1b4)][_0xd78a64(0x267)]({'id':_0x7616e},_0x48d104);if(_0x3373f1['affected']<=0x0)throw new common_1[(_0xd78a64(0x291))](_0xd78a64(0x2cd),common_1[_0xd78a64(0x23f)]['BAD_REQUEST']);return _0xd78a64(0x144);}async[_0x1535f2(0x275)](_0x3cdf2b,_0x52fc17){const _0x57b6dc=_0x1535f2,_0x32c2e4=bcrypt[_0x57b6dc(0x299)](_0x52fc17,0xa),_0x35f90a=await this['userEntity'][_0x57b6dc(0x267)]({'id':_0x3cdf2b},{'password':_0x32c2e4});if(_0x35f90a[_0x57b6dc(0x285)]<=0x0)throw new common_1[(_0x57b6dc(0x291))](_0x57b6dc(0x1e4),common_1[_0x57b6dc(0x23f)][_0x57b6dc(0x187)]);}async[_0x1535f2(0x1d3)](_0x5a0a5a,_0x49e625){const _0x2fd0a1=_0x1535f2;try{const _0x424811=await this[_0x2fd0a1(0x2aa)][_0x2fd0a1(0x239)]({'where':{'userId':_0x5a0a5a['user']['id'],'relateId':_0x49e625['relateId'],'relateType':_0x49e625[_0x2fd0a1(0x193)]}});return _0x424811?await this[_0x2fd0a1(0x2aa)][_0x2fd0a1(0x151)]({'id':_0x424811['id']}):await this[_0x2fd0a1(0x2aa)]['save']({'userId':_0x5a0a5a[_0x2fd0a1(0x1b1)]['id'],'relateId':_0x49e625[_0x2fd0a1(0x297)],'relateType':_0x49e625[_0x2fd0a1(0x193)]}),!![];}catch(_0x5e6fdf){throw new common_1['HttpException'](_0x5e6fdf['message'],common_1[_0x2fd0a1(0x23f)][_0x2fd0a1(0x187)]);}}async['favoriteListByTypeAndIds'](_0x370654,_0xbaefe,_0x2f1384){const _0x1cb8c2=_0x1535f2;return this[_0x1cb8c2(0x2aa)][_0x1cb8c2(0x2bb)]({'where':{'userId':_0x370654,'relateType':_0xbaefe,'relateId':(0x0,typeorm_2['In'])(_0x2f1384)}});}async['genInviteCode'](_0x4bc284){const _0x56c075=_0x1535f2,{id:_0x58d27b}=_0x4bc284[_0x56c075(0x1b1)],_0x51fcd7=await this['userEntity'][_0x56c075(0x239)]({'where':{'id':_0x58d27b}});if(!_0x51fcd7||_0x51fcd7['inviteCode'])throw new common_1[(_0x56c075(0x291))]('已生成过邀请码、请勿重复生成',common_1['HttpStatus'][_0x56c075(0x187)]);const _0x14ef97=(0x0,utils_1[_0x56c075(0x226)])(),_0x21bfe5=await this['userEntity'][_0x56c075(0x239)]({'where':{'inviteCode':_0x14ef97}});if(_0x21bfe5)throw new common_1[(_0x56c075(0x291))](_0x56c075(0x1b2),common_1[_0x56c075(0x23f)]['BAD_REQUEST']);const _0x4d525d=await this[_0x56c075(0x1b4)][_0x56c075(0x267)]({'id':_0x58d27b},{'inviteCode':_0x14ef97});if(_0x4d525d[_0x56c075(0x285)]<=0x0)throw new common_1[(_0x56c075(0x291))](_0x56c075(0x1b2),common_1['HttpStatus'][_0x56c075(0x187)]);return _0x14ef97;}async['getInviteRecord'](_0x46c750,_0x3ca34c){const _0x2880ba=_0x1535f2;try{const {id:_0x3fb328}=_0x46c750[_0x2880ba(0x1b1)],{page:page=0x1,size:size=0xa}=_0x3ca34c,_0x11dee0=await this[_0x2880ba(0x1b4)]['findOne']({'where':{'id':_0x3fb328}}),{inviteCode:_0x40be39}=_0x11dee0;if(!_0x40be39)return[];const [_0xefedb7,_0x4977af]=await this['userEntity'][_0x2880ba(0x197)]({'where':{'inviteCode':_0x40be39},'order':{'id':_0x2880ba(0x1cd)},'select':[_0x2880ba(0x28a),_0x2880ba(0x19b),_0x2880ba(0x153),'status',_0x2880ba(0x21c)],'take':size,'skip':(page-0x1)*size});return(0x0,utils_1[_0x2880ba(0x186)])(_0xefedb7)[_0x2880ba(0x14e)](_0x5c49b6=>{const _0x5ade34=_0x2880ba;return _0x5c49b6[_0x5ade34(0x19b)]=(0x0,utils_1[_0x5ade34(0x203)])(_0x5c49b6[_0x5ade34(0x19b)]),_0x5c49b6;}),{'rows':_0xefedb7,'count':_0x4977af};}catch(_0x192eb3){console[_0x2880ba(0x145)](_0x2880ba(0x1fc),_0x192eb3);throw new common_1[(_0x2880ba(0x291))]('获取邀请记录失败！',common_1[_0x2880ba(0x23f)][_0x2880ba(0x187)]);}}async[_0x1535f2(0x237)](_0x12290d,_0xe7435,_0xc714bb){const _0x2b4843=_0x1535f2,_0x12f38c=(0x0,utils_1[_0x2b4843(0x233)])(this[_0x2b4843(0x2a8)]),{page:page=0x1,size:size=0x14,startTime:_0x29b9d8,endTime:_0x3a9071,saasId:_0x2f1170,keyword:_0x5d4005,inviterKeyword:_0xee1ddb}=_0xe7435,_0x29b04a='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20u.invitedBy\x20!=\x20\x27\x27\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20AND\x20u.invitedBy\x20IS\x20NOT\x20NULL\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+(_0xc714bb?_0x2b4843(0x15b)+_0xc714bb:'')+_0x2b4843(0x177)+(_0x3a9071?_0x2b4843(0x29d)+_0x3a9071+'\x27':'')+_0x2b4843(0x177)+(_0x29b9d8?'\x20AND\x20u.createdAt\x20>=\x20\x27'+_0x29b9d8+'\x27':'')+_0x2b4843(0x177)+(_0x12f38c!==0x0?_0x2b4843(0x22a)+_0x12f38c:(0x0,utils_1[_0x2b4843(0x276)])(_0x2f1170)?_0x2b4843(0x22a)+_0x2f1170:'')+_0x2b4843(0x177)+(_0x5d4005?'\x20AND\x20(\x20u.username\x20LIKE\x20\x27%'+_0x5d4005+_0x2b4843(0x257)+_0x5d4005+'%\x27\x20OR\x20u.nickname\x20LIKE\x20\x27%'+_0x5d4005+_0x2b4843(0x1e7)+_0x5d4005+_0x2b4843(0x280):'')+_0x2b4843(0x177)+(_0xee1ddb?_0x2b4843(0x2a2)+_0xee1ddb+_0x2b4843(0x2a1)+_0xee1ddb+_0x2b4843(0x229)+_0xee1ddb+_0x2b4843(0x21e)+_0xee1ddb+_0x2b4843(0x280):'')+_0x2b4843(0x213),_0x46481f='\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20count(*)\x20AS\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x20u\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20LEFT\x20JOIN\x20users\x20u1\x20ON\x20u.invitedBy\x20=\x20u1.inviteCode\x20\x20\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x29b04a+_0x2b4843(0x213),_0x517dcb=_0x2b4843(0x249)+_0x29b04a+_0x2b4843(0x290)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x2b4843(0x213),_0x198df3=await this[_0x2b4843(0x23c)][_0x2b4843(0x1a5)](_0x46481f),_0x31ee94=await this[_0x2b4843(0x23c)]['query'](_0x517dcb);return!(0x0,utils_1['isSuper'])(this[_0x2b4843(0x2a8)])&&_0x31ee94[_0x2b4843(0x128)](_0x487709=>{const _0x1c2814=_0x2b4843;_0x487709[_0x1c2814(0x1dd)]=(0x0,utils_1[_0x1c2814(0x20f)])(_0x487709[_0x1c2814(0x1dd)]),_0x487709[_0x1c2814(0x19b)]=(0x0,utils_1['hideString'])(_0x487709[_0x1c2814(0x19b)]),_0x487709[_0x1c2814(0x2b6)]=(0x0,utils_1[_0x1c2814(0x20f)])(_0x487709[_0x1c2814(0x2b6)]),_0x487709[_0x1c2814(0x262)]=(0x0,utils_1[_0x1c2814(0x20f)])(_0x487709[_0x1c2814(0x262)]);}),{'rows':_0x31ee94,'count':Number(_0x198df3[0x0]?.[_0x2b4843(0x289)]||0x0)};}async['inviteLink'](_0x30d602){const _0x3b8705=_0x1535f2,_0x384a7a=await this['userEntity']['findOne']({'where':{'inviteCode':_0x30d602}});if(!_0x384a7a)return 0x1;const {inviteLinkCount:inviteLinkCount=0x0}=_0x384a7a,_0x30efc2=await this[_0x3b8705(0x1b4)]['update']({'inviteCode':_0x30d602},{'inviteLinkCount':inviteLinkCount+0x1});return _0x30efc2[_0x3b8705(0x285)]?0x1:0x0;}async['qureyUserInfoByInviteCode'](_0x394d95){return await this['userEntity']['findOne']({'where':{'inviteCode':_0x394d95}});}async[_0x1535f2(0x159)](_0x51f5d7,_0x31cbd8){const _0x34a010=_0x1535f2,_0x10ac7a=(0x0,utils_1[_0x34a010(0x233)])(this['clsService']);let {page:page=0x1,size:size=0xa,username:_0x264016,phone:_0x13244c,email:_0x22f734,status:_0x508e05,keyword:_0x3fa3d4,roleCode:_0x4d7e4a,vip:_0x127264,saasId:_0x4e31fa}=_0x51f5d7,_0x151037='1\x20=\x201';_0x508e05&&(_0x151037=_0x151037+(_0x34a010(0x13e)+_0x508e05));_0x4d7e4a&&(_0x151037=_0x151037+(_0x34a010(0x2ba)+_0x4d7e4a+'\x27'));_0x127264&&(_0x127264=Number(_0x127264));if(_0x127264===0x1)_0x151037=_0x151037+_0x34a010(0x22b);else _0x127264===0x0&&(_0x151037=_0x151037+'\x20AND\x20lifetimeVip\x20=\x200\x20AND\x20vipExpire\x20IS\x20NULL');_0x3fa3d4?_0x151037=_0x151037+(_0x34a010(0x274)+_0x3fa3d4+_0x34a010(0x171)+_0x3fa3d4+_0x34a010(0x17d)+_0x3fa3d4+'%\x27\x20OR\x20email\x20LIKE\x20\x27%'+_0x3fa3d4+_0x34a010(0x1ac)+_0x3fa3d4+'\x27)'):(_0x264016&&(_0x151037=_0x151037+('\x20AND\x20username\x20LIKE\x20\x27%'+_0x264016+'%\x27')),_0x22f734&&(_0x151037=_0x151037+('AND\x20email\x20LIKE\x20\x27%'+_0x22f734+'%\x27')),_0x13244c&&(_0x151037=_0x151037+(_0x34a010(0x2b5)+_0x13244c+'%\x27')));(0x0,utils_1[_0x34a010(0x2c9)])(this['clsService'])?(0x0,utils_1[_0x34a010(0x2cc)])(this[_0x34a010(0x2a8)])&&_0x4e31fa&&(_0x151037=_0x151037+(_0x34a010(0x269)+_0x4e31fa)):_0x151037=_0x151037+('\x20AND\x20saasId\x20=\x20'+_0x10ac7a);const _0x4891be=await this[_0x34a010(0x23c)]['query']('\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20SELECT\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20COUNT(*)\x20as\x20count\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20FROM\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20users\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20WHERE\x0a\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20\x20'+_0x151037+_0x34a010(0x28f)),_0x202c7d=await this['connection'][_0x34a010(0x1a5)](_0x34a010(0x1cb)+_0x151037+_0x34a010(0x191)+size+'\x20OFFSET\x20'+(page-0x1)*size+_0x34a010(0x213)),_0x579b22=[],_0x244339=(0x0,utils_1[_0x34a010(0x13f)])(this[_0x34a010(0x2a8)]),_0x3de624=new Map([[Role_constant_1[_0x34a010(0x27a)]['AGENT'],_0x34a010(0x194)],[Role_constant_1[_0x34a010(0x27a)][_0x34a010(0x1ab)],_0x34a010(0x21a)],[Role_constant_1['ERole']['VIEWER'],_0x34a010(0x22c)]]);for(let _0x419b73=0x0;_0x419b73<_0x202c7d[_0x34a010(0x1fd)];_0x419b73++){const _0x42c77d=_0x202c7d[_0x419b73];let _0x709cbd=_0x34a010(0x22c);if(_0x3de624[_0x34a010(0x241)](_0x42c77d[_0x34a010(0x282)]))_0x709cbd=_0x3de624[_0x34a010(0x232)](_0x42c77d[_0x34a010(0x282)]);else{const _0x326fdf=await this['roleEntity'][_0x34a010(0x239)]({'where':{'code':_0x42c77d[_0x34a010(0x282)],'saasId':_0x42c77d[_0x34a010(0x121)]}});_0x709cbd=_0x326fdf[_0x34a010(0x1c3)];}_0x579b22[_0x34a010(0x19f)]({..._0x42c77d,'roleName':_0x709cbd,'isBindWx':!!_0x42c77d?.[_0x34a010(0x252)],'password':_0x42c77d[_0x34a010(0x22f)]?_0x34a010(0x14f):'no','email':_0x244339?_0x42c77d[_0x34a010(0x19b)]:(0x0,utils_1[_0x34a010(0x203)])(_0x42c77d['email']),'phone':_0x244339?_0x42c77d['phone']:(0x0,utils_1['maskEmail'])(_0x42c77d[_0x34a010(0x1dd)]),'lastLoginIp':_0x244339?_0x42c77d['lastLoginIp']:(0x0,utils_1[_0x34a010(0x164)])(_0x42c77d[_0x34a010(0x284)])});}return{'rows':_0x579b22,'count':Number(_0x4891be[0x0]?.[_0x34a010(0x289)]||0x0)};}async[_0x1535f2(0x256)](_0x3d1ca7){const _0x1e7c8d=_0x1535f2,{page:page=0x1,size:size=0xa,username:_0x10d98b,status:_0x46c8be}=_0x3d1ca7;let _0x2d60a6={};_0x10d98b&&Object['assign'](_0x2d60a6,{'username':(0x0,typeorm_2['Like'])('%'+_0x10d98b+'%')}),_0x46c8be&&Object[_0x1e7c8d(0x20b)](_0x2d60a6,{'status':_0x46c8be});const [_0x302564,_0x6b43ea]=await this[_0x1e7c8d(0x1b4)][_0x1e7c8d(0x197)]({'skip':(page-0x1)*size,'where':_0x2d60a6,'take':size,'cache':!![],'order':{'createdAt':_0x1e7c8d(0x1cd)},'select':['username',_0x1e7c8d(0x22f),_0x1e7c8d(0x282),_0x1e7c8d(0x1d6),'id']});return{'rows':_0x302564,'count':_0x6b43ea};}async[_0x1535f2(0x1a9)]({id:_0x41a310}){const _0x729258=_0x1535f2;let _0x58ca06,_0x206dea;const _0x1f497e=await this[_0x729258(0x1b4)][_0x729258(0x239)]({'where':{'id':_0x41a310}});if(!_0x1f497e)throw new common_1[(_0x729258(0x291))](_0x729258(0x273),common_1['HttpStatus']['UNAUTHORIZED']);if((0x0,utils_1[_0x729258(0x2d1)])(_0x1f497e[_0x729258(0x282)])){const _0x568720=_0x1f497e[_0x729258(0x282)]===Role_constant_1['ERole'][_0x729258(0x2d0)]?0x0:_0x1f497e[_0x729258(0x121)],_0x5bd649=await this[_0x729258(0x26b)][_0x729258(0x239)]({'where':{'code':_0x1f497e[_0x729258(0x282)],'saasId':_0x568720}});if(!_0x5bd649)throw new common_1['HttpException'](_0x729258(0x29a),common_1[_0x729258(0x23f)][_0x729258(0x187)]);_0x58ca06=_0x5bd649['access'],_0x206dea=_0x5bd649['accessLabel'];}return{..._0x1f497e,'access':_0x58ca06,'accessLabel':_0x206dea,'isBindWx':!!_0x1f497e?.[_0x729258(0x252)],'password':_0x1f497e[_0x729258(0x22f)]?'yes':'no'};}async[_0x1535f2(0x17b)](_0xc64169){const _0x5b07b4=_0x1535f2;return await this[_0x5b07b4(0x1b4)][_0x5b07b4(0x239)]({'where':{'username':_0xc64169}});}async[_0x1535f2(0x1b6)](_0x512744){const _0x53edea=_0x1535f2,{id:_0x4a2b12,status:_0xb90cac}=_0x512744,_0x4490e3=await this[_0x53edea(0x1b4)]['findOne']({'where':{'id':_0x4a2b12}});if(!_0x4490e3)throw new common_1[(_0x53edea(0x291))](_0x53edea(0x130),common_1[_0x53edea(0x23f)][_0x53edea(0x187)]);if(_0x4490e3[_0x53edea(0x282)]===Role_constant_1[_0x53edea(0x27a)][_0x53edea(0x1ab)])throw new common_1['HttpException'](_0x53edea(0x1c1),common_1[_0x53edea(0x23f)][_0x53edea(0x187)]);if(_0x4490e3[_0x53edea(0x1d6)]===user_constant_1[_0x53edea(0x1fb)][_0x53edea(0x2ca)])throw new common_1['HttpException']('未激活用户不可手动变更状态！',common_1[_0x53edea(0x23f)][_0x53edea(0x187)]);if(_0xb90cac===user_constant_1[_0x53edea(0x1fb)][_0x53edea(0x2ca)])throw new common_1['HttpException'](_0x53edea(0x253),common_1[_0x53edea(0x23f)][_0x53edea(0x187)]);const _0x9af867=await this[_0x53edea(0x1b4)][_0x53edea(0x267)]({'id':_0x4a2b12},{'status':_0xb90cac});if(_0x9af867['affected']<=0x0)throw new common_1['HttpException'](_0x53edea(0x169),common_1[_0x53edea(0x23f)]['BAD_REQUEST']);return _0x53edea(0x236);}async['resetUserPass'](_0x42f2cb){const _0x1d000b=_0x1535f2,{id:_0x20a4bd}=_0x42f2cb,_0x59f08c=await this['userEntity'][_0x1d000b(0x239)]({'where':{'id':_0x20a4bd}});if(!_0x59f08c)throw new common_1['HttpException'](_0x1d000b(0x130),common_1[_0x1d000b(0x23f)][_0x1d000b(0x187)]);const _0x516380='123456',_0x4835ad=bcrypt[_0x1d000b(0x299)](_0x516380,0xa),_0x9b4622=await this[_0x1d000b(0x1b4)]['update']({'id':_0x20a4bd},{'password':_0x4835ad});if(_0x9b4622[_0x1d000b(0x285)]<=0x0)throw new common_1[(_0x1d000b(0x291))](_0x1d000b(0x1c0),common_1[_0x1d000b(0x23f)][_0x1d000b(0x187)]);return _0x1d000b(0x2bf)+_0x516380+_0x1d000b(0x154);}async['savaLoginIp'](_0x3581bc,_0x1918f0){const _0x1682ad=_0x1535f2;return await this['userEntity'][_0x1682ad(0x267)]({'id':_0x3581bc},{'lastLoginIp':_0x1918f0});}async[_0x1535f2(0x1be)](_0x540dfb,_0x1bc797){const _0x295bf6=_0x1535f2;try{const _0x3f9434=await this['userEntity'][_0x295bf6(0x239)]({'where':{'id':_0x1bc797}});if(!_0x3f9434)return{'status':![],'msg':'当前绑定用户不存在！'};const _0x6080de=await this[_0x295bf6(0x1b4)][_0x295bf6(0x239)]({'where':{'openId':_0x540dfb}});if(_0x6080de)return{'status':![],'msg':_0x295bf6(0x189)};const _0x2bd989=await this[_0x295bf6(0x1b4)]['update']({'id':_0x1bc797},{'openId':_0x540dfb});if(_0x2bd989[_0x295bf6(0x285)]<=0x0)return{'status':![],'msg':_0x295bf6(0x1ef)};return{'status':!![],'msg':_0x295bf6(0x1c9)};}catch(_0x1fba4e){return{'status':![],'msg':'绑定微信失败、请联系管理员！'};}}async[_0x1535f2(0x16f)](_0x524d34){const _0x20da19=_0x1535f2,_0x3bf99a=await this[_0x20da19(0x1b4)][_0x20da19(0x239)]({'where':{'id':_0x524d34}});return _0x3bf99a?.[_0x20da19(0x252)];}async[_0x1535f2(0x295)](_0x20ca70){const _0x4f2aa0=_0x1535f2,_0x3c7a4a=await this[_0x4f2aa0(0x1b4)][_0x4f2aa0(0x239)]({'where':{'id':_0x20ca70}});return _0x3c7a4a?.[_0x4f2aa0(0x18f)];}async[_0x1535f2(0x13b)](_0x551a2e){const _0x4d89ed=_0x1535f2,{username:_0x5aab25,password:_0x45a96b,phone:_0x12148b,phoneCode:_0x2076a2}=_0x551a2e,_0x1e6b91=await this[_0x4d89ed(0x1b4)]['findOne']({'where':[{'username':_0x5aab25},{'phone':_0x12148b}]});if(_0x1e6b91&&_0x1e6b91[_0x4d89ed(0x28a)]===_0x5aab25)throw new common_1[(_0x4d89ed(0x291))]('用户名已存在、请更换用户名！',common_1[_0x4d89ed(0x23f)][_0x4d89ed(0x187)]);if(_0x1e6b91&&_0x1e6b91['phone']===_0x12148b)throw new common_1[(_0x4d89ed(0x291))](_0x4d89ed(0x162),common_1[_0x4d89ed(0x23f)]['BAD_REQUEST']);}async[_0x1535f2(0x201)](_0x14baed){const _0x3a7176=_0x1535f2,_0x46fc01=(0x0,utils_1['getReqSaasId'])(this['clsService']);if(_0x14baed[_0x3a7176(0x282)]!==Role_constant_1[_0x3a7176(0x27a)][_0x3a7176(0x2d0)])_0x14baed[_0x3a7176(0x121)]=_0x46fc01;else{if(!_0x14baed[_0x3a7176(0x121)])throw new common_1['HttpException']('saasId不能为空！',common_1['HttpStatus'][_0x3a7176(0x187)]);}return await this['userEntity'][_0x3a7176(0x1ed)](_0x14baed);}async[_0x1535f2(0x1ba)](_0xcae310){const _0x2cbc3f=_0x1535f2,{id:_0x1d7aa0,moreId:_0xac2704}=_0xcae310;if(_0x1d7aa0)return await this['userEntity']['delete']({'id':_0x1d7aa0});if(_0xac2704)return await this['userEntity'][_0x2cbc3f(0x151)]({'id':(0x0,typeorm_2[_0x2cbc3f(0x29e)])(_0xac2704)});}async[_0x1535f2(0x25e)](_0x439daa){const _0x2be79b=_0x1535f2,_0x1bd65e=_0x439daa[_0x2be79b(0x1b1)]['id'];return await this['userEntity']['delete']({'id':_0x1bd65e})[_0x2be79b(0x147)](_0x5c6b0d=>_0x5c6b0d[_0x2be79b(0x285)]>0x0);}async[_0x1535f2(0x173)](_0x26384c,_0x3b30c8){const _0x13d4cd=_0x1535f2;try{if(!_0x26384c[_0x13d4cd(0x28a)]&&!_0x26384c[_0x13d4cd(0x1dd)]&&!_0x26384c[_0x13d4cd(0x19b)])throw new Error('账号、手机、邮箱必须存在一个');if(_0x26384c[_0x13d4cd(0x28a)]){if(!/^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]+$/[_0x13d4cd(0x2a7)](_0x26384c[_0x13d4cd(0x28a)]))throw new Error(_0x13d4cd(0x19a));if(!_0x26384c['password'])throw new Error(_0x13d4cd(0x22d));}if(_0x26384c[_0x13d4cd(0x1dd)]){if(!(0x0,class_validator_1['isMobilePhone'])(_0x26384c[_0x13d4cd(0x1dd)],_0x13d4cd(0x2cf)))throw new Error(_0x13d4cd(0x25d));}if(_0x26384c[_0x13d4cd(0x19b)]){if(!(0x0,class_validator_1[_0x13d4cd(0x14b)])(_0x26384c[_0x13d4cd(0x19b)]))throw new Error(_0x13d4cd(0x163));}if(_0x26384c['username']){const _0x66669f=await this[_0x13d4cd(0x1b4)][_0x13d4cd(0x296)]({'where':{'username':_0x26384c['username']}});if(_0x66669f)throw new Error(_0x13d4cd(0x277));}if(_0x26384c[_0x13d4cd(0x1dd)]){const _0x55011e=await this[_0x13d4cd(0x1b4)]['exists']({'where':{'phone':_0x26384c[_0x13d4cd(0x1dd)]}});if(_0x55011e)throw new Error(_0x13d4cd(0x1a2));}if(_0x26384c[_0x13d4cd(0x19b)]){const _0x43e77d=await this[_0x13d4cd(0x1b4)][_0x13d4cd(0x296)]({'where':{'email':_0x26384c[_0x13d4cd(0x19b)]}});if(_0x43e77d)throw new Error(_0x13d4cd(0x2c8));}const _0x58cd8=new user_entity_1[(_0x13d4cd(0x2c7))]();for(let _0x178fc5 in _0x26384c){_0x26384c[_0x178fc5]&&(_0x58cd8[_0x178fc5]=_0x26384c[_0x178fc5]);}return _0x58cd8['password']&&(_0x58cd8[_0x13d4cd(0x22f)]=bcrypt['hashSync'](_0x26384c[_0x13d4cd(0x22f)],0xa)),_0x58cd8[_0x13d4cd(0x1d6)]=user_constant_1[_0x13d4cd(0x1fb)][_0x13d4cd(0x243)],!_0x58cd8['nickname']&&(_0x58cd8['nickname']=_0x58cd8[_0x13d4cd(0x1e0)]||'小智'),!_0x58cd8[_0x13d4cd(0x21c)]&&(_0x58cd8['avatar']=await this[_0x13d4cd(0x1fa)]['getConfigByKeys']([_0x13d4cd(0x1b9)])),await this['createUser'](_0x58cd8),!![];}catch(_0x53e835){throw new common_1[(_0x13d4cd(0x291))](_0x53e835[_0x13d4cd(0x15c)],common_1[_0x13d4cd(0x23f)][_0x13d4cd(0x187)]);}}['genUserName'](){const _0x261b25=_0x1535f2;let _0x501b83=_0x261b25(0x21f);const _0x3d8840=[0x0,0x1,0x2,0x3,0x4,0x5,0x6,0x7,0x8,0x9,'-','a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q','R','S','T','U','V','W','X','Y','Z'];for(let _0x36f514=0x0;_0x36f514<0xa;_0x36f514++){_0x501b83=_0x501b83+_0x3d8840[Math[_0x261b25(0x198)](Math[_0x261b25(0x2a3)]()*0x3f)];}return _0x501b83;}async[_0x1535f2(0x1d7)](_0x291ec1){const _0x3c62cd=_0x1535f2;let _0x51194f=[];for(let _0x12092b=0x0;_0x12092b<_0x291ec1;_0x12092b++){_0x51194f['push'](this[_0x3c62cd(0x25b)]());}const _0x49925d=await this['userEntity'][_0x3c62cd(0x2bb)]({'where':{'username':(0x0,typeorm_2['In'])(_0x51194f)}});if(!_0x49925d[_0x3c62cd(0x1fd)])return _0x51194f;else{const _0x522132=new Set(_0x49925d['map'](_0x2eaf0a=>_0x2eaf0a[_0x3c62cd(0x28a)]));_0x51194f=_0x51194f[_0x3c62cd(0x1d4)](_0x2c5e0d=>!_0x522132[_0x3c62cd(0x241)](_0x2c5e0d));const _0x95e9f7=await this[_0x3c62cd(0x1d7)](_0x522132[_0x3c62cd(0x24b)]);return _0x51194f=_0x51194f[_0x3c62cd(0x1d0)](_0x95e9f7),_0x51194f;}}async[_0x1535f2(0x292)](_0x3a4cd6,_0x3bc40d){const _0x5944a3=_0x1535f2,_0x303b40=await this[_0x5944a3(0x1d7)](_0x3a4cd6[_0x5944a3(0x23d)]),_0x2da592=[],_0x50b6c2=[],_0x2af3c2=await this[_0x5944a3(0x1fa)]['getConfigByKeys'](['userDefautlAvatar']);for(let _0x1a0b2d=0x0;_0x1a0b2d<_0x3a4cd6[_0x5944a3(0x23d)];_0x1a0b2d++){const _0x19ff51=new user_entity_1[(_0x5944a3(0x2c7))]();_0x19ff51[_0x5944a3(0x1d6)]=0x1,_0x19ff51['avatar']=_0x2af3c2,_0x19ff51[_0x5944a3(0x28a)]=_0x303b40[_0x1a0b2d],_0x19ff51[_0x5944a3(0x1e0)]=_0x303b40[_0x1a0b2d],_0x19ff51[_0x5944a3(0x22f)]=bcrypt[_0x5944a3(0x299)](_0x5944a3(0x140),0xa),_0x3a4cd6[_0x5944a3(0x265)]&&(_0x19ff51[_0x5944a3(0x265)]=Number(_0x3a4cd6[_0x5944a3(0x265)])),_0x3a4cd6['vipLeavelName']&&(_0x19ff51['vipLeavelName']=_0x3a4cd6[_0x5944a3(0x1eb)]),_0x3a4cd6[_0x5944a3(0x1b0)]&&(_0x19ff51[_0x5944a3(0x1b0)]=_0x3a4cd6[_0x5944a3(0x1b0)]),_0x3a4cd6['vipDays']&&_0x50b6c2[_0x5944a3(0x19f)]({'username':_0x303b40[_0x1a0b2d],'vipDays':_0x3a4cd6[_0x5944a3(0x17e)]}),_0x2da592[_0x5944a3(0x19f)](_0x19ff51);}try{return await this[_0x5944a3(0x23c)]['transaction'](async()=>{const _0x475e02=_0x5944a3;await this[_0x475e02(0x1b4)]['save'](_0x2da592),await this[_0x475e02(0x1ea)][_0x475e02(0x1ed)](_0x50b6c2);}),!![];}catch(_0x3bc848){throw new common_1[(_0x5944a3(0x291))](_0x3bc848[_0x5944a3(0x15c)],axios_1[_0x5944a3(0x1df)][_0x5944a3(0x209)]);}}async['giftScore'](_0x53ffe8,_0x53e7f){const _0x1d8ead=_0x1535f2,_0x496c8f=await this[_0x1d8ead(0x1b4)][_0x1d8ead(0x239)]({'where':{'id':_0x53e7f[_0x1d8ead(0x263)]}});await this['userEntity'][_0x1d8ead(0x259)]({'id':_0x496c8f['id']},_0x1d8ead(0x1b0),_0x53e7f[_0x1d8ead(0x1b0)]),await this[_0x1d8ead(0x245)][_0x1d8ead(0x17f)]({'userId':_0x496c8f['id'],'rawScore':_0x496c8f[_0x1d8ead(0x1b0)],'newScore':_0x496c8f[_0x1d8ead(0x1b0)]+_0x53e7f[_0x1d8ead(0x1b0)],'changeScore':_0x53e7f[_0x1d8ead(0x1b0)],'changeType':balance_constant_1[_0x1d8ead(0x222)][_0x1d8ead(0x131)],'rebateUserId':_0x53ffe8[_0x1d8ead(0x1b1)]['id'],'description':_0x1d8ead(0x287)});}async['giftVip'](_0x1919af,_0x14e10a){const _0x3542ba=_0x1535f2,_0x3737f4=await this[_0x3542ba(0x1b4)][_0x3542ba(0x239)]({'where':{'id':_0x14e10a[_0x3542ba(0x263)]}});return await this['updateVipExpire'](_0x3737f4,balance_constant_1['EChangeType'][_0x3542ba(0x131)],_0x14e10a['days'],'管理员赠送',_0x1919af[_0x3542ba(0x1b1)]['id']),!![];}async[_0x1535f2(0x188)](_0x2d50f9){const _0x8440c9=_0x1535f2,_0x1be6ad=await this['userInitVipEntity'][_0x8440c9(0x239)]({'where':{'username':_0x2d50f9[_0x8440c9(0x28a)]}});_0x1be6ad&&await this[_0x8440c9(0x23c)][_0x8440c9(0x1e6)](async()=>{const _0x51e72d=_0x8440c9;_0x1be6ad[_0x51e72d(0x17e)]===-0x1?_0x2d50f9[_0x51e72d(0x29f)]=0x1:_0x2d50f9[_0x51e72d(0x2c6)]=(0x0,date_1[_0x51e72d(0x13d)])()[_0x51e72d(0x1ae)](_0x1be6ad['vipDays'],_0x51e72d(0x183))['toDate'](),_0x2d50f9=await this[_0x51e72d(0x1b4)][_0x51e72d(0x1ed)](_0x2d50f9),await this[_0x51e72d(0x1ea)]['delete']({'id':_0x1be6ad['id']});});}async[_0x1535f2(0x26d)](_0x1b4e67,_0x28a679){const _0x909a9c=_0x1535f2;await this['userEntity'][_0x909a9c(0x267)]({'id':_0x1b4e67},{'consecutiveDays':_0x28a679});}async[_0x1535f2(0x184)](_0x2a8c42){const _0x247661=_0x1535f2,_0x5c6072=await this[_0x247661(0x242)](_0x2a8c42);_0x5c6072['violationCount']=_0x5c6072[_0x247661(0x225)]+0x1,await this[_0x247661(0x1b4)]['save'](_0x5c6072);}async[_0x1535f2(0x1ad)](_0x3fe6fa,_0x4cdd9c){const _0xa26422=_0x1535f2,_0x185f3c=await this[_0xa26422(0x1fa)][_0xa26422(0x202)](['registerSendStatus',_0xa26422(0x12e),'inviteSendStatus',_0xa26422(0x2be),'inviteRewardVip','invitedRewards',_0xa26422(0x1b5)]),_0x1bc496={};for(let _0x5c1d59 in _0x185f3c){const _0x446169=Number(_0x185f3c[_0x5c1d59]),_0x4398c7=Number['isInteger'](_0x446169)&&_0x446169>0x0?_0x446169:0x0;_0x1bc496[_0x5c1d59]=_0x4398c7;}_0x1bc496[_0xa26422(0x16d)]&&(await this[_0xa26422(0x1b4)][_0xa26422(0x267)]({'id':_0x3fe6fa['id']},{'score':_0x1bc496[_0xa26422(0x12e)]}),await this['userBalanceService'][_0xa26422(0x17f)]({'userId':_0x3fe6fa['id'],'rawScore':0x0,'newScore':_0x1bc496['registerRewards'],'changeScore':_0x1bc496['registerRewards'],'changeType':balance_constant_1[_0xa26422(0x222)][_0xa26422(0x1b3)],'description':_0xa26422(0x2c2)}));if(_0x4cdd9c&&_0x1bc496[_0xa26422(0x139)]){_0x1bc496[_0xa26422(0x2be)]&&(await this[_0xa26422(0x1b4)][_0xa26422(0x259)]({'id':_0x4cdd9c['id']},_0xa26422(0x1b0),_0x1bc496['inviteRewards']),await this[_0xa26422(0x245)][_0xa26422(0x17f)]({'userId':_0x4cdd9c['id'],'rawScore':_0x4cdd9c[_0xa26422(0x1b0)],'newScore':_0x4cdd9c[_0xa26422(0x1b0)]+_0x1bc496[_0xa26422(0x2be)],'changeScore':_0x1bc496[_0xa26422(0x2be)],'changeType':balance_constant_1['EChangeType'][_0xa26422(0x29b)],'rebateUserId':_0x3fe6fa['id'],'description':'邀请新用户注册奖励'}));_0x1bc496[_0xa26422(0x1f6)]&&await this[_0xa26422(0x228)](_0x4cdd9c,balance_constant_1[_0xa26422(0x222)][_0xa26422(0x29b)],_0x1bc496[_0xa26422(0x1f6)],'邀请新用户注册奖励',_0x3fe6fa['id']);const _0x377eb9=await this[_0xa26422(0x1b4)][_0xa26422(0x239)]({'where':{'id':_0x3fe6fa['id']}});_0x1bc496[_0xa26422(0x20a)]&&(await this[_0xa26422(0x1b4)][_0xa26422(0x259)]({'id':_0x377eb9['id']},'score',_0x1bc496[_0xa26422(0x20a)]),await this[_0xa26422(0x245)][_0xa26422(0x17f)]({'userId':_0x3fe6fa['id'],'rawScore':_0x377eb9[_0xa26422(0x1b0)],'newScore':_0x377eb9['score']+_0x1bc496[_0xa26422(0x20a)],'changeScore':_0x1bc496[_0xa26422(0x20a)],'changeType':balance_constant_1[_0xa26422(0x222)]['Invited'],'rebateUserId':_0x4cdd9c['id'],'description':_0xa26422(0x190)})),_0x1bc496['invitedRewardVip']&&await this['updateVipExpire'](_0x377eb9,balance_constant_1[_0xa26422(0x222)][_0xa26422(0x178)],_0x1bc496[_0xa26422(0x1b5)],_0xa26422(0x190),_0x4cdd9c['id']);}}async['changeScore4Other'](_0x6094b2,_0x51d824,_0x39c5f0,_0x79fa13,_0x130d63){const _0x465bbe=_0x1535f2;await this[_0x465bbe(0x1b4)][_0x465bbe(0x267)]({'id':_0x6094b2['id']},{'score':_0x6094b2[_0x465bbe(0x1b0)]+_0x39c5f0}),await this['userBalanceService']['insertAccountLog']({'userId':_0x6094b2['id'],'rawScore':_0x6094b2['score'],'newScore':_0x6094b2[_0x465bbe(0x1b0)]+_0x39c5f0,'changeScore':_0x39c5f0,'changeType':_0x51d824,'relateId':_0x130d63?String(_0x130d63):null,'description':_0x79fa13});}async[_0x1535f2(0x228)](_0x5296f5,_0x35293,_0x450578,_0x3857e4,_0x5b27b0){const _0x277c4c=_0x1535f2;if(_0x5296f5[_0x277c4c(0x29f)])return;_0x450578===-0x1?await this['userEntity'][_0x277c4c(0x267)]({'id':_0x5296f5['id']},{'lifetimeVip':0x1}):(_0x5296f5[_0x277c4c(0x2c6)]?_0x5296f5[_0x277c4c(0x2c6)]=(0x0,date_1['default'])(_0x5296f5[_0x277c4c(0x2c6)])[_0x277c4c(0x1ae)](_0x450578,_0x277c4c(0x183))[_0x277c4c(0x248)]():_0x5296f5['vipExpire']=(0x0,date_1['default'])()[_0x277c4c(0x1ae)](_0x450578,_0x277c4c(0x183))['toDate'](),await this[_0x277c4c(0x1b4)][_0x277c4c(0x267)]({'id':_0x5296f5['id']},{'vipExpire':_0x5296f5[_0x277c4c(0x2c6)]})),_0x5296f5=await this[_0x277c4c(0x1b4)][_0x277c4c(0x239)]({'where':{'id':_0x5296f5['id']}}),await this[_0x277c4c(0x245)][_0x277c4c(0x21b)]({'userId':_0x5296f5['id'],'vipDays':_0x450578,'vipExpire':_0x5296f5[_0x277c4c(0x2c6)],'relateType':_0x35293,'relateId':_0x5b27b0?String(_0x5b27b0):'','description':_0x3857e4});}async['validateBalance4Chat'](_0x4d61bb,_0xb6df2c){const _0x329622=_0x1535f2;let _0x59d080=!![];const _0x52cb7e=await this[_0x329622(0x242)](_0x4d61bb);if(_0x52cb7e['lifetimeVip']||_0x52cb7e[_0x329622(0x2c6)]){if(_0xb6df2c[_0x329622(0x127)]<0x0)_0x59d080=!![];else{if(_0xb6df2c[_0x329622(0x127)]>0x0){const _0x3453c0=redisKey_constant_1['VIP_FREE']+'-'+_0x4d61bb+'-'+_0xb6df2c['id'];let _0x51ed8c=await this['redisCacheService'][_0x329622(0x232)]({'key':_0x3453c0});console[_0x329622(0x145)](_0x51ed8c);let _0x17e90a=Number(_0x51ed8c||0x0);_0x17e90a<_0xb6df2c[_0x329622(0x127)]?_0x59d080=!![]:_0x59d080=_0x52cb7e[_0x329622(0x1b0)]>=_0xb6df2c['deduct'];}else _0x59d080=_0x52cb7e[_0x329622(0x1b0)]>=_0xb6df2c[_0x329622(0x25c)];}}else _0x59d080=_0x52cb7e['score']>=_0xb6df2c['deduct'];if(!_0x59d080)throw new common_1[(_0x329622(0x291))]('用户余额不足，请充值',common_1[_0x329622(0x23f)][_0x329622(0x187)]);}async[_0x1535f2(0x219)](_0x59df8c,_0x1cbfc5,_0x1fe3a7){const _0x41be26=_0x1535f2,_0x237db0=await this[_0x41be26(0x242)](_0x59df8c);let _0x3f8776;switch(_0x1cbfc5[_0x41be26(0x246)]){case model_constant_1[_0x41be26(0x1bb)][_0x41be26(0x25f)]:_0x3f8776=balance_constant_1[_0x41be26(0x222)]['PPT'];break;case model_constant_1[_0x41be26(0x1bb)]['APP']:_0x3f8776=balance_constant_1[_0x41be26(0x222)]['GPTS'];break;case model_constant_1[_0x41be26(0x1bb)][_0x41be26(0x1de)]:_0x3f8776=balance_constant_1['EChangeType'][_0x41be26(0x214)];break;case model_constant_1['EModelType']['VIDEO']:_0x3f8776=balance_constant_1['EChangeType'][_0x41be26(0x268)];break;case model_constant_1[_0x41be26(0x1bb)][_0x41be26(0x24f)]:_0x3f8776=balance_constant_1[_0x41be26(0x222)][_0x41be26(0x2a4)];break;case model_constant_1[_0x41be26(0x1bb)]['CHAT']:_0x3f8776=balance_constant_1['EChangeType'][_0x41be26(0x294)];break;case model_constant_1['EModelType'][_0x41be26(0x278)]:_0x3f8776=balance_constant_1[_0x41be26(0x222)]['Tool'];break;case model_constant_1[_0x41be26(0x1bb)][_0x41be26(0x134)]:_0x3f8776=balance_constant_1[_0x41be26(0x222)]['File'];break;case model_constant_1['EModelType'][_0x41be26(0x15e)]:_0x3f8776=balance_constant_1['EChangeType'][_0x41be26(0x1a8)];break;default:_0x3f8776=balance_constant_1[_0x41be26(0x222)][_0x41be26(0x294)];}if(_0x237db0[_0x41be26(0x29f)]||_0x237db0[_0x41be26(0x2c6)]){if(_0x1cbfc5[_0x41be26(0x127)]<0x0)await this['changeScore4Other'](_0x237db0,_0x3f8776,0x0,_0x41be26(0x161)+_0x1cbfc5['modelName']+_0x41be26(0x16e),_0x1fe3a7);else{if(_0x1cbfc5[_0x41be26(0x127)]>0x0){const _0x5e6306=redisKey_constant_1[_0x41be26(0x2a9)]+'-'+_0x59df8c+'-'+_0x1cbfc5['id'];let _0x57dfd7=await this[_0x41be26(0x22e)][_0x41be26(0x232)]({'key':_0x5e6306}),_0x169aa5=Number(_0x57dfd7||0x0);if(_0x169aa5<_0x1cbfc5[_0x41be26(0x127)]){const _0xbd497b=(0x0,date_1[_0x41be26(0x13d)])()[_0x41be26(0x204)]('d')[_0x41be26(0x1f4)]((0x0,date_1[_0x41be26(0x13d)])(),'s');await this['redisCacheService'][_0x41be26(0x1ff)]({'key':_0x5e6306,'val':_0x169aa5+0x1},_0xbd497b),await this[_0x41be26(0x283)](_0x237db0,_0x3f8776,0x0,_0x41be26(0x161)+_0x1cbfc5[_0x41be26(0x261)]+_0x41be26(0x2a5),_0x1fe3a7);}else await this[_0x41be26(0x283)](_0x237db0,_0x3f8776,-_0x1cbfc5['deduct'],_0x41be26(0x161)+_0x1cbfc5[_0x41be26(0x261)]+_0x41be26(0x124),_0x1fe3a7);}else await this[_0x41be26(0x283)](_0x237db0,_0x3f8776,-_0x1cbfc5[_0x41be26(0x25c)],_0x41be26(0x161)+_0x1cbfc5[_0x41be26(0x261)]+'】使用扣减',_0x1fe3a7);}}else await this[_0x41be26(0x283)](_0x237db0,_0x3f8776,-_0x1cbfc5['deduct'],'模型【'+_0x1cbfc5[_0x41be26(0x261)]+'】使用扣减',_0x1fe3a7);}async[_0x1535f2(0x230)](_0x591a87,_0x253ca0,_0x253039){const _0x3c1dc3=_0x1535f2,_0x38695f=await this[_0x3c1dc3(0x242)](_0x591a87);let _0x5e677d;switch(_0x253ca0[_0x3c1dc3(0x246)]){case model_constant_1[_0x3c1dc3(0x1bb)][_0x3c1dc3(0x235)]:_0x5e677d=balance_constant_1[_0x3c1dc3(0x222)][_0x3c1dc3(0x156)];break;case model_constant_1[_0x3c1dc3(0x1bb)][_0x3c1dc3(0x1de)]:_0x5e677d=balance_constant_1['EChangeType'][_0x3c1dc3(0x214)];break;case model_constant_1[_0x3c1dc3(0x1bb)][_0x3c1dc3(0x24f)]:_0x5e677d=balance_constant_1[_0x3c1dc3(0x222)]['Draw'];break;case model_constant_1[_0x3c1dc3(0x1bb)][_0x3c1dc3(0x27b)]:_0x5e677d=balance_constant_1['EChangeType']['Chat'];break;case model_constant_1['EModelType'][_0x3c1dc3(0x278)]:_0x5e677d=balance_constant_1['EChangeType'][_0x3c1dc3(0x146)];break;default:_0x5e677d=balance_constant_1[_0x3c1dc3(0x222)]['Chat'];}await this[_0x3c1dc3(0x283)](_0x38695f,_0x5e677d,_0x253ca0['deduct'],_0x3c1dc3(0x161)+_0x253ca0[_0x3c1dc3(0x261)]+_0x3c1dc3(0x28d),_0x253039);}async[_0x1535f2(0x1c2)](_0x597b0d,_0x585b4d,_0x1323ba){const _0x2385da=_0x1535f2;let _0x5a4df5='',_0x2619a8='',_0x241b63='',_0x2c48ea=_0x585b4d;const _0x24b495=_0x585b4d[_0x2385da(0x2b1)](),_0x98d6b4=new RegExp('imagine|variation|outpaint|pan|blend|inpaint|upsample|picreader|reroll'),_0x3bb2e6=new RegExp(_0x2385da(0x2d2)),_0x1a8097=new RegExp(_0x2385da(0x160));if(_0x597b0d===midjourney_constant_1[_0x2385da(0x2ae)][_0x2385da(0x15d)])_0x2619a8=_0x2385da(0x244),_0x5a4df5=_0x2385da(0x158),_0x241b63=_0x2385da(0x13a);else{if(_0x597b0d===midjourney_constant_1[_0x2385da(0x2ae)][_0x2385da(0x220)])_0x2619a8='type2',_0x5a4df5=_0x2385da(0x180),_0x241b63=_0x2385da(0x27f);else _0x597b0d===midjourney_constant_1[_0x2385da(0x2ae)][_0x2385da(0x28c)]&&(_0x2619a8=_0x2385da(0x23b),_0x5a4df5=_0x2385da(0x126),_0x241b63=_0x2385da(0x18c));}if(_0x98d6b4[_0x2385da(0x2a7)](_0x24b495))_0x5a4df5=_0x5a4df5+0x1;else{if(_0x3bb2e6['test'](_0x24b495))_0x5a4df5=_0x5a4df5+0x2;else _0x1a8097['test'](_0x24b495)&&(_0x5a4df5=_0x5a4df5+0x3);}const _0x1fc232={},_0x3da62b=await this[_0x2385da(0x1fa)]['getConfigByKeys']([_0x5a4df5,_0x241b63]);for(let _0x168d86 in _0x3da62b){_0x1fc232[_0x168d86]=Number(_0x3da62b[_0x168d86])||0x0;}if(_0x1323ba[_0x2385da(0x265)]){const _0x4ae5f1=await this[_0x2385da(0x1fa)][_0x2385da(0x25a)](_0x1323ba[_0x2385da(0x265)],'mj');_0x4ae5f1&&(_0x1fc232[_0x241b63]=_0x4ae5f1[_0x2619a8]||0x0);}for(let _0x190097 in midjourney_constant_1[_0x2385da(0x227)]){if(_0x24b495[_0x2385da(0x1f9)](midjourney_constant_1[_0x2385da(0x227)][_0x190097][_0x2385da(0x155)])){_0x2c48ea=midjourney_constant_1[_0x2385da(0x227)][_0x190097]['cn'];break;}}return{'price':_0x1fc232[_0x5a4df5],'vipFreeNum':_0x1fc232[_0x241b63],'vipFreeKey':_0x241b63,'description':_0x2c48ea};}async[_0x1535f2(0x24d)](_0x104659,_0x5f49e4,_0x2e5da5){const _0x16dfba=_0x1535f2;let _0x5f1eb0=!![];const _0x152413=await this[_0x16dfba(0x242)](_0x104659),_0x5c3367=await this[_0x16dfba(0x1c2)](_0x5f49e4,_0x2e5da5,_0x152413);if(_0x152413[_0x16dfba(0x29f)]||_0x152413[_0x16dfba(0x2c6)]){if(_0x5c3367['vipFreeNum']<0x0)_0x5f1eb0=!![];else{if(_0x5c3367[_0x16dfba(0x127)]>0x0){const _0x266f8c=redisKey_constant_1[_0x16dfba(0x2a9)]+'-'+_0x104659+'-'+_0x5c3367[_0x16dfba(0x2ad)];let _0x450934=await this[_0x16dfba(0x22e)]['get']({'key':_0x266f8c}),_0x269497=Number(_0x450934||0x0);_0x269497<_0x5c3367[_0x16dfba(0x127)]?_0x5f1eb0=!![]:_0x5f1eb0=_0x152413[_0x16dfba(0x1b0)]>=_0x5c3367[_0x16dfba(0x254)];}else _0x5f1eb0=_0x152413[_0x16dfba(0x1b0)]>=_0x5c3367[_0x16dfba(0x254)];}}else _0x5f1eb0=_0x152413[_0x16dfba(0x1b0)]>=_0x5c3367[_0x16dfba(0x254)];if(!_0x5f1eb0)throw new common_1[(_0x16dfba(0x291))]('用户余额不足，请充值',common_1['HttpStatus'][_0x16dfba(0x187)]);}async[_0x1535f2(0x270)](_0x5893ad,_0x1539aa,_0x1f82f8,_0xa7e475){const _0x1a315d=_0x1535f2,_0x2f99b6=await this['getUserById'](_0x5893ad),_0x2886d7=await this[_0x1a315d(0x1c2)](_0x1539aa,_0x1f82f8,_0x2f99b6),_0x58b890=balance_constant_1[_0x1a315d(0x222)]['MjDraw'];if(_0x2f99b6['lifetimeVip']||_0x2f99b6[_0x1a315d(0x2c6)]){if(_0x2886d7['vipFreeNum']<0x0)await this[_0x1a315d(0x283)](_0x2f99b6,_0x58b890,0x0,_0x1a315d(0x196)+_0x2886d7['description']+_0x1a315d(0x16e),_0xa7e475);else{if(_0x2886d7['vipFreeNum']>0x0){const _0x4a0a85=redisKey_constant_1['VIP_FREE']+'-'+_0x5893ad+'-'+_0x2886d7[_0x1a315d(0x2ad)];let _0x368ca2=await this[_0x1a315d(0x22e)][_0x1a315d(0x232)]({'key':_0x4a0a85}),_0x5de1c1=Number(_0x368ca2||0x0);if(_0x5de1c1<_0x2886d7[_0x1a315d(0x127)]){const _0x5be40a=(0x0,date_1['default'])()[_0x1a315d(0x204)]('d')['diff']((0x0,date_1[_0x1a315d(0x13d)])(),'s');await this[_0x1a315d(0x22e)][_0x1a315d(0x1ff)]({'key':_0x4a0a85,'val':_0x5de1c1+0x1},_0x5be40a),await this['changeScore4Other'](_0x2f99b6,_0x58b890,0x0,'MJ绘画【'+_0x2886d7[_0x1a315d(0x16b)]+_0x1a315d(0x2a5),_0xa7e475);}else await this[_0x1a315d(0x283)](_0x2f99b6,_0x58b890,-_0x2886d7[_0x1a315d(0x254)],_0x1a315d(0x196)+_0x2886d7[_0x1a315d(0x16b)]+_0x1a315d(0x124),_0xa7e475);}else await this[_0x1a315d(0x283)](_0x2f99b6,_0x58b890,-_0x2886d7[_0x1a315d(0x254)],_0x1a315d(0x196)+_0x2886d7['description']+'】使用扣减',_0xa7e475);}}else await this[_0x1a315d(0x283)](_0x2f99b6,_0x58b890,-_0x2886d7[_0x1a315d(0x254)],'MJ绘画【'+_0x2886d7[_0x1a315d(0x16b)]+'】使用扣减',_0xa7e475);}async['debuctBalance4PPT'](_0x22c1e7,_0x13a6b3,_0xfab6cb,_0x535181=![]){const _0x49317a=_0x1535f2,_0x193766={'structure':{'key':'pptOutline','vlrk':_0x49317a(0x244),'desc':'标题大纲任务'},'cover':{'key':_0x49317a(0x176),'vlrk':_0x49317a(0x244),'desc':_0x49317a(0x20c)},'recover':{'key':_0x49317a(0x176),'vlrk':_0x49317a(0x244),'desc':_0x49317a(0x2b7)},'create':{'key':_0x49317a(0x14d),'vlrk':_0x49317a(0x1ce),'desc':_0x49317a(0x1e1)},'thesis':{'key':_0x49317a(0x27c),'vlrk':'type3','desc':'论文生成PPT'},'file':{'key':_0x49317a(0x14d),'vlrk':_0x49317a(0x1ce),'desc':_0x49317a(0x212)},'theme':{'key':_0x49317a(0x14d),'vlrk':_0x49317a(0x1ce),'desc':_0x49317a(0x2ac)},'addpage':{'key':'pptCreate','vlrk':_0x49317a(0x1ce),'desc':_0x49317a(0x27e)},'addNotes':{'key':'pptCreate','vlrk':'type2','desc':'增加PPT备注'}},_0x3054e8=_0x193766[_0xfab6cb][_0x49317a(0x2c0)],_0xa79d17=_0x193766[_0xfab6cb][_0x49317a(0x271)]+'Price',_0x3609ae=_0x193766[_0xfab6cb][_0x49317a(0x271)]+_0x49317a(0x240),_0x323977={},_0x1cb3d7=await this[_0x49317a(0x1fa)][_0x49317a(0x202)]([_0xa79d17,_0x3609ae]);for(let _0x5e4ab1 in _0x1cb3d7){_0x323977[_0x5e4ab1]=Number(_0x1cb3d7[_0x5e4ab1])||0x0;}const _0x45907a=await this[_0x49317a(0x242)](_0x22c1e7);if(_0x45907a['vipLeavelId']){const _0x87fb82=await this[_0x49317a(0x1fa)][_0x49317a(0x25a)](_0x45907a['vipLeavelId'],model_constant_1[_0x49317a(0x1bb)][_0x49317a(0x25f)]);_0x87fb82&&(_0x323977[_0x3609ae]=_0x87fb82[_0x193766[_0xfab6cb]['vlrk']]||0x0);}if(_0x45907a['lifetimeVip']||_0x45907a['vipExpire']){if(_0x323977[_0x3609ae]<0x0)await this[_0x49317a(0x283)](_0x45907a,balance_constant_1[_0x49317a(0x222)][_0x49317a(0x25f)],0x0,_0x49317a(0x135)+_0x3054e8+_0x49317a(0x16e),_0x13a6b3);else{if(_0x323977[_0x3609ae]>0x0){const _0x497eaa=redisKey_constant_1[_0x49317a(0x2a9)]+'-'+_0x22c1e7+'-'+_0x3609ae;let _0x63d4d=await this[_0x49317a(0x22e)]['get']({'key':_0x497eaa}),_0x26f379=Number(_0x63d4d||0x0);if(_0x26f379<_0x323977[_0x3609ae]){const _0x14f8fa=(0x0,date_1['default'])()[_0x49317a(0x204)]('d')[_0x49317a(0x1f4)]((0x0,date_1[_0x49317a(0x13d)])(),'s');await this[_0x49317a(0x22e)][_0x49317a(0x1ff)]({'key':_0x497eaa,'val':_0x26f379+0x1},_0x14f8fa),await this[_0x49317a(0x283)](_0x45907a,balance_constant_1['EChangeType'][_0x49317a(0x25f)],0x0,_0x49317a(0x135)+_0x3054e8+_0x49317a(0x2a5),_0x13a6b3);}else await this[_0x49317a(0x283)](_0x45907a,balance_constant_1[_0x49317a(0x222)][_0x49317a(0x25f)],-_0x323977[_0xa79d17],'PPT【'+_0x3054e8+_0x49317a(0x124),_0x13a6b3);}else await this[_0x49317a(0x283)](_0x45907a,balance_constant_1[_0x49317a(0x222)][_0x49317a(0x25f)],-_0x323977[_0xa79d17],'PPT【'+_0x3054e8+'】使用扣减',_0x13a6b3);}}else await this['changeScore4Other'](_0x45907a,balance_constant_1['EChangeType'][_0x49317a(0x25f)],-_0x323977[_0xa79d17],_0x49317a(0x135)+_0x3054e8+_0x49317a(0x124),_0x13a6b3);}async[_0x1535f2(0x152)](_0x1ea0b1,_0x152c10,_0x129907){const _0x26bade=_0x1535f2,_0x4847a0=await this[_0x26bade(0x242)](_0x1ea0b1);if(_0x4847a0[_0x26bade(0x29f)]||_0x4847a0['vipExpire']){if(_0x152c10['vipFreeNum']<0x0)await this[_0x26bade(0x283)](_0x4847a0,balance_constant_1[_0x26bade(0x222)]['WORKFLOW'],0x0,_0x26bade(0x234)+_0x152c10[_0x26bade(0x261)]+_0x26bade(0x16e),_0x129907);else{if(_0x152c10['vipFreeNum']>0x0){const _0x2a1cc8=redisKey_constant_1[_0x26bade(0x2a9)]+'-'+_0x1ea0b1+'-'+_0x152c10['id'];let _0x54216b=await this[_0x26bade(0x22e)][_0x26bade(0x232)]({'key':_0x2a1cc8}),_0x55c30c=Number(_0x54216b||0x0);if(_0x55c30c<_0x152c10['vipFreeNum']){const _0x3708eb=(0x0,date_1[_0x26bade(0x13d)])()[_0x26bade(0x204)]('d')[_0x26bade(0x1f4)]((0x0,date_1[_0x26bade(0x13d)])(),'s');await this[_0x26bade(0x22e)][_0x26bade(0x1ff)]({'key':_0x2a1cc8,'val':_0x55c30c+0x1},_0x3708eb),await this[_0x26bade(0x283)](_0x4847a0,balance_constant_1[_0x26bade(0x222)][_0x26bade(0x224)],0x0,'小工具【'+_0x152c10[_0x26bade(0x261)]+_0x26bade(0x2a5),_0x129907);}else await this[_0x26bade(0x283)](_0x4847a0,balance_constant_1[_0x26bade(0x222)][_0x26bade(0x224)],-_0x152c10[_0x26bade(0x25c)],_0x26bade(0x234)+_0x152c10[_0x26bade(0x261)]+'】使用扣减',_0x129907);}else await this[_0x26bade(0x283)](_0x4847a0,balance_constant_1[_0x26bade(0x222)][_0x26bade(0x224)],-_0x152c10[_0x26bade(0x25c)],_0x26bade(0x234)+_0x152c10['modelName']+_0x26bade(0x124),_0x129907);}}else await this[_0x26bade(0x283)](_0x4847a0,balance_constant_1['EChangeType']['WORKFLOW'],-_0x152c10[_0x26bade(0x25c)],_0x26bade(0x234)+_0x152c10[_0x26bade(0x261)]+_0x26bade(0x124),_0x129907);}async[_0x1535f2(0x255)](_0x358d84,_0x484be9){const _0x29b2c9=_0x1535f2,_0x5103bd=store_1[_0x29b2c9(0x250)][_0x29b2c9(0x288)],_0x4f09ce=await this[_0x29b2c9(0x242)](_0x358d84),_0x582aaf=balance_constant_1[_0x29b2c9(0x222)]['SD'];if(_0x4f09ce[_0x29b2c9(0x29f)]||_0x4f09ce[_0x29b2c9(0x2c6)]){if(store_1[_0x29b2c9(0x250)][_0x29b2c9(0x1da)]<0x0)await this[_0x29b2c9(0x283)](_0x4f09ce,_0x582aaf,0x0,_0x29b2c9(0x123),_0x484be9);else{if(store_1['CZConfig']['czVipFree']>0x0){const _0x3809b1=redisKey_constant_1[_0x29b2c9(0x2a9)]+'-'+_0x358d84+_0x29b2c9(0x281);let _0x279245=await this['redisCacheService'][_0x29b2c9(0x232)]({'key':_0x3809b1}),_0x4e5b4b=Number(_0x279245||0x0);if(_0x4e5b4b<store_1[_0x29b2c9(0x250)][_0x29b2c9(0x1da)]){const _0x59c66c=(0x0,date_1[_0x29b2c9(0x13d)])()[_0x29b2c9(0x204)]('d')[_0x29b2c9(0x1f4)]((0x0,date_1[_0x29b2c9(0x13d)])(),'s');await this[_0x29b2c9(0x22e)][_0x29b2c9(0x1ff)]({'key':_0x3809b1,'val':_0x4e5b4b+0x1},_0x59c66c),await this[_0x29b2c9(0x283)](_0x4f09ce,_0x582aaf,0x0,_0x29b2c9(0x136)+_0x5103bd+_0x29b2c9(0x2a5),_0x484be9);}else await this[_0x29b2c9(0x283)](_0x4f09ce,_0x582aaf,-_0x5103bd,_0x29b2c9(0x136)+_0x5103bd+_0x29b2c9(0x124),_0x484be9);}else await this['changeScore4Other'](_0x4f09ce,_0x582aaf,-_0x5103bd,_0x29b2c9(0x136)+_0x5103bd+_0x29b2c9(0x124),_0x484be9);}}else await this[_0x29b2c9(0x283)](_0x4f09ce,_0x582aaf,-_0x5103bd,_0x29b2c9(0x136)+_0x5103bd+_0x29b2c9(0x124),_0x484be9);}async['updateVipExpire2Redis'](){const _0x5399b6=_0x1535f2,_0x2ad063=await this[_0x5399b6(0x1b4)][_0x5399b6(0x2bb)]({'where':{'vipExpire':(0x0,typeorm_2[_0x5399b6(0x125)])((0x0,date_1[_0x5399b6(0x13d)])()[_0x5399b6(0x1bd)]('d')['toDate'](),(0x0,date_1['default'])()[_0x5399b6(0x204)]('d')[_0x5399b6(0x248)]())}});if(_0x2ad063[_0x5399b6(0x1fd)])for(let _0x1ef1cb=0x0;_0x1ef1cb<_0x2ad063[_0x5399b6(0x1fd)];_0x1ef1cb++){const _0x3c5d09=_0x2ad063[_0x1ef1cb];await this['redisCacheService'][_0x5399b6(0x1ff)]({'key':redisKey_constant_1[_0x5399b6(0x19c)]+_0x3c5d09['id'],'val':''},(0x0,date_1[_0x5399b6(0x13d)])()[_0x5399b6(0x204)]('d')[_0x5399b6(0x1f4)]((0x0,date_1[_0x5399b6(0x13d)])(),'s'));}const _0x1ddd39=await this[_0x5399b6(0x1b4)]['find']({'where':{'vipExpire':(0x0,typeorm_2[_0x5399b6(0x150)])((0x0,date_1['default'])()['toDate']())}});if(_0x1ddd39['length']){const _0x373d92=_0x1ddd39['map'](_0x47949a=>_0x47949a['id']);await this['userEntity']['update']({'id':(0x0,typeorm_2['In'])(_0x373d92)},{'vipExpire':null});}}};UserService=__decorate([(0x0,common_1['Injectable'])(),__param(0x0,(0x0,common_1[_0x1535f2(0x215)])(_0x1535f2(0x1bf))),__param(0x1,(0x0,typeorm_1[_0x1535f2(0x143)])(user_entity_1[_0x1535f2(0x2c7)])),__param(0x2,(0x0,typeorm_1['InjectRepository'])(saas_entity_1['SaasEntity'])),__param(0x3,(0x0,typeorm_1[_0x1535f2(0x143)])(role_entity_1[_0x1535f2(0x1fe)])),__param(0x4,(0x0,typeorm_1[_0x1535f2(0x143)])(user_init_vip_entity_1[_0x1535f2(0x2b0)])),__param(0x5,(0x0,typeorm_1[_0x1535f2(0x143)])(userFavorite_entity_1[_0x1535f2(0x199)])),__metadata(_0x1535f2(0x1d5),[Object,typeorm_2[_0x1535f2(0x28e)],typeorm_2[_0x1535f2(0x28e)],typeorm_2[_0x1535f2(0x28e)],typeorm_2[_0x1535f2(0x28e)],typeorm_2[_0x1535f2(0x28e)],nestjs_cls_1[_0x1535f2(0x29c)],mailer_1[_0x1535f2(0x20e)],redisCache_service_1[_0x1535f2(0x14a)],userBalance_service_1[_0x1535f2(0x1ee)],globalConfig_service_1[_0x1535f2(0x12d)],verification_service_1[_0x1535f2(0x1cc)],typeorm_2[_0x1535f2(0x174)]])],UserService),exports[_0x1535f2(0x18e)]=UserService;